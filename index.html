<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AcoustiSkin CRM â€” Enterprise</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FullCalendar 6 -->
  <link  href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{ --purple:#6A1B9A; --purple-dark:#4a148c; }
    body{font-family:Inter,sans-serif;background:#fff;color:var(--purple);}
    h1,h2,h3,h4,h5,th,td,label,button,a{color:var(--purple);}
    .sidebar{width:17rem;background:var(--purple-dark);}
    .nav-link:hover,.sidebar .active{background:rgba(255,255,255,.12);}
    .calendar-btn{background:var(--purple);color:#fff;padding:.35rem .8rem;border-radius:.375rem;font-size:.8125rem;}
    .badge{padding:.15rem .55rem;border-radius:.25rem;font-size:.75rem}
  </style>
</head>

<body class="flex antialiased min-h-screen">
<!-- ============  SIDEBAR  ============ -->
<aside class="sidebar text-white fixed inset-y-0 left-0 flex flex-col shadow-lg">
  <h1 class="p-6 text-2xl font-bold border-b border-purple-900">AcoustiSkin CRM</h1>

  <nav id="nav" class="flex-1 overflow-y-auto text-sm uppercase tracking-wider px-3 py-4 space-y-1">
    <a data-view="dashboard" class="nav-link block p-3 rounded">Dashboard</a>
    <a data-view="customers" class="nav-link block p-3 rounded">Customers</a>
    <a data-view="orders"    class="nav-link block p-3 rounded">Orders</a>
    <a data-view="calendar"  class="nav-link block p-3 rounded">Calendar</a>
    <a data-view="pipeline"  class="nav-link block p-3 rounded">Pipeline</a>
  </nav>

  <button id="newCustomerBtn"
          class="m-4 bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg font-semibold">
    + New Customer
  </button>
</aside>

<!-- ============  MAIN  ============ -->
<main class="flex-1 ml-[17rem] flex flex-col">
  <!-- top bar -->
  <header class="bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-10">
    <h2 id="hdrCustomer" class="font-bold text-lg">
      Customer: <span class="font-normal text-gray-500">None</span>
    </h2>
    <div class="flex items-center space-x-3">
      <select id="csrSelect" class="border-gray-300 rounded text-sm">
        <option value="">CSR loginâ€¦</option>
        <option>Jane Waters</option><option>Harry Chen</option><option>Aarav Patel</option>
      </select>
      <button id="hdrCalendarBtn" class="calendar-btn">ðŸ“… Schedule</button>
      <button id="editCustBtn"    class="calendar-btn hidden">âœŽ Edit</button>
    </div>
  </header>

  <!-- toast -->
  <div id="toast" class="fixed top-4 right-4 hidden px-4 py-2 rounded shadow"></div>

  <!-- dynamic views -->
  <section id="dashboard" class="p-6"></section>
  <section id="customers" class="p-6 hidden"></section>
  <section id="orders"    class="p-6 hidden"></section>
  <section id="calendar"  class="p-0  hidden"></section>
  <section id="pipeline"  class="p-6 hidden"></section>
</main>

<!-- JavaScript modules -->
<script type="module" src="./data-model.js"></script>
<script type="module" src="./app.js"></script>
</body>
</html>/* Local-storage â€œrepositoryâ€ layer */
export const db = JSON.parse(localStorage.getItem('ASCRM') || `{
  "customers": [], "orders": [], "appointments": [], "pipeline": []
}`);

export const save = () => localStorage.setItem('ASCRM', JSON.stringify(db));

export const uuid = () => Date.now().toString(36) + Math.random().toString(36).slice(2);

/* factory helpers */
export const newCustomer = csr => ({
  id: uuid(), name:"", phone:"", emails:[], csr,
  billTo:{}, shipTo:{},
  createdAt: new Date().toLocaleString(),
  updatedAt: new Date().toLocaleString()
});

export const newOrder = csr => ({
  id: uuid(),
  orderNo: 'ORD-' + Date.now().toString().slice(-5),
  custId:"", status:"Pending", carrier:"", csr,
  date: new Date().toLocaleDateString()
});

export const newAppointment = (date,custId,csr) => ({
  id: uuid(), title:"", type:"Appointment",
  date, time:"09:00", custId, notes:"", csr
});/* AcoustiSkin CRM â€“ main SPA logic */
import {db,save,uuid,newCustomer,newOrder,newAppointment} from './data-model.js';

/* tiny helpers */
const $  = q => document.querySelector(q);
const $$ = q => document.querySelectorAll(q);
const toast = (msg,type='info') =>{
  const t=$("#toast");
  const palette = {
    info   :'bg-purple-100 text-purple-800',
    success:'bg-green-100 text-green-700',
    error  :'bg-red-100 text-red-700'
  };
  t.textContent=msg;
  t.className=`fixed top-4 right-4 px-4 py-2 rounded shadow ${palette[type]}`;
  t.classList.remove('hidden');
  clearTimeout(t._hide); t._hide=setTimeout(()=>t.classList.add('hidden'),3000);
};

/* state */
let activeCustomer = null;
let currentCSR     = '';

/* ------------------------------------------------------------------
   ROUTER & NAV
------------------------------------------------------------------ */
const views=['dashboard','customers','orders','calendar','pipeline'];
function show(id){
  views.forEach(v=>$('#'+v).classList.toggle('hidden',v!==id));
  if(id==='dashboard') renderDash();
  if(id==='customers') renderCustomerForm();
  if(id==='orders')    renderOrders();
  if(id==='calendar')  renderCalendar();
  if(id==='pipeline')  renderPipeline();
}

/* sidebar */
$$('.nav-link').forEach(a=>{
  a.onclick=e=>{
    e.preventDefault();
    $$('.nav-link').forEach(l=>l.classList.remove('active'));
    a.classList.add('active');
    show(a.dataset.view);
  };
});

/* header items */
$('#hdrCalendarBtn').onclick = ()=>show('calendar');
$('#editCustBtn').onclick    = ()=>show('customers');
$('#csrSelect').onchange     = e=>currentCSR=e.target.value;

/* new customer */
$('#newCustomerBtn').onclick=()=>{
  activeCustomer=newCustomer(currentCSR);
  db.customers.push(activeCustomer); save();
  updateHeader();
  $('#editCustBtn').classList.remove('hidden');
  show('customers');
};

/* helper */
const updateHeader=()=>$('#hdrCustomer').innerHTML=
  `Customer: <span class="font-normal text-gray-500">${activeCustomer?activeCustomer.name||'Unnamed':'None'}</span>`;

/* ------------------------------------------------------------------
   DASHBOARD
------------------------------------------------------------------ */
function renderDash(){
  const el=$("#dashboard");
  if(!activeCustomer){
    el.innerHTML='<p class="text-gray-500 text-center mt-10">Select or create a customer.</p>';return;
  }
  el.innerHTML=`
    <h2 class="text-2xl font-bold mb-4">${activeCustomer.name||'Unnamed'}</h2>
    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <p><strong>CSR:</strong> ${activeCustomer.csr||''}</p>
        <p><strong>Email:</strong> ${activeCustomer.emails[0]||''}</p>
        <p><strong>Phone:</strong> ${activeCustomer.phone||''}</p>
      </div>
      <div>
        <p><strong>Ship To:</strong> ${(activeCustomer.shipTo.line1||'')+' '+(activeCustomer.shipTo.city||'')}</p>
      </div>
    </div>
    <p class="text-sm mt-4 text-gray-500">Updated ${activeCustomer.updatedAt}</p>`;
}

/* ------------------------------------------------------------------
   CUSTOMER MASTER
------------------------------------------------------------------ */
function renderCustomerForm(){
  const c=activeCustomer;
  if(!c){ $('#customers').innerHTML='<p>Select a customer first.</p>'; return; }
  $('#customers').innerHTML=`
    <h2 class="text-xl font-bold mb-6">Customer Master</h2>
    <div class="grid md:grid-cols-2 gap-6">
      <div class="space-y-3">
        <label>Name <input id="c-name"   class="border rounded w-full p-1" value="${c.name}"></label>
        <label>Business Email <input id="c-e1" class="border rounded w-full p-1" value="${c.emails[0]||''}"></label>
        <label>Personal Email <input id="c-e2" class="border rounded w-full p-1" value="${c.emails[1]||''}"></label>
        <label>Phone <input id="c-phone" class="border rounded w-full p-1" value="${c.phone||''}"></label>
        <label>CSR <input id="c-csr"     class="border rounded w-full p-1" value="${c.csr||currentCSR}"></label>
      </div>
      <div class="space-y-3">
        <h3 class="font-semibold">Bill To</h3>
        <input id="c-b1" class="border rounded w-full p-1" placeholder="Street" value="${c.billTo.line1||''}">
        <input id="c-bcity" class="border rounded w-full p-1" placeholder="City, ST" value="${c.billTo.city||''}">
        <input id="c-bzip"  class="border rounded w-full p-1" placeholder="ZIP" value="${c.billTo.zip||''}">
        <h3 class="font-semibold mt-4">Ship To</h3>
        <input id="c-s1" class="border rounded w-full p-1" placeholder="Street" value="${c.shipTo.line1||''}">
        <input id="c-scity" class="border rounded w-full p-1" placeholder="City, ST" value="${c.shipTo.city||''}">
        <input id="c-szip"  class="border rounded w-full p-1" placeholder="ZIP" value="${c.shipTo.zip||''}">
      </div>
    </div>
    <div class="mt-6 flex justify-end gap-3">
      <button id="delCust" class="bg-red-600 text-white px-4 py-2 rounded">Delete</button>
      <button id="savCust" class="calendar-btn">ðŸ’¾ Save</button>
    </div>
    <p class="text-sm mt-4 text-gray-500">Created ${c.createdAt} | Updated ${c.updatedAt}</p>`;

  $('#savCust').onclick=()=>{
    Object.assign(c,{
      name:$('#c-name').value.trim(),
      emails:[$('#c-e1').value.trim(),$('#c-e2').value.trim()],
      phone:$('#c-phone').value.trim(),
      csr:$('#c-csr').value.trim(),
      billTo:{line1:$('#c-b1').value,city:$('#c-bcity').value,zip:$('#c-bzip').value},
      shipTo:{line1:$('#c-s1').value,city:$('#c-scity').value,zip:$('#c-szip').value},
      updatedAt:new Date().toLocaleString()
    });
    save(); updateHeader(); toast('Customer saved','success');
    renderDash();
  };

  $('#delCust').onclick=()=>{
    if(confirm('Delete this customer?')){
      db.customers=db.customers.filter(x=>x.id!==c.id);
      activeCustomer=null; save(); updateHeader(); $('#editCustBtn').classList.add('hidden');
      toast('Deleted','success'); show('dashboard');
    }
  };
}

/* ------------------------------------------------------------------
   ORDERS
------------------------------------------------------------------ */
function renderOrders(){
  $('#orders').innerHTML=`
   <div class="flex justify-between items-center mb-4">
     <h2 class="text-xl font-bold">Orders</h2>
     <button id="newOrderBtn" class="calendar-btn">+ New</button>
   </div>
   <table class="w-full text-sm">
     <thead><tr class="border-b">
       <th class="text-left py-1">#</th><th class="text-left">Customer</th>
       <th>Status</th><th>Carrier</th><th>CSR</th><th>Date</th><th></th>
     </tr></thead>
     <tbody id="orderTbody"></tbody>
   </table>`;
  const tbody=$('#orderTbody');
  tbody.innerHTML=db.orders.map(o=>{
    const name=(db.customers.find(c=>c.id===o.custId)||{}).name||'';
    const badge=o.status==='Shipped'?'bg-green-200 text-green-800':'bg-yellow-100 text-yellow-800';
    return `<tr class="border-b">
      <td>${o.orderNo}</td><td>${name}</td><td><span class="badge ${badge}">${o.status}</span></td>
      <td>${o.carrier||''}</td><td>${o.csr||''}</td><td>${o.date}</td>
      <td><button data-id="${o.id}" class="text-purple-600 text-xs">Edit</button></td>
    </tr>`;}).join('');
  tbody.querySelectorAll('button').forEach(b=>b.onclick=()=>editOrder(b.dataset.id));
  $('#newOrderBtn').onclick=()=>editOrder();
}

function editOrder(id){
  let o=id?db.orders.find(x=>x.id===id):newOrder(currentCSR);
  Swal.fire({
    title:id?'Edit Order':'New Order',
    html:`<select id="o-cust" class="swal2-input">
        ${db.customers.map(c=>`<option value="${c.id}" ${c.id===o.custId?'selected':''}>${c.name}</option>`).join('')}
      </select>
      <input id="o-no" class="swal2-input" value="${o.orderNo}">
      <select id="o-st" class="swal2-input">
        <option ${o.status==='Pending'?'selected':''}>Pending</option>
        <option ${o.status==='Shipped'?'selected':''}>Shipped</option>
        <option ${o.status==='Closed'?'selected':''}>Closed</option></select>
      <input id="o-car"  class="swal2-input" placeholder="Carrier" value="${o.carrier||''}">
      <input id="o-csr"  class="swal2-input" value="${o.csr||currentCSR}">`,
    preConfirm:()=>{
      o.custId=$('#o-cust').value; o.orderNo=$('#o-no').value;
      o.status=$('#o-st').value;   o.carrier=$('#o-car').value;
      o.csr=$('#o-csr').value;
    }
  }).then(r=>{
    if(r.isConfirmed){
      if(!id) db.orders.push(o);
      save(); renderOrders(); toast('Order saved','success');
    }
  });
}

/* ------------------------------------------------------------------
   CALENDAR (FullCalendar)
------------------------------------------------------------------ */
let fc=null;
function renderCalendar(){
  $('#calendar').innerHTML='<div id="fc" class="p-4"></div>';
  if(fc) fc.destroy();
  fc=new FullCalendar.Calendar($('#fc'),{
    height:'auto',
    initialView:'dayGridMonth',
    headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,timeGridDay,listWeek'},
    events:db.appointments.map(a=>({...a,id:a.id,backgroundColor:'#d1b3ff',borderColor:'#b88aff'})),
    dateClick: ({dateStr}) => openEventModal(null,dateStr),
    eventClick: ({event})  => {
      const ev=db.appointments.find(x=>x.id===event.id);
      if(ev) openEventModal(ev,ev.date);
    }
  });
  fc.render();
}

function openEventModal(ev,dateStr){
  const item = ev ? {...ev} : newAppointment(dateStr,activeCustomer?.id,currentCSR);
  Swal.fire({
    title: ev?'Edit Event':'New Event',
    html:`<input id="e-title" class="swal2-input" placeholder="Title" value="${item.title}">
      <select id="e-type" class="swal2-input">
        <option ${item.type==='Appointment'?'selected':''}>Appointment</option>
        <option ${item.type==='Task'?'selected':''}>Task</option>
        <option ${item.type==='To-Do'?'selected':''}>To-Do</option></select>
      <input id="e-date" type="date" class="swal2-input" value="${item.date}">
      <input id="e-time" type="time" class="swal2-input" value="${item.time}">
      <select id="e-cust" class="swal2-input"><option value=""> â€” </option>
        ${db.customers.map(c=>`<option value="${c.id}" ${c.id===item.custId?'selected':''}>${c.name}</option>`).join('')}</select>
      <textarea id="e-notes" class="swal2-textarea" placeholder="Notes">${item.notes}</textarea>`,
    preConfirm:()=>{
      item.title=$('#e-title').value; item.type=$('#e-type').value; item.date=$('#e-date').value;
      item.time=$('#e-time').value;   item.custId=$('#e-cust').value; item.notes=$('#e-notes').value;
      item.csr=currentCSR;
    }
  }).then(r=>{
    if(r.isConfirmed){
      if(ev){ Object.assign(ev,item);} else{ db.appointments.push(item);}
      save(); renderCalendar(); toast('Event saved','success');
    }
  });
}

/* ------------------------------------------------------------------
   PIPELINE placeholder
------------------------------------------------------------------ */
function renderPipeline(){
  $('#pipeline').innerHTML='<p class="text-gray-500">Kanban pipeline (drag-and-drop) coming later.</p>';
}

/* ------------------------------------------------------------------
   BOOT
------------------------------------------------------------------ */
updateHeader();
show('dashboard');
/*  Extras (optional)  =========================================
   1.  Dark-mode toggle
   2.  Drag-and-drop Kanban pipeline with SortableJS
----------------------------------------------------------------*/
export function darkModeToggle(){
  const btn=document.createElement('button');
  btn.className='fixed bottom-4 right-4 bg-gray-200 text-sm px-3 py-1 rounded';
  btn.textContent='ðŸŒ“';
  document.body.appendChild(btn);
  btn.onclick=()=>{
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('ASCRM_dark', document.documentElement.classList.contains('dark'));
  };
  if(localStorage.getItem('ASCRM_dark')==='true') document.documentElement.classList.add('dark');
}

/* Kanban pipeline (phase-2) â€“ call initKanban() after you add
   <section id="pipelineBoard"></section> in pipeline view      */
import Sortable from 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm';

export function initKanban(stages,deals,onMove){
  const board=document.getElementById('pipelineBoard');
  board.innerHTML=stages.map(s=>`<div class="stage" data-stage="${s}">
     <h3 class="font-bold mb-2">${s}</h3><div class="col space-y-2 p-2 bg-gray-50 rounded h-full"></div></div>`).join('');
  stages.forEach(s=>{
    const col=board.querySelector(`.stage[data-stage="${s}"] .col`);
    deals.filter(d=>d.stage===s).forEach(d=>{
      col.insertAdjacentHTML('beforeend',`<div class="card bg-white p-2 rounded shadow" data-id="${d.id}">
          <p class="font-medium">${d.name}</p><p class="text-xs">${d.value}</p></div>`);
    });
    Sortable.create(col,{group:'kanban',animation:150,onEnd:e=>{
      const id=e.item.dataset.id; const stage=e.to.parentElement.dataset.stage;
      onMove(id,stage);
    }});
  });
}
