<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AcoustiSkin CRM - AI-Powered Enterprise Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      min-height: 100vh;
    }
    .sidebar { 
      width: 260px; 
      background: linear-gradient(180deg, #4a7c59 0%, #2e5940 100%);
      box-shadow: 4px 0 20px rgba(0,0,0,0.15);
    }
    .main-content { margin-left: 260px; min-height: 100vh; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(67, 160, 71, 0.4);
    }
    .btn-secondary {
      background: white;
      color: #43a047;
      border: 2px solid #43a047;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }
    .btn-secondary:hover {
      background: #43a047;
      color: white;
    }
    .btn-danger {
      background: white;
      color: #e53935;
      border: 2px solid #e53935;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }
    .btn-danger:hover {
      background: #e53935;
      color: white;
    }
    .nav-item {
      padding: 12px 20px;
      color: white;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px 10px;
      transition: all 0.3s;
    }
    .nav-item:hover, .nav-item.active {
      background: rgba(255,255,255,0.2);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      overflow-y: auto;
    }
    .modal-content {
      background: white;
      margin: 30px auto;
      padding: 30px;
      border-radius: 16px;
      max-width: 1100px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #2e5940;
      font-weight: 600;
      font-size: 14px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #c8e6c9;
      border-radius: 6px;
      font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #66bb6a;
    }
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-item input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .calendar-day {
      background: white;
      border: 2px solid #e8f5e9;
      border-radius: 8px;
      padding: 10px;
      min-height: 120px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .calendar-day:hover {
      background: #f1f8e9;
      border-color: #66bb6a;
      transform: translateY(-2px);
    }
    .calendar-day.today {
      border-color: #43a047;
      background: #e8f5e9;
      box-shadow: 0 0 10px rgba(67, 160, 71, 0.3);
    }
    .event-item {
      background: #66bb6a;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-top: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .event-item:hover {
      background: #43a047;
      transform: scale(1.05);
    }
    .holiday-item {
      background: #ff6b6b;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-top: 4px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-active { background: #c8e6c9; color: #2e7d32; }
    .status-prospect { background: #bbdefb; color: #1565c0; }
    .status-inactive { background: #ffcdd2; color: #c62828; }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-left: 4px solid #66bb6a;
      display: none;
      z-index: 2000;
      animation: slideIn 0.3s;
      max-width: 400px;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    .table th {
      background: #e8f5e9;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #2e5940;
    }
    .table td {
      padding: 12px;
      border-bottom: 1px solid #e8f5e9;
    }
    .table tr:hover {
      background: #f1f8e9;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }
    .section-header {
      color: #2e5940;
      margin: 25px 0 15px 0;
      border-bottom: 2px solid #e8f5e9;
      padding-bottom: 10px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .ai-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .score-badge {
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: 600;
      display: inline-block;
    }
    .score-high { background: #c8e6c9; color: #2e7d32; }
    .score-medium { background: #fff9c4; color: #f57f17; }
    .score-low { background: #ffcdd2; color: #c62828; }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      font-size: 13px;
    }
    .backup-indicator {
      background: rgba(255,255,255,0.1);
      padding: 10px 15px;
      border-radius: 8px;
      margin: 15px 10px;
      color: white;
      font-size: 12px;
    }
    .drag-drop-zone {
      border: 3px dashed #c8e6c9;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: #f1f8e9;
      transition: all 0.3s;
      cursor: pointer;
    }
    .drag-drop-zone.drag-over {
      border-color: #43a047;
      background: #e8f5e9;
      transform: scale(1.02);
    }
    .drag-drop-zone:hover {
      border-color: #66bb6a;
      background: #e8f5e9;
    }
  </style>
</head>
<body>
  <!-- Notification -->
  <div id="notification" class="notification">
    <i class="fas fa-check-circle" style="color: #66bb6a; margin-right: 8px;"></i>
    <span id="notificationText"></span>
  </div>

  <!-- Backup Reminder Modal -->
  <div id="backupReminderModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div style="text-align: center;">
        <div style="font-size: 64px; color: #ffa726; margin-bottom: 20px;">
          <i class="fas fa-shield-alt"></i>
        </div>
        <h3 style="color: #2e5940; font-size: 24px; margin-bottom: 15px;">Time to Back Up Your Data!</h3>
        <p style="color: #666; margin-bottom: 25px;">
          It's been a while since your last backup. Protect your valuable customer data by backing up now.
        </p>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button class="btn-secondary" onclick="snoozeBackupReminder()">
            <i class="fas fa-clock"></i> Remind Me Later
          </button>
          <button class="btn-primary" onclick="quickBackup()">
            <i class="fas fa-download"></i> Backup Now
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Conflict Resolution Modal -->
  <div id="conflictModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <h3 style="color: #2e5940; margin-bottom: 20px;">
        <i class="fas fa-exclamation-triangle" style="color: #ffa726;"></i> Data Import Options
      </h3>
      
      <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107;">
        <strong>You're importing data that may conflict with existing data.</strong><br>
        Choose how you want to handle this:
      </div>
      
      <div id="conflictInfo" style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;"></div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
        <button class="btn-secondary" onclick="resolveConflict('replace')" style="padding: 20px;">
          <i class="fas fa-exchange-alt" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
          <strong>Replace All</strong><br>
          <small style="opacity: 0.7;">Delete existing data and use imported data</small>
        </button>
        <button class="btn-primary" onclick="resolveConflict('merge')" style="padding: 20px;">
          <i class="fas fa-layer-group" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
          <strong>Merge Data</strong><br>
          <small style="opacity: 0.9;">Keep both, add imported data to existing</small>
        </button>
      </div>
      
      <div style="text-align: center; margin-top: 15px;">
        <button class="btn-secondary" onclick="closeModal('conflictModal')">
          <i class="fas fa-times"></i> Cancel Import
        </button>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar" style="position: fixed; height: 100vh; overflow-y: auto;">
    <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.2);">
      <h1 style="color: white; font-size: 20px; font-weight: 700;">
        <i class="fas fa-leaf"></i> AcoustiSkin CRM
      </h1>
      <div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 5px;">
        <span class="ai-badge"><i class="fas fa-brain"></i> AI-Powered</span>
      </div>
    </div>
    
    <nav style="padding: 20px 0;">
      <div class="nav-item active" onclick="showView('dashboard')">
        <i class="fas fa-home" style="margin-right: 10px;"></i>Dashboard
      </div>
      <div class="nav-item" onclick="showView('customers')">
        <i class="fas fa-users" style="margin-right: 10px;"></i>Customers
      </div>
      <div class="nav-item" onclick="showView('orders')">
        <i class="fas fa-shopping-cart" style="margin-right: 10px;"></i>Orders
      </div>
      <div class="nav-item" onclick="showView('calendar')">
        <i class="fas fa-calendar" style="margin-right: 10px;"></i>Calendar
      </div>
      <div class="nav-item" onclick="showView('pipeline')">
        <i class="fas fa-chart-line" style="margin-right: 10px;"></i>Pipeline
      </div>
      <div class="nav-item" onclick="showView('analytics')">
        <i class="fas fa-chart-bar" style="margin-right: 10px;"></i>Analytics
      </div>
      <div class="nav-item" onclick="showView('marketing')">
        <i class="fas fa-bullhorn" style="margin-right: 10px;"></i>Marketing
      </div>
      <div class="nav-item" onclick="showView('referrals')">
        <i class="fas fa-gift" style="margin-right: 10px;"></i>Referral Program
      </div>
      <div class="nav-item" onclick="showView('settings')">
        <i class="fas fa-cog" style="margin-right: 10px;"></i>Settings
      </div>
    </nav>

    <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
      <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="openCustomerModal()">
        <i class="fas fa-plus"></i> New Customer
      </button>
      <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="openEventModal()">
        <i class="fas fa-calendar-plus"></i> Schedule Event
      </button>
      <button class="btn-primary" style="width: 100%;" onclick="openOrderModal()">
        <i class="fas fa-cart-plus"></i> New Order
      </button>
      
      <div class="backup-indicator" id="backupIndicator">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
          <span style="font-weight: 600;"><i class="fas fa-shield-alt"></i> Last Backup</span>
        </div>
        <div id="lastBackupTime" style="font-size: 11px; opacity: 0.8;">Never</div>
      </div>
      
      <div style="margin-top: 15px;">
        <button class="btn-primary" style="width: 100%; margin-bottom: 10px; background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);" onclick="emailBackup()">
          <i class="fas fa-envelope"></i> Email Backup
        </button>
        <button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="exportData()">
          <i class="fas fa-download"></i> Download Backup
        </button>
        <button class="btn-secondary" style="width: 100%;" onclick="showImportOptions()">
          <i class="fas fa-upload"></i> Import Data
        </button>
        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content" style="padding: 30px;">
    <!-- Dashboard View -->
    <div id="dashboard-view" class="view-content">
      <h2 style="font-size: 28px; color: #2e5940; margin-bottom: 20px;">
        AI-Powered Dashboard <span class="ai-badge"><i class="fas fa-sparkles"></i> Smart Insights</span>
      </h2>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="card" style="background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); color: white;">
          <div style="font-size: 14px; opacity: 0.9;">Total Customers</div>
          <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="totalCustomers">0</div>
          <div style="font-size: 12px; opacity: 0.8;"><i class="fas fa-arrow-up"></i> Active accounts</div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: white;">
          <div style="font-size: 14px; opacity: 0.9;">Total Orders</div>
          <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="totalOrders">0</div>
          <div style="font-size: 12px; opacity: 0.8;"><i class="fas fa-shopping-bag"></i> Completed</div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); color: white;">
          <div style="font-size: 14px; opacity: 0.9;">Revenue</div>
          <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="totalRevenue">$0</div>
          <div style="font-size: 12px; opacity: 0.8;"><i class="fas fa-dollar-sign"></i> This month</div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%); color: white;">
          <div style="font-size: 14px; opacity: 0.9;">Referral Rate</div>
          <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="referralRate">0%</div>
          <div style="font-size: 12px; opacity: 0.8;"><i class="fas fa-users"></i> Willing to refer</div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
        <div class="card">
          <h3 style="color: #2e5940; margin-bottom: 15px; font-size: 18px;">
            <i class="fas fa-bolt"></i> AI Insights & Recommendations
          </h3>
          <div id="aiInsights"></div>
        </div>
        
        <div class="card">
          <h3 style="color: #2e5940; margin-bottom: 15px; font-size: 18px;">Today's Tasks</h3>
          <div id="todayTasks"></div>
        </div>
      </div>
    </div>

    <!-- Customers View -->
    <div id="customers-view" class="view-content" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 28px; color: #2e5940;">Customers</h2>
        <button class="btn-primary" onclick="openCustomerModal()">
          <i class="fas fa-plus"></i> Add Customer
        </button>
      </div>
      
      <div class="card">
        <div style="margin-bottom: 15px;">
          <input type="text" id="searchCustomers" placeholder="Search customers..." 
                 style="width: 100%; padding: 10px; border: 2px solid #c8e6c9; border-radius: 6px;"
                 oninput="filterCustomers()">
        </div>
        <div style="overflow-x: auto;">
          <table class="table" id="customersTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Lead Source</th>
                <th>Status</th>
                <th>AI Score</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Orders View -->
    <div id="orders-view" class="view-content" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 28px; color: #2e5940;">Orders</h2>
        <button class="btn-primary" onclick="openOrderModal()">
          <i class="fas fa-plus"></i> New Order
        </button>
      </div>
      
      <div class="card">
        <div style="overflow-x: auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Calendar View -->
    <div id="calendar-view" class="view-content" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 28px; color: #2e5940;" id="calendarTitle">Calendar</h2>
        <div>
          <button class="btn-secondary" onclick="changeMonth(-1)">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="btn-secondary" onclick="changeMonth(0)" style="margin: 0 10px;">Today</button>
          <button class="btn-secondary" onclick="changeMonth(1)">
            <i class="fas fa-chevron-right"></i>
          </button>
          <button class="btn-primary" onclick="openEventModal()" style="margin-left: 10px;">
            <i class="fas fa-plus"></i> Add Event
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="calendar-grid" style="margin-bottom: 10px;">
          <div style="text-align: center; font-weight: 600; color: #2e5940; padding: 10px;">Sun</div>
          <div style="text-align: center; font-weight: 600; color: #2e5940; padding: 10px;">Mon</div>
          <div style="text-align: center; font-weight: 600; color: #2e5940; padding: 10px;">Tue</div>
          <div style="text-align: center; font-weight: 600; color: #2e5940; padding: 10px;">Wed</div>
          <div style="text-align: center; font-weight: 600; color: #2e5940; padding: 10px;">Thu</div>
          <div style="text-align: center; font-weight: 600; color: #2e5940; padding: 10px;">Fri</div>
          <div style="text-align: center; font-weight: 600; color: #2e5940; padding: 10px;">Sat</div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>
    </div>

    <!-- Marketing View -->
    <div id="marketing-view" class="view-content" style="display: none;">
      <h2 style="font-size: 28px; color: #2e5940; margin-bottom: 20px;">Marketing Intelligence</h2>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <div class="card">
          <h3 style="color: #2e5940; margin-bottom: 15px;">Lead Sources</h3>
          <canvas id="leadSourceChart"></canvas>
        </div>
        
        <div class="card">
          <h3 style="color: #2e5940; margin-bottom: 15px;">Social Media Presence</h3>
          <canvas id="socialMediaChart"></canvas>
        </div>
        
        <div class="card">
          <h3 style="color: #2e5940; margin-bottom: 15px;">Referral Insights</h3>
          <div id="referralInsights"></div>
        </div>
        
        <div class="card">
          <h3 style="color: #2e5940; margin-bottom: 15px;">Discount Interest</h3>
          <div id="discountInsights"></div>
        </div>
      </div>
    </div>

    <!-- Referral Program View -->
    <div id="referrals-view" class="view-content" style="display: none;">
      <h2 style="font-size: 28px; color: #2e5940; margin-bottom: 20px;">
        <i class="fas fa-gift"></i> Referral Program Dashboard
      </h2>
      
      <div class="info-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
        <strong><i class="fas fa-rocket"></i> Growth Hack Alert!</strong> Referral programs can increase customer acquisition by 300%! Track every referral and reward your advocates with $<span id="referralCreditDisplay">15</span> per successful referral.
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <div style="font-size: 14px; opacity: 0.9;">Total Referrals</div>
          <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="totalReferrals">0</div>
          <div style="font-size: 12px; opacity: 0.8;"><i class="fas fa-users"></i> New customers</div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
          <div style="font-size: 14px; opacity: 0.9;">Credits Issued</div>
          <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="totalCredits">$0</div>
          <div style="font-size: 12px; opacity: 0.8;"><i class="fas fa-dollar-sign"></i> In rewards</div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); color: white;">
          <div style="font-size: 14px; opacity: 0.9;">Active Advocates</div>
          <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="activeAdvocates">0</div>
          <div style="font-size: 12px; opacity: 0.8;"><i class="fas fa-star"></i> Top referrers</div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%); color: white;">
          <div style="font-size: 14px; opacity: 0.9;">Conversion Rate</div>
          <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="conversionRate">0%</div>
          <div style="font-size: 12px; opacity: 0.8;"><i class="fas fa-chart-line"></i> Referred â†’ Customer</div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="card">
          <h3 style="color: #2e5940; margin-bottom: 15px;">
            <i class="fas fa-trophy"></i> Top Referrers Leaderboard
          </h3>
          <div id="topReferrersList"></div>
        </div>
        
        <div class="card">
          <h3 style="color: #2e5940; margin-bottom: 15px;">
            <i class="fas fa-crown"></i> Reward Tiers
          </h3>
          <div id="referralRewardTiersDisplay" style="padding: 15px;">
            <!-- Tiers will be loaded dynamically -->
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3 style="color: #2e5940; margin-bottom: 15px;">
          <i class="fas fa-history"></i> Recent Referrals
        </h3>
        <div style="overflow-x: auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Referrer</th>
                <th>New Customer</th>
                <th>Date</th>
                <th>Status</th>
                <th>Credit Earned</th>
              </tr>
            </thead>
            <tbody id="recentReferralsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Pipeline View -->
    <div id="pipeline-view" class="view-content" style="display: none;">
      <h2 style="font-size: 28px; color: #2e5940; margin-bottom: 20px;">Sales Pipeline</h2>
      <div id="pipelineContent"></div>
    </div>

    <!-- Analytics View -->
    <div id="analytics-view" class="view-content" style="display: none;">
      <h2 style="font-size: 28px; color: #2e5940; margin-bottom: 20px;">Analytics</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
        <div class="card">
          <h3 style="color: #2e5940; margin-bottom: 15px;">Revenue Over Time</h3>
          <canvas id="revenueChart"></canvas>
        </div>
        
        <div class="card">
          <h3 style="color: #2e5940; margin-bottom: 15px;">Customer Status</h3>
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Settings View -->
    <div id="settings-view" class="view-content" style="display: none;">
      <h2 style="font-size: 28px; color: #2e5940; margin-bottom: 20px;">
        <i class="fas fa-cog"></i> CRM Settings
      </h2>
      
      <div class="card">
        <h3 style="color: #2e5940; margin-bottom: 20px; font-size: 20px;">
          <i class="fas fa-gift"></i> Referral Program Configuration
        </h3>
        
        <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107;">
          <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> <strong>Important:</strong> Changes here will affect how referral credits and tiers are calculated for all customers.
        </div>
        
        <form id="settingsForm" onsubmit="saveSettings(event)">
          <div class="section-header">
            <i class="fas fa-dollar-sign"></i> Credit Amount
          </div>
          
          <div class="form-group" style="max-width: 300px;">
            <label>Credit Per Successful Referral</label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 20px; font-weight: 600;">$</span>
              <input type="number" id="settingsCreditAmount" min="0" step="1" required 
                     style="width: 100px;" placeholder="15">
              <span style="color: #666; font-size: 14px;">per referral</span>
            </div>
            <small style="color: #666; display: block; margin-top: 5px;">Both referrer and new customer get this amount</small>
          </div>
          
          <div class="section-header">
            <i class="fas fa-medal"></i> Tier Thresholds
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #cd7f32;">
              <div style="font-weight: 600; color: #cd7f32; margin-bottom: 10px;">
                <i class="fas fa-medal"></i> BRONZE TIER
              </div>
              <div class="grid-2" style="gap: 10px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px;">Min Referrals</label>
                  <input type="number" id="bronzeMin" min="1" required style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px;">Max Referrals</label>
                  <input type="number" id="bronzeMax" min="1" required style="padding: 8px;">
                </div>
              </div>
              <div class="form-group" style="margin-top: 10px; 


margin-bottom: 0;">
                  <label style="font-size: 12px;">Bonus Credit</label>
                  <input type="number" id="bronzeBonus" min="0" step="1" required style="padding: 8px;" placeholder="5">
                </div>
              </div>
            </div>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #c0c0c0;">
              <div style="font-weight: 600; color: #808080; margin-bottom: 10px;">
                <i class="fas fa-medal"></i> SILVER TIER
              </div>
              <div class="grid-2" style="gap: 10px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px;">Min Referrals</label>
                  <input type="number" id="silverMin" min="1" required style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px;">Max Referrals</label>
                  <input type="number" id="silverMax" min="1" required style="padding: 8px;">
                </div>
              </div>
              <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                <label style="font-size: 12px;">Bonus Credit</label>
                <input type="number" id="silverBonus" min="0" step="1" required style="padding: 8px;" placeholder="10">
              </div>
            </div>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #ffd700;">
              <div style="font-weight: 600; color: #daa520; margin-bottom: 10px;">
                <i class="fas fa-medal"></i> GOLD TIER
              </div>
              <div class="grid-2" style="gap: 10px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px;">Min Referrals</label>
                  <input type="number" id="goldMin" min="1" required style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px;">Max Referrals</label>
                  <input type="number" id="goldMax" min="1" required style="padding: 8px;">
                </div>
              </div>
              <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                <label style="font-size: 12px;">Bonus Credit</label>
                <input type="number" id="goldBonus" min="0" step="1" required style="padding: 8px;" placeholder="20">
              </div>
            </div>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #b9f2ff;">
              <div style="font-weight: 600; color: #4dd0e1; margin-bottom: 10px;">
                <i class="fas fa-gem"></i> PLATINUM TIER
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 12px;">Min Referrals</label>
                <input type="number" id="platinumMin" min="1" required style="padding: 8px;">
              </div>
              <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                <label style="font-size: 12px;">Bonus Credit</label>
                <input type="number" id="platinumBonus" min="0" step="1" required style="padding: 8px;" placeholder="50">
              </div>
            </div>
          </div>
          
          <div class="section-header">
            <i class="fas fa-clock"></i> Backup Reminder Settings
          </div>
          
          <div class="form-group" style="max-width: 400px;">
            <label>Backup Reminder Interval (days)</label>
            <input type="number" id="backupReminderDays" min="1" max="365" required placeholder="7">
            <small style="color: #666; display: block; margin-top: 5px;">Get reminded to backup your data every X days</small>
          </div>
          
          <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e8f5e9;">
            <button type="submit" class="btn-primary" style="padding: 12px 30px;">
              <i class="fas fa-save"></i> Save All Settings
            </button>
            <button type="button" class="btn-secondary" onclick="resetSettings()" style="margin-left: 10px; padding: 12px 30px;">
              <i class="fas fa-undo"></i> Reset to Defaults
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Customer Modal -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <h3 style="color: #2e5940; margin-bottom: 20px; font-size: 24px;">
        <span id="customerModalTitle">Add New Customer</span>
        <span class="ai-badge"><i class="fas fa-brain"></i> AI Enhanced</span>
      </h3>
      
      <form id="customerForm" onsubmit="saveCustomer(event)">
        <input type="hidden" id="customerId">
        
        <div class="section-header">
          <i class="fas fa-user"></i> Basic Information
        </div>
        
        <div class="grid-2">
          <div class="form-group">
            <label>First Name *</label>
            <input type="text" id="customerFirstName" required>
          </div>
          
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" id="customerLastName" required>
          </div>
        </div>
        
        <div class="grid-2">
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="customerEmail" required>
          </div>
          
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="customerPhone">
          </div>
        </div>
        
        <div class="section-header">
          <i class="fas fa-map-marker-alt"></i> Address Information
        </div>
        
        <div class="form-group">
          <label>Street Address</label>
          <input type="text" id="customerAddress">
        </div>
        
        <div class="grid-3">
          <div class="form-group">
            <label>City</label>
            <input type="text" id="customerCity">
          </div>
          
          <div class="form-group">
            <label>State</label>
            <input type="text" id="customerState">
          </div>
          
          <div class="form-group">
            <label>ZIP Code</label>
            <input type="text" id="customerZip">
          </div>
        </div>
        
        <div class="section-header">
          <i class="fas fa-chart-line"></i> Marketing & Lead Information
        </div>
        
        <div class="grid-2">
          <div class="form-group">
            <label>Lead Source *</label>
            <select id="customerLeadSource" required>
              <option value="">Select Source</option>
              <option value="Google">Google Search</option>
              <option value="Facebook">Facebook</option>
              <option value="Instagram">Instagram</option>
              <option value="Referral">Referral</option>
              <option value="Direct">Direct Contact</option>
              <option value="Website">Website</option>
              <option value="Trade Show">Trade Show</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Status</label>
            <select id="customerStatus">
              <option value="Prospect">Prospect</option>
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>Social Media Accounts (select all that apply)</label>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="socialFacebook" value="Facebook">
              <label for="socialFacebook" style="margin: 0; font-weight: normal;">Facebook</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="socialInstagram" value="Instagram">
              <label for="socialInstagram" style="margin: 0; font-weight: normal;">Instagram</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="socialTwitter" value="Twitter">
              <label for="socialTwitter" style="margin: 0; font-weight: normal;">Twitter</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="socialLinkedIn" value="LinkedIn">
              <label for="socialLinkedIn" style="margin: 0; font-weight: normal;">LinkedIn</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="socialYouTube" value="YouTube">
              <label for="socialYouTube" style="margin: 0; font-weight: normal;">YouTube</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="socialTikTok" value="TikTok">
              <label for="socialTikTok" style="margin: 0; font-weight: normal;">TikTok</label>
            </div>
          </div>
        </div>
        
        <div class="section-header">
          <i class="fas fa-bullhorn"></i> Marketing Preferences
        </div>
        
        <div class="grid-2">
          <div class="form-group">
            <label>Interested in Discounts?</label>
            <select id="customerDiscountInterest">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
              <option value="Maybe">Maybe</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Willing to Refer Others?</label>
            <select id="customerReferralWillingness">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
              <option value="Maybe">Maybe</option>
            </select>
          </div>
        </div>
        
        <div class="section-header">
          <i class="fas fa-gift"></i> Referral Information
        </div>
        
        <div class="form-group">
          <label>Referred By (Customer Name)</label>
          <input type="text" id="customerReferredBy" placeholder="Leave blank if not a referral">
          <small style="color: #666; display: block; margin-top: 5px;">Enter the name of the customer who referred this person</small>
        </div>
        
        <div class="form-group">
          <label>Notes</label>
          <textarea id="customerNotes" rows="3" placeholder="Additional notes about this customer..."></textarea>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Customer
          </button>
          <button type="button" class="btn-secondary" onclick="closeModal('customerModal')">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Event Modal -->
  <div id="eventModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <h3 style="color: #2e5940; margin-bottom: 20px;">Schedule Event</h3>
      
      <form id="eventForm" onsubmit="saveEvent(event)">
        <input type="hidden" id="eventId">
        
        <div class="form-group">
          <label>Event Title *</label>
          <input type="text" id="eventTitle" required>
        </div>
        
        <div class="form-group">
          <label>Customer</label>
          <select id="eventCustomer">
            <option value="">Select Customer (Optional)</option>
          </select>
        </div>
        
        <div class="grid-2">
          <div class="form-group">
            <label>Date *</label>
            <input type="date" id="eventDate" required>
          </div>
          
          <div class="form-group">
            <label>Time</label>
            <input type="time" id="eventTime">
          </div>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <select id="eventType">
            <option value="Consultation">Consultation</option>
            <option value="Installation">Installation</option>
            <option value="Follow-up">Follow-up</option>
            <option value="Meeting">Meeting</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Notes</label>
          <textarea id="eventNotes" rows="3"></textarea>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Event
          </button>
          <button type="button" class="btn-secondary" onclick="closeModal('eventModal')">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Order Modal -->
  <div id="orderModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <h3 style="color: #2e5940; margin-bottom: 20px;">Create Order</h3>
      
      <form id="orderForm" onsubmit="saveOrder(event)">
        <input type="hidden" id="orderId">
        
        <div class="form-group">
          <label>Customer *</label>
          <select id="orderCustomer" required>
            <option value="">Select Customer</option>
          </select>
        </div>
        
        <div class="grid-2">
          <div class="form-group">
            <label>Order Date *</label>
            <input type="date" id="orderDate" required>
          </div>
          
          <div class="form-group">
            <label>Order Total *</label>
            <input type="number" id="orderTotal" step="0.01" min="0" required placeholder="0.00">
          </div>
        </div>
        
        <div class="form-group">
          <label>Products/Services</label>
          <textarea id="orderProducts" rows="3" placeholder="List products or services included in this order..."></textarea>
        </div>
        
        <div class="form-group">
          <label>Status</label>
          <select id="orderStatus">
            <option value="Pending">Pending</option>
            <option value="Processing">Processing</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Notes</label>
          <textarea id="orderNotes" rows="3"></textarea>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Order
          </button>
          <button type="button" class="btn-secondary" onclick="closeModal('orderModal')">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Options Modal -->
  <div id="importOptionsModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <h3 style="color: #2e5940; margin-bottom: 20px;">
        <i class="fas fa-upload"></i> Import Data
      </h3>
      
      <div class="info-box">
        Import your customer data from a backup file. You can choose to replace all existing data or merge with current data.
      </div>
      
      <div class="drag-drop-zone" id="dragDropZone" onclick="document.getElementById('importFile').click()">
        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #66bb6a; margin-bottom: 15px;"></i>
        <div style="font-size: 18px; color: #2e5940; font-weight: 600; margin-bottom: 10px;">
          Drop your backup file here
        </div>
        <div style="color: #666; font-size: 14px;">
          or click to browse for a file
        </div>
        <div style="color: #999; font-size: 12px; margin-top: 10px;">
          Accepts .json files only
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 15px;">
        <button class="btn-secondary" onclick="closeModal('importOptionsModal')">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </div>
  </div>

  <script>
    // Data Storage
    let customers = [];
    let orders = [];
    let events = [];
    let currentView = 'dashboard';
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let lastBackupDate = null;
    let backupReminderInterval = 7; // days
    let currentImportData = null;
    
    // Settings
    let settings = {
      creditAmount: 15,
      tiers: {
        bronze: { min: 1, max: 4, bonus: 5 },
        silver: { min: 5, max: 9, bonus: 10 },
        gold: { min: 10, max: 19, bonus: 20 },
        platinum: { min: 20, bonus: 50 }
      },
      backupReminderDays: 7
    };

    // US Holidays 2024-2026
    const holidays = {
      2024: [
        { date: '2024-01-01', name: 'New Year\'s Day' },
        { date: '2024-01-15', name: 'MLK Day' },
        { date: '2024-02-19', name: 'Presidents Day' },
        { date: '2024-05-27', name: 'Memorial Day' },
        { date: '2024-07-04', name: 'Independence Day' },
        { date: '2024-09-02', name: 'Labor Day' },
        { date: '2024-10-14', name: 'Columbus Day' },
        { date: '2024-11-11', name: 'Veterans Day' },
        { date: '2024-11-28', name: 'Thanksgiving' },
        { date: '2024-12-25', name: 'Christmas' }
      ],
      2025: [
        { date: '2025-01-01', name: 'New Year\'s Day' },
        { date: '2025-01-20', name: 'MLK Day' },
        { date: '2025-02-17', name: 'Presidents Day' },
        { date: '2025-05-26', name: 'Memorial Day' },
        { date: '2025-07-04', name: 'Independence Day' },
        { date: '2025-09-01', name: 'Labor Day' },
        { date: '2025-10-13', name: 'Columbus Day' },
        { date: '2025-11-11', name: 'Veterans Day' },
        { date: '2025-11-27', name: 'Thanksgiving' },
        { date: '2025-12-25', name: 'Christmas' }
      ],
      2026: [
        { date: '2026-01-01', name: 'New Year\'s Day' },
        { date: '2026-01-19', name: 'MLK Day' },
        { date: '2026-02-16', name: 'Presidents Day' },
        { date: '2026-05-25', name: 'Memorial Day' },
        { date: '2026-07-03', name: 'Independence Day' },
        { date: '2026-09-07', name: 'Labor Day' },
        { date: '2026-10-12', name: 'Columbus Day' },
        { date: '2026-11-11', name: 'Veterans Day' },
        { date: '2026-11-26', name: 'Thanksgiving' },
        { date: '2026-12-25', name: 'Christmas' }
      ]
    };

    // Initialize
    function init() {
      loadData();
      loadSettings();
      updateDashboard();
      renderCustomersTable();
      renderOrdersTable();
      renderCalendar();
      updateMarketingView();
      updateReferralsView();
      checkBackupReminder();
      setupDragDrop();
      
      // Set today's date as default for forms
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('eventDate').value = today;
      document.getElementById('orderDate').value = today;
    }

    // Load/Save Data
    function loadData() {
      const savedCustomers = localStorage.getItem('acoustiskin_customers');
      const savedOrders = localStorage.getItem('acoustiskin_orders');
      const savedEvents = localStorage.getItem('acoustiskin_events');
      const savedBackupDate = localStorage.getItem('acoustiskin_last_backup');
      
      if (savedCustomers) customers = JSON.parse(savedCustomers);
      if (savedOrders) orders = JSON.parse(savedOrders);
      if (savedEvents) events = JSON.parse(savedEvents);
      if (savedBackupDate) lastBackupDate = new Date(savedBackupDate);
    }

    function saveData() {
      localStorage.setItem('acoustiskin_customers', JSON.stringify(customers));
      localStorage.setItem('acoustiskin_orders', JSON.stringify(orders));
      localStorage.setItem('acoustiskin_events', JSON.stringify(events));
    }

    function loadSettings() {
      const savedSettings = localStorage.getItem('acoustiskin_settings');
      if (savedSettings) {
        settings = JSON.parse(savedSettings);
      }
      document.getElementById('referralCreditDisplay').textContent = settings.creditAmount;
      backupReminderInterval = settings.backupReminderDays;
    }

    function saveSettings(event) {
      event.preventDefault();
      
      settings.creditAmount = parseInt(document.getElementById('settingsCreditAmount').value);
      settings.tiers = {
        bronze: {
          min: parseInt(document.getElementById('bronzeMin').value),
          max: parseInt(document.getElementById('bronzeMax').value),
          bonus: parseInt(document.getElementById('bronzeBonus').value)
        },
        silver: {
          min: parseInt(document.getElementById('silverMin').value),
          max: parseInt(document.getElementById('silverMax').value),
          bonus: parseInt(document.getElementById('silverBonus').value)
        },
        gold: {
          min: parseInt(document.getElementById('goldMin').value),
          max: parseInt(document.getElementById('goldMax').value),
          bonus: parseInt(document.getElementById('goldBonus').value)
        },
        platinum: {
          min: parseInt(document.getElementById('platinumMin').value),
          bonus: parseInt(document.getElementById('platinumBonus').value)
        }
      };
      settings.backupReminderDays = parseInt(document.getElementById('backupReminderDays').value);
      
      localStorage.setItem('acoustiskin_settings', JSON.stringify(settings));
      backupReminderInterval = settings.backupReminderDays;
      
      showNotification('Settings saved successfully!');
      updateReferralsView();
      document.getElementById('referralCreditDisplay').textContent = settings.creditAmount;
    }

    function resetSettings() {
      settings = {
        creditAmount: 15,
        tiers: {
          bronze: { min: 1, max: 4, bonus: 5 },
          silver: { min: 5, max: 9, bonus: 10 },
          gold: { min: 10, max: 19, bonus: 20 },
          platinum: { min: 20, bonus: 50 }
        },
        backupReminderDays: 7
      };
      
      localStorage.setItem('acoustiskin_settings', JSON.stringify(settings));
      populateSettingsForm();
      showNotification('Settings reset to defaults');
      document.getElementById('referralCreditDisplay').textContent = settings.creditAmount;
    }

    function populateSettingsForm() {
      document.getElementById('settingsCreditAmount').value = settings.creditAmount;
      document.getElementById('bronzeMin').value = settings.tiers.bronze.min;
      document.getElementById('bronzeMax').value = settings.tiers.bronze.max;
      document.getElementById('bronzeBonus').value = settings.tiers.bronze.bonus;
      document.getElementById('silverMin').value = settings.tiers.silver.min;
      document.getElementById('silverMax').value = settings.tiers.silver.max;
      document.getElementById('silverBonus').value = settings.tiers.silver.bonus;
      document.getElementById('goldMin').value = settings.tiers.gold.min;
      document.getElementById('goldMax').value = settings.tiers.gold.max;
      document.getElementById('goldBonus').value = settings.tiers.gold.bonus;
      document.getElementById('platinumMin').value = settings.tiers.platinum.min;
      document.getElementById('platinumBonus').value = settings.tiers.platinum.bonus;
      document.getElementById('backupReminderDays').value = settings.backupReminderDays;
    }

    // Navigation
    function showView(viewName) {
      document.querySelectorAll('.view-content').forEach(v => v.style.display = 'none');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      document.getElementById(viewName + '-view').style.display = 'block';
      event.target.closest('.nav-item').classList.add('active');
      currentView = viewName;
      
      if (viewName === 'calendar') renderCalendar();
      if (viewName === 'pipeline') updatePipelineView();
      if (viewName === 'analytics') updateAnalyticsView();
      if (viewName === 'marketing') updateMarketingView();
      if (viewName === 'referrals') updateReferralsView();
      if (viewName === 'settings') populateSettingsForm();
    }

    // Dashboard
    function updateDashboard() {
      document.getElementById('totalCustomers').textContent = customers.length;
      document.getElementById('totalOrders').textContent = orders.length;
      
      const revenue = orders.reduce((sum, order) => sum + parseFloat(order.total || 0), 0);
      document.getElementById('totalRevenue').textContent = '$' + revenue.toFixed(0);
      
      const willingToRefer = customers.filter(c => c.referralWillingness === 'Yes').length;
      const referralRate = customers.length > 0 ? (willingToRefer / customers.length * 100).toFixed(0) : 0;
      document.getElementById('referralRate').textContent = referralRate + '%';
      
      generateAIInsights();
      updateTodayTasks();
    }

    function generateAIInsights() {
      const insights = [];
      
      // High-value customers
      const highValueCustomers = customers.filter(c => calculateAIScore(c) >= 80);
      if (highValueCustomers.length > 0) {
        insights.push({
          icon: 'star',
          color: '#ffa726',
          title: 'High-Value Customers',
          text: `You have ${highValueCustomers.length} customers with scores of 80+. Consider offering them VIP benefits or exclusive discounts.`
        });
      }
      
      // Referral opportunity
      const referralReady = customers.filter(c => c.referralWillingness === 'Yes' && !c.hasReferred);
      if (referralReady.length > 0) {
        insights.push({
          icon: 'gift',
          color: '#ab47bc',
          title: 'Referral Opportunity',
          text: `${referralReady.length} customers are willing to refer others but haven't yet. Send them a personalized referral link!`
        });
      }
      
      // Social media presence
      const socialCustomers = customers.filter(c => c.socialMedia && c.socialMedia.length > 0);
      if (socialCustomers.length > customers.length * 0.7) {
        insights.push({
          icon: 'thumbs-up',
          color: '#66bb6a',
          title: 'Strong Social Presence',
          text: `${Math.round(socialCustomers.length / customers.length * 100)}% of your customers are on social media. Consider running social media campaigns!`
        });
      }
      
      // Discount interest
      const discountInterested = customers.filter(c => c.discountInterest === 'Yes').length;
      if (discountInterested > customers.length * 0.5) {
        insights.push({
          icon: 'percentage',
          color: '#42a5f5',
          title: 'Discount Campaign',
          text: `${discountInterested} customers expressed interest in discounts. Create a limited-time offer to boost sales!`
        });
      }
      
      // Recent orders
      const recentOrders = orders.filter(o => {
        const orderDate = new Date(o.date);
        const daysSince = (new Date() - orderDate) / (1000 * 60 * 60 * 24);
        return daysSince <= 30;
      });
      
      if (recentOrders.length > 0) {
        insights.push({
          icon: 'chart-line',
          color: '#26a69a',
          title: 'Recent Activity',
          text: `${recentOrders.length} orders in the past 30 days. ${recentOrders.length > orders.length * 0.3 ? 'Great momentum!' : 'Focus on lead conversion.'}`
        });
      }
      
      const insightsHTML = insights.length > 0 
        ? insights.map(insight => `
            <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid ${insight.color};">
              <div style="display: flex; align-items: start; gap: 12px;">
                <i class="fas fa-${insight.icon}" style="color: ${insight.color}; font-size: 24px; margin-top: 3px;"></i>
                <div>
                  <div style="font-weight: 600; color: #2e5940; margin-bottom: 5px;">${insight.title}</div>
                  <div style="color: #666; font-size: 14px;">${insight.text}</div>
                </div>
              </div>
            </div>
          `).join('')
        : '<div style="text-align: center; color: #999; padding: 30px;"><i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>Add more customers to generate AI insights</div>';
      
      document.getElementById('aiInsights').innerHTML = insightsHTML;
    }

    function updateTodayTasks() {
      const today = new Date().toISOString().split('T')[0];
      const todayEvents = events.filter(e => e.date === today);
      
      const tasksHTML = todayEvents.length > 0
        ? todayEvents.map(e => `
            <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #66bb6a;">
              <div style="font-weight: 600; color: #2e5940; margin-bottom: 3px;">${e.title}</div>
              <div style="color: #666; font-size: 13px;">
                <i class="fas fa-clock"></i> ${e.time || 'All day'}
                ${e.customer ? ` â€¢ ${e.customer}` : ''}
              </div>
            </div>
          `).join('')
        : '<div style="text-align: center; color: #999; padding: 20px;">No tasks scheduled for today</div>';
      
      document.getElementById('todayTasks').innerHTML = tasksHTML;
    }

    // Customer Management
    function openCustomerModal(customerId = null) {
      const modal = document.getElementById('customerModal');
      const form = document.getElementById('customerForm');
      form.reset();
      
      if (customerId) {
        const customer = customers.find(c => c.id === customerId);
        if (customer) {
          document.getElementById('customerModalTitle').textContent = 'Edit Customer';
          document.getElementById('customerId').value = customer.id;
          document.getElementById('customerFirstName').value = customer.firstName;
          document.getElementById('customerLastName').value = customer.lastName;
          document.getElementById('customerEmail').value = customer.email;
          document.getElementById('customerPhone').value = customer.phone || '';
          document.getElementById('customerAddress').value = customer.address || '';
          document.getElementById('customerCity').value = customer.city || '';
          document.getElementById('customerState').value = customer.state || '';
          document.getElementById('customerZip').value = customer.zip || '';
          document.getElementById('customerLeadSource').value = customer.leadSource;
          document.getElementById('customerStatus').value = customer.status || 'Prospect';
          document.getElementById('customerDiscountInterest').value = customer.discountInterest || 'No';
          document.getElementById('customerReferralWillingness').value = customer.referralWillingness || 'No';
          document.getElementById('customerReferredBy').value = customer.referredBy || '';
          document.getElementById('customerNotes').value = customer.notes || '';
          
          // Set social media checkboxes
          if (customer.socialMedia) {
            customer.socialMedia.forEach(platform => {
              const checkbox = document.getElementById('social' + platform);
              if (checkbox) checkbox.checked = true;
            });
          }
        }
      } else {
        document.getElementById('customerModalTitle').textContent = 'Add New Customer';
        document.getElementById('customerId').value = '';
      }
      
      modal.style.display = 'block';
    }

    function saveCustomer(event) {
      event.preventDefault();
      
      const socialMedia = [];
      ['Facebook', 'Instagram', 'Twitter', 'LinkedIn', 'YouTube', 'TikTok'].forEach(platform => {
        if (document.getElementById('social' + platform).checked) {
          socialMedia.push(platform);
        }
      });
      
      const customer = {
        id: document.getElementById('customerId').value || Date.now().toString(),
        firstName: document.getElementById('customerFirstName').value,
        lastName: document.getElementById('customerLastName').value,
        email: document.getElementById('customerEmail').value,
        phone: document.getElementById('customerPhone').value,
        address: document.getElementById('customerAddress').value,
        city: document.getElementById('customerCity').value,
        state: document.getElementById('customerState').value,
        zip: document.getElementById('customerZip').value,
        leadSource: document.getElementById('customerLeadSource').value,
        status: document.getElementById('customerStatus').value,
        socialMedia: socialMedia,
        discountInterest: document.getElementById('customerDiscountInterest').value,
        referralWillingness: document.getElementById('customerReferralWillingness').value,
        referredBy: document.getElementById('customerReferredBy').value,
        notes: document.getElementById('customerNotes').value,
        dateAdded: new Date().toISOString()
      };
      
      // Handle referral
      if (customer.referredBy) {
        const referrer = customers.find(c => 
          `${c.firstName} ${c.lastName}`.toLowerCase() === customer.referredBy.toLowerCase()
        );
        
        if (referrer) {
          // Mark that referrer has referred someone
          referrer.hasReferred = true;
          referrer.totalReferrals = (referrer.totalReferrals || 0) + 1;
          referrer.referralCredits = (referrer.referralCredits || 0) + settings.creditAmount;
          
          // Also give credit to new customer
          customer.referralCredits = settings.creditAmount;
          customer.isReferral = true;
          customer.referrerId = referrer.id;
        }
      }
      
      const existingIndex = customers.findIndex(c => c.id === customer.id);
      if (existingIndex >= 0) {
        // Preserve referral data when editing
        customer.hasReferred = customers[existingIndex].hasReferred;
        customer.totalReferrals = customers[existingIndex].totalReferrals;
        customer.referralCredits = customers[existingIndex].referralCredits;
        customers[existingIndex] = customer;
        showNotification('Customer updated successfully!');
      } else {
        customers.push(customer);
        showNotification('Customer added successfully!');
      }
      
      saveData();
      closeModal('customerModal');
      renderCustomersTable();
      updateDashboard();
      updateMarketingView();
      updateReferralsView();
      updateEventCustomerDropdown();
      updateOrderCustomerDropdown();
    }

    function deleteCustomer(customerId) {
      if (confirm('Are you sure you want to delete this customer?')) {
        customers = customers.filter(c => c.id !== customerId);
        saveData();
        renderCustomersTable();
        updateDashboard();
        updateMarketingView();
        updateReferralsView();
        showNotification('Customer deleted successfully!');
      }
    }

    function renderCustomersTable() {
      const tbody = document.getElementById('customersTableBody');
      
      if (customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 40px;">No customers yet. Add your first customer!</td></tr>';
        return;
      }
      
      tbody.innerHTML = customers.map(customer => {
        const score = calculateAIScore(customer);
        const scoreClass = score >= 70 ? 'score-high' : score >= 40 ? 'score-medium' : 'score-low';
        const statusClass = customer.status === 'Active' ? 'status-active' : 
                           customer.status === 'Prospect' ? 'status-prospect' : 'status-inactive';
        
        return `
          <tr>
            <td>
              <div style="font-weight: 600;">${customer.firstName} ${customer.lastName}</div>
              ${customer.referralCredits ? `<div style="font-size: 11px; color: #ab47bc;"><i class="fas fa-gift"></i> $${customer.referralCredits} credit</div>` : ''}
            </td>
            <td>${customer.email}</td>
            <td>${customer.leadSource}</td>
            <td><span class="status-badge ${statusClass}">${customer.status}</span></td>
            <td><span class="score-badge ${scoreClass}">${score}</span></td>
            <td>
              <button class="btn-secondary" style="padding: 6px 12px; margin-right: 5px;" onclick="openCustomerModal('${customer.id}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-danger" style="padding: 6px 12px;" onclick="deleteCustomer('${customer.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterCustomers() {
      const search = document.getElementById('searchCustomers').value.toLowerCase();
      const filtered = customers.filter(c => 
        c.firstName.toLowerCase().includes(search) ||
        c.lastName.toLowerCase().includes(search) ||
        c.email.toLowerCase().includes(search) ||
        c.leadSource.toLowerCase().includes(search)
      );
      
      const tbody = document.getElementById('customersTableBody');
      tbody.innerHTML = filtered.map(customer => {
        const score = calculateAIScore(customer);
        const scoreClass = score >= 70 ? 'score-high' : score >= 40 ? 'score-medium' : 'score-low';
        const statusClass = customer.status === 'Active' ? 'status-active' : 
                           customer.status === 'Prospect' ? 'status-prospect' : 'status-inactive';
        
        return `
          <tr>
            <td>
              <div style="font-weight: 600;">${customer.firstName} ${customer.lastName}</div>
              ${customer.referralCredits ? `<div style="font-size: 11px; color: #ab47bc;"><i class="fas fa-gift"></i> $${customer.referralCredits} credit</div>` : ''}
            </td>
            <td>${customer.email}</td>
            <td>${customer.leadSource}</td>
            <td><span class="status-badge ${statusClass}">${customer.status}</span></td>
            <td><span class="score-badge ${scoreClass}">${score}</span></td>
            <td>
              <button class="btn-secondary" style="padding: 6px 12px; margin-right: 5px;" onclick="openCustomerModal('${customer.id}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-danger" style="padding: 6px 12px;" onclick="deleteCustomer('${customer.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function calculateAIScore(customer) {
      let score = 50; // Base score
      
      // Lead source quality
      const qualitySources = ['Referral', 'Google', 'Website'];
      if (qualitySources.includes(customer.leadSource)) score += 15;
      
      // Social media presence
      if (customer.socialMedia && customer.socialMedia.length > 0) {
        score += customer.socialMedia.length * 3; // Up to 18 points
      }
      
      // Willingness to refer
      if (customer.referralWillingness === 'Yes') score += 20;
      if (customer.referralWillingness === 'Maybe') score += 10;
      
      // Status
      if (customer.status === 'Active') score += 15;
      
      // Discount interest (lower score if they need discounts)
      if (customer.discountInterest === 'No') score += 7;
      
      return Math.min(100, score);
    }

    // Order Management
    function openOrderModal(orderId = null) {
      const modal = document.getElementById('orderModal');
      const form = document.getElementById('orderForm');
      form.reset();
      
      updateOrderCustomerDropdown();
      
      if (orderId) {
        const order = orders.find(o => o.id === orderId);
        if (order) {
          document.getElementById('orderId').value = order.id;
          document.getElementById('orderCustomer').value = order.customerId;
          document.getElementById('orderDate').value = order.date;
          document.getElementById('orderTotal').value = order.total;
          document.getElementById('orderProducts').value = order.products || '';
          document.getElementById('orderStatus').value = order.status || 'Pending';
          document.getElementById('orderNotes').value = order.notes || '';
        }
      } else {
        document.getElementById('orderId').value = '';
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('orderDate').value = today;
      }
      
      modal.style.display = 'block';
    }

    function updateOrderCustomerDropdown() {
      const select = document.getElementById('orderCustomer');
      select.innerHTML = '<option value="">Select Customer</option>' +
        customers.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
    }

    function saveOrder(event) {
      event.preventDefault();
      
      const customerId = document.getElementById('orderCustomer').value;
      const customer = customers.find(c => c.id === customerId);
      
      const order = {
        id: document.getElementById('orderId').value || Date.now().toString(),
        customerId: customerId,
        customerName: customer ? `${customer.firstName} ${customer.lastName}` : '',
        date: document.getElementById('orderDate').value,
        total: parseFloat(document.getElementById('orderTotal').value),
        products: document.getElementById('orderProducts').value,
        status: document.getElementById('orderStatus').value,
        notes: document.getElementById('orderNotes').value
      };
      
      const existingIndex = orders.findIndex(o => o.id === order.id);
      if (existingIndex >= 0) {
        orders[existingIndex] = order;
        showNotification('Order updated successfully!');
      } else {
        orders.push(order);
        showNotification('Order created successfully!');
      }
      
      saveData();
      closeModal('orderModal');
      renderOrdersTable();
      updateDashboard();
    }

    function deleteOrder(orderId) {
      if (confirm('Are you sure you want to delete this order?')) {
        orders = orders.filter(o => o.id !== orderId);
        saveData();
        renderOrdersTable();
        updateDashboard();
        showNotification('Order deleted successfully!');
      }
    }

    function renderOrdersTable() {
      const tbody = document.getElementById('ordersTableBody');
      
      if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 40px;">No orders yet. Create your first order!</td></tr>';
        return;
      }
      
      tbody.innerHTML = orders.map(order => `
        <tr>
          <td><strong>#${order.id.substring(0, 8)}</strong></td>
          <td>${order.customerName}</td>
          <td>${new Date(order.date).toLocaleDateString()}</td>
          <td><strong>$${order.total.toFixed(2)}</strong></td>
          <td><span class="status-badge ${order.status === 'Completed' ? 'status-active' : 'status-prospect'}">${order.status}</span></td>
          <td>
            <button class="btn-secondary" style="padding: 6px 12px; margin-right: 5px;" onclick="openOrderModal('${order.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-danger" style="padding: 6px 12px;" onclick="deleteOrder('${order.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Event/Calendar Management
    function openEventModal(eventId = null, date = null) {
      const modal = document.getElementById('eventModal');
      const form = document.getElementById('eventForm');
      form.reset();
      
      updateEventCustomerDropdown();
      
      if (eventId) {
        const event = events.find(e => e.id === eventId);
        if (event) {
          document.getElementById('eventId').value = event.id;
          document.getElementById('eventTitle').value = event.title;
          document.getElementById('eventCustomer').value = event.customerId || '';
          document.getElementById('eventDate').value = event.date;
          document.getElementById('eventTime').value = event.time || '';
          document.getElementById('eventType').value = event.type || 'Meeting';
          document.getElementById('eventNotes').value = event.notes || '';
        }
      } else {
        document.getElementById('eventId').value = '';
        if (date) {
          document.getElementById('eventDate').value = date;
        } else {
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('eventDate').value = today;
        }
      }
      
      modal.style.display = 'block';
    }

    function updateEventCustomerDropdown() {
      const select = document.getElementById('eventCustomer');
      select.innerHTML = '<option value="">Select Customer (Optional)</option>' +
        customers.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
    }

    function saveEvent(event) {
      event.preventDefault();
      
      const customerId = document.getElementById('eventCustomer').value;
      const customer = customerId ? customers.find(c => c.id === customerId) : null;
      
      const evt = {
        id: document.getElementById('eventId').value || Date.now().toString(),
        title: document.getElementById('eventTitle').value,
        customerId: customerId,
        customer: customer ? `${customer.firstName} ${customer.lastName}` : '',
        date: document.getElementById('eventDate').value,
        time: document.getElementById('eventTime').value,
        type: document.getElementById('eventType').value,
        notes: document.getElementById('eventNotes').value
      };
      
      const existingIndex = events.findIndex(e => e.id === evt.id);
      if (existingIndex >= 0) {
        events[existingIndex] = evt;
        showNotification('Event updated successfully!');
      } else {
        events.push(evt);
        showNotification('Event created successfully!');
      }
      
      saveData();
      closeModal('eventModal');
      renderCalendar();
      updateTodayTasks();
    }

    function deleteEvent(eventId) {
      if (confirm('Are you sure you want to delete this event?')) {
        events = events.filter(e => e.id !== eventId);
        saveData();
        renderCalendar();
        updateTodayTasks();
        showNotification('Event deleted successfully!');
      }
    }

    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      const title = document.getElementById('calendarTitle');
      
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const startingDayOfWeek = firstDay.getDay();
      const monthDays = lastDay.getDate();
      
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                         'July', 'August', 'September', 'October', 'November', 'December'];
      title.textContent = `${monthNames[currentMonth]} ${currentYear}`;
      
      let html = '';
      
      // Empty cells for days before month starts
      for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="calendar-day" style="opacity: 0.3;"></div>';
      }
      
      // Days of the month
      const today = new Date();
      const currentYearHolidays = holidays[currentYear] || [];
      
      for (let day = 1; day <= monthDays; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dateStr = date.toISOString().split('T')[0];
        const isToday = dateStr === today.toISOString().split('T')[0];
        
        const dayEvents = events.filter(e => e.date === dateStr);
        const dayHolidays = currentYearHolidays.filter(h => h.date === dateStr);
        
        html += `
          <div class="calendar-day ${isToday ? 'today' : ''}" onclick="openEventModal(null, '${dateStr}')">
            <div style="font-weight: 600; color: #2e5940; margin-bottom: 8px;">${day}</div>
            ${dayHolidays.map(h => `<div class="holiday-item">${h.name}</div>`).join('')}
            ${dayEvents.map(e => `
              <div class="event-item" onclick="event.stopPropagation(); openEventModal('${e.id}')">
                ${e.time ? e.time + ' - ' : ''}${e.title}
              </div>
            `).join('')}
          </div>
        `;
      }
      
      grid.innerHTML = html;
    }

    function changeMonth(delta) {
      if (delta === 0) {
        // Go to today
        const today = new Date();
        currentMonth = today.getMonth();
        currentYear = today.getFullYear();
      } else {
        currentMonth += delta;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        } else if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
      }
      renderCalendar();
    }

    // Marketing View
    function updateMarketingView() {
      renderLeadSourceChart();
      renderSocialMediaChart();
      updateReferralInsights();
      updateDiscountInsights();
    }

    function renderLeadSourceChart() {
      const ctx = document.getElementById('leadSourceChart');
      if (!ctx) return;
      
      const sources = {};
      customers.forEach(c => {
        sources[c.leadSource] = (sources[c.leadSource] || 0) + 1;
      });
      
      if (window.leadSourceChartInstance) {
        window.leadSourceChartInstance.destroy();
      }
      
      window.leadSourceChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(sources),
          datasets: [{
            data: Object.values(sources),
            backgroundColor: ['#66bb6a', '#42a5f5', '#ffa726', '#ab47bc', '#26a69a', '#ef5350', '#78909c']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function renderSocialMediaChart() {
      const ctx = document.getElementById('socialMediaChart');
      if (!ctx) return;
      
      const platforms = {};
      customers.forEach(c => {
        if (c.socialMedia) {
          c.socialMedia.forEach(p => {
            platforms[p] = (platforms[p] || 0) + 1;
          });
        }
      });
      
      if (window.socialMediaChartInstance) {
        window.socialMediaChartInstance.destroy();
      }
      
      window.socialMediaChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(platforms),
          datasets: [{
            label: 'Customers',
            data: Object.values(platforms),
            backgroundColor: '#66bb6a'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function updateReferralInsights() {
      const willing = customers.filter(c => c.referralWillingness === 'Yes').length;
      const maybe = customers.filter(c => c.referralWillingness === 'Maybe').length;
      const notWilling = customers.filter(c => c.referralWillingness === 'No').length;
      
      document.getElementById('referralInsights').innerHTML = `
        <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; margin-bottom: 10px;">
          <div style="font-size: 32px; font-weight: 700; color: #2e7d32;">${willing}</div>
          <div style="color: #2e5940; font-weight: 600;">Willing to Refer</div>
        </div>
        <div style="padding: 15px; background: #fff9c4; border-radius: 8px; margin-bottom: 10px;">
          <div style="font-size: 32px; font-weight: 700; color: #f57f17;">${maybe}</div>
          <div style="color: #f57f17; font-weight: 600;">Maybe</div>
        </div>
        <div style="padding: 15px; background: #ffcdd2; border-radius: 8px;">
          <div style="font-size: 32px; font-weight: 700; color: #c62828;">${notWilling}</div>
          <div style="color: #c62828; font-weight: 600;">Not Interested</div>
        </div>
      `;
    }

    function updateDiscountInsights() {
      const interested = customers.filter(c => c.discountInterest === 'Yes').length;
      const maybe = customers.filter(c => c.discountInterest === 'Maybe').length;
      const notInterested = customers.filter(c => c.discountInterest === 'No').length;
      
      document.getElementById('discountInsights').innerHTML = `
        <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
          <div style="font-size: 32px; font-weight: 700; color: #1565c0;">${interested}</div>
          <div style="color: #1565c0; font-weight: 600;">Interested</div>
        </div>
        <div style="padding: 15px; background: #fff3e0; border-radius: 8px; margin-bottom: 10px;">
          <div style="font-size: 32px; font-weight: 700; color: #e65100;">${maybe}</div>
          <div style="color: #e65100; font-weight: 600;">Maybe</div>
        </div>
        <div style="padding: 15px; background: #f5f5f5; border-radius: 8px;">
          <div style="font-size: 32px; font-weight: 700; color: #757575;">${notInterested}</div>
          <div style="color: #757575; font-weight: 600;">Not Interested</div>
        </div>
      `;
    }

    // Referral Program
    function updateReferralsView() {
      const totalReferrals = customers.filter(c => c.isReferral).length;
      const totalCredits = customers.reduce((sum, c) => sum + (c.referralCredits || 0), 0);
      const activeAdvocates = customers.filter(c => c.totalReferrals > 0).length;
      const conversionRate = customers.length > 0 ? (totalReferrals / customers.length * 100).toFixed(1) : 0;
      
      document.getElementById('totalReferrals').textContent = totalReferrals;
      document.getElementById('totalCredits').textContent = '$' + totalCredits;
      document.getElementById('activeAdvocates').textContent = activeAdvocates;
      document.getElementById('conversionRate').textContent = conversionRate + '%';
      
      renderTopReferrersList();
      renderReferralRewardTiers();
      renderRecentReferralsTable();
    }

    function renderTopReferrersList() {
      const topReferrers = customers
        .filter(c => c.totalReferrals > 0)
        .sort((a, b) => b.totalReferrals - a.totalReferrals)
        .slice(0, 10);
      
      if (topReferrers.length === 0) {
        document.getElementById('topReferrersList').innerHTML = `
          <div style="text-align: center; color: #999; padding: 40px;">
            <i class="fas fa-trophy" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
            No referrers yet. Start building your referral network!
          </div>
        `;
        return;
      }
      
      const html = topReferrers.map((c, index) => {
        const tier = getTierForReferrals(c.totalReferrals);
        const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
        const medal = index < 3 ? medals[index] : '';
        
        return `
          <div style="padding: 15px; background: ${index === 0 ? '#fff9c4' : '#f5f5f5'}; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${tier.color};">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; color: #2e5940; margin-bottom: 3px;">
                  ${medal} ${c.firstName} ${c.lastName}
                  <span style="margin-left: 10px; padding: 3px 8px; background: ${tier.color}; color: white; border-radius: 4px; font-size: 10px; font-weight: 600;">
                    ${tier.name}
                  </span>
                </div>
                <div style="color: #666; font-size: 13px;">
                  <i class="fas fa-users"></i> ${c.totalReferrals} referral${c.totalReferrals !== 1 ? 's' : ''}
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 20px; font-weight: 700; color: #ab47bc;">$${c.referralCredits || 0}</div>
                <div style="font-size: 11px; color: #666;">earned</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('topReferrersList').innerHTML = html;
    }

    function getTierForReferrals(count) {
      if (count >= settings.tiers.platinum.min) {
        return { name: 'PLATINUM', color: '#4dd0e1', bonus: settings.tiers.platinum.bonus };
      } else if (count >= settings.tiers.gold.min && count <= settings.tiers.gold.max) {
        return { name: 'GOLD', color: '#ffd700', bonus: settings.tiers.gold.bonus };
      } else if (count >= settings.tiers.silver.min && count <= settings.tiers.silver.max) {
        return { name: 'SILVER', color: '#c0c0c0', bonus: settings.tiers.silver.bonus };
      } else if (count >= settings.tiers.bronze.min && count <= settings.tiers.bronze.max) {
        return { name: 'BRONZE', color: '#cd7f32', bonus: settings.tiers.bronze.bonus };
      }
      return { name: 'STARTER', color: '#999', bonus: 0 };
    }

    function renderReferralRewardTiers() {
      const html = `
        <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #cd7f32; margin-bottom: 12px;">
          <div style="font-weight: 600; color: #cd7f32; margin-bottom: 8px;">
            <i class="fas fa-medal"></i> BRONZE (${settings.tiers.bronze.min}-${settings.tiers.bronze.max} referrals)
          </div>
          <div style="font-size: 13px; color: #666;">Base credit: $${settings.creditAmount}</div>
          <div style="font-size: 13px; color: #666;">Bonus: +$${settings.tiers.bronze.bonus} per referral</div>
        </div>
        
        <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #c0c0c0; margin-bottom: 12px;">
          <div style="font-weight: 600; color: #808080; margin-bottom: 8px;">
            <i class="fas fa-medal"></i> SILVER (${settings.tiers.silver.min}-${settings.tiers.silver.max} referrals)
          </div>
          <div style="font-size: 13px; color: #666;">Base credit: $${settings.creditAmount}</div>
          <div style="font-size: 13px; color: #666;">Bonus: +$${settings.tiers.silver.bonus} per referral</div>
        </div>
        
        <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #ffd700; margin-bottom: 12px;">
          <div style="font-weight: 600; color: #daa520; margin-bottom: 8px;">
            <i class="fas fa-medal"></i> GOLD (${settings.tiers.gold.min}-${settings.tiers.gold.max} referrals)
          </div>
          <div style="font-size: 13px; color: #666;">Base credit: $${settings.creditAmount}</div>
          <div style="font-size: 13px; color: #666;">Bonus: +$${settings.tiers.gold.bonus} per referral</div>
        </div>
        
        <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #4dd0e1;">
          <div style="font-weight: 600; color: #4dd0e1; margin-bottom: 8px;">
            <i class="fas fa-gem"></i> PLATINUM (${settings.tiers.platinum.min}+ referrals)
          </div>
          <div style="font-size: 13px; color: #666;">Base credit: $${settings.creditAmount}</div>
          <div style="font-size: 13px; color: #666;">Bonus: +$${settings.tiers.platinum.bonus} per referral</div>
        </div>
      `;
      
      document.getElementById('referralRewardTiersDisplay').innerHTML = html;
    }

    function renderRecentReferralsTable() {
      const referrals = customers
        .filter(c => c.isReferral)
        .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded))
        .slice(0, 20);
      
      const tbody = document.getElementById('recentReferralsTable');
      
      if (referrals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999; padding: 40px;">No referrals yet. Start your referral program!</td></tr>';
        return;
      }
      
      tbody.innerHTML = referrals.map(r => {
        const referrer = customers.find(c => c.id === r.referrerId);
        return `
          <tr>
            <td>${referrer ? `${referrer.firstName} ${referrer.lastName}` : 'Unknown'}</td>
            <td><strong>${r.firstName} ${r.lastName}</strong></td>
            <td>${new Date(r.dateAdded).toLocaleDateString()}</td>
            <td><span class="status-badge status-active">Completed</span></td>
            <td><strong style="color: #ab47bc;">$${settings.creditAmount}</strong></td>
          </tr>
        `;
      }).join('');
    }

    // Pipeline View
    function updatePipelineView() {
      const prospects = customers.filter(c => c.status === 'Prospect');
      const active = customers.filter(c => c.status === 'Active');
      const inactive = customers.filter(c => c.status === 'Inactive');
      
      document.getElementById('pipelineContent').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
          <div class="card" style="border-top: 4px solid #42a5f5;">
            <h3 style="color: #1565c0; margin-bottom: 15px;">
              <i class="fas fa-users"></i> Prospects (${prospects.length})
            </h3>
            ${prospects.map(c => `
              <div style="padding: 12px; background: #e3f2fd; border-radius: 6px; margin-bottom: 8px;">
                <div style="font-weight: 600; color: #1565c0;">${c.firstName} ${c.lastName}</div>
                <div style="font-size: 12px; color: #666; margin-top: 3px;">
                  <i class="fas fa-envelope"></i> ${c.email}
                </div>
                <div style="font-size: 12px; color: #666;">
                  <i class="fas fa-chart-line"></i> Score: <span class="score-badge ${calculateAIScore(c) >= 70 ? 'score-high' : calculateAIScore(c) >= 40 ? 'score-medium' : 'score-low'}">${calculateAIScore(c)}</span>
                </div>
              </div>
            `).join('') || '<div style="text-align: center; color: #999; padding: 20px;">No prospects</div>'}
          </div>
          
          <div class="card" style="border-top: 4px solid #66bb6a;">
            <h3 style="color: #2e7d32; margin-bottom: 15px;">
              <i class="fas fa-check-circle"></i> Active (${active.length})
            </h3>
            ${active.map(c => `
              <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; margin-bottom: 8px;">
                <div style="font-weight: 600; color: #2e7d32;">${c.firstName} ${c.lastName}</div>
                <div style="font-size: 12px; color: #666; margin-top: 3px;">
                  <i class="fas fa-envelope"></i> ${c.email}
                </div>
                <div style="font-size: 12px; color: #666;">
                  <i class="fas fa-chart-line"></i> Score: <span class="score-badge ${calculateAIScore(c) >= 70 ? 'score-high' : calculateAIScore(c) >= 40 ? 'score-medium' : 'score-low'}">${calculateAIScore(c)}</span>
                </div>
              </div>
            `).join('') || '<div style="text-align: center; color: #999; padding: 20px;">No active customers</div>'}
          </div>
          
          <div class="card" style="border-top: 4px solid #ef5350;">
            <h3 style="color: #c62828; margin-bottom: 15px;">
              <i class="fas fa-pause-circle"></i> Inactive (${inactive.length})
            </h3>
            ${inactive.map(c => `
              <div style="padding: 12px; background: #ffebee; border-radius: 6px; margin-bottom: 8px;">
                <div style="font-weight: 600; color: #c62828;">${c.firstName} ${c.lastName}</div>
                <div style="font-size: 12px; color: #666; margin-top: 3px;">
                  <i class="fas fa-envelope"></i> ${c.email}
                </div>
                <div style="font-size: 12px; color: #666;">
                  <i class="fas fa-chart-line"></i> Score: <span class="score-badge ${calculateAIScore(c) >= 70 ? 'score-high' : calculateAIScore(c) >= 40 ? 'score-medium' : 'score-low'}">${calculateAIScore(c)}</span>
                </div>
              </div>
            `).join('') || '<div style="text-align: center; color: #999; padding: 20px;">No inactive customers</div>'}
          </div>
        </div>
      `;
    }

    // Analytics View
    function updateAnalyticsView() {
      renderRevenueChart();
      renderStatusChart();
    }

    function renderRevenueChart() {
      const ctx = document.getElementById('revenueChart');
      if (!ctx) return;
      
      // Group orders by month
      const monthlyRevenue = {};
      orders.forEach(o => {
        const date = new Date(o.date);
        const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        monthlyRevenue[key] = (monthlyRevenue[key] || 0) + parseFloat(o.total);
      });
      
      const sortedKeys = Object.keys(monthlyRevenue).sort();
      const labels = sortedKeys.map(k => {
        const [year, month] = k.split('-');
        const date = new Date(year, month - 1);
        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      });
      const data = sortedKeys.map(k => monthlyRevenue[k]);
      
      if (window.revenueChartInstance) {
        window.revenueChartInstance.destroy();
      }
      
      window.revenueChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Revenue',
            data: data,
            borderColor: '#66bb6a',
            backgroundColor: 'rgba(102, 187, 106, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          }
        }
      });
    }

    function renderStatusChart() {
      const ctx = document.getElementById('statusChart');
      if (!ctx) return;
      
      const prospects = customers.filter(c => c.status === 'Prospect').length;
      const active = customers.filter(c => c.status === 'Active').length;
      const inactive = customers.filter(c => c.status === 'Inactive').length;
      
      if (window.statusChartInstance) {
        window.statusChartInstance.destroy();
      }
      
      window.statusChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Prospects', 'Active', 'Inactive'],
          datasets: [{
            data: [prospects, active, inactive],
            backgroundColor: ['#42a5f5', '#66bb6a', '#ef5350']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    // Backup & Import/Export
    function exportData() {
      const data = {
        customers: customers,
        orders: orders,
        events: events,
        settings: settings,
        exportDate: new Date().toISOString(),
        version: '1.0'
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `acoustiskin-backup-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      lastBackupDate = new Date();
      localStorage.setItem('acoustiskin_last_backup', lastBackupDate.toISOString());
      updateBackupIndicator();
      
      showNotification('Backup downloaded successfully!');
    }

    function emailBackup() {
      const data = {
        customers: customers,
        orders: orders,
        events: events,
        settings: settings,
        exportDate: new Date().toISOString(),
        version: '1.0'
      };
      
      const jsonStr = JSON.stringify(data, null, 2);
      const encoded = encodeURIComponent(jsonStr);
      const subject = `AcoustiSkin CRM Backup - ${new Date().toLocaleDateString()}`;
      const body = `Your CRM backup is attached as JSON data. Save this email for safekeeping.\n\n${jsonStr}`;
      
      window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      
      lastBackupDate = new Date();
      localStorage.setItem('acoustiskin_last_backup', lastBackupDate.toISOString());
      updateBackupIndicator();
      
      showNotification('Opening email client with backup data...');
    }

    function showImportOptions() {
      document.getElementById('importOptionsModal').style.display = 'block';
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          currentImportData = data;
          
          // Check for conflicts
          if (customers.length > 0 || orders.length > 0 || events.length > 0) {
            showConflictResolution(data);
          } else {
            // No conflicts, just import
            performImport(data, 'replace');
          }
        } catch (error) {
          alert('Error reading backup file. Please ensure it\'s a valid JSON file.');
          console.error(error);
        }
      };
      reader.readAsText(file);
      
      closeModal('importOptionsModal');
      event.target.value = ''; // Reset file input
    }

    function showConflictResolution(data) {
      const info = `
        <strong>Existing Data:</strong><br>
        â€¢ ${customers.length} customer(s)<br>
        â€¢ ${orders.length} order(s)<br>
        â€¢ ${events.length} event(s)<br>
        <br>
        <strong>Importing:</strong><br>
        â€¢ ${data.customers?.length || 0} customer(s)<br>
        â€¢ ${data.orders?.length || 0} order(s)<br>
        â€¢ ${data.events?.length || 0} event(s)
      `;
      
      document.getElementById('conflictInfo').innerHTML = info;
      document.getElementById('conflictModal').style.display = 'block';
    }

    function resolveConflict(action) {
      if (currentImportData) {
        performImport(currentImportData, action);
        currentImportData = null;
      }
      closeModal('conflictModal');
    }

    function performImport(data, action) {
      if (action === 'replace') {
        customers = data.customers || [];
        orders = data.orders || [];
        events = data.events || [];
      } else if (action === 'merge') {
        customers = [...customers, ...(data.customers || [])];
        orders = [...orders, ...(data.orders || [])];
        events = [...events, ...(data.events || [])];
      }
      
      if (data.settings) {
        settings = data.settings;
        localStorage.setItem('acoustiskin_settings', JSON.stringify(settings));
        document.getElementById('referralCreditDisplay').textContent = settings.creditAmount;
      }
      
      saveData();
      renderCustomersTable();
      renderOrdersTable();
      renderCalendar();
      updateDashboard();
      updateMarketingView();
      updateReferralsView();
      updateEventCustomerDropdown();
      updateOrderCustomerDropdown();
      
      showNotification(`Data imported successfully! (${action === 'replace' ? 'Replaced' : 'Merged'} existing data)`);
    }

    function setupDragDrop() {
      const zone = document.getElementById('dragDropZone');
      
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('drag-over');
      });
      
      zone.addEventListener('dragleave', () => {
        zone.classList.remove('drag-over');
      });
      
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('drag-over');
        
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.json')) {
          const input = document.getElementById('importFile');
          const dt = new DataTransfer();
          dt.items.add(file);
          input.files = dt.files;
          importData({ target: input });
        } else {
          alert('Please drop a valid .json backup file');
        }
      });
    }

    function quickBackup() {
      exportData();
      closeModal('backupReminderModal');
    }

    function snoozeBackupReminder() {
      lastBackupDate = new Date();
      localStorage.setItem('acoustiskin_last_backup', lastBackupDate.toISOString());
      updateBackupIndicator();
      closeModal('backupReminderModal');
      showNotification('Backup reminder snoozed');
    }

    function checkBackupReminder() {
      if (!lastBackupDate) return;
      
      const daysSinceBackup = (new Date() - lastBackupDate) / (1000 * 60 * 60 * 24);
      
      if (daysSinceBackup >= backupReminderInterval) {
        document.getElementById('backupReminderModal').style.display = 'block';
      }
    }

    function updateBackupIndicator() {
      const indicator = document.getElementById('lastBackupTime');
      
      if (!lastBackupDate) {
        indicator.textContent = 'Never';
        return;
      }
      
      const daysSince = Math.floor((new Date() - lastBackupDate) / (1000 * 60 * 60 * 24));
      
      if (daysSince === 0) {
        indicator.textContent = 'Today';
      } else if (daysSince === 1) {
        indicator.textContent = '1 day ago';
      } else {
        indicator.textContent = `${daysSince} days ago`;
      }
    }

    // Utility Functions
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function showNotification(message) {
      const notification = document.getElementById('notification');
      const text = document.getElementById('notificationText');
      text.textContent = message;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    };

    // Initialize on load
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
