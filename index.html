<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AcoustiSkin CRM - Enterprise Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: #ffffff; 
    }
    .sidebar { 
      width: 280px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .main-content { flex-grow: 1; }
    .app-header { 
      box-shadow: 0 1px 3px rgba(102, 126, 234, 0.1); 
      background: #ffffff;
    }
    .input-group label { 
      font-weight: 500; 
      font-size: 0.875rem; 
      color: #764ba2; 
      margin-bottom: 0.25rem; 
      display: block; 
    }
    .input-group input, .input-group select, .input-group textarea {
      width: 100%; 
      padding: 0.5rem; 
      border: 1px solid #e9d5ff; 
      border-radius: 0.375rem;
      transition: all 0.2s;
    }
    .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
      border-color: #764ba2;
      outline: none;
      box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
    }
    .calendar-grid { 
      display: grid; 
      grid-template-columns: repeat(7, 1fr); 
      gap: 0.25rem; 
    }
    .calendar-day { 
      min-height: 100px; 
      border: 1px solid #e9d5ff; 
      padding: 0.5rem; 
      border-radius: 0.5rem;
      background: #faf5ff;
      cursor: pointer;
      transition: all 0.2s;
    }
    .calendar-day:hover {
      background: #f3e8ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(118, 75, 162, 0.15);
    }
    .kanban-column { 
      background: linear-gradient(to bottom, #faf5ff, #f3e8ff); 
      padding: 1rem; 
      border-radius: 0.75rem; 
      min-height: 24rem;
      border: 2px solid #e9d5ff;
    }
    .deal-card { 
      background: white; 
      padding: 0.75rem; 
      border-radius: 0.5rem; 
      box-shadow: 0 2px 8px rgba(118, 75, 162, 0.1); 
      margin-bottom: 0.75rem; 
      cursor: move;
      border-left: 4px solid #764ba2;
      transition: all 0.2s;
    }
    .deal-card:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(118, 75, 162, 0.2);
    }
    .field-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: 1rem; 
    }
    .purple-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
    }
    .purple-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background-color: white;
      margin: 2% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .close {
      color: #764ba2;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover { color: #667eea; }
    .action-btn {
      background: white;
      color: #764ba2;
      border: 1px solid #764ba2;
      padding: 0.25rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn:hover {
      background: #764ba2;
      color: white;
    }
    .calendar-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .calendar-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
    }
    .time-slot {
      padding: 0.25rem 0.5rem;
      margin: 0.125rem;
      background: #faf5ff;
      border-radius: 0.25rem;
      cursor: pointer;
      display: inline-block;
      transition: all 0.2s;
    }
    .time-slot:hover {
      background: #764ba2;
      color: white;
    }
    .time-slot.selected {
      background: #764ba2;
      color: white;
    }
    .priority-high { border-left: 4px solid #f5576c !important; }
    .priority-medium { border-left: 4px solid #ffc107 !important; }
    .priority-low { border-left: 4px solid #4fc3f7 !important; }
    .task-item {
      background: white;
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(118, 75, 162, 0.1);
    }
    .activity-feed {
      max-height: 400px;
      overflow-y: auto;
    }
    .activity-item {
      padding: 0.75rem;
      border-left: 3px solid #e9d5ff;
      margin-bottom: 0.5rem;
      background: #faf5ff;
      border-radius: 0 0.5rem 0.5rem 0;
    }
    h1, h2, h3, h4, h5, h6 {
      color: #764ba2;
    }
    .text-purple {
      color: #764ba2;
    }
    .bg-purple-light {
      background: #faf5ff;
    }
  </style>
</head>
<body class="bg-white min-h-screen antialiased flex">
  <!-- Notification Toast -->
  <div id="notification" class="fixed top-4 right-4 z-50 p-4 hidden rounded-lg shadow-2xl text-sm font-medium transition-all duration-300 bg-white border-l-4 border-purple-600" role="alert">
    <div class="flex items-center">
      <i class="fas fa-check-circle text-purple-600 mr-2"></i>
      <span id="notificationText"></span>
    </div>
  </div>

  <!-- Advanced Calendar Modal -->
  <div id="calendarModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCalendarModal()">&times;</span>
      <h2 class="text-2xl font-bold text-purple mb-6">
        <i class="fas fa-calendar-alt mr-2"></i>Schedule Activity
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <div class="input-group">
            <label><i class="fas fa-tasks mr-1"></i> Activity Type *</label>
            <select id="activityType" onchange="updateActivityFields()">
              <option value="appointment">Appointment</option>
              <option value="task">Task</option>
              <option value="call">Phone Call</option>
              <option value="meeting">Meeting</option>
              <option value="email">Email Follow-up</option>
              <option value="demo">Product Demo</option>
              <option value="deadline">Deadline</option>
              <option value="reminder">Reminder</option>
            </select>
          </div>
          <div class="input-group">
            <label><i class="fas fa-heading mr-1"></i> Title *</label>
            <input type="text" id="activityTitle" placeholder="e.g., Quarterly Business Review">
          </div>
          <div class="input-group">
            <label><i class="fas fa-user mr-1"></i> Customer</label>
            <select id="activityCustomer"></select>
          </div>
          <div class="input-group">
            <label><i class="fas fa-calendar-day mr-1"></i> Date *</label>
            <input type="date" id="activityDate">
          </div>
          <div class="input-group" id="timeField">
            <label><i class="fas fa-clock mr-1"></i> Time</label>
            <div class="grid grid-cols-4 gap-2">
              <div class="time-slot" onclick="selectTime(this, '09:00')">9:00 AM</div>
              <div class="time-slot" onclick="selectTime(this, '09:30')">9:30 AM</div>
              <div class="time-slot" onclick="selectTime(this, '10:00')">10:00 AM</div>
              <div class="time-slot" onclick="selectTime(this, '10:30')">10:30 AM</div>
              <div class="time-slot" onclick="selectTime(this, '11:00')">11:00 AM</div>
              <div class="time-slot" onclick="selectTime(this, '11:30')">11:30 AM</div>
              <div class="time-slot" onclick="selectTime(this, '12:00')">12:00 PM</div>
              <div class="time-slot" onclick="selectTime(this, '12:30')">12:30 PM</div>
              <div class="time-slot" onclick="selectTime(this, '01:00')">1:00 PM</div>
              <div class="time-slot" onclick="selectTime(this, '01:30')">1:30 PM</div>
              <div class="time-slot" onclick="selectTime(this, '02:00')">2:00 PM</div>
              <div class="time-slot" onclick="selectTime(this, '02:30')">2:30 PM</div>
              <div class="time-slot" onclick="selectTime(this, '03:00')">3:00 PM</div>
              <div class="time-slot" onclick="selectTime(this, '03:30')">3:30 PM</div>
              <div class="time-slot" onclick="selectTime(this, '04:00')">4:00 PM</div>
              <div class="time-slot" onclick="selectTime(this, '04:30')">4:30 PM</div>
            </div>
            <input type="hidden" id="activityTime">
          </div>
          <div class="input-group">
            <label><i class="fas fa-hourglass mr-1"></i> Duration</label>
            <select id="activityDuration">
              <option value="30">30 minutes</option>
              <option value="60" selected>1 hour</option>
              <option value="90">1.5 hours</option>
              <option value="120">2 hours</option>
              <option value="180">3 hours</option>
              <option value="240">4 hours</option>
              <option value="480">All day</option>
            </select>
          </div>
        </div>
        <div>
          <div class="input-group">
            <label><i class="fas fa-exclamation-circle mr-1"></i> Priority</label>
            <select id="activityPriority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
          <div class="input-group">
            <label><i class="fas fa-map-marker-alt mr-1"></i> Location</label>
            <input type="text" id="activityLocation" placeholder="Office, Zoom, Client Site, etc.">
          </div>
          <div class="input-group">
            <label><i class="fas fa-users mr-1"></i> Attendees</label>
            <input type="text" id="activityAttendees" placeholder="John Smith, Sarah Johnson">
          </div>
          <div class="input-group">
            <label><i class="fas fa-bell mr-1"></i> Reminder</label>
            <select id="activityReminder">
              <option value="0">No reminder</option>
              <option value="15" selected>15 minutes before</option>
              <option value="30">30 minutes before</option>
              <option value="60">1 hour before</option>
              <option value="1440">1 day before</option>
              <option value="10080">1 week before</option>
            </select>
          </div>
          <div class="input-group">
            <label><i class="fas fa-redo mr-1"></i> Repeat</label>
            <select id="activityRepeat">
              <option value="none">Don't repeat</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="biweekly">Every 2 weeks</option>
              <option value="monthly">Monthly</option>
              <option value="quarterly">Quarterly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>
          <div class="input-group">
            <label><i class="fas fa-sticky-note mr-1"></i> Notes</label>
            <textarea id="activityNotes" rows="4" placeholder="Agenda items, preparation notes, etc."></textarea>
          </div>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-6">
        <button onclick="closeCalendarModal()" class="action-btn">
          <i class="fas fa-times mr-1"></i> Cancel
        </button>
        <button onclick="saveActivity()" class="purple-btn">
          <i class="fas fa-save mr-1"></i> Save Activity
        </button>
      </div>
    </div>
  </div>

  <!-- Task Management Modal -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeTaskModal()">&times;</span>
      <h2 class="text-2xl font-bold text-purple mb-6">
        <i class="fas fa-tasks mr-2"></i>Task Management
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="font-semibold text-purple mb-3">Create New Task</h3>
          <div class="input-group">
            <label>Task Title *</label>
            <input type="text" id="taskTitle" placeholder="e.g., Follow up on proposal">
          </div>
          <div class="input-group">
            <label>Category</label>
            <select id="taskCategory">
              <option>Sales</option>
              <option>Support</option>
              <option>Marketing</option>
              <option>Operations</option>
              <option>Finance</option>
            </select>
          </div>
          <div class="input-group">
            <label>Due Date</label>
            <input type="date" id="taskDueDate">
          </div>
          <div class="input-group">
            <label>Priority</label>
            <select id="taskPriority">
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
          <div class="input-group">
            <label>Assigned To</label>
            <input type="text" id="taskAssignee" placeholder="Team member name">
          </div>
          <div class="input-group">
            <label>Description</label>
            <textarea id="taskDescription" rows="3"></textarea>
          </div>
          <button onclick="addTask()" class="purple-btn w-full">
            <i class="fas fa-plus mr-1"></i> Add Task
          </button>
        </div>
        <div>
          <h3 class="font-semibold text-purple mb-3">Active Tasks</h3>
          <div id="taskList" class="activity-feed"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar text-white flex flex-col h-screen fixed">
    <div class="p-6 text-2xl font-bold border-b border-purple-500 bg-white/10">
      <i class="fas fa-rocket mr-2"></i>AcoustiSkin CRM
    </div>
    <div class="p-6 flex-grow overflow-y-auto">
      <h3 class="text-sm font-semibold mb-2 text-purple-200 uppercase tracking-wider">Navigation</h3>
      <nav class="space-y-1">
        <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-white/20 transition-all" data-view="dashboard-view">
          <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
        </a>
        <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-white/20 transition-all" data-view="customers-view">
          <i class="fas fa-users mr-3"></i>Customers
        </a>
        <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-white/20 transition-all" data-view="orders-view">
          <i class="fas fa-shopping-cart mr-3"></i>Orders
        </a>
        <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-white/20 transition-all" data-view="calendar-view">
          <i class="fas fa-calendar mr-3"></i>Calendar
        </a>
        <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-white/20 transition-all" data-view="pipeline-view">
          <i class="fas fa-funnel-dollar mr-3"></i>Pipeline
        </a>
        <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-white/20 transition-all" data-view="analytics-view">
          <i class="fas fa-chart-line mr-3"></i>Analytics
        </a>
      </nav>
      <div class="mt-6 space-y-2">
        <button id="newCustomerButton" class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-2 px-4 rounded-lg transition-all">
          <i class="fas fa-plus mr-2"></i>New Customer
        </button>
        <button onclick="openCalendarModal()" class="w-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white font-semibold py-2 px-4 rounded-lg transition-all">
          <i class="fas fa-calendar-plus mr-2"></i>Quick Schedule
        </button>
        <button onclick="openTaskModal()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition-all">
          <i class="fas fa-tasks mr-2"></i>Task Manager
        </button>
      </div>
    </div>
    <div class="p-6 border-t border-purple-500 bg-white/10">
      <h3 class="text-sm font-semibold mb-2 text-purple-200 uppercase tracking-wider">Recent Customers</h3>
      <ul id="customerList" class="space-y-1 max-h-64 overflow-y-auto">
        <li class="p-3 text-center text-gray-300">Loading...</li>
      </ul>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content flex flex-col ml-72 w-full">
    <header class="app-header bg-white p-4 flex justify-between items-center sticky top-0 z-10 border-b border-purple-200">
      <h1 class="text-xl font-bold text-purple">
        <i class="fas fa-user-circle mr-2"></i>Customer: 
        <span id="currentCustomerName" class="text-purple-600">Select Customer</span>
      </h1>
      <div class="flex items-center space-x-3">
        <button onclick="openCalendarModal()" class="calendar-btn">
          <i class="fas fa-calendar-plus mr-1"></i>Schedule
        </button>
        <button id="backToDashboard" class="hidden action-btn">
          <i class="fas fa-arrow-left mr-1"></i>Back
        </button>
        <button id="editCustomerButton" class="purple-btn">
          <i class="fas fa-user-edit mr-1"></i>Edit Profile
        </button>
      </div>
    </header>
    
    <div id="customerStatusBar" class="mx-6 mt-4 p-3 font-semibold text-sm rounded-lg bg-purple-light text-purple border-l-4 border-purple-600">
      <i class="fas fa-info-circle mr-2"></i>Status: N/A
    </div>
    
    <div id="dashboard-view" class="app-view p-6"></div>
    <div id="customers-view" class="app-view p-6 hidden"></div>
    <div id="orders-view" class="app-view p-6 hidden"></div>
    <div id="calendar-view" class="app-view p-6 hidden"></div>
    <div id="pipeline-view" class="app-view p-6 hidden"></div>
    <div id="analytics-view" class="app-view p-6 hidden"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Complete JavaScript code
    let activeCustomer = null;
    let selectedTime = null;
    let editingActivity = null;
    let customers = [
      {
        id: 'CUST-001',
        name: 'Bay Area Sports Team',
        firstName: 'John',
        lastName: 'Smith',
        email: 'john.smith@bayareasports.com',
        phone: '415-555-0100',
        address: '123 Sports Arena Blvd, San Francisco, CA',
        website: 'bayareasports.com',
        industry: 'Professional Sports',
        revenue: '$150M',
        employees: '500-1000',
        status: 'Active Customer',
        leadSource: 'Referral',
        clv: '$48,000',
        lastPurchase: '2024-10-15',
        firstPurchase: '2023-01-10',
        purchaseFrequency: 4,
        primaryProduct: 'Team Uniforms',
        subscriptionTier: 'Enterprise',
        lastContact: '2024-11-01',
        nextTask: 'Quarterly review meeting',
        nps: 9,
        social: ['LinkedIn', 'Instagram'],
        handle: '@bayareasports'
      },
      {
        id: 'CUST-002',
        name: 'Tech Startup Inc',
        firstName: 'Sarah',
        lastName: 'Johnson',
        email: 'sarah@techstartup.com',
        phone: '650-555-0200',
        address: '456 Innovation Way, Palo Alto, CA',
        website: 'techstartup.com',
        industry: 'Technology',
        revenue: '$10M',
        employees: '50-100',
        status: 'Prospect',
        leadSource: 'Website',
        clv: '$12,000',
        lastPurchase: null,
        firstPurchase: null,
        purchaseFrequency: 0,
        primaryProduct: null,
        subscriptionTier: null,
        lastContact: '2024-11-10',
        nextTask: 'Send proposal',
        nps: null,
        social: ['LinkedIn', 'Twitter'],
        handle: '@techstartup'
      }
    ];

    let activities = [];
    let tasks = [];
    let orderItems = [];
    let pipelineDeals = [
      { id: 'DEAL-001', customerId: 'CUST-001', name: 'Annual Uniform Contract', value: 48000, stage: 'Proposal', probability: 75, closeDate: '2025-12-15' },
      { id: 'DEAL-002', customerId: 'CUST-002', name: 'Pilot Order', value: 8000, stage: 'Negotiation', probability: 90, closeDate: '2025-11-30' }
    ];

    // Load saved data
    const savedData = localStorage.getItem('AcoustiSkinCRM_Enterprise');
    if (savedData) {
      const parsed = JSON.parse(savedData);
      customers = parsed.customers || customers;
      pipelineDeals = parsed.pipelineDeals || pipelineDeals;
      activities = parsed.activities || [];
      tasks = parsed.tasks || [];
      orderItems = parsed.orderItems || [];
    }

    // Auto-save function
    function autoSave() {
      const toSave = { customers, pipelineDeals, activities, tasks, orderItems };
      localStorage.setItem('AcoustiSkinCRM_Enterprise', JSON.stringify(toSave));
    }

    // Enhanced notification
    function showNotification(msg, icon = 'check-circle', color = 'purple') {
      const n = document.getElementById('notification');
      const text = document.getElementById('notificationText');
      text.textContent = msg;
      n.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-2xl text-sm font-medium transition-all duration-300 bg-white border-l-4 border-${color}-600`;
      n.querySelector('i').className = `fas fa-${icon} text-${color}-600 mr-2`;
      n.classList.remove('hidden');
      setTimeout(() => n.classList.add('hidden'), 4000);
    }

    // Calendar Modal Functions
    function openCalendarModal(customerId = null, date = null) {
      document.getElementById('calendarModal').style.display = 'block';
      
      const customerSelect = document.getElementById('activityCustomer');
      customerSelect.innerHTML = '<option value="">Select Customer</option>' + 
        customers.map(c => `<option value="${c.id}" ${(customerId || activeCustomer?.id) === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
      
      document.getElementById('activityDate').value = date || new Date().toISOString().split('T')[0];
    }

    function closeCalendarModal() {
      document.getElementById('calendarModal').style.display = 'none';
      editingActivity = null;
      selectedTime = null;
      document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
    }

    function selectTime(element, time) {
      document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
      element.classList.add('selected');
      selectedTime = time;
      document.getElementById('activityTime').value = time;
    }

    function updateActivityFields() {
      const type = document.getElementById('activityType').value;
      const timeField = document.getElementById('timeField');
      
      if (type === 'task' || type === 'deadline') {
        timeField.style.display = 'none';
      } else {
        timeField.style.display = 'block';
      }
    }

    function saveActivity() {
      const activity = {
        id: editingActivity?.id || 'ACT-' + Date.now(),
        type: document.getElementById('activityType').value,
        title: document.getElementById('activityTitle').value,
        customerId: document.getElementById('activityCustomer').value,
        date: document.getElementById('activityDate').value,
        time: selectedTime || document.getElementById('activityTime').value,
        duration: document.getElementById('activityDuration').value,
        priority: document.getElementById('activityPriority').value,
        location: document.getElementById('activityLocation').value,
        attendees: document.getElementById('activityAttendees').value,
        reminder: document.getElementById('activityReminder').value,
        repeat: document.getElementById('activityRepeat').value,
        notes: document.getElementById('activityNotes').value,
        createdAt: editingActivity?.createdAt || new Date().toISOString(),
        status: 'scheduled'
      };

      if (!activity.title || !activity.date) {
        showNotification('Please fill in required fields', 'exclamation-circle', 'red');
        return;
      }

      if (editingActivity) {
        const index = activities.findIndex(a => a.id === editingActivity.id);
        if (index !== -1) activities[index] = activity;
      } else {
        activities.push(activity);
      }

      autoSave();
      closeCalendarModal();
      showNotification(editingActivity ? 'Activity updated successfully!' : 'Activity scheduled successfully!', 'calendar-check', 'green');
      
      if (document.getElementById('calendar-view').classList.contains('hidden') === false) {
        renderCalendar();
      }
      if (document.getElementById('dashboard-view').classList.contains('hidden') === false) {
        renderDashboard();
      }
    }

    // Task Modal Functions
    function openTaskModal() {
      document.getElementById('taskModal').style.display = 'block';
      renderTaskList();
    }

    function closeTaskModal() {
      document.getElementById('taskModal').style.display = 'none';
    }

    function addTask() {
      const task = {
        id: 'TASK-' + Date.now(),
        title: document.getElementById('taskTitle').value,
        category: document.getElementById('taskCategory').value,
        dueDate: document.getElementById('taskDueDate').value,
        priority: document.getElementById('taskPriority').value,
        assignee: document.getElementById('taskAssignee').value,
        description: document.getElementById('taskDescription').value,
        customerId: activeCustomer?.id,
        status: 'open',
        createdAt: new Date().toISOString()
      };

      if (!task.title) {
        showNotification('Please enter a task title', 'exclamation-circle', 'red');
        return;
      }

      tasks.push(task);
      autoSave();
      
      document.getElementById('taskTitle').value = '';
      document.getElementById('taskDescription').value = '';
      document.getElementById('taskAssignee').value = '';
      
      renderTaskList();
      showNotification('Task created successfully!', 'check-circle', 'green');
    }

    function renderTaskList() {
      const taskList = document.getElementById('taskList');
      const sortedTasks = tasks.filter(t => t.status === 'open').sort((a, b) => {
        const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
        return priorityOrder[a.priority] - priorityOrder[b.priority];
      });

      taskList.innerHTML = sortedTasks.map(task => `
        <div class="task-item priority-${task.priority}">
          <div class="flex justify-between items-start">
            <div>
              <p class="font-semibold text-purple">${task.title}</p>
              <p class="text-xs text-gray-600">Category: ${task.category} | Due: ${task.dueDate || 'No date'}</p>
              <p class="text-xs text-gray-600">Assigned: ${task.assignee || 'Unassigned'}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="completeTask('${task.id}')" class="text-green-600 text-sm">
                <i class="fas fa-check"></i>
              </button>
              <button onclick="deleteTask('${task.id}')" class="text-red-600 text-sm">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('') || '<p class="text-gray-500 text-center">No tasks yet</p>';
    }

    function completeTask(id) {
      tasks = tasks.map(t => t.id === id ? {...t, status: 'completed'} : t);
      autoSave();
      renderTaskList();
      showNotification('Task completed!', 'check-circle', 'green');
      if (!document.getElementById('dashboard-view').classList.contains('hidden')) {
        renderDashboard();
      }
    }

    function deleteTask(id) {
      tasks = tasks.filter(t => t.id !== id);
      autoSave();
      renderTaskList();
      showNotification('Task deleted', 'trash', 'red');
    }

    function editActivity(id) {
      const activity = activities.find(a => a.id === id);
      if (activity) {
        editingActivity = activity;
        openCalendarModal();
        
        document.getElementById('activityType').value = activity.type;
        document.getElementById('activityTitle').value = activity.title;
        document.getElementById('activityCustomer').value = activity.customerId;
        document.getElementById('activityDate').value = activity.date;
        document.getElementById('activityDuration').value = activity.duration;
        document.getElementById('activityPriority').value = activity.priority;
        document.getElementById('activityLocation').value = activity.location || '';
        document.getElementById('activityAttendees').value = activity.attendees || '';
        document.getElementById('activityReminder').value = activity.reminder || '15';
        document.getElementById('activityRepeat').value = activity.repeat || 'none';
        document.getElementById('activityNotes').value = activity.notes || '';
        
        if (activity.time) {
          selectedTime = activity.time;
          document.getElementById('activityTime').value = activity.time;
        }
        
        updateActivityFields();
      }
    }

    function deleteActivity(id) {
      if (confirm('Are you sure you want to delete this activity?')) {
        activities = activities.filter(a => a.id !== id);
        autoSave();
        showNotification('Activity deleted', 'trash', 'red');
        if (!document.getElementById('dashboard-view').classList.contains('hidden')) {
          renderDashboard();
        }
        if (!document.getElementById('calendar-view').classList.contains('hidden')) {
          renderCalendar();
        }
      }
    }

    // Enhanced Navigation
    function navigateTo(view) {
      document.querySelectorAll('.app-view').forEach(v => v.classList.add('hidden'));
      document.getElementById(view)?.classList.remove('hidden');
      document.getElementById('editCustomerButton')?.classList[view === 'customers-view' ? 'remove' : 'add']('hidden');
      document.getElementById('backToDashboard')?.classList[view === 'dashboard-view' ? 'add' : 'remove']('hidden');
      
      if (view === 'dashboard-view') renderDashboard();
      if (view === 'customers-view') renderCustomers();
      if (view === 'orders-view' && activeCustomer) renderOrderForm();
      if (view === 'calendar-view') renderCalendar();
      if (view === 'pipeline-view') renderPipeline();
      if (view === 'analytics-view') renderAnalytics();
    }

    function updateCustomerStatusUI(status) {
      const bar = document.getElementById('customerStatusBar');
      let icon = 'info-circle';
      let borderColor = 'border-purple-600';
      
      if (status === 'Active Customer' || status === 'Customer') {
        icon = 'check-circle';
        borderColor = 'border-green-600';
      } else if (status === 'Prospect') {
        icon = 'user-clock';
        borderColor = 'border-blue-600';
      }
      
      bar.className = `mx-6 mt-4 p-3 font-semibold text-sm rounded-lg bg-purple-light text-purple border-l-4 ${borderColor}`;
      bar.innerHTML = `<i class="fas fa-${icon} mr-2"></i>Status: ${status || 'N/A'}`;
    }

    function renderCustomerList() {
      const list = document.getElementById('customerList');
      list.innerHTML = customers.map(c => `
        <li class="customer-item p-3 cursor-pointer hover:bg-white/20 rounded-lg text-sm transition-all ${activeCustomer?.id === c.id ? 'bg-white/30' : ''}" data-customer-id="${c.id}">
          <div class="flex justify-between items-center">
            <span>${c.name}</span>
            <button class="text-xs text-purple-200 hover:text-white" onclick="event.stopPropagation(); editCustomer('${c.id}')">
              <i class="fas fa-edit"></i>
            </button>
          </div>
        </li>`).join('');
      
      document.querySelectorAll('.customer-item').forEach(item => {
        item.onclick = (e) => {
          if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') return;
          document.querySelectorAll('.customer-item').forEach(i => i.classList.remove('bg-white/30'));
          item.classList.add('bg-white/30');
          activeCustomer = customers.find(c => c.id === item.dataset.customerId);
          document.getElementById('currentCustomerName').textContent = activeCustomer.name;
          updateCustomerStatusUI(activeCustomer.status);
          navigateTo('dashboard-view');
        };
      });
    }

    function editCustomer(id) {
      activeCustomer = customers.find(c => c.id === id);
      navigateTo('customers-view');
    }

    // Complete the rest of the functions (renderDashboard, renderCustomers, renderOrderForm, renderCalendar, renderPipeline, renderAnalytics)
    // Due to length constraints, I'll provide the key structure

    function renderDashboard() {
      const view = document.getElementById('dashboard-view');
      if (!activeCustomer) {
        view.innerHTML = `
          <div class="text-center text-purple mt-20">
            <i class="fas fa-user-slash text-6xl mb-4 text-purple-300"></i>
            <p class="text-xl">Select a customer to view dashboard</p>
          </div>`;
        return;
      }

      const customerActivities = activities.filter(a => a.customerId === activeCustomer.id);
      const customerTasks = tasks.filter(t => t.customerId === activeCustomer.id && t.status === 'open');
      const customerDeals = pipelineDeals.filter(d => d.customerId === activeCustomer.id);

      view.innerHTML = `
        <div class="max-w-7xl mx-auto">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-extrabold text-purple">${activeCustomer.name} - Dashboard</h2>
            <div class="flex gap-2">
              <button onclick="openCalendarModal('${activeCustomer.id}')" class="calendar-btn">
                <i class="fas fa-calendar-plus mr-1"></i>Schedule
              </button>
              <button onclick="editCustomer('${activeCustomer.id}')" class="action-btn">
                <i class="fas fa-edit mr-1"></i>Edit
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-4 rounded-xl text-white">
              <p class="text-sm opacity-90">Lifetime Value</p>
              <p class="text-2xl font-bold">${activeCustomer.clv}</p>
            </div>
            <div class="bg-gradient-to-r from-blue-500 to-cyan-500 p-4 rounded-xl text-white">
              <p class="text-sm opacity-90">Open Tasks</p>
              <p class="text-2xl font-bold">${customerTasks.length}</p>
            </div>
            <div class="bg-gradient-to-r from-green-500 to-teal-500 p-4 rounded-xl text-white">
              <p class="text-sm opacity-90">Active Deals</p>
              <p class="text-2xl font-bold">${customerDeals.length}</p>
            </div>
            <div class="bg-gradient-to-r from-orange-500 to-red-500 p-4 rounded-xl text-white">
              <p class="text-sm opacity-90">NPS Score</p>
              <p class="text-2xl font-bold">${activeCustomer.nps || 'N/A'}</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-purple-100">
              <h3 class="font-semibold text-purple mb-4">Company Info</h3>
              <div class="space-y-2">
                <p><strong class="text-purple">Industry:</strong> ${activeCustomer.industry}</p>
                <p><strong class="text-purple">Revenue:</strong> ${activeCustomer.revenue}</p>
                <p><strong class="text-purple">Employees:</strong> ${activeCustomer.employees}</p>
                <p><strong class="text-purple">Website:</strong> <a href="http://${activeCustomer.website}" target="_blank" class="text-purple-600">${activeCustomer.website}</a></p>
              </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border border-purple-100">
              <h3 class="font-semibold text-purple mb-4">Contact Info</h3>
              <div class="space-y-2">
                <p><strong class="text-purple">Name:</strong> ${activeCustomer.firstName} ${activeCustomer.lastName}</p>
                <p><strong class="text-purple">Email:</strong> ${activeCustomer.email}</p>
                <p><strong class="text-purple">Phone:</strong> ${activeCustomer.phone}</p>
              </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border border-purple-100">
              <h3 class="font-semibold text-purple mb-4">Activities</h3>
              ${customerActivities.slice(0, 3).map(a => `
                <div class="mb-2 p-2 bg-purple-light rounded">
                  <p class="text-sm">${a.title}</p>
                  <p class="text-xs text-gray-600">${a.date}</p>
                </div>
              `).join('') || '<p class="text-gray-500">No activities</p>'}
            </div>
          </div>
        </div>`;
    }

    function renderCustomers() {
      const view = document.getElementById('customers-view');
      if (!activeCustomer) {
        view.innerHTML = '<p class="text-center text-purple">Select a customer to edit</p>';
        return;
      }

      view.innerHTML = `
        <div class="max-w-7xl mx-auto">
          <h2 class="text-2xl font-extrabold text-purple mb-6">Edit Customer Profile</h2>
          <form id="customerForm" class="bg-white p-6 rounded-xl shadow-lg border border-purple-100 space-y-4">
            <div class="field-grid">
              <div class="input-group">
                <label>Company Name</label>
                <input type="text" name="name" value="${activeCustomer.name}">
              </div>
              <div class="input-group">
                <label>Email</label>
                <input type="email" name="email" value="${activeCustomer.email}">
              </div>
              <div class="input-group">
                <label>Phone</label>
                <input type="tel" name="phone" value="${activeCustomer.phone || ''}">
              </div>
              <div class="input-group">
                <label>Status</label>
                <select name="status">
                  <option ${activeCustomer.status === 'Prospect' ? 'selected' : ''}>Prospect</option>
                  <option ${activeCustomer.status === 'Customer' ? 'selected' : ''}>Customer</option>
                  <option ${activeCustomer.status === 'Active Customer' ? 'selected' : ''}>Active Customer</option>
                </select>
              </div>
            </div>
            <button type="button" id="saveCustomerBtn" class="purple-btn">Save Changes</button>
          </form>
        </div>`;
      
      document.getElementById('saveCustomerBtn')?.addEventListener('click', () => {
        const form = document.getElementById('customerForm');
        const data = {};
        form.querySelectorAll('input, select, textarea').forEach(f => {
          data[f.name] = f.value;
        });
        Object.assign(activeCustomer, data);
        autoSave();
        showNotification('Customer saved!', 'check-circle', 'green');
        renderCustomerList();
        updateCustomerStatusUI(activeCustomer.status);
        navigateTo('dashboard-view');
      });
    }

    function renderOrderForm() {
      const view = document.getElementById('orders-view');
      view.innerHTML = `
        <div class="max-w-7xl mx-auto">
          <h2 class="text-2xl font-extrabold text-purple mb-6">New Order</h2>
          <div class="bg-white p-6 rounded-xl shadow-lg border border-purple-100">
            <p>Order form for ${activeCustomer.name}</p>
          </div>
        </div>`;
    }

    function renderCalendar() {
      const view = document.getElementById('calendar-view');
      view.innerHTML = `
        <div class="max-w-7xl mx-auto">
          <h2 class="text-2xl font-extrabold text-purple mb-6">Calendar</h2>
          <div class="bg-white p-6 rounded-xl shadow-lg border border-purple-100">
            <div class="grid grid-cols-7 gap-2">
              ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => `
                <div class="font-bold text-purple text-center">${d}</div>
              `).join('')}
            </div>
          </div>
        </div>`;
    }

    function renderPipeline() {
      const view = document.getElementById('pipeline-view');
      const stages = ['Lead', 'Qualified', 'Proposal', 'Negotiation', 'Closed Won', 'Closed Lost'];
      
      view.innerHTML = `
        <div class="max-w-7xl mx-auto">
          <h2 class="text-2xl font-extrabold text-purple mb-6">Sales Pipeline</h2>
          <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            ${stages.map(stage => `
              <div class="kanban-column">
                <h3 class="font-bold text-purple text-center mb-3">${stage}</h3>
                ${pipelineDeals.filter(d => d.stage === stage).map(deal => `
                  <div class="deal-card">
                    <p class="font-medium">${customers.find(c => c.id === deal.customerId)?.name}</p>
                    <p class="text-sm">${deal.name}</p>
                    <p class="font-bold text-purple">$${deal.value.toLocaleString()}</p>
                  </div>
                `).join('')}
              </div>
            `).join('')}
          </div>
        </div>`;
    }

    function renderAnalytics() {
      const view = document.getElementById('analytics-view');
      view.innerHTML = `
        <div class="max-w-7xl mx-auto">
          <h2 class="text-2xl font-extrabold text-purple mb-6">Analytics Dashboard</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-purple-100">
              <h3 class="font-semibold text-purple mb-4">Revenue Overview</h3>
              <canvas id="revenueChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-purple-100">
              <h3 class="font-semibold text-purple mb-4">Customer Status</h3>
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>`;
    }

    function setupEventListeners() {
      document.getElementById('newCustomerButton').addEventListener('click', () => {
        const id = 'CUST-' + Date.now();
        activeCustomer = { 
          id, 
          name: 'New Customer', 
          email: '', 
          phone: '', 
          status: 'Prospect'
        };
        customers.push(activeCustomer);
        autoSave();
        renderCustomerList();
        navigateTo('customers-view');
      });
      
      document.getElementById('editCustomerButton').addEventListener('click', () => {
        if (activeCustomer) {
          navigateTo('customers-view');
        } else {
          showNotification('Please select a customer first', 'exclamation-circle', 'yellow');
        }
      });
      
      document.getElementById('backToDashboard').addEventListener('click', () => navigateTo('dashboard-view'));
      
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const view = link.dataset.view;
          if (view === 'orders-view' && !activeCustomer) {
            showNotification('Please select a customer first', 'exclamation-circle', 'yellow');
            return;
          }
          navigateTo(view);
        });
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      renderCustomerList();
      setupEventListeners();
      navigateTo('dashboard-view');
      showNotification('Welcome to AcoustiSkin CRM!', 'rocket', 'purple');
    });
  </script>
</body>
</html>
