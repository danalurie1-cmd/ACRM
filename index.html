<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcoustiSkin CRM Pro - Customer View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #7c3aed; /* Violet 600 */
            --secondary-color: #3b82f6; /* Blue 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for aesthetic */
        .sidebar {
            scrollbar-width: thin;
            scrollbar-color: #9ca3af #f3f4f6;
        }
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 3px;
        }
        .sidebar::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }
        .event-box {
            color: white;
            padding: 2px 4px;
            font-size: 0.75rem;
            line-height: 1;
            border-radius: 4px;
            margin-top: 4px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .calendar-day-cell {
            min-height: 120px; /* Ensure visual spacing */
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 4px;
        }
        .calendar-grid {
            border-left: 1px solid #e5e7eb;
            border-top: 1px solid #e5e7eb;
        }
        .loading-overlay {
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 60;
            transition: opacity 0.3s;
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase functions to the global scope for use in the main script block
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, onSnapshot, collection, query, addDoc, setLogLevel
        };
    </script>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay fixed inset-0 flex items-center justify-center">
        <div class="flex items-center space-x-2 text-violet-600">
            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Loading CRM data...</span>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar w-64 bg-white p-4 flex flex-col shadow-lg overflow-y-auto">
        <div class="text-xl font-bold text-violet-700 mb-8 pb-4 border-b">
            AcoustiSkin <span class="text-gray-900">CRM Pro</span>
            <div id="user-info" class="text-xs text-gray-500 mt-1 truncate">User ID: N/A</div>
        </div>
        
        <!-- Navigation -->
        <div class="space-y-2 mb-8">
            <h3 class="text-xs font-semibold uppercase text-gray-500 mb-2">CORE</h3>
            <a href="#" class="flex items-center p-3 text-gray-600 hover:bg-violet-50 hover:text-violet-700 rounded-lg transition duration-150">Dashboard</a>
            <a href="#" class="flex items-center p-3 text-gray-600 hover:bg-violet-50 hover:text-violet-700 rounded-lg transition duration-150">Customers</a>
            <a href="#" class="flex items-center p-3 text-gray-600 hover:bg-violet-50 hover:text-violet-700 rounded-lg transition duration-150">New Order</a>
            <a href="#" class="flex items-center p-3 text-gray-600 hover:bg-violet-50 hover:text-violet-700 rounded-lg transition duration-150">Order Tracking</a>
            <a href="#" class="flex items-center p-3 bg-violet-100 text-violet-700 font-semibold rounded-lg transition duration-150">Calendar</a>
            <a href="#" class="flex items-center p-3 text-gray-600 hover:bg-violet-50 hover:text-violet-700 rounded-lg transition duration-150">Pipeline</a>
            <a href="#" class="flex items-center p-3 text-gray-600 hover:bg-violet-50 hover:text-violet-700 rounded-lg transition duration-150">Reports</a>
            <a href="#" class="flex items-center p-3 text-gray-600 hover:bg-violet-50 hover:text-violet-700 rounded-lg transition duration-150">Vendors & Team</a>
        </div>
        
        <!-- Actions -->
        <div class="space-y-3 mb-8">
            <button class="w-full bg-violet-600 hover:bg-violet-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                + New Customer
            </button>
            <button class="w-full bg-pink-500 hover:bg-pink-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                + New Vendor
            </button>
            <button id="quick-schedule-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg transition duration-150 flex items-center justify-center">
                Quick Schedule Task
            </button>
        </div>

        <!-- Export/Import -->
        <div class="space-y-2 mt-auto pt-4 border-t">
            <a href="#" class="flex items-center p-2 text-sm text-gray-600 hover:text-violet-700 transition duration-150">Export Data</a>
            <a href="#" class="flex items-center p-2 text-sm text-gray-600 hover:text-violet-700 transition duration-150">Import Data</a>
            <p class="text-xs font-semibold uppercase text-gray-500 pt-4">ADDRESS BOOK</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-8">
        <!-- Header -->
        <header class="flex justify-between items-center pb-6 mb-6 border-b">
            <h1 class="text-2xl font-semibold text-gray-800">Customer: Acme Corp</h1>
            <div class="space-x-4">
                <button class="text-violet-600 hover:text-violet-800 font-medium">Back to Dashboard</button>
                <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                    Edit Profile
                </button>
            </div>
        </header>

        <!-- Status Tag -->
        <div class="mb-8">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                Status: Active Customer
            </span>
        </div>

        <!-- Calendar Component -->
        <div class="bg-white p-6 rounded-xl shadow-xl">
            <!-- Calendar Controls -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                <div class="flex space-x-2">
                    <button class="p-2 text-sm font-medium rounded-lg text-gray-600 bg-gray-100 hover:bg-gray-200">Day</button>
                    <button class="p-2 text-sm font-medium rounded-lg text-gray-600 bg-gray-100 hover:bg-gray-200">Week</button>
                    <button class="p-2 text-sm font-medium rounded-lg bg-violet-600 text-white shadow-md">Month</button>
                </div>
                
                <h2 id="calendar-title" class="text-xl font-semibold text-gray-800"></h2>

                <div class="flex items-center space-x-3">
                    <button id="prev-month" class="p-2 text-gray-600 hover:bg-gray-100 rounded-full transition duration-150">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <button id="today-btn" class="p-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300">Today</button>
                    <button id="next-month" class="p-2 text-gray-600 hover:bg-gray-100 rounded-full transition duration-150">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="calendar-grid">
                <!-- Weekday Headers -->
                <div class="grid grid-cols-7 text-center font-medium text-gray-700 border-b">
                    <div class="p-2 text-red-500">Sun</div>
                    <div class="p-2">Mon</div>
                    <div class="p-2">Tue</div>
                    <div class="p-2">Wed</div>
                    <div class="p-2">Thu</div>
                    <div class="p-2">Fri</div>
                    <div class="p-2 text-blue-500">Sat</div>
                </div>

                <!-- Days Container -->
                <div id="calendar-days" class="grid grid-cols-7">
                    <!-- Calendar cells will be injected here -->
                </div>
            </div>

        </div>

        <!-- Event Modal (Display Details) -->
        <div id="event-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-gray-800" id="modal-title">Event Details</h3>
                <p class="text-gray-700 mb-4" id="modal-body"></p>
                <div class="flex justify-end">
                    <button onclick="closeModal('event-modal')" class="px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition">Close</button>
                </div>
            </div>
        </div>

        <!-- New Task Modal (Input Form) -->
        <div id="task-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
                <h3 class="text-2xl font-bold mb-6 text-gray-800">Schedule New Task/Event</h3>
                <form id="task-form">
                    <div class="space-y-4">
                        <div>
                            <label for="task-name" class="block text-sm font-medium text-gray-700">Task Name</label>
                            <input type="text" id="task-name" name="task-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 p-2 border">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="task-date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="task-date" name="task-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 p-2 border">
                            </div>
                            <div>
                                <label for="task-time" class="block text-sm font-medium text-gray-700">Time</label>
                                <input type="time" id="task-time" name="task-time" required value="09:00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 p-2 border">
                            </div>
                        </div>
                        <div>
                            <label for="task-type" class="block text-sm font-medium text-gray-700">Event Type</label>
                            <select id="task-type" name="task-type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 p-2 border bg-white">
                                <option value="Customer Follow-up">Customer Follow-up</option>
                                <option value="Internal Meeting">Internal Meeting</option>
                                <option value="Vendor Communication">Vendor Communication</option>
                                <option value="General Task">General Task</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeModal('task-modal')" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition">Schedule Task</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script type="module">
        
        // --- FIREBASE INITIALIZATION & DATA SETUP ---

        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, onSnapshot, collection, query, addDoc, setLogLevel } = window.firebase;
        
        // Global Firebase references
        let app;
        let db;
        let auth;
        let userId = null;
        let events = []; // Array to hold combined events (Firestore + Holidays)

        // Firebase Configuration & Initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let isAuthReady = false; // New state variable to track auth status

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // Enable Firestore logging

            // 1. Authentication and Listener Setup
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true; // Auth state has been determined
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-info').textContent = `User ID: ${userId}`;
                    setupFirestoreListener(); // Start listening for data once authenticated
                } else {
                    document.getElementById('user-info').textContent = `Signing in...`;
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        document.getElementById('user-info').textContent = `Auth Failed.`;
                        // Fallback: render static holidays and hide overlay
                        events = getFederalHolidays(currentDate.getFullYear());
                        renderCalendar();
                        document.getElementById('loading-overlay').classList.add('hidden');
                    }
                }
            });
        } else {
            // FIX: If Firebase config is missing, ensure the page loads immediately with static data.
            console.warn("Firebase configuration is missing. Running in static mode.");
            events = getFederalHolidays(currentDate.getFullYear());
            
            document.addEventListener('DOMContentLoaded', () => {
                renderCalendar();
                document.getElementById('loading-overlay').classList.add('hidden');
            });
        }

        function setupFirestoreListener() {
            // Using a public collection for team collaboration on the calendar
            const eventsCollectionPath = `artifacts/${appId}/public/data/calendarEvents`;
            const q = collection(db, eventsCollectionPath);

            onSnapshot(q, (snapshot) => {
                const firestoreEvents = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ensure the structure is compatible with the event object
                    firestoreEvents.push({ 
                        id: doc.id, 
                        date: data.date, 
                        name: data.name, 
                        type: data.type, 
                        time: data.time || '09:00' 
                    });
                });

                // Combine Firestore events with calculated Federal Holidays for the current year
                const currentYear = currentDate.getFullYear();
                const dynamicHolidays = getFederalHolidays(currentYear);
                
                // Prioritize user events to show them before holidays in the cell
                events = [...firestoreEvents, ...dynamicHolidays];
                console.log(`Fetched ${firestoreEvents.length} user events and ${dynamicHolidays.length} holidays.`);
                
                renderCalendar(); 
                document.getElementById('loading-overlay').classList.add('hidden');
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                // FIX: Ensure the overlay is hidden even if the data connection fails
                document.getElementById('loading-overlay').classList.add('hidden');
            });
        }

        // --- CALENDAR LOGIC START (PRESERVED FIX) ---

        const MONTH_NAMES = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        // Start date is December 2025, as seen in the screenshot
        let currentDate = new Date(2025, 11, 1); 

        // ----------------------------------------------------------------------
        // 1. DYNAMIC FEDERAL HOLIDAY CALCULATION LOGIC (PRESERVED FIX)
        // ----------------------------------------------------------------------

        function getNthDayOfMonth(year, monthIndex, dayOfWeek, n) {
            const date = new Date(year, monthIndex, 1);
            let count = 0;
            while (date.getDay() !== dayOfWeek) {
                date.setDate(date.getDate() + 1);
            }
            count = 1;
            while (count < n) {
                date.setDate(date.getDate() + 7);
                count++;
            }
            return date;
        }

        function getLastMondayInMay(year) {
            let date = new Date(year, 5, 0); 
            while (date.getDay() !== 1) { // 1 = Monday
                date.setDate(date.getDate() - 1);
            }
            return date;
        }

        function getFederalHolidays(year) {
            const holidays = [
                { name: "New Year's Day", date: new Date(year, 0, 1) },
                { name: 'Juneteenth National Independence Day', date: new Date(year, 5, 19) },
                { name: 'Independence Day', date: new Date(year, 6, 4) },
                { name: 'Veterans Day', date: new Date(year, 10, 11) },
                { name: 'Christmas Day', date: new Date(year, 11, 25) },
            ];

            // Floating Holidays
            holidays.push({ name: 'MLK Jr. Day', date: getNthDayOfMonth(year, 0, 1, 3) });
            holidays.push({ name: "President's Day", date: getNthDayOfMonth(year, 1, 1, 3) });
            holidays.push({ name: 'Labor Day', date: getNthDayOfMonth(year, 8, 1, 1) });
            holidays.push({ name: 'Columbus Day', date: getNthDayOfMonth(year, 9, 1, 2) });
            holidays.push({ name: 'Memorial Day', date: getLastMondayInMay(year) });
            holidays.push({ name: 'Thanksgiving Day', date: getNthDayOfMonth(year, 10, 4, 4) });

            const finalHolidays = [];
            holidays.forEach(h => {
                const day = h.date.getDay();
                let observedDate = new Date(h.date);
                let observedName = h.name;

                // Weekend Observance Rules
                if (day === 0) { // Sunday -> Observed Monday
                    observedDate.setDate(observedDate.getDate() + 1);
                    observedName = `${h.name} (Observed)`;
                } else if (day === 6) { // Saturday -> Observed Friday
                    observedDate.setDate(observedDate.getDate() - 1);
                    observedName = `${h.name} (Observed)`;
                } 
                
                // Official Holiday
                finalHolidays.push({ 
                    date: h.date.toISOString().split('T')[0], 
                    name: h.name, 
                    type: 'Federal Holiday', 
                    time: '09:00' 
                });

                // Observed Day
                if (h.date.toISOString().split('T')[0] !== observedDate.toISOString().split('T')[0]) {
                     finalHolidays.push({ 
                        date: observedDate.toISOString().split('T')[0], 
                        name: observedName, 
                        type: 'Federal Holiday (Observed)', 
                        time: '09:00' 
                    });
                }
            });

            return finalHolidays;
        }

        // ----------------------------------------------------------------------
        // 2. EVENT FILTERING LOGIC
        // ----------------------------------------------------------------------

        function getEventsForMonth(year, month) {
            const monthStr = (month + 1).toString().padStart(2, '0');
            const targetPrefix = `${year}-${monthStr}`;

            // Filter the global 'events' array (which is already combined data)
            return events.filter(event => event.date.startsWith(targetPrefix));
        }

        // ----------------------------------------------------------------------
        // 3. CALENDAR RENDERING LOGIC
        // ----------------------------------------------------------------------

        function renderCalendar() {
            const calendarTitle = document.getElementById('calendar-title');
            const calendarDays = document.getElementById('calendar-days');

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();
            
            const monthStr = (month + 1).toString().padStart(2, '0');

            calendarTitle.textContent = `${MONTH_NAMES[month]} ${year}`;
            calendarDays.innerHTML = '';

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay(); 

            // Get events for the current month
            const currentMonthEvents = getEventsForMonth(year, month);
            const eventsByDate = {};
            currentMonthEvents.forEach(event => {
                const dayOfMonth = parseInt(event.date.split('-')[2], 10);
                if (!eventsByDate[dayOfMonth]) {
                    eventsByDate[dayOfMonth] = [];
                }
                eventsByDate[dayOfMonth].push(event);
            });

            // 1. Fill leading empty cells
            for (let i = 0; i < firstDayOfWeek; i++) {
                const prevMonthLastDay = new Date(year, month, 0).getDate();
                const day = prevMonthLastDay - firstDayOfWeek + i + 1;
                const cell = document.createElement('div');
                cell.className = 'calendar-day-cell text-gray-400 bg-gray-50';
                cell.innerHTML = `<div class="p-1 text-sm font-medium text-right">${day}</div>`;
                calendarDays.appendChild(cell);
            }

            // 2. Fill current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day-cell relative hover:bg-violet-50 transition duration-100';
                
                let dayClasses = 'text-gray-900';
                if (new Date(year, month, day).getDay() === 0) dayClasses = 'text-red-500'; 
                if (new Date(year, month, day).getDay() === 6) dayClasses = 'text-blue-500'; 

                let todayClass = '';
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    todayClass = 'bg-violet-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg';
                    dayClasses = 'text-white'; 
                }
                
                cell.innerHTML = `
                    <div class="p-1 flex justify-end">
                        <span class="text-sm font-medium ${todayClass}">${day}</span>
                    </div>
                `;

                // Add events for this day
                if (eventsByDate[day]) {
                    const sortedEvents = eventsByDate[day].sort((a, b) => {
                        return a.time.localeCompare(b.time);
                    });

                    sortedEvents.forEach(event => {
                        const eventDiv = document.createElement('div');
                        let eventColor = event.type.includes('Holiday') ? 'bg-sky-400' : 
                                         event.type.includes('Customer') ? 'bg-blue-500' : 
                                         event.type.includes('Internal') ? 'bg-green-500' : 
                                         event.type.includes('Vendor') ? 'bg-orange-500' : 'bg-gray-500';

                        eventDiv.className = `event-box mt-1 ${eventColor} text-white`;
                        eventDiv.textContent = `${event.time.substring(0, 5)} ${event.name}`;
                        
                        eventDiv.onclick = (e) => {
                            e.stopPropagation(); 
                            showModal(event);
                        };
                        cell.appendChild(eventDiv);
                    });
                }

                calendarDays.appendChild(cell);
            }

            // 3. Fill trailing empty cells
            const totalCells = firstDayOfWeek + daysInMonth;
            const remainingCells = 42 - totalCells; 

            for (let i = 1; i <= remainingCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day-cell text-gray-400 bg-gray-50';
                cell.innerHTML = `<div class="p-1 text-sm font-medium text-right">${i}</div>`;
                calendarDays.appendChild(cell);
            }
        }

        // ----------------------------------------------------------------------
        // 4. NAVIGATION, MODAL, AND FIREBASE ACTIONS
        // ----------------------------------------------------------------------
        
        // Modal functions
        window.closeModal = function(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        }

        function showModal(event) {
            const dateParts = event.date.split('-');
            const formattedDate = `${MONTH_NAMES[parseInt(dateParts[1], 10) - 1]} ${dateParts[2]}, ${dateParts[0]}`;

            document.getElementById('modal-title').textContent = event.name;
            document.getElementById('modal-body').innerHTML = `
                <p><strong>Type:</strong> ${event.type}</p>
                <p><strong>Date:</strong> ${formattedDate}</p>
                <p><strong>Time:</strong> ${event.time}</p>
            `;
            document.getElementById('event-modal').classList.remove('hidden');
            document.getElementById('event-modal').classList.add('flex');
        }

        // Task Modal Handler
        document.getElementById('quick-schedule-btn').addEventListener('click', () => {
            const todayDate = new Date().toISOString().split('T')[0];
            document.getElementById('task-date').value = todayDate;
            document.getElementById('task-modal').classList.remove('hidden');
            document.getElementById('task-modal').classList.add('flex');
        });

        document.getElementById('task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const eventName = form['task-name'].value;
            const eventDate = form['task-date'].value;
            const eventTime = form['task-time'].value;
            const eventType = form['task-type'].value;

            if (!db) {
                console.error("Database is not initialized.");
                return;
            }

            const newEvent = {
                name: eventName,
                date: eventDate,
                time: eventTime,
                type: eventType,
                createdBy: userId,
                timestamp: new Date().toISOString(),
            };

            const eventsCollectionPath = `artifacts/${appId}/public/data/calendarEvents`;

            try {
                await addDoc(collection(db, eventsCollectionPath), newEvent);
                console.log("New event added successfully:", newEvent);
                closeModal('task-modal');
                form.reset();
            } catch (error) {
                console.error("Error adding document to Firestore:", error);
            }
        });

        // Navigation functions
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            // Re-render will automatically pull in new holidays for the new year/month via the onSnapshot
            // We just need to ensure the calendar renders the current state of 'events'
            renderCalendar(); 
        }

        function goToToday() {
            const today = new Date();
            currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
            renderCalendar();
        }

        // Attach event listeners
        document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
        document.getElementById('next-month').addEventListener('click', () => changeMonth(1));
        document.getElementById('today-btn').addEventListener('click', goToToday);

        // --- FINAL INITIALIZATION FALLBACK ---
        // This ensures the application starts rendering even if the Firebase config check is slow or missing.
        document.addEventListener('DOMContentLoaded', () => {
            if (!firebaseConfig) {
                // If Firebase wasn't initialized, we render the static holiday calendar now
                renderCalendar();
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
