<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AcoustiSkin CRM - AI-Powered Enterprise Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      min-height: 100vh;
    }
    .sidebar { 
      width: 260px; 
      background: linear-gradient(180deg, #4a7c59 0%, #2e5940 100%);
      box-shadow: 4px 0 20px rgba(0,0,0,0.15);
    }
    .main-content { margin-left: 260px; min-height: 100vh; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(67, 160, 71, 0.4);
    }
    .btn-secondary {
      background: white;
      color: #43a047;
      border: 2px solid #43a047;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }
    .btn-secondary:hover {
      background: #43a047;
      color: white;
    }
    .btn-danger {
      background: white;
      color: #e53935;
      border: 2px solid #e53935;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }
    .btn-danger:hover {
      background: #e53935;
      color: white;
    }
    .nav-item {
      padding: 12px 20px;
      color: white;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px 10px;
      transition: all 0.3s;
    }
    .nav-item:hover, .nav-item.active {
      background: rgba(255,255,255,0.2);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      overflow-y: auto;
    }
    .modal-content {
      background: white;
      margin: 30px auto;
      padding: 30px;
      border-radius: 16px;
      max-width: 1100px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #2e5940;
      font-weight: 600;
      font-size: 14px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #c8e6c9;
      border-radius: 6px;
      font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #66bb6a;
    }
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-item input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .calendar-day {
      background: white;
      border: 2px solid #e8f5e9;
      border-radius: 8px;
      padding: 10px;
      min-height: 120px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .calendar-day:hover {
      background: #f1f8e9;
      border-color: #66bb6a;
      transform: translateY(-2px);
    }
    .calendar-day.today {
      border-color: #43a047;
      background: #e8f5e9;
      box-shadow: 0 0 10px rgba(67, 160, 71, 0.3);
    }
    .event-item {
      background: #66bb6a;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-top: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .event-item:hover {
      background: #43a047;
      transform: scale(1.05);
    }
    .holiday-item {
      background: #ff6b6b;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-top: 4px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-active { background: #c8e6c9; color: #2e7d32; }
    .status-prospect { background: #bbdefb; color: #1565c0; }
    .status-inactive { background: #ffcdd2; color: #c62828; }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-left: 4px solid #66bb6a;
      display: none;
      z-index: 2000;
      animation: slideIn 0.3s;
      max-width: 400px;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    .table th {
      background: #e8f5e9;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #2e5940;
    }
    .table td {
      padding: 12px;
      border-bottom: 1px solid #e8f5e9;
    }
    .table tr:hover {
      background: #f1f8e9;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }
    .grid-4 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 15px;
    }
    .section-header {
      color: #2e5940;
      margin: 25px 0 15px 0;
      border-bottom: 2px solid #e8f5e9;
      padding-bottom: 10px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .ai-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .score-badge {
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: 600;
      display: inline-block;
    }
    .score-high { background: #c8e6c9; color: #2e7d32; }
    .score-medium { background: #fff9c4; color: #f57f17; }
    .score-low { background: #ffcdd2; color: #c62828; }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      font-size: 13px;
    }
    .backup-indicator {
      background: rgba(255,255,255,0.1);
      padding: 10px 15px;
      border-radius: 8px;
      margin: 15px 10px;
      color: white;
      font-size: 12px;
    }
    .drag-drop-zone {
      border: 3px dashed #c8e6c9;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: #f1f8e9;
      transition: all 0.3s;
      cursor: pointer;
    }
    .drag-drop-zone.drag-over {
      border-color: #43a047;
      background: #e8f5e9;
      transform: scale(1.02);
    }
    .drag-drop-zone:hover {
      border-color: #66bb6a;
      background: #e8f5e9;
    }
    .settings-icon {
      cursor: pointer;
      color: #66bb6a;
      transition: all 0.3s;
    }
    .settings-icon:hover {
      color: #43a047;
      transform: rotate(90deg);
    }
    .timeline-item {
      padding: 15px;
      background: #f1f8e9;
      border-left: 4px solid #66bb6a;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .task-item {
      padding: 15px;
      background: white;
      border: 2px solid #e8f5e9;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .task-item.overdue {
      border-color: #e53935;
      background: #ffebee;
    }
    .purchase-item {
      padding: 15px;
      background: white;
      border: 2px solid #e8f5e9;
      border-radius: 8px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- Notification -->
  <div id="notification" class="notification">
    <i class="fas fa-check-circle" style="color: #66bb6a; margin-right: 8px;"></i>
    <span id="notificationText"></span>
  </div>

  <!-- Backup Reminder Modal -->
  <div id="backupReminderModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div style="text-align: center;">
        <div style="font-size: 64px; color: #ffa726; margin-bottom: 20px;">
          <i class="fas fa-shield-alt"></i>
        </div>
        <h3 style="color: #2e5940; font-size: 24px; margin-bottom: 15px;">Time to Back Up Your Data!</h3>
        <p style="color: #666; margin-bottom: 25px;">
          It's been a while since your last backup. Protect your valuable customer data by backing up now.
        </p>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button class="btn-secondary" onclick="snoozeBackupReminder()">
            <i class="fas fa-clock"></i> Remind Me Later
          </button>
          <button class="btn-primary" onclick="quickBackup()">
            <i class="fas fa-download"></i> Backup Now
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Conflict Resolution Modal -->
  <div id="conflictModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <h3 style="color: #2e5940; margin-bottom: 20px;">
        <i class="fas fa-exclamation-triangle" style="color: #ffa726;"></i> Data Import Options
      </h3>
      
      <div class="info-box">
        <strong>You're importing data that may conflict with existing data.</strong><br>
        Choose how you want to handle this:
      </div>
      
      <div id="conflictInfo" style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;"></div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
        <button class="btn-secondary" onclick="resolveConflict('replace')" style="padding: 20px;">
          <i class="fas fa-exchange-alt" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
          <strong>Replace All</strong><br>
          <small style="opacity: 0.7;">Delete existing data and use imported data</small>
        </button>
        <button class="btn-primary" onclick="resolveConflict('merge')" style="padding: 20px;">
          <i class="fas fa-layer-group" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
          <strong>Merge Data</strong><br>
          <small style="opacity: 0.9;">Keep both, add imported data to existing</small>
        </button>
      </div>
      
      <div style="text-align: center; margin-top: 15px;">
        <button class="btn-secondary" onclick="closeModal('conflictModal')">
          <i class="fas fa-times"></i> Cancel Import
        </button>
      </div>
    </div>
  </div>

  <!-- Referral Settings Modal -->
  <div id="referralSettingsModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
          <i class="fas fa-cog"></i> Referral Program Settings
        </h3>
        <button onclick="closeModal('referralSettingsModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="referralSettingsForm" onsubmit="saveReferralSettings(event)">
        <div class="section-header">
          <i class="fas fa-dollar-sign"></i> Reward Structure
        </div>

        <div class="form-group">
          <label>Credit Per Referral ($)</label>
          <input type="number" id="settingsCreditAmount" min="0" step="1" value="15" required>
          <small style="color: #666; font-size: 12px;">Amount credited to referrer for each successful referral</small>
        </div>

        <div class="section-header">
          <i class="fas fa-trophy"></i> Tier Thresholds
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Bronze Tier (min referrals)</label>
            <input type="number" id="settingsBronzeMin" min="1" value="1" required>
          </div>
          <div class="form-group">
            <label>Bronze Tier (max referrals)</label>
            <input type="number" id="settingsBronzeMax" min="1" value="2" required>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Silver Tier (min referrals)</label>
            <input type="number" id="settingsSilverMin" min="1" value="3" required>
          </div>
          <div class="form-group">
            <label>Silver Tier (max referrals)</label>
            <input type="number" id="settingsSilverMax" min="1" value="5" required>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Gold Tier (min referrals)</label>
            <input type="number" id="settingsGoldMin" min="1" value="6" required>
          </div>
          <div class="form-group">
            <label>Gold Tier (max referrals)</label>
            <input type="number" id="settingsGoldMax" min="1" value="10" required>
          </div>
        </div>

        <div class="form-group">
          <label>Platinum Tier (min referrals)</label>
          <input type="number" id="settingsPlatinumMin" min="1" value="11" required>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
          <button type="button" class="btn-secondary" onclick="closeModal('referralSettingsModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Settings
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Communication Modal (Phase 1) -->
  <div id="communicationModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
          <i class="fas fa-comments"></i> <span id="communicationModalTitle">Add Communication</span>
        </h3>
        <button onclick="closeModal('communicationModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="communicationForm" onsubmit="saveCommunication(event)">
        <input type="hidden" id="communicationId">
        <input type="hidden" id="communicationCustomerId">

        <!-- Smart Customer Selector -->
        <div class="form-group">
          <label>Customer *</label>
          <div style="position: relative;">
            <input type="text" 
                   id="commCustomerSearch" 
                   placeholder="Search by name, city, state, or zip..." 
                   autocomplete="off"
                   onkeyup="filterCommCustomers()"
                   onfocus="showCommCustomerList()"
                   required>
            <div id="commCustomerList" 
                 style="display: none; position: absolute; top: 100%; left: 0; right: 0; 
                        background: white; border: 2px solid #e8f5e9; border-radius: 8px; 
                        max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            </div>
          </div>
          <div id="commSelectedCustomer" style="display: none; margin-top: 10px; padding: 10px; 
               background: #e8f5e9; border-radius: 8px; border-left: 4px solid #66bb6a;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; color: #2e5940;" id="commSelectedCustomerName"></div>
                <div style="font-size: 13px; color: #666;" id="commSelectedCustomerInfo"></div>
              </div>
              <button type="button" class="btn-secondary" style="font-size: 12px; padding: 4px 8px;" 
                      onclick="clearCommCustomerSelection()">
                <i class="fas fa-times"></i> Change
              </button>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Type *</label>
            <select id="communicationType" required>
              <option value="email">Email</option>
              <option value="phone">Phone Call</option>
              <option value="meeting">In-Person Meeting</option>
              <option value="sms">SMS/Text</option>
              <option value="social">Social Media</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Date *</label>
            <input type="date" id="communicationDate" required>
          </div>
        </div>

        <div class="form-group">
          <label>Subject *</label>
          <input type="text" id="communicationSubject" required placeholder="Brief description">
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="communicationNotes" rows="4" placeholder="Details of the communication..."></textarea>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn-secondary" onclick="closeModal('communicationModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Task Modal (Phase 1) -->
  <div id="taskModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
          <i class="fas fa-tasks"></i> <span id="taskModalTitle">Add Task</span>
        </h3>
        <button onclick="closeModal('taskModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="taskForm" onsubmit="saveTask(event)">
        <input type="hidden" id="taskId">
        <input type="hidden" id="taskCustomerId">

        <!-- Smart Customer Selector -->
        <div class="form-group">
          <label>Customer *</label>
          <div style="position: relative;">
            <input type="text" 
                   id="taskCustomerSearch" 
                   placeholder="Search by name, city, state, or zip..." 
                   autocomplete="off"
                   onkeyup="filterTaskCustomers()"
                   onfocus="showTaskCustomerList()"
                   required>
            <div id="taskCustomerList" 
                 style="display: none; position: absolute; top: 100%; left: 0; right: 0; 
                        background: white; border: 2px solid #e8f5e9; border-radius: 8px; 
                        max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            </div>
          </div>
          <div id="taskSelectedCustomer" style="display: none; margin-top: 10px; padding: 10px; 
               background: #e8f5e9; border-radius: 8px; border-left: 4px solid #66bb6a;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; color: #2e5940;" id="taskSelectedCustomerName"></div>
                <div style="font-size: 13px; color: #666;" id="taskSelectedCustomerInfo"></div>
              </div>
              <button type="button" class="btn-secondary" style="font-size: 12px; padding: 4px 8px;" 
                      onclick="clearTaskCustomerSelection()">
                <i class="fas fa-times"></i> Change
              </button>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Task Title *</label>
          <input type="text" id="taskTitle" required placeholder="e.g., Follow up on quote">
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Due Date *</label>
            <input type="date" id="taskDueDate" required>
          </div>
          <div class="form-group">
            <label>Priority *</label>
            <select id="taskPriority" required>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Status *</label>
          <select id="taskStatus" required>
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="taskDescription" rows="4" placeholder="Task details..."></textarea>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Task
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar" style="position: fixed; height: 100vh; overflow-y: auto;">
    <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.2);">
      <h1 style="color: white; font-size: 20px; font-weight: 700;">
        <i class="fas fa-leaf"></i> AcoustiSkin CRM
      </h1>
      <div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 5px;">
        <span class="ai-badge"><i class="fas fa-brain"></i> AI-Powered</span>
      </div>
    </div>
    
    <nav style="padding: 20px 0;">
      <div class="nav-item active" onclick="showView('dashboard')">
        <i class="fas fa-home" style="margin-right: 10px;"></i>Dashboard
      </div>
      <div class="nav-item" onclick="showView('customers')">
        <i class="fas fa-users" style="margin-right: 10px;"></i>Customers
      </div>
      <div class="nav-item" onclick="showView('orders')">
        <i class="fas fa-shopping-cart" style="margin-right: 10px;"></i>Orders
      </div>
      <div class="nav-item" onclick="showView('calendar')">
        <i class="fas fa-calendar" style="margin-right: 10px;"></i>Calendar
      </div>
      <div class="nav-item" onclick="showView('communications')">
        <i class="fas fa-comments" style="margin-right: 10px;"></i>Communications
      </div>
      <div class="nav-item" onclick="showView('tasks')">
        <i class="fas fa-tasks" style="margin-right: 10px;"></i>Tasks
      </div>
      <div class="nav-item" onclick="showView('pipeline')">
        <i class="fas fa-chart-line" style="margin-right: 10px;"></i>Pipeline
      </div>
      <div class="nav-item" onclick="showView('analytics')">
        <i class="fas fa-chart-bar" style="margin-right: 10px;"></i>Analytics
      </div>
      <div class="nav-item" onclick="showView('marketing')">
        <i class="fas fa-bullhorn" style="margin-right: 10px;"></i>Marketing
      </div>
      <div class="nav-item" onclick="showView('referrals')">
        <i class="fas fa-gift" style="margin-right: 10px;"></i>Referral Program
      </div>
    
<div class="nav-item" onclick="showView('blueprint')">
<i class="fas fa-sitemap" style="margin-right: 10px;"></i>Enterprise Blueprint
</div>
</nav>

    <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
      <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="openCustomerModal()">
        <i class="fas fa-plus"></i> New Customer
      </button>
      <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="openEventModal()">
        <i class="fas fa-calendar-plus"></i> Schedule Event
      </button>
      <button class="btn-primary" style="width: 100%;" onclick="openOrderModal()">
        <i class="fas fa-cart-plus"></i> New Order
      </button>
      
      <div class="backup-indicator" id="backupIndicator">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
          <span style="font-weight: 600;"><i class="fas fa-shield-alt"></i> Last Backup</span>
        </div>
        <div id="lastBackupTime" style="font-size: 11px; opacity: 0.8;">Never</div>
      </div>
      
      <div style="margin-top: 15px;">
        <button class="btn-primary" style="width: 100%; margin-bottom: 10px; background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);" onclick="emailBackup()">
          <i class="fas fa-envelope"></i> Email Backup
        </button>
        <button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="exportData()">
          <i class="fas fa-download"></i> Download Backup
        </button>
        <button class="btn-secondary" style="width: 100%;" onclick="showImportOptions()">
          <i class="fas fa-upload"></i> Import Data
        </button>
        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
      </div>
    </div>
  </aside>
  <!-- Main Content -->
  <main class="main-content" style="padding: 30px;">
    
    <!-- Dashboard View -->
    <div id="dashboardView" class="view">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
          <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;">Dashboard</h2>
          <p style="color: #666; margin-top: 5px;">Welcome back! Here's what's happening today.</p>
        </div>
        <div style="text-align: right;">
          <div style="color: #666; font-size: 14px;">Today</div>
          <div id="currentDate" style="color: #2e5940; font-size: 18px; font-weight: 600;"></div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="card" style="background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); color: white; cursor: pointer;" 
             onclick="showView('customers')">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Customers</div>
          <div style="font-size: 36px; font-weight: 700;" id="totalCustomers">0</div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">
            <i class="fas fa-arrow-up"></i> Click to view all customers
          </div>
        </div>
        <div class="card" style="background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: white; cursor: pointer;" 
             onclick="showView('orders')">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Orders</div>
          <div style="font-size: 36px; font-weight: 700;" id="totalOrders">0</div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">
            <i class="fas fa-shopping-cart"></i> Click to view all orders
          </div>
        </div>
        <div class="card" style="background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); color: white; cursor: pointer;" 
             onclick="showView('orders')">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Revenue</div>
          <div style="font-size: 36px; font-weight: 700;" id="totalRevenue">$0</div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">
            <i class="fas fa-dollar-sign"></i> Click to view orders
          </div>
        </div>
        <div class="card" style="background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%); color: white; cursor: pointer;" 
             onclick="showView('calendar')">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Events Today</div>
          <div style="font-size: 36px; font-weight: 700;" id="eventsToday">0</div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">
            <i class="fas fa-calendar-check"></i> Click to view calendar
          </div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Recent Customers -->
        <div class="card">
          <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
            <i class="fas fa-users"></i> Recent Customers
          </h3>
          <div id="recentCustomers"></div>
        </div>

        <!-- Today's Tasks -->
        <div class="card">
          <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
            <i class="fas fa-tasks"></i> Today's Tasks
          </h3>
          <div id="todaysTasks"></div>
        </div>
      </div>
    </div>

    <!-- Customers View -->
    <div id="customersView" class="view" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
          <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;">Customers</h2>
          <p style="color: #666; margin-top: 5px;">Manage your customer relationships</p>
        </div>
        <button class="btn-primary" onclick="openCustomerModal()">
          <i class="fas fa-plus"></i> Add Customer
        </button>
      </div>

      <div class="card">
        <div style="margin-bottom: 20px;">
          <input type="text" id="customerSearch" placeholder="Search customers..." 
            style="width: 100%; padding: 12px; border: 2px solid #c8e6c9; border-radius: 8px;" 
            oninput="filterCustomers()">
        </div>
        <div style="overflow-x: auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Contact</th>
                <th>Status</th>
                <th>AI Score</th>
                <th>Lead Source</th>
                <th>Referrals Made</th>
                <th>Potential Referrals</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Orders View -->
    <div id="ordersView" class="view" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
          <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;">Orders</h2>
          <p style="color: #666; margin-top: 5px;">Track and manage all orders</p>
        </div>
        <button class="btn-primary" onclick="openOrderModal()">
          <i class="fas fa-plus"></i> New Order
        </button>
      </div>

      <div class="card">
        <div style="overflow-x: auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Product</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Customer Profile View (NEW: Phase 2) -->
    <div id="customerProfileView" class="view" style="display: none;">
      <div style="margin-bottom: 30px;">
        <button class="btn-secondary" onclick="showView('customers')" style="margin-bottom: 15px;">
          <i class="fas fa-arrow-left"></i> Back to Customers
        </button>
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;" id="profileCustomerName">Customer Profile</h2>
            <p style="color: #666; margin-top: 5px;" id="profileCustomerContact">Contact information</p>
          </div>
          <button class="btn-primary" onclick="editCustomerFromProfile()">
            <i class="fas fa-edit"></i> Edit Customer
          </button>
        </div>
      </div>

      <!-- Customer Info Card -->
      <div class="card" style="margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
          <div>
            <h4 style="color: #2e5940; margin-bottom: 15px; font-size: 16px; font-weight: 600;">
              <i class="fas fa-user"></i> Basic Information
            </h4>
            <div style="line-height: 1.8;">
              <div><strong>Status:</strong> <span id="profileStatus"></span></div>
              <div><strong>AI Score:</strong> <span id="profileAIScore"></span></div>
              <div><strong>Lead Source:</strong> <span id="profileLeadSource"></span></div>
              <div><strong>Industry:</strong> <span id="profileIndustry"></span></div>
              <div><strong>Age Range:</strong> <span id="profileAgeRange"></span></div>
            </div>
          </div>
          
          <div>
            <h4 style="color: #2e5940; margin-bottom: 15px; font-size: 16px; font-weight: 600;">
              <i class="fas fa-envelope"></i> Contact Details
            </h4>
            <div style="line-height: 1.8;">
              <div><strong>Email:</strong> <span id="profileEmail"></span></div>
              <div><strong>Home Phone:</strong> <span id="profileHomePhone"></span></div>
              <div><strong>Mobile Phone:</strong> <span id="profileMobilePhone"></span></div>
              <div><strong>Preferred Contact:</strong> <span id="profileContactMethod"></span></div>
              <div><strong>Best Time:</strong> <span id="profileContactTime"></span></div>
            </div>
          </div>
          
          <div>
            <h4 style="color: #2e5940; margin-bottom: 15px; font-size: 16px; font-weight: 600;">
              <i class="fas fa-map-marker-alt"></i> Address
            </h4>
            <div style="line-height: 1.8;">
              <div><strong>Billing:</strong></div>
              <div id="profileBillingAddress" style="margin-left: 10px; color: #666;"></div>
              <div style="margin-top: 10px;"><strong>Shipping:</strong></div>
              <div id="profileShippingAddress" style="margin-left: 10px; color: #666;"></div>
            </div>
          </div>
          
          <div>
            <h4 style="color: #2e5940; margin-bottom: 15px; font-size: 16px; font-weight: 600;">
              <i class="fas fa-table-tennis"></i> Pickleball Profile
            </h4>
            <div style="line-height: 1.8;">
              <div><strong>Skill Level:</strong> <span id="profileSkillLevel"></span></div>
              <div><strong>Play Frequency:</strong> <span id="profilePlayFrequency"></span></div>
              <div><strong>Paddle Brand:</strong> <span id="profilePaddleBrand"></span></div>
              <div><strong>Product Interests:</strong> <span id="profileProductInterests"></span></div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e8f5e9;">
          <h4 style="color: #2e5940; margin-bottom: 15px; font-size: 16px; font-weight: 600;">
            <i class="fas fa-users"></i> Referral Information
          </h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div><strong>Referral Code:</strong> <span id="profileReferralCode" style="color: #66bb6a; font-family: monospace;"></span></div>
            <div><strong>Referrals Made:</strong> <span id="profileReferralsMade"></span></div>
            <div><strong>Referral Credits:</strong> <span id="profileReferralCredits"></span></div>
            <div><strong>Potential Referrals:</strong> <span id="profilePotentialReferrals"></span></div>
          </div>
        </div>
        
        <div id="profileNotes" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e8f5e9; display: none;">
          <h4 style="color: #2e5940; margin-bottom: 10px; font-size: 16px; font-weight: 600;">
            <i class="fas fa-sticky-note"></i> Notes
          </h4>
          <p id="profileNotesContent" style="color: #666; line-height: 1.6;"></p>
        </div>
      </div>

      <!-- Activity Tabs -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
        <div class="card" style="text-align: center; cursor: pointer;" onclick="switchProfileTab('orders')">
          <div style="font-size: 36px; font-weight: 700; color: #66bb6a;" id="profileOrdersCount">0</div>
          <div style="color: #666; margin-top: 5px;">Orders</div>
        </div>
        <div class="card" style="text-align: center; cursor: pointer;" onclick="switchProfileTab('communications')">
          <div style="font-size: 36px; font-weight: 700; color: #42a5f5;" id="profileCommunicationsCount">0</div>
          <div style="color: #666; margin-top: 5px;">Communications</div>
        </div>
        <div class="card" style="text-align: center; cursor: pointer;" onclick="switchProfileTab('tasks')">
          <div style="font-size: 36px; font-weight: 700; color: #ffa726;" id="profileTasksCount">0</div>
          <div style="color: #666; margin-top: 5px;">Tasks</div>
        </div>
      </div>

      <!-- Orders Tab -->
      <div id="profileOrdersTab" class="card">
        <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
          <i class="fas fa-shopping-cart"></i> Order History
        </h3>
        <div id="profileOrdersList"></div>
      </div>

      <!-- Communications Tab -->
      <div id="profileCommunicationsTab" class="card" style="display: none;">
        <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
          <i class="fas fa-comments"></i> Communications History
        </h3>
        <div id="profileCommunicationsList"></div>
      </div>

      <!-- Tasks Tab -->
      <div id="profileTasksTab" class="card" style="display: none;">
        <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
          <i class="fas fa-tasks"></i> Tasks
        </h3>
        <div id="profileTasksList"></div>
      </div>
    </div>

    <!-- Calendar View -->
    <div id="calendarView" class="view" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
          <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;">Calendar</h2>
          <p style="color: #666; margin-top: 5px;">Schedule and track events</p>
        </div>
        <button class="btn-primary" onclick="openEventModal()">
          <i class="fas fa-plus"></i> New Event
        </button>
      </div>

      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <button class="btn-secondary" onclick="changeMonth(-1)">
            <i class="fas fa-chevron-left"></i>
          </button>
          <h3 id="calendarTitle" style="color: #2e5940; font-size: 20px; font-weight: 600;"></h3>
          <button class="btn-secondary" onclick="changeMonth(1)">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <div class="calendar-grid">
          <div style="text-align: center; font-weight: 600; padding: 10px; color: #2e5940;">Sun</div>
          <div style="text-align: center; font-weight: 600; padding: 10px; color: #2e5940;">Mon</div>
          <div style="text-align: center; font-weight: 600; padding: 10px; color: #2e5940;">Tue</div>
          <div style="text-align: center; font-weight: 600; padding: 10px; color: #2e5940;">Wed</div>
          <div style="text-align: center; font-weight: 600; padding: 10px; color: #2e5940;">Thu</div>
          <div style="text-align: center; font-weight: 600; padding: 10px; color: #2e5940;">Fri</div>
          <div style="text-align: center; font-weight: 600; padding: 10px; color: #2e5940;">Sat</div>
        </div>
        <div id="calendarDays" class="calendar-grid"></div>
      </div>
    </div>

    <!-- Communications View -->
    <div id="communicationsView" class="view" style="display: none;">
      <div style="margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;">
              <i class="fas fa-comments"></i> Communications
            </h2>
            <p style="color: #666; margin-top: 5px;">All customer communications in one place</p>
          </div>
          <!-- View Toggle -->
          <div style="display: flex; gap: 10px; background: #f1f8e9; padding: 5px; border-radius: 8px;">
            <button id="commViewAll" class="btn-secondary" 
                    style="background: #66bb6a; color: white; border: none;" 
                    onclick="switchCommView('all')">
              <i class="fas fa-list"></i> All Communications
            </button>
            <button id="commViewByCustomer" class="btn-secondary" 
                    onclick="switchCommView('byCustomer')">
              <i class="fas fa-users"></i> By Customer
            </button>
          </div>
        </div>
      </div>

      <!-- View 1: All Communications (Filter & Search) -->
      <div id="commAllView">
        <!-- Filter Bar -->
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
            <div>
              <label style="display: block; color: #666; font-size: 14px; margin-bottom: 5px;">Search</label>
              <input type="text" id="commSearchInput" placeholder="Search communications..." 
                     style="width: 100%; padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px;" 
                     onkeyup="filterCommunications()">
            </div>
            <div>
              <label style="display: block; color: #666; font-size: 14px; margin-bottom: 5px;">Customer</label>
              <select id="commCustomerFilter" onchange="filterCommunications()" 
                      style="width: 100%; padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px;">
                <option value="">All Customers</option>
              </select>
            </div>
            <div>
              <label style="display: block; color: #666; font-size: 14px; margin-bottom: 5px;">Type</label>
              <select id="commTypeFilter" onchange="filterCommunications()" 
                      style="width: 100%; padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px;">
                <option value="">All Types</option>
                <option value="email">Email</option>
                <option value="phone">Phone</option>
                <option value="meeting">Meeting</option>
                <option value="text">Text</option>
              </select>
            </div>
            <div>
              <button class="btn-primary" onclick="openCommunicationModal()">
                <i class="fas fa-plus"></i> Add Communication
              </button>
            </div>
          </div>
        </div>

        <!-- Communications List -->
        <div id="allCommunicationsList"></div>
        
        <!-- Empty State -->
        <div id="commEmptyState" style="display: none; text-align: center; padding: 60px 20px;">
          <i class="fas fa-comments" style="font-size: 64px; color: #c8e6c9; margin-bottom: 20px;"></i>
          <h3 style="color: #666; margin-bottom: 10px;">No communications found</h3>
          <p style="color: #999;">Start by adding your first communication or adjust your filters</p>
          <button class="btn-primary" onclick="openCommunicationModal()" style="margin-top: 20px;">
            <i class="fas fa-plus"></i> Add Communication
          </button>
        </div>
      </div>

      <!-- View 2: By Customer (Quick Add) -->
      <div id="commByCustomerView" style="display: none;">
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; gap: 15px; align-items: center;">
            <div style="flex: 1;">
              <input type="text" id="commCustomerSearchBox" placeholder="Search customers by name, city, state, or zip..." 
                     style="width: 100%; padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px;" 
                     onkeyup="filterCustomerListForComm()">
            </div>
          </div>
        </div>

        <!-- Customer List with Quick Add Buttons -->
        <div id="commCustomerList"></div>
        
        <!-- Empty State -->
        <div id="commCustomerEmptyState" style="display: none; text-align: center; padding: 60px 20px;">
          <i class="fas fa-users" style="font-size: 64px; color: #c8e6c9; margin-bottom: 20px;"></i>
          <h3 style="color: #666; margin-bottom: 10px;">No customers found</h3>
          <p style="color: #999;">Add customers first, then you can log communications with them</p>
        </div>
      </div>
    </div>

    <!-- Tasks View -->
    <div id="tasksView" class="view" style="display: none;">
      <div style="margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;">
              <i class="fas fa-tasks"></i> Tasks & Follow-ups
            </h2>
            <p style="color: #666; margin-top: 5px;">Manage all customer tasks and reminders</p>
          </div>
          <!-- View Toggle -->
          <div style="display: flex; gap: 10px; background: #f1f8e9; padding: 5px; border-radius: 8px;">
            <button id="taskViewAll" class="btn-secondary" 
                    style="background: #66bb6a; color: white; border: none;" 
                    onclick="switchTaskView('all')">
              <i class="fas fa-list"></i> All Tasks
            </button>
            <button id="taskViewByCustomer" class="btn-secondary" 
                    onclick="switchTaskView('byCustomer')">
              <i class="fas fa-users"></i> By Customer
            </button>
          </div>
        </div>
      </div>

      <!-- View 1: All Tasks (Filter & Search) -->
      <div id="taskAllView">
        <!-- Filter Bar -->
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
            <div>
              <label style="display: block; color: #666; font-size: 14px; margin-bottom: 5px;">Search</label>
              <input type="text" id="taskSearchInput" placeholder="Search tasks..." 
                     style="width: 100%; padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px;" 
                     onkeyup="filterTasks()">
            </div>
            <div>
              <label style="display: block; color: #666; font-size: 14px; margin-bottom: 5px;">Customer</label>
              <select id="taskCustomerFilter" onchange="filterTasks()" 
                      style="width: 100%; padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px;">
                <option value="">All Customers</option>
              </select>
            </div>
            <div>
              <label style="display: block; color: #666; font-size: 14px; margin-bottom: 5px;">Priority</label>
              <select id="taskPriorityFilter" onchange="filterTasks()" 
                      style="width: 100%; padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px;">
                <option value="">All Priorities</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div>
              <label style="display: block; color: #666; font-size: 14px; margin-bottom: 5px;">Status</label>
              <select id="taskStatusFilter" onchange="filterTasks()" 
                      style="width: 100%; padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px;">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            <div>
              <button class="btn-primary" onclick="openTaskModal()">
                <i class="fas fa-plus"></i> Add Task
              </button>
            </div>
          </div>
        </div>

        <!-- Tasks List -->
        <div id="allTasksList"></div>
        
        <!-- Empty State -->
        <div id="taskEmptyState" style="display: none; text-align: center; padding: 60px 20px;">
          <i class="fas fa-tasks" style="font-size: 64px; color: #c8e6c9; margin-bottom: 20px;"></i>
          <h3 style="color: #666; margin-bottom: 10px;">No tasks found</h3>
          <p style="color: #999;">Start by adding your first task or adjust your filters</p>
          <button class="btn-primary" onclick="openTaskModal()" style="margin-top: 20px;">
            <i class="fas fa-plus"></i> Add Task
          </button>
        </div>
      </div>

      <!-- View 2: By Customer (Quick Add) -->
      <div id="taskByCustomerView" style="display: none;">
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; gap: 15px; align-items: center;">
            <div style="flex: 1;">
              <input type="text" id="taskCustomerSearchBox" placeholder="Search customers by name, city, state, or zip..." 
                     style="width: 100%; padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px;" 
                     onkeyup="filterCustomerListForTask()">
            </div>
          </div>
        </div>

        <!-- Customer List with Quick Add Buttons -->
        <div id="taskCustomerList"></div>
        
        <!-- Empty State -->
        <div id="taskCustomerEmptyState" style="display: none; text-align: center; padding: 60px 20px;">
          <i class="fas fa-users" style="font-size: 64px; color: #c8e6c9; margin-bottom: 20px;"></i>
          <h3 style="color: #666; margin-bottom: 10px;">No customers found</h3>
          <p style="color: #999;">Add customers first, then you can create tasks for them</p>
        </div>
      </div>
    </div>

    <!-- Pipeline View -->
    <div id="pipelineView" class="view" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
          <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;">Sales Pipeline</h2>
          <p style="color: #666; margin-top: 5px;">Track prospects through your sales funnel</p>
        </div>
        <button class="btn-primary" onclick="openCustomerModal(null, 'prospect')">
          <i class="fas fa-plus"></i> New Prospect
        </button>
      </div>

      <div class="grid-3">
        <div class="card">
          <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
            <i class="fas fa-search"></i> Prospects
          </h3>
          <div id="prospectsList"></div>
        </div>
        <div class="card">
          <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
            <i class="fas fa-check-circle"></i> Active Customers
          </h3>
          <div id="activeList"></div>
        </div>
        <div class="card">
          <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
            <i class="fas fa-exclamation-circle"></i> Inactive Customers
          </h3>
          <div id="inactiveList"></div>
        </div>
      </div>
    </div>

    <!-- Analytics View -->
    <div id="analyticsView" class="view" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
          <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;">Analytics</h2>
          <p style="color: #666; margin-top: 5px;">Gain insights from your CRM data</p>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
            <i class="fas fa-chart-pie"></i> Lead Sources
          </h3>
          <canvas id="leadSourceChart"></canvas>
        </div>

        <div class="card">
          <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
            <i class="fas fa-chart-bar"></i> Social Platforms
          </h3>
          <canvas id="socialChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
          <i class="fas fa-chart-line"></i> Revenue Trend
        </h3>
        <canvas id="revenueChart"></canvas>
      </div>

      <div class="card">
        <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
          <i class="fas fa-brain"></i> AI Insights
        </h3>
        <div id="aiInsights"></div>
      </div>
    </div>

    <!-- Marketing View -->
    <div id="marketingView" class="view" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
          <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;">Marketing</h2>
          <p style="color: #666; margin-top: 5px;">Plan and execute marketing campaigns</p>
        </div>
      </div>

      <div class="card">
        <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
          <i class="fas fa-lightbulb"></i> Campaign Recommendations
        </h3>
        <div id="marketingRecommendations"></div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
            <i class="fas fa-star"></i> High-Value Customers
          </h3>
          <div id="highValueCustomers"></div>
        </div>

        <div class="card">
          <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
            <i class="fas fa-gift"></i> Referral Opportunities
          </h3>
          <div id="referralOpportunities"></div>
        </div>
      </div>
    </div>

    <!-- Referrals View -->
    <div id="referralsView" class="view" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
          <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;">Referral Program</h2>
          <p style="color: #666; margin-top: 5px;">Manage referrals and reward your customers</p>
        </div>
        <button class="btn-primary" onclick="openReferralSettings()">
          <i class="fas fa-cog"></i> Settings
        </button>
      </div>

      <div class="card">
        <h3 style="color: #2e5940; font-size: 18px; margin-bottom: 15px;">
          <i class="fas fa-medal"></i> Referral Leaderboard
        </h3>
        <div id="referralLeaderboard"></div>
      </div>
    </div>

    <!-- Enterprise Blueprint View -->
    <div id="blueprintView" class="view" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
          <h2 style="color: #2e5940; font-size: 28px; font-weight: 700;">Enterprise CRM Blueprint</h2>
          <p style="color: #666; margin-top: 5px;">7 Pillars of a Full-Scale System</p>
        </div>
      </div>
      <div class="card" style="margin-bottom: 20px;">
        <p style="margin-bottom: 15px;">As a CRM architect, I understand that the initial application is merely the tip of the iceberg. A true Enterprise Customer Relationship Management system must be structurally sound, highly integrated, and capable of driving strategic business decisions across all departments.</p>
        <p>The following seven pillars define the critical categories and essential features required for a full-scale implementation, moving beyond simple customer lists to holistic relationship management.</p>
        <p>This framework provides the necessary structure for scaling AcoustiSkin's CRM system.</p>
      </div>

      <div class="card" style="margin-bottom: 20px;">
        <h3 style="color: #2e5940; font-size: 20px; margin-bottom: 10px;">1. Core Data Management (CDM)</h3>
        <p style="margin-bottom: 15px;">The foundation of the entire system. Data must be unified, clean, and structured to support all downstream processes.</p>
        <table class="table">
          <thead>
            <tr>
              <th>Sub-Category</th>
              <th>Essential Features</th>
              <th>AcoustiSkin Relevance</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Customer/Contact Profiles</td>
              <td>Single Source of Truth (SSOT), GDPR/CCPA compliance flags, Hierarchical roles (e.g., Buyer vs. Coach).</td>
              <td>Linking multiple paddle manufacturers, social media, and physical address data for targeted communication.</td>
            </tr>
            <tr>
              <td>Account Management</td>
              <td>Corporate account structure, legal entity details, billing contacts, parent/child relationships.</td>
              <td>Managing retailer accounts, sponsorship teams, or leagues (Accounts) that contain individual players (Contacts).</td>
            </tr>
            <tr>
              <td>Data Quality & Hygiene</td>
              <td>Duplicate detection and merging tools, data validation rules (e.g., email format), mass data update capabilities.</td>
              <td>Ensuring every referral code is unique and tied to a verified email address to prevent abuse and maintain clean reporting.</td>
            </tr>
            <tr>
              <td>Activity Tracking</td>
              <td>Comprehensive log of every interaction: calls, emails, meetings, SMS, In-App Messaging.</td>
              <td>Tracking which customer views the referral code, clicks the sharing link, and which team member last contacted them.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card" style="margin-bottom: 20px;">
        <h3 style="color: #2e5940; font-size: 20px; margin-bottom: 10px;">2. Sales Force Automation (SFA)</h3>
        <p style="margin-bottom: 15px;">Moving relationships from prospect to committed buyer, focusing on efficiency and revenue generation.</p>
        <table class="table">
          <thead>
            <tr>
              <th>Sub-Category</th>
              <th>Essential Features</th>
              <th>AcoustiSkin Relevance</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Lead Management</td>
              <td>Lead scoring (e.g., based on website visits, demo requests), automated assignment rules, lead conversion process.</td>
              <td>Scoring potential brand advocates (Leads) based on social influence or paddle tournament ranking, and automatically assigning them to a Brand Ambassador (Sales Rep).</td>
            </tr>
            <tr>
              <td>Opportunity Management</td>
              <td>Configurable sales pipeline stages, probability metrics, competitive tracking, dynamic product catalogs.</td>
              <td>Managing bulk sponsorship deals or large retail inventory orders through structured stages (Prospecting, Negotiation, Closed/Won).</td>
            </tr>
            <tr>
              <td>Sales Forecasting</td>
              <td>Weighted pipeline summation, AI-driven prediction models, historical data analysis, forecast hierarchies.</td>
              <td>Predicting quarterly sales volumes for specific paddle cover models based on current opportunity stages and historical closure rates.</td>
            </tr>
            <tr>
              <td>Quote-to-Cash (QTC)</td>
              <td>Generation of quotes, approval workflows, integration with billing systems (ERP).</td>
              <td>Generating professional proposals for sponsored athletes detailing product costs and credit allocations.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card" style="margin-bottom: 20px;">
        <h3 style="color: #2e5940; font-size: 20px; margin-bottom: 10px;">3. Marketing Automation (MA)</h3>
        <p style="margin-bottom: 15px;">Tools to segment customers, execute multi-channel campaigns, and measure ROI.</p>
        <table class="table">
          <thead>
            <tr>
              <th>Sub-Category</th>
              <th>Essential Features</th>
              <th>AcoustiSkin Relevance</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Segmentation</td>
              <td>Dynamic list creation based on attributes (e.g., manufacturer, location, purchase history, credits earned).</td>
              <td>Targeting users who prefer Joola with a custom cover design campaign, or users with 5+ credits with a loyalty email.</td>
            </tr>
            <tr>
              <td>Campaign Management</td>
              <td>Multi-step email and SMS journey builders, A/B testing, scheduling, and throttle control.</td>
              <td>Automated onboarding drip campaigns for new customers, or re-engagement campaigns for customers who haven't used their referral code.</td>
            </tr>
            <tr>
              <td>Social Media Monitoring</td>
              <td>Listening tools integrated with social profiles (e.g., Instagram, X), automated sentiment analysis, direct engagement logging.</td>
              <td>Automatically logging mentions of "AcoustiSkin" and routing negative feedback to the Service team while identifying positive mentions for the Sales team.</td>
            </tr>
            <tr>
              <td>Web & Forms</td>
              <td>Landing page builder, web form capture, and Progressive Profiling (gathering more data over time).</td>
              <td>Capturing paddle preference and playing style directly from the website and feeding that data into the CRM customer profile.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card" style="margin-bottom: 20px;">
        <h3 style="color: #2e5940; font-size: 20px; margin-bottom: 10px;">4. Customer Service & Support (CSS)</h3>
        <p style="margin-bottom: 15px;">Managing post-sale interaction to ensure satisfaction and loyalty.</p>
        <table class="table">
          <thead>
            <tr>
              <th>Sub-Category</th>
              <th>Essential Features</th>
              <th>AcoustiSkin Relevance</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Case & Ticket Management</td>
              <td>Queue management, Service Level Agreements (SLAs), escalation rules, omnichannel intake (email, phone, chat).</td>
              <td>Tracking issues like product defects, warranty claims, or referral code failures from first report to resolution.</td>
            </tr>
            <tr>
              <td>Knowledge Base (KB)</td>
              <td>Internal and external self-service articles, controlled publishing workflows, search analytics to find knowledge gaps.</td>
              <td>Providing customers with a portal to check referral code status and find troubleshooting guides for applying paddle covers.</td>
            </tr>
            <tr>
              <td>Entitlements & Warranties</td>
              <td>Service contracts, product lifetime tracking, warranty claim initiation linked directly to the product ID (e.g., paddle cover serial number).</td>
              <td>Ensuring that only customers within their warranty period can submit certain types of support tickets.</td>
            </tr>
            <tr>
              <td>Field Service Integration</td>
              <td>Scheduling, resource optimization, mobile access for technicians or Brand Ambassadors (if conducting on-site events).</td>
              <td>Scheduling a Brand Ambassador to conduct a promotional demo at a local tournament.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card" style="margin-bottom: 20px;">
        <h3 style="color: #2e5940; font-size: 20px; margin-bottom: 10px;">5. Analytics & Reporting (A&R)</h3>
        <p style="margin-bottom: 15px;">Translating data into actionable insights for the business.</p>
        <table class="table">
          <thead>
            <tr>
              <th>Sub-Category</th>
              <th>Essential Features</th>
              <th>AcoustiSkin Relevance</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Custom Dashboards</td>
              <td>Role-based visualizations (Executive, Sales, Marketing), real-time data feeds, historical comparisons.</td>
              <td>An Executive dashboard showing Customer Lifetime Value (CLV) vs. Cost of Acquisition (CAC).</td>
            </tr>
            <tr>
              <td>Business Intelligence (BI) Integration</td>
              <td>Seamless connection to enterprise tools like Tableau or Power BI for complex data modeling.</td>
              <td>Allowing the Finance department to run advanced models on referral liability and forecasting future credit redemption rates.</td>
            </tr>
            <tr>
              <td>Predictive & Prescriptive AI</td>
              <td>Next Best Action recommendations, churn prediction, automated customer health scores.</td>
              <td>Using AI to suggest the next marketing action (e.g., "Send personalized email") or flag a customer who is likely to stop using the referral code.</td>
            </tr>
            <tr>
              <td>Data Export & Audit Trails</td>
              <td>Scheduled data dumps for compliance, full historical log of data changes (who, when, what changed).</td>
              <td>Maintaining a permanent record of all credit transactions and customer consent settings.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card" style="margin-bottom: 20px;">
        <h3 style="color: #2e5940; font-size: 20px; margin-bottom: 10px;">6. Integration & Ecosystem (I&E)</h3>
        <p style="margin-bottom: 15px;">The ability to seamlessly connect the CRM with other essential enterprise systems.</p>
        <table class="table">
          <thead>
            <tr>
              <th>Sub-Category</th>
              <th>Essential Features</th>
              <th>AcoustiSkin Relevance</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>ERP (Enterprise Resource Planning)</td>
              <td>Bi-directional synchronization of Inventory, Orders, and Financial data (e.g., SAP, Oracle).</td>
              <td>Connecting the 'Orders' data page directly to the warehouse system to confirm stock levels before processing a redeemed credit order.</td>
            </tr>
            <tr>
              <td>SCM (Supply Chain Management)</td>
              <td>Visibility into product sourcing and delivery timelines.</td>
              <td>Informing a customer service agent instantly if a specific paddle cover color is delayed due to supply chain issues.</td>
            </tr>
            <tr>
              <td>API Framework</td>
              <td>Robust, well-documented RESTful and GraphQL APIs for all core objects to facilitate custom external integrations.</td>
              <td>Allowing a third-party tournament registration platform to create new customer contacts directly in the AcoustiSkin CRM.</td>
            </tr>
            <tr>
              <td>Partner Portal</td>
              <td>Dedicated, secure access for resellers, distributors, or, in this case, Brand Ambassadors.</td>
              <td>Giving Ambassadors a secure view of their referral code usage, credit balance, and performance dashboard.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card" style="margin-bottom: 20px;">
        <h3 style="color: #2e5940; font-size: 20px; margin-bottom: 10px;">7. Technical & Governance (T&G)</h3>
        <p style="margin-bottom: 15px;">Ensuring the platform is secure, available, and compliant globally.</p>
        <table class="table">
          <thead>
            <tr>
              <th>Sub-Category</th>
              <th>Essential Features</th>
              <th>AcoustiSkin Relevance</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Security & Authentication</td>
              <td>Role-Based Access Control (RBAC), Single Sign-On (SSO) integration, encryption at rest and in transit.</td>
              <td>Ensuring that Marketing users can only view contact details, while Sales can edit them, and Ambassadors can only view their own performance metrics.</td>
            </tr>
            <tr>
              <td>Scalability & Performance</td>
              <td>Load balancing, regional data centers, caching mechanisms, support for millions of simultaneous records and users.</td>
              <td>Guaranteed low latency even during high-traffic periods following a major product launch or tournament.</td>
            </tr>
            <tr>
              <td>Compliance & Regulation</td>
              <td>Tools for managing data residency (e.g., required for EU data), explicit opt-in/opt-out tracking for communications.</td>
              <td>Automatically flagging customers whose data must be stored within the EU (GDPR) and ensuring all emails include a valid unsubscribe link.</td>
            </tr>
            <tr>
              <td>Disaster Recovery</td>
              <td>Point-in-time recovery, geo-redundancy, and tested business continuity plans.</td>
              <td>Guaranteeing less than 1 hour of downtime during a critical hardware failure.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Customer Modal WITH PHASE2 TABS -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
          <i class="fas fa-user-plus"></i> <span id="customerModalTitle">Add New Customer</span>
        </h3>
        <button onclick="closeModal('customerModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="customerForm" onsubmit="saveCustomer(event)">
        <input type="hidden" id="customerId">

        <!-- Basic Information -->
        <div class="section-header">
          <i class="fas fa-info-circle"></i> Basic Information
        </div>
        <div class="grid-2">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="customerName" required>
          </div>
          <div class="form-group">
            <label>Contact Type *</label>
            <select id="customerContact" required>
              <option value="">Select...</option>
              <option value="Individual">Individual</option>
              <option value="Business">Business</option>
              <option value="Organization">Organization</option>
            </select>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="customerEmail">
          </div>
          <div class="form-group">
            <label>Home Number</label>
            <input type="tel" id="customerHomePhone">
          </div>
        </div>

        <div class="grid-3">
          <div class="form-group">
            <label>Mobile Number</label>
            <input type="tel" id="customerMobilePhone">
          </div>
          <div class="form-group">
            <label>Status *</label>
            <select id="customerStatus" required>
              <option value="Prospect">Prospect</option>
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
          <div class="form-group">
            <label>Industry</label>
            <input type="text" id="customerIndustry" placeholder="e.g., Healthcare, Tech">
          </div>
        </div>

        <div class="form-group">
          <label>Age Range</label>
          <select id="customerAgeRange">
            <option value="">Select...</option>
            <option value="18-24">18-24</option>
            <option value="25-34">25-34</option>
            <option value="35-44">35-44</option>
            <option value="45-54">45-54</option>
            <option value="55-64">55-64</option>
            <option value="65+">65+</option>
          </select>
        </div>
        <!-- PHASE 1 TABS - Only visible when editing existing customer -->
        <!-- Customer History Links -->
        <div class="info-box" style="background: #e8f5e9; border-left: 4px solid #66bb6a;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
              <strong style="color: #2e5940;">
                <i class="fas fa-history"></i> Customer History
              </strong>
              <p style="margin-top: 5px; font-size: 13px; color: #666;">
                View this customer's communications, tasks, and purchase history
              </p>
            </div>
            <div style="display: flex; gap: 10px;">
              <button type="button" class="btn-secondary" style="font-size: 13px; padding: 8px 12px;" 
                      onclick="viewCustomerHistory('communications')">
                <i class="fas fa-comments"></i> Communications
              </button>
              <button type="button" class="btn-secondary" style="font-size: 13px; padding: 8px 12px;" 
                      onclick="viewCustomerHistory('tasks')">
                <i class="fas fa-tasks"></i> Tasks
              </button>
              <button type="button" class="btn-secondary" style="font-size: 13px; padding: 8px 12px;" 
                      onclick="viewCustomerHistory('purchases')">
                <i class="fas fa-shopping-cart"></i> Purchases
              </button>
            </div>
          </div>
        </div>

        <!-- Billing Address -->
        <div class="section-header">
          <i class="fas fa-map-marker-alt"></i> Billing Address
        </div>
        <div class="form-group">
          <label>Street Address</label>
          <input type="text" id="customerBillingStreet" placeholder="123 Main St">
        </div>
        <div class="grid-3">
          <div class="form-group">
            <label>City</label>
            <input type="text" id="customerBillingCity">
          </div>
          <div class="form-group">
            <label>State</label>
            <select id="customerBillingState">
              <option value="">Select...</option>
              <option value="AL">Alabama</option>
              <option value="AK">Alaska</option>
              <option value="AZ">Arizona</option>
              <option value="AR">Arkansas</option>
              <option value="CA">California</option>
              <option value="CO">Colorado</option>
              <option value="CT">Connecticut</option>
              <option value="DE">Delaware</option>
              <option value="FL">Florida</option>
              <option value="GA">Georgia</option>
              <option value="HI">Hawaii</option>
              <option value="ID">Idaho</option>
              <option value="IL">Illinois</option>
              <option value="IN">Indiana</option>
              <option value="IA">Iowa</option>
              <option value="KS">Kansas</option>
              <option value="KY">Kentucky</option>
              <option value="LA">Louisiana</option>
              <option value="ME">Maine</option>
              <option value="MD">Maryland</option>
              <option value="MA">Massachusetts</option>
              <option value="MI">Michigan</option>
              <option value="MN">Minnesota</option>
              <option value="MS">Mississippi</option>
              <option value="MO">Missouri</option>
              <option value="MT">Montana</option>
              <option value="NE">Nebraska</option>
              <option value="NV">Nevada</option>
              <option value="NH">New Hampshire</option>
              <option value="NJ">New Jersey</option>
              <option value="NM">New Mexico</option>
              <option value="NY">New York</option>
              <option value="NC">North Carolina</option>
              <option value="ND">North Dakota</option>
              <option value="OH">Ohio</option>
              <option value="OK">Oklahoma</option>
              <option value="OR">Oregon</option>
              <option value="PA">Pennsylvania</option>
              <option value="RI">Rhode Island</option>
              <option value="SC">South Carolina</option>
              <option value="SD">South Dakota</option>
              <option value="TN">Tennessee</option>
              <option value="TX">Texas</option>
              <option value="UT">Utah</option>
              <option value="VT">Vermont</option>
              <option value="VA">Virginia</option>
              <option value="WA">Washington</option>
              <option value="WV">West Virginia</option>
              <option value="WI">Wisconsin</option>
              <option value="WY">Wyoming</option>
            </select>
          </div>
          <div class="form-group">
            <label>Zip Code</label>
            <input type="text" id="customerBillingZip" placeholder="12345">
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="section-header">
          <i class="fas fa-shipping-fast"></i> Shipping Address
        </div>
        
        <div class="form-group">
          <div class="checkbox-item" style="margin-bottom: 15px;">
            <input type="checkbox" id="sameAsBilling" onchange="copySameAsBilling()">
            <label for="sameAsBilling" style="margin: 0; font-weight: normal;">Same as billing address</label>
          </div>
        </div>

        <div class="form-group">
          <label>Street Address</label>
          <input type="text" id="customerShippingStreet" placeholder="123 Main St">
        </div>
        <div class="grid-3">
          <div class="form-group">
            <label>City</label>
            <input type="text" id="customerShippingCity">
          </div>
          <div class="form-group">
            <label>State</label>
            <select id="customerShippingState">
              <option value="">Select...</option>
              <option value="AL">Alabama</option>
              <option value="AK">Alaska</option>
              <option value="AZ">Arizona</option>
              <option value="AR">Arkansas</option>
              <option value="CA">California</option>
              <option value="CO">Colorado</option>
              <option value="CT">Connecticut</option>
              <option value="DE">Delaware</option>
              <option value="FL">Florida</option>
              <option value="GA">Georgia</option>
              <option value="HI">Hawaii</option>
              <option value="ID">Idaho</option>
              <option value="IL">Illinois</option>
              <option value="IN">Indiana</option>
              <option value="IA">Iowa</option>
              <option value="KS">Kansas</option>
              <option value="KY">Kentucky</option>
              <option value="LA">Louisiana</option>
              <option value="ME">Maine</option>
              <option value="MD">Maryland</option>
              <option value="MA">Massachusetts</option>
              <option value="MI">Michigan</option>
              <option value="MN">Minnesota</option>
              <option value="MS">Mississippi</option>
              <option value="MO">Missouri</option>
              <option value="MT">Montana</option>
              <option value="NE">Nebraska</option>
              <option value="NV">Nevada</option>
              <option value="NH">New Hampshire</option>
              <option value="NJ">New Jersey</option>
              <option value="NM">New Mexico</option>
              <option value="NY">New York</option>
              <option value="NC">North Carolina</option>
              <option value="ND">North Dakota</option>
              <option value="OH">Ohio</option>
              <option value="OK">Oklahoma</option>
              <option value="OR">Oregon</option>
              <option value="PA">Pennsylvania</option>
              <option value="RI">Rhode Island</option>
              <option value="SC">South Carolina</option>
              <option value="SD">South Dakota</option>
              <option value="TN">Tennessee</option>
              <option value="TX">Texas</option>
              <option value="UT">Utah</option>
              <option value="VT">Vermont</option>
              <option value="VA">Virginia</option>
              <option value="WA">Washington</option>
              <option value="WV">West Virginia</option>
              <option value="WI">Wisconsin</option>
              <option value="WY">Wyoming</option>
            </select>
          </div>
          <div class="form-group">
            <label>Zip Code</label>
            <input type="text" id="customerShippingZip" placeholder="12345">
          </div>
        </div>

        <!-- Lead Information -->
        <div class="section-header">
          <i class="fas fa-bullseye"></i> Lead Information
        </div>
        <div class="grid-2">
          <div class="form-group">
            <label>Lead Source</label>
            <select id="customerLeadSource">
              <option value="">Select...</option>
              <option value="Google">Google Search</option>
              <option value="Facebook">Facebook</option>
              <option value="Instagram">Instagram</option>
              <option value="Twitter">Twitter/X</option>
              <option value="LinkedIn">LinkedIn</option>
              <option value="TikTok">TikTok</option>
              <option value="Referral">Customer Referral</option>
              <option value="Tournament">Pickleball Tournament</option>
              <option value="Club">Pickleball Club</option>
              <option value="Website">Direct Website</option>
              <option value="Email">Email Campaign</option>
              <option value="Event">Event/Trade Show</option>
              <option value="Retail">Retail Store</option>
              <option value="Partner">Partner/Affiliate</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Referred By (Customer Name)</label>
            <input type="text" id="customerReferrer" placeholder="If applicable">
          </div>
        </div>

        <!-- Social Media -->
        <div class="section-header">
          <i class="fas fa-share-alt"></i> Social Media
        </div>
        <div class="form-group">
          <label>Active Social Platforms</label>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="social_facebook" value="Facebook">
              <label for="social_facebook">Facebook</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="social_instagram" value="Instagram">
              <label for="social_instagram">Instagram</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="social_twitter" value="Twitter/X">
              <label for="social_twitter">Twitter/X</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="social_tiktok" value="TikTok">
              <label for="social_tiktok">TikTok</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="social_youtube" value="YouTube">
              <label for="social_youtube">YouTube</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="social_linkedin" value="LinkedIn">
              <label for="social_linkedin">LinkedIn</label>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Primary Social Handle</label>
            <input type="text" id="customerSocialHandle" placeholder="@username">
          </div>
          <div class="form-group">
            <label>Social Engagement Level</label>
            <select id="customerSocialEngagement">
              <option value="">Select...</option>
              <option value="Very High">Very High (Daily posts)</option>
              <option value="High">High (Several times/week)</option>
              <option value="Medium">Medium (Weekly)</option>
              <option value="Low">Low (Occasional)</option>
              <option value="None">None/Not Active</option>
            </select>
          </div>
        </div>

        <!-- Pickleball Profile -->
        <div class="section-header">
          <i class="fas fa-table-tennis"></i> Pickleball Profile
        </div>
        <div class="grid-3">
          <div class="form-group">
            <label>Skill Level</label>
            <select id="customerSkillLevel">
              <option value="">Select...</option>
              <option value="Beginner">Beginner (1.0-2.5)</option>
              <option value="Intermediate">Intermediate (3.0-3.5)</option>
              <option value="Advanced">Advanced (4.0-4.5)</option>
              <option value="Expert">Expert (5.0+)</option>
              <option value="Professional">Professional</option>
            </select>
          </div>
          <div class="form-group">
            <label>Play Frequency</label>
            <select id="customerPlayFrequency">
              <option value="">Select...</option>
              <option value="Daily">Daily</option>
              <option value="Several times/week">Several times/week</option>
              <option value="Weekly">Weekly</option>
              <option value="Monthly">Monthly</option>
              <option value="Occasional">Occasional</option>
            </select>
          </div>
          <div class="form-group">
            <label>Current Paddle Brand</label>
            <select id="customerPaddleBrand">
              <option value="">Select...</option>
              <option value="Bantam">Bantam</option>
              <option value="BREAD">BREAD</option>
              <option value="CRBN">CRBN</option>
              <option value="Diadem">Diadem</option>
              <option value="Electrum">Electrum</option>
              <option value="Engage">Engage</option>
              <option value="Franklin">Franklin</option>
              <option value="Gamma">Gamma</option>
              <option value="Gearbox">Gearbox</option>
              <option value="HEAD">HEAD</option>
              <option value="Holbrook">Holbrook</option>
              <option value="Hudef">Hudef</option>
              <option value="Joola">Joola</option>
              <option value="Legacy">Legacy</option>
              <option value="Nomex">Nomex</option>
              <option value="Onix">Onix</option>
              <option value="Paddletek">Paddletek</option>
              <option value="Prince">Prince</option>
              <option value="ProKennex">ProKennex</option>
              <option value="Prolite">Prolite</option>
              <option value="Selkirk">Selkirk</option>
              <option value="Six Zero">Six Zero</option>
              <option value="Slinger">Slinger</option>
              <option value="Thrive">Thrive</option>
              <option value="Vatic Pro">Vatic Pro</option>
              <option value="Viking">Viking</option>
              <option value="Vulcan">Vulcan</option>
              <option value="Wilson">Wilson</option>
              <option value="Yonex">Yonex</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <!-- Product Interests -->
        <div class="section-header">
          <i class="fas fa-heart"></i> Product Interests
        </div>
        <div class="form-group">
          <label>Interested In (Check all that apply)</label>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="interest_noise" value="Noise Reduction">
              <label for="interest_noise">Noise Reduction</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="interest_performance" value="Performance Enhancement">
              <label for="interest_performance">Performance Enhancement</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="interest_durability" value="Durability">
              <label for="interest_durability">Durability</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="interest_custom" value="Customization">
              <label for="interest_custom">Customization</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="interest_gift" value="Gift Purchase">
              <label for="interest_gift">Gift Purchase</label>
            </div>
          </div>
        </div>

        <!-- Communication Preferences -->
        <div class="section-header">
          <i class="fas fa-envelope"></i> Communication Preferences
        </div>
        <div class="grid-3">
          <div class="form-group">
            <label>Preferred Contact Method</label>
            <select id="customerContactMethod">
              <option value="">Select...</option>
              <option value="Email">Email</option>
              <option value="Phone">Phone</option>
              <option value="SMS">SMS/Text</option>
              <option value="Social Media">Social Media</option>
            </select>
          </div>
          <div class="form-group">
            <label>Best Time to Contact</label>
            <select id="customerContactTime">
              <option value="">Select...</option>
              <option value="Morning">Morning (8AM-12PM)</option>
              <option value="Afternoon">Afternoon (12PM-5PM)</option>
              <option value="Evening">Evening (5PM-8PM)</option>
              <option value="Anytime">Anytime</option>
            </select>
          </div>
          <div class="form-group" style="display: flex; flex-direction: column; gap: 8px; padding-top: 25px;">
            <div class="checkbox-item">
              <input type="checkbox" id="customerEmailOptIn">
              <label for="customerEmailOptIn">Email Marketing Opt-in</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="customerSMSOptIn">
              <label for="customerSMSOptIn">SMS Marketing Opt-in</label>
            </div>
          </div>
        </div>

        <!-- Referral Potential -->
        <div class="section-header">
          <i class="fas fa-user-friends"></i> Referral & Marketing Potential
        </div>
        <div class="grid-3">
          <div class="form-group">
            <label>Interested in Referral Program?</label>
            <select id="customerReferralInterest">
              <option value="">Select...</option>
              <option value="Very Interested">Very Interested</option>
              <option value="Somewhat Interested">Somewhat Interested</option>
              <option value="Not Interested">Not Interested</option>
              <option value="Unknown">Unknown</option>
            </select>
          </div>
          <div class="form-group">
            <label>Interested in Discounts/Promotions?</label>
            <select id="customerDiscountInterest">
              <option value="">Select...</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
              <option value="Unknown">Unknown</option>
            </select>
          </div>
          <div class="form-group">
            <label>Potential Referrals</label>
            <input type="number" id="customerPotentialReferrals" min="0" placeholder="Estimated number">
          </div>
        </div>

        <!-- Notes -->
        <div class="section-header">
          <i class="fas fa-sticky-note"></i> Additional Notes
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="customerNotes" rows="4" placeholder="Any additional information..."></textarea>
        </div>


        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
          <button type="button" class="btn-secondary" onclick="closeModal('customerModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Customer
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Order Modal WITH FIXED SHIPPING ADDRESS -->
  <div id="orderModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
          <i class="fas fa-shopping-cart"></i> <span id="orderModalTitle">New Order</span>
        </h3>
        <button onclick="closeModal('orderModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="orderForm" onsubmit="saveOrder(event)">
        <input type="hidden" id="orderId">

        <div class="grid-2">
          <div class="form-group">
            <label>Customer *</label>
            <select id="orderCustomer" required onchange="updateOrderAddresses()">
              <option value="">Select Customer...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Order Date *</label>
            <input type="date" id="orderDate" required>
          </div>
        </div>

        <div class="section-header">
          <i class="fas fa-box"></i> Product Information
        </div>

        <div class="form-group">
          <label>Product/Service *</label>
          <input type="text" id="orderProduct" required placeholder="e.g., AcoustiSkin Paddle Cover">
        </div>

        <div class="form-group">
          <label>Paddle Manufacturer (if applicable)</label>
          <select id="orderManufacturer">
            <option value="">Select manufacturer...</option>
            <option value="Bantam">Bantam</option>
            <option value="BREAD">BREAD</option>
            <option value="CRBN">CRBN</option>
            <option value="Diadem">Diadem</option>
            <option value="Electrum">Electrum</option>
            <option value="Engage">Engage</option>
            <option value="Franklin">Franklin</option>
            <option value="Gamma">Gamma</option>
            <option value="Gearbox">Gearbox</option>
            <option value="HEAD">HEAD</option>
            <option value="Holbrook">Holbrook</option>
            <option value="Hudef">Hudef</option>
            <option value="Joola">Joola</option>
            <option value="Legacy">Legacy</option>
            <option value="Nomex">Nomex</option>
            <option value="Onix">Onix</option>
            <option value="Paddletek">Paddletek</option>
            <option value="Prince">Prince</option>
            <option value="ProKennex">ProKennex</option>
            <option value="Prolite">Prolite</option>
            <option value="Selkirk">Selkirk</option>
            <option value="Six Zero">Six Zero</option>
            <option value="Slinger">Slinger</option>
            <option value="Thrive">Thrive</option>
            <option value="Vatic Pro">Vatic Pro</option>
            <option value="Viking">Viking</option>
            <option value="Vulcan">Vulcan</option>
            <option value="Wilson">Wilson</option>
            <option value="Yonex">Yonex</option>
          </select>
        </div>

        <div class="grid-3">
          <div class="form-group">
            <label>Quantity *</label>
            <input type="number" id="orderQuantity" required min="1" value="1" oninput="calculateOrderTotal()">
          </div>
          <div class="form-group">
            <label>Unit Price ($) *</label>
            <input type="number" id="orderPrice" required min="0" step="0.01" oninput="calculateOrderTotal()">
          </div>
          <div class="form-group">
            <label>Shipping ($)</label>
            <input type="number" id="orderShippingCost" min="0" step="0.01" value="0" oninput="calculateOrderTotal()">
          </div>
        </div>

        <div class="section-header">
          <i class="fas fa-map-marker-alt"></i> Bill To Address (from customer record)
        </div>
        <div id="orderBillToDisplay" style="padding: 15px; background: #f1f8e9; border-radius: 8px; color: #2e5940; font-size: 14px; margin-bottom: 20px;">
          Select a customer to view billing address
        </div>

        <div class="section-header">
          <i class="fas fa-truck"></i> Ship To Address
        </div>

        <div class="form-group">
          <div class="checkbox-item" style="margin-bottom: 15px;">
            <input type="checkbox" id="orderSameAsBilling" onchange="copyOrderBillingToShipping()">
            <label for="orderSameAsBilling" style="margin: 0; font-weight: normal;">Same as billing address</label>
          </div>
        </div>

        <div class="form-group">
          <label>Street Address *</label>
          <input type="text" id="orderShippingStreet" required placeholder="123 Main St">
        </div>
        <div class="grid-3">
          <div class="form-group">
            <label>City *</label>
            <input type="text" id="orderShippingCity" required>
          </div>
          <div class="form-group">
            <label>State *</label>
            <select id="orderShippingState" required onchange="calculateOrderTotal()">
              <option value="">Select...</option>
              <option value="AL">Alabama</option>
              <option value="AK">Alaska</option>
              <option value="AZ">Arizona</option>
              <option value="AR">Arkansas</option>
              <option value="CA">California</option>
              <option value="CO">Colorado</option>
              <option value="CT">Connecticut</option>
              <option value="DE">Delaware</option>
              <option value="FL">Florida</option>
              <option value="GA">Georgia</option>
              <option value="HI">Hawaii</option>
              <option value="ID">Idaho</option>
              <option value="IL">Illinois</option>
              <option value="IN">Indiana</option>
              <option value="IA">Iowa</option>
              <option value="KS">Kansas</option>
              <option value="KY">Kentucky</option>
              <option value="LA">Louisiana</option>
              <option value="ME">Maine</option>
              <option value="MD">Maryland</option>
              <option value="MA">Massachusetts</option>
              <option value="MI">Michigan</option>
              <option value="MN">Minnesota</option>
              <option value="MS">Mississippi</option>
              <option value="MO">Missouri</option>
              <option value="MT">Montana</option>
              <option value="NE">Nebraska</option>
              <option value="NV">Nevada</option>
              <option value="NH">New Hampshire</option>
              <option value="NJ">New Jersey</option>
              <option value="NM">New Mexico</option>
              <option value="NY">New York</option>
              <option value="NC">North Carolina</option>
              <option value="ND">North Dakota</option>
              <option value="OH">Ohio</option>
              <option value="OK">Oklahoma</option>
              <option value="OR">Oregon</option>
              <option value="PA">Pennsylvania</option>
              <option value="RI">Rhode Island</option>
              <option value="SC">South Carolina</option>
              <option value="SD">South Dakota</option>
              <option value="TN">Tennessee</option>
              <option value="TX">Texas</option>
              <option value="UT">Utah</option>
              <option value="VT">Vermont</option>
              <option value="VA">Virginia</option>
              <option value="WA">Washington</option>
              <option value="WV">West Virginia</option>
              <option value="WI">Wisconsin</option>
              <option value="WY">Wyoming</option>
            </select>
          </div>
          <div class="form-group">
            <label>ZIP Code *</label>
            <input type="text" id="orderShippingZip" required placeholder="12345">
          </div>
        </div>

        <div class="section-header">
          <i class="fas fa-shipping-fast"></i> Shipping Details
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Shipping Company</label>
            <select id="orderShipper">
              <option value="">Select...</option>
              <option value="USPS">USPS</option>
              <option value="FedEx">FedEx</option>
              <option value="UPS">UPS</option>
              <option value="DHL">DHL</option>
              <option value="Amazon">Amazon Logistics</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tracking Number</label>
            <input type="text" id="orderTracking" placeholder="Optional">
          </div>
        </div>

        <div class="form-group">
          <label>Status *</label>
          <select id="orderStatus" required>
            <option value="Pending">Pending</option>
            <option value="Processing">Processing</option>
            <option value="Shipped">Shipped</option>
            <option value="Delivered">Delivered</option>
          </select>
        </div>

        <div class="info-box">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
            <div>
              <strong>Subtotal:</strong>
              <div style="font-size: 20px; color: #2e5940;" id="orderSubtotalDisplay">$0.00</div>
            </div>
            <div>
              <strong>Tax:</strong>
              <div style="font-size: 20px; color: #2e5940;" id="orderTaxDisplay">$0.00</div>
            </div>
            <div>
              <strong>Total:</strong>
              <div style="font-size: 24px; color: #43a047; font-weight: 700;" id="orderTotalDisplay">$0.00</div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="orderNotes" rows="3" placeholder="Any additional order notes..."></textarea>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn-secondary" onclick="closeModal('orderModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Order
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Event Modal -->
  <div id="eventModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
          <i class="fas fa-calendar-plus"></i> <span id="eventModalTitle">New Event</span>
        </h3>
        <button onclick="closeModal('eventModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="eventForm" onsubmit="saveEvent(event)">
        <input type="hidden" id="eventId">

        <div class="form-group">
          <label>Event Type *</label>
          <select id="eventType" required>
            <option value="meeting">Meeting</option>
            <option value="call">Phone Call</option>
            <option value="task">Task</option>
            <option value="appointment">Appointment</option>
            <option value="todo">To-Do</option>
            <option value="deadline">Deadline</option>
          </select>
        </div>

        <div class="form-group">
          <label>Title *</label>
          <input type="text" id="eventTitle" required placeholder="e.g., Follow-up call with John">
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Date *</label>
            <input type="date" id="eventDate" required>
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="time" id="eventTime">
          </div>
        </div>

        <div class="form-group">
          <label>Related Customer</label>
          <select id="eventCustomer">
            <option value="">None</option>
          </select>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="eventDescription" rows="4" placeholder="Event details..."></textarea>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn-secondary" onclick="closeModal('eventModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Event
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Event Details Modal -->
  <div id="eventDetailsModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
          <i class="fas fa-calendar-alt"></i> Event Details
        </h3>
        <button onclick="closeModal('eventDetailsModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="eventDetailsContent"></div>

      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn-danger" onclick="deleteEventFromDetails()">
          <i class="fas fa-trash"></i> Delete
        </button>
        <button class="btn-primary" onclick="editEventFromDetails()">
          <i class="fas fa-edit"></i> Edit
        </button>
      </div>
    </div>
  </div>
</body>
</html>

  <script>
    // State Tax Rates by State
    const stateTaxRates = {
      'AL': 4.00, 'AK': 0.00, 'AZ': 5.60, 'AR': 6.50, 'CA': 7.25,
      'CO': 2.90, 'CT': 6.35, 'DE': 0.00, 'FL': 6.00, 'GA': 4.00,
      'HI': 4.00, 'ID': 6.00, 'IL': 6.25, 'IN': 7.00, 'IA': 6.00,
      'KS': 6.50, 'KY': 6.00, 'LA': 4.45, 'ME': 5.50, 'MD': 6.00,
      'MA': 6.25, 'MI': 6.00, 'MN': 6.88, 'MS': 7.00, 'MO': 4.23,
      'MT': 0.00, 'NE': 5.50, 'NV': 6.85, 'NH': 0.00, 'NJ': 6.63,
      'NM': 5.13, 'NY': 4.00, 'NC': 4.75, 'ND': 5.00, 'OH': 5.75,
      'OK': 4.50, 'OR': 0.00, 'PA': 6.00, 'RI': 7.00, 'SC': 6.00,
      'SD': 4.50, 'TN': 7.00, 'TX': 6.25, 'UT': 6.10, 'VT': 6.00,
      'VA': 5.30, 'WA': 6.50, 'WV': 6.00, 'WI': 5.00, 'WY': 4.00
    };

    // US Holidays
    const holidays = {
      '2024-01-01': "New Year's Day", '2024-01-15': "Martin Luther King Jr. Day",
      '2024-02-19': "Presidents' Day", '2024-05-27': "Memorial Day",
      '2024-06-19': "Juneteenth", '2024-07-04': "Independence Day",
      '2024-09-02': "Labor Day", '2024-10-14': "Columbus Day",
      '2024-11-11': "Veterans Day", '2024-11-28': "Thanksgiving",
      '2024-12-25': "Christmas", '2025-01-01': "New Year's Day",
      '2025-01-20': "Martin Luther King Jr. Day", '2025-02-17': "Presidents' Day",
      '2025-05-26': "Memorial Day", '2025-06-19': "Juneteenth",
      '2025-07-04': "Independence Day", '2025-09-01': "Labor Day",
      '2025-10-13': "Columbus Day", '2025-11-11': "Veterans Day",
      '2025-11-27': "Thanksgiving", '2025-12-25': "Christmas",
      '2026-01-01': "New Year's Day", '2026-01-19': "Martin Luther King Jr. Day",
      '2026-02-16': "Presidents' Day", '2026-05-25': "Memorial Day",
      '2026-06-19': "Juneteenth", '2026-07-04': "Independence Day",
      '2026-09-07': "Labor Day", '2026-10-12': "Columbus Day",
      '2026-11-11': "Veterans Day", '2026-11-26': "Thanksgiving",
      '2026-12-25': "Christmas"
    };

    // Data Structure WITH PHASE 1
    let crmData = {
      customers: [],
      orders: [],
      events: [],
      communications: [],
      tasks: [],
      products: [] // PHASE 2: Product catalog for inventory tracking
    };

    // Referral Settings
    let referralSettings = {
      creditAmount: 15,
      tiers: {
        bronze: { min: 1, max: 2 },
        silver: { min: 3, max: 5 },
        gold: { min: 6, max: 10 },
        platinum: { min: 11 }
      }
    };

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let currentEventId = null;
    let currentCustomerId = null;
    let currentCommunicationId = null;
    let currentTaskId = null;
    let pendingImportData = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      initializeDefaultProducts(); // PHASE 2: Load default products
      loadReferralSettings();
      updateDashboard();
      updateCurrentDate();
      renderCalendar();
      populateCustomerDropdowns();
      setDefaultOrderDate();
      checkBackupReminder();
      updateReferralDisplays();
      setupDragDrop();
    });

    // Drag and Drop Setup
    function setupDragDrop() {
      const body = document.body;
      body.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
      });
      body.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].name.endsWith('.json')) {
          const reader = new FileReader();
          reader.onload = function(event) {
            try {
              const data = JSON.parse(event.target.result);
              handleImportData(data);
            } catch (error) {
              showNotification('Invalid JSON file', 'error');
            }
          };
          reader.readAsText(files[0]);
        }
      });
    }

    // Save & Load Data
    function saveData() {
      localStorage.setItem('acoustiskinCRM_AI', JSON.stringify(crmData));
    }

    function loadData() {
      const saved = localStorage.getItem('acoustiskinCRM_AI');
      if (saved) {
        const loadedData = JSON.parse(saved);
        crmData = {
          customers: loadedData.customers || [],
          orders: loadedData.orders || [],
          events: loadedData.events || [],
          communications: loadedData.communications || [],
          tasks: loadedData.tasks || []
        };
      }
      updateLastBackupIndicator();
    }
  </script>
    function updateLastBackupIndicator() {
      const last = localStorage.getItem('lastBackupTime');
      const el = document.getElementById('lastBackupTime');
      if (!el) return;
      if (last) {
        const date = new Date(parseInt(last));
        el.textContent = date.toLocaleString();
      } else {
        el.textContent = 'Never';
      }
    }

    function quickBackup() {
      exportData();
      localStorage.setItem('lastBackupTime', Date.now());
      updateLastBackupIndicator();
      closeModal('backupReminderModal');
      showNotification('Backup completed successfully!');
    }

    function snoozeBackupReminder() {
      localStorage.setItem('backupSnoozeUntil', Date.now() + 7*24*60*60*1000); // 7 days
      closeModal('backupReminderModal');
    }

    function checkBackupReminder() {
      const last = localStorage.getItem('lastBackupTime');
      const snooze = localStorage.getItem('backupSnoozeUntil');
      const now = Date.now();

      if (snooze && now < parseInt(snooze)) return;
      if (!last || now - parseInt(last) > 14*24*60*60*1000) { // 14 days
        document.getElementById('backupReminderModal').style.display = 'block';
      }
    }

    // Notification System
    function showNotification(text, type = 'success') {
      const n = document.getElementById('notification');
      const nt = document.getElementById('notificationText');
      nt.textContent = text;
      n.style.borderLeftColor = type === 'error' ? '#e53935' : '#66bb6a';
      n.style.display = 'block';
      setTimeout(() => n.style.display = 'none', 4000);
    }

    // Modal Helpers
    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function openModal(id) {
      document.getElementById(id).style.display = 'block';
    }

    // View Navigation
    function showView(viewName) {
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(viewName + 'View').style.display = 'block';
      document.querySelector(`.nav-item[onclick="showView('${viewName}')"]`).classList.add('active');

      // Refresh data when switching views
      if (viewName === 'customers') updateCustomersView();
      if (viewName === 'orders') updateOrdersView();
      if (viewName === 'calendar') renderCalendar();
      if (viewName === 'communications') loadAllCommunications();
      if (viewName === 'tasks') loadAllTasks();
      if (viewName === 'referrals') updateReferralLeaderboard();
    }

    // Dashboard Updates
    function updateDashboard() {
      document.getElementById('totalCustomers').textContent = crmData.customers.length;
      document.getElementById('totalOrders').textContent = crmData.orders.length;
      const revenue = crmData.orders.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);
      document.getElementById('totalRevenue').textContent = '$' + revenue.toFixed(2);

      const today = new Date().toISOString().slice(0,10);
      const todayEvents = crmData.events.filter(e => e.date === today).length;
      document.getElementById('eventsToday').textContent = todayEvents;

      renderRecentCustomers();
      renderTodaysTasks();
    }

    function updateCurrentDate() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDate').textContent = now.toLocaleDateString(undefined, options);
    }

    // === CUSTOMER FUNCTIONS ===
    function openCustomerModal(id = null) {
      document.getElementById('customerForm').reset();
      document.getElementById('customerId').value = '';
      document.getElementById('customerModalTitle').textContent = 'Add New Customer';

      if (id) {
        const cust = crmData.customers.find(c => c.id === id);
        if (cust) {
          Object.keys(cust).forEach(key => {
            const el = document.getElementById('customer' + key.charAt(0).toUpperCase() + key.slice(1));
            if (el) el.value = cust[key] || '';
          });
          document.getElementById('customerId').value = id;
          document.getElementById('customerModalTitle').textContent = 'Edit Customer';
        }
      }
      openModal('customerModal');
    }

    function saveCustomer(e) {
      e.preventDefault();
      const id = document.getElementById('customerId').value || Date.now().toString();
      const cust = {
        id,
        name: document.getElementById('customerName').value.trim(),
        email: document.getElementById('customerEmail').value.trim(),
        homePhone: document.getElementById('customerHomePhone').value.trim(),
        mobilePhone: document.getElementById('customerMobilePhone').value.trim(),
        status: document.getElementById('customerStatus').value,
        leadSource: document.getElementById('customerLeadSource').value,
        referralCode: document.getElementById('customerReferralCode')?.value || generateReferralCode(),
        referralsMade: parseInt(document.getElementById('customerReferralsMade')?.value) || 0,
        referralCredits: parseFloat(document.getElementById('customerReferralCredits')?.value) || 0,
        potentialReferrals: parseInt(document.getElementById('customerPotentialReferrals').value) || 0,
        createdAt: document.getElementById('customerId').value ? crmData.customers.find(c => c.id === id)?.createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      const index = crmData.customers.findIndex(c => c.id === id);
      if (index === -1) crmData.customers.push(cust);
      else crmData.customers[index] = cust;

      saveData();
      closeModal('customerModal');
      updateDashboard();
      updateCustomersView();
      showNotification('Customer saved successfully');
    }

    function deleteCustomer(id) {
      if (confirm('Delete this customer and all related data?')) {
        crmData.customers = crmData.customers.filter(c => c.id !== id);
        crmData.orders = crmData.orders.filter(o => o.customerId !== id);
        crmData.events = crmData.events.filter(e => e.customerId !== id);
        crmData.communications = crmData.communications.filter(c => c.customerId === id);
        crmData.tasks = crmData.tasks.filter(t => t.customerId === id);
        saveData();
        updateDashboard();
        updateCustomersView();
        showNotification('Customer deleted');
      }
    }

    // === ORDER FUNCTIONS ===
    function openOrderModal(id = null) {
      document.getElementById('orderForm').reset();
      document.getElementById('orderId').value = '';
      document.getElementById('orderModalTitle').textContent = 'New Order';
      populateOrderCustomerDropdown();

      if (id) {
        const order = crmData.orders.find(o => o.id === id);
        if (order) {
          Object.keys(order).forEach(key => {
            const el = document.getElementById('order' + key.charAt(0).toUpperCase() + key.slice(1));
            if (el) el.value = order[key] || '';
          });
          document.getElementById('orderId').value = id;
          document.getElementById('orderModalTitle').textContent = 'Edit Order';
          updateOrderAddresses();
          calculateOrderTotal();
        }
      }
      openModal('orderModal');
    }

    function saveOrder(e) {
      e.preventDefault();
      const id = document.getElementById('orderId').value || Date.now().toString();
      const order = {
        id,
        customerId: document.getElementById('orderCustomer').value,
        date: document.getElementById('orderDate').value,
        product: document.getElementById('orderProduct').value,
        quantity: parseInt(document.getElementById('orderQuantity').value),
        price: parseFloat(document.getElementById('orderPrice').value),
        total: parseFloat(document.getElementById('orderTotalDisplay').textContent.replace('$','')),
        status: document.getElementById('orderStatus').value,
        tracking: document.getElementById('orderTracking').value.trim(),
        createdAt: document.getElementById('orderId').value ? crmData.orders.find(o => o.id === id)?.createdAt : new Date().toISOString()
      };

      const index = crmData.orders.findIndex(o => o.id === id);
      if (index === -1) crmData.orders.push(order);
      else crmData.orders[index] = order;

      saveData();
      closeModal('orderModal');
      updateDashboard();
      updateOrdersView();
      showNotification('Order saved');
    }

    function deleteOrder(id) {
      if (confirm('Delete this order?')) {
        crmData.orders = crmData.orders.filter(o => o.id !== id);
        saveData();
        updateOrdersView();
        showNotification('Order deleted');
      }
    }

    // === EVENT / CALENDAR ===
    function openEventModal(id = null) {
      document.getElementById('eventForm').reset();
      document.getElementById('eventId').value = '';
      if (id) {
        const ev = crmData.events.find(e => e.id === id);
        if (ev) {
          Object.keys(ev).forEach(k => {
            const el = document.getElementById('event' + k.charAt(0).toUpperCase() + k.slice(1));
            if (el) el.value = ev[k];
          });
          document.getElementById('eventId').value = id;
        }
      }
      openModal('eventModal');
    }

    function saveEvent(e) {
      e.preventDefault();
      const id = document.getElementById('eventId').value || Date.now().toString();
      const ev = {
        id,
        type: document.getElementById('eventType').value,
        title: document.getElementById('eventTitle').value,
        date: document.getElementById('eventDate').value,
        time: document.getElementById('eventTime').value || '',
        customerId: document.getElementById('eventCustomer').value || null,
        description: document.getElementById('eventDescription').value
      };

      const idx = crmData.events.findIndex(e => e.id === id);
      if (idx === -1) crmData.events.push(ev);
      else crmData.events[idx] = ev;

      saveData();
      closeModal('eventModal');
      renderCalendar();
      showNotification('Event saved');
    }

    function deleteEvent(id) {
      if (confirm('Delete this event?')) {
        crmData.events = crmData.events.filter(e => e.id !== id);
        saveData();
        renderCalendar();
        showNotification('Event deleted');
      }
    }

    // === COMMUNICATIONS ===
    function openCommunicationModal(id = null) {
      document.getElementById('communicationForm').reset();
      document.getElementById('communicationId').value = '';
      document.getElementById('communicationModalTitle').textContent = 'Add Communication';
      clearCommCustomerSelection();

      if (id) {
        const comm = crmData.communications.find(c => c.id === id);
        if (comm) {
          Object.keys(comm).forEach(k => {
            const el = document.getElementById('communication' + k.charAt(0).toUpperCase() + k.slice(1));
            if (el) el.value = comm[k];
          });
          document.getElementById('communicationId').value = id;
          document.getElementById('communicationModalTitle').textContent = 'Edit Communication';
          // Pre-select customer if exists
          if (comm.customerId) selectCommCustomer(comm.customerId);
        }
      }
      openModal('communicationModal');
    }

    function saveCommunication(e) {
      e.preventDefault();
      const id = document.getElementById('communicationId').value || Date.now().toString();
      const comm = {
        id,
        customerId: document.getElementById('communicationCustomerId').value,
        type: document.getElementById('communicationType').value,
        date: document.getElementById('communicationDate').value,
        subject: document.getElementById('communicationSubject').value,
        notes: document.getElementById('communicationNotes').value,
        createdAt: document.getElementById('communicationId').value ? crmData.communications.find(c => c.id === id)?.createdAt : new Date().toISOString()
      };

      const idx = crmData.communications.findIndex(c => c.id === id);
      if (idx === -1) crmData.communications.push(comm);
      else crmData.communications[idx] = comm;

      saveData();
      closeModal('communicationModal');
      loadAllCommunications();
      showNotification('Communication saved');
    }

    function deleteCommunication(id) {
      if (confirm('Delete this communication?')) {
        crmData.communications = crmData.communications.filter(c => c.id !== id);
        saveData();
        loadAllCommunications();
        showNotification('Communication deleted');
      }
    }

    // === TASKS ===
    function openTaskModal(id = null) {
      document.getElementById('taskForm').reset();
      document.getElementById('taskId').value = '';
      document.getElementById('taskModalTitle').textContent = 'Add Task';
      clearTaskCustomerSelection();

      if (id) {
        const task = crmData.tasks.find(t => t.id === id);
        if (task) {
          Object.keys(task).forEach(k => {
            const el = document.getElementById('task' + k.charAt(0).toUpperCase() + k.slice(1));
            if (el) el.value = task[k];
          });
          document.getElementById('taskId').value = id;
          document.getElementById('taskModalTitle').textContent = 'Edit Task';
          if (task.customerId) selectTaskCustomer(task.customerId);
        }
      }
      openModal('taskModal');
    }

    function saveTask(e) {
      e.preventDefault();
      const id = document.getElementById('taskId').value || Date.now().toString();
      const task = {
        id,
        customerId: document.getElementById('taskCustomerId').value,
        title: document.getElementById('taskTitle').value,
        dueDate: document.getElementById('taskDueDate').value,
        priority: document.getElementById('taskPriority').value,
        status: document.getElementById('taskStatus').value,
        description: document.getElementById('taskDescription').value,
        createdAt: document.getElementById('taskId').value ? crmData.tasks.find(t => t.id === id)?.createdAt : new Date().toISOString()
      };

      const idx = crmData.tasks.findIndex(t => t.id === id);
      if (idx === -1) crmData.tasks.push(task);
      else crmData.tasks[idx] = task;

      saveData();
      closeModal('taskModal');
      loadAllTasks();
      showNotification('Task saved');
    }

    function deleteTask(id) {
      if (confirm('Delete this task?')) {
        crmData.tasks = crmData.tasks.filter(t => t.id !== id);
        saveData();
        loadAllTasks();
        showNotification('Task deleted');
      }
    }

    // === INTELLIGENT IMPORT CONFLICT RESOLUTION (your requested feature) ===
    function resolveConflict(action) {
      closeModal('conflictModal');
      if (!pendingImportData) return;

      const importData = pendingImportData.crmData;

      // === CUSTOMERS ===
      if (importData.customers && importData.customers.length > 0) {
        importData.customers.forEach(impCust => {
          const existingIndex = crmData.customers.findIndex(c => c.id === impCust.id);
          if (existingIndex === -1) {
            crmData.customers.push(impCust);
          } else {
            const existing = crmData.customers[existingIndex];
            const better = getBetterCustomerRecord(existing, impCust);
            crmData.customers[existingIndex] = better;
          }
        });
      }

      // === ORDERS ===
      if (importData.orders && importData.orders.length > 0) {
        importData.orders.forEach(impOrder => {
          const existingIndex = crmData.orders.findIndex(o => o.id === impOrder.id);
          if (existingIndex === -1) {
            crmData.orders.push(impOrder);
          } else {
            const existing = crmData.orders[existingIndex];
            const better = getBetterOrderRecord(existing, impOrder);
            crmData.orders[existingIndex] = better;
          }
        });
      }

      // === EVENTS, COMMUNICATIONS, TASKS (append only - no duplicates by ID) ===
      ['events', 'communications', 'tasks'].forEach(key => {
        if (importData[key] && importData[key].length > 0) {
          importData[key].forEach(item => {
            if (!crmData[key].some(existing => existing.id === item.id)) {
              crmData[key].push(item);
            }
          });
        }
      });

      // Referral settings  keep the newest version
      if (pendingImportData.settings) {
        referralSettings = pendingImportData.settings;
        localStorage.setItem('acoustiskinReferralSettings', JSON.stringify(referralSettings));
      }

      saveData();
      pendingImportData = null;

      // Refresh everything
      updateDashboard();
      updateCustomersView();
      updateOrdersView();
      renderCalendar();
      populateCustomerDropdowns();
      updateReferralDisplays();
      loadAllCommunications();
      loadAllTasks();

      showNotification('Data imported successfully  conflicts resolved intelligently');
    }

    // Helper: decide which customer record is "better"
    function getBetterCustomerRecord(existing, incoming) {
      if (existing.referralCode && !incoming.referralCode) return existing;
      if (!existing.referralCode && incoming.referralCode) return incoming;

      const existingDate = new Date(existing.updatedAt || existing.createdAt || 0);
      const incomingDate = new Date(incoming.updatedAt || incoming.createdAt || 0);
      if (incomingDate > existingDate) return incoming;

      const existingFields = Object.values(existing).filter(v => v && v !== '').length;
      const incomingFields = Object.values(incoming).filter(v => v && v !== '').length;

      return incomingFields >= existingFields ? incoming : existing;
    }

    // Helper: decide which order is "better"
    function getBetterOrderRecord(existing, incoming) {
      if (incoming.tracking && !existing.tracking) return incoming;
      if (incoming.total > existing.total) return incoming;
      if (incoming.date > existing.date) return incoming;
      if (incoming.status === 'Delivered' && existing.status !== 'Delivered') return incoming;
      return existing;
    }

    // Final init call (in case you load this script separately)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        loadData();
        updateDashboard();
        renderCalendar();
        populateCustomerDropdowns();
        updateReferralDisplays();
      });
    }
</script>
