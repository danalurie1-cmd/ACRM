<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AcoustiSkin CRM - AI-Powered Enterprise Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* Custom Styling from Attached File for New Look */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); /* Lighter Green Background */
      min-height: 100vh;
    }
    .sidebar { 
      width: 260px; 
      background: linear-gradient(180deg, #4a7c59 0%, #2e5940 100%); /* Vibrant Darker Green */
      box-shadow: 4px 0 20px rgba(0,0,0,0.15);
    }
    .nav-link {
      display: flex;
      align-items: center;
      padding: 1rem 1.5rem;
      color: #fff;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.1s;
      border-radius: 0.5rem;
      margin: 0.25rem 0.75rem;
    }
    .nav-link:hover, .nav-link.active {
      background-color: rgba(255, 255, 255, 0.2);
      transform: translateX(5px);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }
    .nav-link i {
      margin-right: 0.75rem;
    }
    .main-content {
      padding: 2rem;
      width: 100%;
      overflow-y: auto;
    }
    .card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 1.5rem;
    }
    /* Component Styles from Attachment for a robust look */
    .btn-primary {
      background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); /* Primary Button Green */
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(67, 160, 71, 0.4);
    }
    .btn-secondary {
      background: white;
      color: #43a047;
      border: 2px solid #43a047;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }
    .btn-secondary:hover {
      background: #43a047;
      color: white;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      font-size: 13px;
    }
    .ai-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    /* Calendar styles */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        background-color: #e5e7eb; /* Light border color */
        border-radius: 0.75rem;
        overflow: hidden;
    }
    .day-header {
        background-color: #2e5940; /* Header green */
        color: white;
        text-align: center;
        padding: 0.5rem 0;
        font-weight: 600;
    }
    .day-cell {
        background-color: #fff;
        min-height: 100px;
        padding: 0.5rem;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .day-cell:hover {
        background-color: #f1f8e9;
    }
    .day-cell.today {
      border: 2px solid #43a047;
      background: #e8f5e9;
    }
    .day-number {
        font-weight: 700;
        font-size: 1.1rem;
        color: #43a047; /* Primary Green */
    }
    .has-orders {
        border-left: 4px solid #f97316; /* Orange marker for orders */
    }
    .event-item {
      background: #66bb6a;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-top: 4px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      cursor: pointer;
      transition: all 0.2s;
    }
  </style>
</head>
<body class="flex h-screen">

  <div id="sidebar" class="sidebar flex flex-col justify-between h-full fixed md:relative z-20 transform -translate-x-full md:translate-x-0 transition-transform duration-300">
    <div class="p-6">
      <h1 class="text-3xl font-extrabold text-white mb-8 tracking-wider">AcoustiSkin</h1>
      
      <div id="user-info" class="mb-8 text-white bg-green-700/50 p-3 rounded-lg text-sm">
        <p class="font-bold">Admin User</p>
        <p class="text-xs break-words mt-1">ID: <span id="user-id-display">N/A</span></p>
      </div>

      <nav id="sidebar-menu" class="flex flex-col space-y-2">
        <a href="#" onclick="changeView('dashboard')" class="nav-link active">
          <i class="fas fa-home w-5"></i>
          <span>Dashboard</span>
        </a>
        <a href="#" onclick="changeView('referral')" class="nav-link">
          <i class="fas fa-bullhorn w-5"></i>
          <span>Referral Program</span>
        </a>
        <a href="#" onclick="changeView('customers')" class="nav-link">
          <i class="fas fa-users w-5"></i>
          <span>Customer List</span>
        </a>
        
        <div class="h-px bg-white/20 my-2"></div>

        <a href="#" onclick="changeView('new-order')" class="nav-link">
          <i class="fas fa-plus-circle w-5"></i>
          <span>New Order</span>
        </a>
        <a href="#" onclick="changeView('calendar')" class="nav-link">
          <i class="fas fa-calendar-alt w-5"></i>
          <span>Order Calendar</span>
        </a>
        <a href="#" onclick="changeView('inventory')" class="nav-link">
          <i class="fas fa-boxes w-5"></i>
          <span>Inventory</span>
        </a>
        <a href="#" onclick="changeView('reports')" class="nav-link">
          <i class="fas fa-chart-line w-5"></i>
          <span>Reports</span>
        </a>
      </nav>
    </div>
    
    <div class="p-6">
      <a href="#" onclick="changeView('settings')" class="nav-link justify-center">
        <i class="fas fa-cog w-5"></i>
        <span>Settings</span>
      </a>
    </div>
  </div>

  <div class="flex flex-col flex-1 overflow-y-auto">
    <header class="md:hidden p-4 bg-white shadow-md flex justify-between items-center">
        <h2 class="text-xl font-bold text-gray-800">AcoustiSkin CRM</h2>
        <button id="menu-toggle" class="text-gray-600 focus:outline-none">
            <i class="fas fa-bars text-2xl"></i>
        </button>
    </header>

    <main id="app-container" class="main-content flex-1">
      </main>
  </div>

  <div id="global-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-100 duration-300">
      <h3 id="modal-title" class="text-xl font-bold mb-4 text-green-700"></h3>
      <p id="modal-message" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end">
        <button onclick="closeModal()" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 shadow-md">
          Close
        </button>
      </div>
    </div>
  </div>

<script type="module">
  // FIX: Ensured all necessary Firestore functions (addDoc, collection) are imported correctly
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    getDoc, 
    addDoc, // <-- CRITICAL FIX: Ensure this is explicitly imported
    setDoc, 
    updateDoc, 
    deleteDoc, 
    onSnapshot, 
    collection, // <-- CRITICAL FIX: Ensure this is explicitly imported
    query, 
    where, 
    getDocs, 
    setLogLevel 
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- GLOBAL VARIABLES ---
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-acoustiskin-crm';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
  
  let app, db, auth;
  let unsubscribeListeners = [];

  // --- STATE MANAGEMENT ---
  const state = {
    currentView: 'dashboard',
    isAuthReady: false,
    userId: null,
    referralSettings: {
      creditAmount: 10,
      minOrderValue: 50
    },
    customers: [],
    orders: [],
    currentCalendarDate: new Date(),
  };

  // --- UTILITY FUNCTIONS ---
  
  function showModal(title, message) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message').innerHTML = message; // Use innerHTML for richer content
    document.getElementById('global-modal').classList.remove('hidden');
  }

  window.closeModal = () => {
    document.getElementById('global-modal').classList.add('hidden');
  };

  /**
   * Simple customer creation function.
   * Checks if a customer exists by name, if not, creates a new one.
   * NOTE: addDoc and collection are available due to module import scoping.
   * @param {string} customerName The name of the customer.
   */
  async function ensureCustomerExists(customerName) {
    if (!db) {
        console.error("Database not initialized in ensureCustomerExists.");
        return null;
    }
    
    const trimmedName = customerName.trim();
    if (!trimmedName) return null;

    // 1. Check local state (fast)
    const existingCustomer = state.customers.find(c => c.name.toLowerCase() === trimmedName.toLowerCase());
    if (existingCustomer) {
      return existingCustomer;
    }

    // 2. If not found, create a new customer document
    const customersColRef = collection(db, 'artifacts', appId, 'public', 'data', 'customers');
    const newCustomer = {
        name: trimmedName,
        email: `${trimmedName.toLowerCase().replace(/\s/g, '.').substring(0, 30)}@example.com`, 
        joinedAt: new Date(),
    };
    
    const docRef = await addDoc(customersColRef, newCustomer);
    console.log("New Customer Created:", trimmedName, docRef.id);
    return { id: docRef.id, ...newCustomer };
  }


  // --- FIREBASE INITIALIZATION & AUTH ---

  async function initFirebase() {
    if (!firebaseConfig) {
      console.error("Firebase configuration is missing.");
      showModal("Configuration Error", "Firebase configuration is not available. Persistence features will not work.");
      return;
    }

    try {
      setLogLevel('debug');
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app); // Initialize db here
      
      await setPersistence(auth, browserSessionPersistence);

      // Sign in or use existing auth
      if (initialAuthToken) {
        await signInWithCustomToken(auth, initialAuthToken);
      } else {
        await signInAnonymously(auth);
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          state.userId = user.uid;
          document.getElementById('user-id-display').textContent = state.userId;
          state.isAuthReady = true;
          startDataListeners();
          window.renderApp(); // Initial render after auth
        } else {
          console.warn("User signed out or failed to sign in.");
          state.userId = null;
          state.isAuthReady = true;
          window.renderApp();
        }
      });

    } catch (error) {
      console.error("Error initializing Firebase:", error);
      showModal("Firebase Error", "Could not initialize or authenticate with Firebase. Check console for details.");
    }
  }

  // --- DATA LISTENERS ---

  function startDataListeners() {
    if (!db || !state.isAuthReady) return;

    // Clear previous listeners
    unsubscribeListeners.forEach(unsub => unsub());
    unsubscribeListeners = [];

    // Listener for Referral Settings (Public Data)
    const settingsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'referral');
    const unsubSettings = onSnapshot(settingsDocRef, (docSnap) => {
      if (docSnap.exists()) {
        state.referralSettings = docSnap.data();
      } else {
        // Use setDoc for initial creation if document does not exist
        setDoc(settingsDocRef, state.referralSettings).catch(e => console.error("Error setting initial settings:", e));
      }
      window.renderApp();
    }, (error) => console.error("Error fetching settings:", error));
    unsubscribeListeners.push(unsubSettings);

    // Listener for Customers (Public Data)
    const customersColRef = collection(db, 'artifacts', appId, 'public', 'data', 'customers');
    const unsubCustomers = onSnapshot(customersColRef, (snapshot) => {
      state.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
      window.renderApp();
    }, (error) => console.error("Error fetching customers:", error));
    unsubscribeListeners.push(unsubCustomers);

    // Listener for Orders (Public Data)
    const ordersColRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
    const unsubOrders = onSnapshot(ordersColRef, (snapshot) => {
      state.orders = snapshot.docs.map(doc => ({ 
        id: doc.id, 
        ...doc.data(),
        // Convert Firestore Timestamp to Date object for consistency
        orderDate: doc.data().orderDate ? doc.data().orderDate.toDate() : new Date(),
        // Calculate total value if missing
        totalValue: (doc.data().price * doc.data().quantity) || 0,
      })).sort((a, b) => b.orderDate - a.orderDate); // Sort by date descending
      window.renderApp();
    }, (error) => console.error("Error fetching orders:", error));
    unsubscribeListeners.push(unsubOrders);
  }
  
  // --- VIEW MANAGEMENT ---

  window.changeView = (viewName) => {
    state.currentView = viewName;
    
    // Update active state in sidebar
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    const activeLink = document.querySelector(`.nav-link[onclick*='${viewName}']`);
    if (activeLink) {
      activeLink.classList.add('active');
    }
    
    // Hide mobile menu on navigation
    document.getElementById('sidebar').classList.add('-translate-x-full');
    
    window.renderApp();
  };

  window.renderApp = function() {
    if (!state.isAuthReady) {
      document.getElementById('app-container').innerHTML = '<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-4xl text-green-600"></i><p class="mt-4 text-gray-600">Connecting to CRM database...</p></div>';
      return;
    }

    const container = document.getElementById('app-container');
    container.innerHTML = ''; // Clear content

    switch (state.currentView) {
      case 'dashboard':
        container.innerHTML = renderDashboardView();
        setupDashboardCharts();
        break;
      case 'referral':
        container.innerHTML = renderReferralView();
        setupReferralQRCode();
        break;
      case 'customers':
        container.innerHTML = renderCustomersView();
        break;
      case 'new-order':
        container.innerHTML = renderNewOrderView();
        break;
      case 'calendar':
        container.innerHTML = renderCalendarView();
        break;
      case 'inventory':
        container.innerHTML = renderInventoryView(); 
        break;
      case 'reports':
        container.innerHTML = renderReportsView(); 
        setupReportsCharts();
        break;
      case 'settings':
        container.innerHTML = renderSettingsView();
        break;
      default:
        container.innerHTML = renderDashboardView();
        setupDashboardCharts();
        break;
    }
  }

  // --- VIEW RENDERING FUNCTIONS ---

  function renderDashboardView() {
    const totalCustomers = state.customers.length;
    // totalValue is pre-calculated in the listener
    const totalRevenue = state.orders.reduce((sum, order) => sum + (order.totalValue), 0).toFixed(2);
    const totalOrders = state.orders.length;
    const completedOrders = state.orders.filter(o => o.status === 'Completed').length;
    
    return `
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Overview</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        ${renderMetricCard('Total Customers', totalCustomers.toLocaleString(), 'fas fa-users', 'bg-blue-100 text-blue-600')}
        ${renderMetricCard('Total Revenue', '$' + totalRevenue.toLocaleString(), 'fas fa-dollar-sign', 'bg-green-100 text-green-600')}
        ${renderMetricCard('Total Orders', totalOrders.toLocaleString(), 'fas fa-shopping-cart', 'bg-yellow-100 text-yellow-600')}
        ${renderMetricCard('Completed Orders', completedOrders.toLocaleString(), 'fas fa-check-circle', 'bg-purple-100 text-purple-600')}
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card lg:col-span-2">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">Monthly Revenue Trend</h3>
          <canvas id="revenueChart"></canvas>
        </div>

        <div class="card">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">Latest Orders</h3>
          <ul class="space-y-3">
            ${state.orders.slice(0, 5).map(order => `
              <li class="p-3 bg-gray-50 rounded-lg flex justify-between items-center text-sm">
                <span>${order.customerName} - ${order.product}</span>
                <span class="font-bold text-green-600">$${order.totalValue.toFixed(2)}</span>
              </li>
            `).join('')}
            ${state.orders.length === 0 ? '<li class="text-center text-gray-500 py-4">No orders recorded yet.</li>' : ''}
          </ul>
        </div>
      </div>
    `;
  }
  
  function renderMetricCard(title, value, iconClass, colorClass) {
    return `
      <div class="card p-5 flex items-center space-x-4">
        <div class="p-3 rounded-full ${colorClass}">
          <i class="${iconClass} text-2xl"></i>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-500">${title}</p>
          <p class="text-2xl font-bold text-gray-900">${value}</p>
        </div>
      </div>
    `;
  }

  function setupDashboardCharts() {
    const ctx = document.getElementById('revenueChart');
    if (!ctx) return;

    // Group orders by month/year for charting
    const monthlyRevenue = state.orders.reduce((acc, order) => {
        const monthYear = order.orderDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        // Use pre-calculated totalValue
        const revenue = order.totalValue; 
        acc[monthYear] = (acc[monthYear] || 0) + revenue;
        return acc;
    }, {});

    const labels = Object.keys(monthlyRevenue).sort((a, b) => new Date(a) - new Date(b));
    const data = labels.map(label => monthlyRevenue[label]);

    // Destroy existing chart instance if it exists before creating a new one
    if (window.revenueChartInstance) {
        window.revenueChartInstance.destroy();
    }

    window.revenueChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Revenue ($)',
          data: data,
          backgroundColor: 'rgba(67, 160, 71, 0.5)', // Attachment's darker green with alpha
          borderColor: '#43a047',
          borderWidth: 2,
          tension: 0.4,
          fill: true,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
  }

  function renderReferralView() {
    const userReferralCode = state.userId ? state.userId.substring(0, 8).toUpperCase() : 'CODE1234';
    const settings = state.referralSettings;

    return `
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Referral Program Management</h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">Your Unique Referral Code</h3>
          <div class="flex flex-col items-center p-6 bg-green-50 rounded-xl border border-dashed border-green-300">
            <div id="qrcode-container" class="mb-4 p-2 bg-white rounded-lg shadow-inner"></div>
            <p class="text-lg text-gray-600 mb-2">Share this code with your network:</p>
            <div class="flex items-center space-x-3 w-full max-w-sm">
              <input id="referral-code-input" type="text" value="${userReferralCode}" readonly
                class="flex-1 p-3 border border-green-400 rounded-lg font-mono text-center text-xl bg-white focus:outline-none" />
              <button onclick="copyToClipboard('${userReferralCode}')" class="p-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 shadow-md">
                <i class="fas fa-copy"></i>
              </button>
            </div>
            <p class="mt-4 text-sm text-gray-700">They get <strong>$${settings.creditAmount} OFF</strong> their first order over $${settings.minOrderValue}.</p>
          </div>

          <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-800">Share Options</h3>
          <div class="flex flex-wrap gap-3">
            <button onclick="shareToEmail('${userReferralCode}')" class="flex items-center space-x-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
              <i class="fas fa-envelope"></i> <span>Email</span>
            </button>
            <button onclick="shareToWhatsApp('${userReferralCode}')" class="flex items-center space-x-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
              <i class="fab fa-whatsapp"></i> <span>WhatsApp</span>
            </button>
            <button onclick="shareToTwitter('${userReferralCode}')" class="flex items-center space-x-2 px-4 py-2 bg-blue-400 text-white rounded-lg hover:bg-blue-500 transition">
              <i class="fab fa-twitter"></i> <span>X (Twitter)</span>
            </button>
          </div>
        </div>
        
        <div class="card">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">Program Settings</h3>
          <form onsubmit="updateReferralSettings(event)">
            <div class="space-y-4">
              <div>
                <label for="creditAmount" class="block text-sm font-medium text-gray-700">Credit Amount ($)</label>
                <input type="number" id="creditAmount" value="${settings.creditAmount}" min="1" required
                  class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
              </div>
              <div>
                <label for="minOrderValue" class="block text-sm font-medium text-gray-700">Minimum Order Value ($)</label>
                <input type="number" id="minOrderValue" value="${settings.minOrderValue}" min="1" required
                  class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
              </div>
            </div>
            <button type="submit" class="mt-6 w-full py-3 btn-primary shadow-md">
              Save Settings
            </button>
          </form>
        </div>
      </div>
    `;
  }

  // Helper function to set up the QR code
  function setupReferralQRCode() {
    const container = document.getElementById('qrcode-container');
    if (!container) return;
    container.innerHTML = ''; // Clear previous QR code

    const code = document.getElementById('referral-code-input')?.value || 'CRM123';
    const link = `${window.location.origin}/?ref=${code}`; // Mock referral link
    
    new QRCode(container, {
      text: link,
      width: 128,
      height: 128,
      colorDark : "#43a047", // Dark Green from attachment CSS
      colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.H
    });
  }

  // Helper function for clipboard copy
  window.copyToClipboard = (text) => {
    try {
      navigator.clipboard.writeText(text);
      showModal("Success", "Referral code copied to clipboard!");
    } catch (err) {
      // Fallback for environments where clipboard API is restricted (like iframes)
      const textarea = document.createElement('textarea');
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      showModal("Success", "Referral code copied to clipboard (using fallback).");
    }
  };

  // Helper functions for sharing
  function shareToEmail(code) {
    const settings = state.referralSettings;
    const subject = encodeURIComponent('AcoustiSkin Paddle Cover Discount!');
    const body = encodeURIComponent(`Hey! You should check out AcoustiSkin paddle cover. Use my referral code "${code}" to get $${settings.creditAmount} off your first order!\n\nCheck them out at [Your Website URL]`);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }

  function shareToWhatsApp(code) {
    const settings = state.referralSettings;
    const text = encodeURIComponent(`Check out AcoustiSkin! Use my code "${code}" for $${settings.creditAmount} off!`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
  }

  function shareToTwitter(code) {
    const settings = state.referralSettings;
    const text = encodeURIComponent(`Get $${settings.creditAmount} off @AcoustiSkin paddle covers with my code: ${code}`);
    window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
  }


  // --- FIRESTORE UPDATE LOGIC ---
  window.updateReferralSettings = async (event) => {
    event.preventDefault();
    if (!db) {
      showModal("Error", "Database is not initialized.");
      return;
    }

    const creditAmount = parseFloat(document.getElementById('creditAmount').value);
    const minOrderValue = parseFloat(document.getElementById('minOrderValue').value);

    if (isNaN(creditAmount) || isNaN(minOrderValue) || creditAmount <= 0 || minOrderValue <= 0) {
      showModal("Validation Error", "Please enter valid positive numeric values.");
      return;
    }
    
    const newSettings = { creditAmount, minOrderValue };
    const settingsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'referral');

    try {
      await setDoc(settingsDocRef, newSettings, { merge: true });
      showModal("Success", "Referral program settings updated successfully!");
    } catch (error) {
      console.error("Error updating settings:", error);
      showModal("Error", "Failed to update settings. See console for details.");
    }
  };

  function renderCustomersView() {
    return `
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Customer List (${state.customers.length})</h2>
      
      <div class="card overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email (Placeholder)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Orders</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Spent</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            ${state.customers.map(customer => {
              const customerOrders = state.orders.filter(o => o.customerName === customer.name);
              const totalSpent = customerOrders.reduce((sum, o) => sum + (o.totalValue), 0).toFixed(2);
              return `
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.name}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.email}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customerOrders.length}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">$${totalSpent}</td>
                </tr>
              `;
            }).join('')}
            ${state.customers.length === 0 ? '<tr><td colspan="4" class="text-center py-8 text-gray-500">No customers found.</td></tr>' : ''}
          </tbody>
        </table>
      </div>
    `;
  }
  
  // --- NEW ORDER VIEW (Completed) ---
  function renderNewOrderView() {
    // Generate a list of customer names for the datalist (autocomplete suggestions)
    const customerOptions = state.customers
        .map(c => `<option value="${c.name}">`).join('');

    // Pre-select today's date
    const today = new Date().toISOString().substring(0, 10);

    return `
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Add New Order</h2>
      
      <div class="card max-w-2xl mx-auto">
        <form id="newOrderForm" onsubmit="handleNewOrderSubmission(event)">
          <div class="space-y-6">
            
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
              <label for="customerName" class="block text-sm font-medium text-gray-700 mb-2">Customer Name (Type a new name or select existing)</label>
              <input type="text" id="customerName" list="customerNames" required 
                class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 bg-white"
                placeholder="e.g., Jane Doe">
              <datalist id="customerNames">
                ${customerOptions}
              </datalist>
              <p class="text-xs text-gray-500 mt-1">If the customer is new, simply type their full name and they will be added automatically.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="product" class="block text-sm font-medium text-gray-700">Product</label>
                <select id="product" required 
                  class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 bg-white">
                  <option value="Standard" selected>Standard Paddle Cover</option>
                  <option value="Pro">Pro Series Cover (Enhanced)</option>
                  <option value="Custom">Custom Design Cover</option>
                </select>
              </div>
              <div>
                <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                <input type="number" id="quantity" min="1" value="1" required
                  class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="price" class="block text-sm font-medium text-gray-700">Unit Price ($)</label>
                <input type="number" id="price" step="0.01" min="0.01" value="35.00" required
                  class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
              </div>
              <div>
                <label for="orderDate" class="block text-sm font-medium text-gray-700">Order Date</label>
                <input type="date" id="orderDate" value="${new Date().toISOString().substring(0, 10)}" required
                  class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
              </div>
            </div>

            <div>
              <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
              <select id="status" required 
                class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 bg-white">
                <option value="Pending">Pending</option>
                <option value="Processing" selected>Processing</option>
                <option value="Shipped">Shipped</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>

            <div>
              <label for="notes" class="block text-sm font-medium text-gray-700">Order Notes (Optional)</label>
              <textarea id="notes" rows="3"
                class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"></textarea>
            </div>

          </div>
          
          <button type="submit" class="mt-8 w-full py-3 btn-primary shadow-md">
            <i class="fas fa-save mr-2"></i> Save New Order
          </button>
        </form>
      </div>
    `;
  }
  
  // Define the missing order handler
  window.handleNewOrderSubmission = async (event) => {
    event.preventDefault();
    if (!db) {
      showModal("Error", "Database is not initialized.");
      return;
    }

    const form = document.getElementById('newOrderForm');
    const customerName = form.customerName.value.trim();
    const product = form.product.value;
    const quantity = parseInt(form.quantity.value);
    const price = parseFloat(form.price.value);
    const orderDate = new Date(form.orderDate.value);
    const status = form.status.value;
    const notes = form.notes.value;

    if (!customerName || isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
        showModal("Validation Error", "Please ensure all required fields are filled correctly.");
        return;
    }

    try {
        // Ensure customer exists (or create new one)
        const customer = await ensureCustomerExists(customerName);
        if (!customer) {
            showModal("Error", "Could not process customer name.");
            return;
        }

        const newOrder = {
            customerName: customer.name,
            customerId: customer.id, // Link to the customer record
            product,
            quantity,
            price, // Unit price
            orderDate,
            status,
            notes,
            totalValue: price * quantity,
            createdAt: new Date(),
        };

        const ordersColRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
        await addDoc(ordersColRef, newOrder);

        showModal("Success", `Order for ${customerName} placed successfully! Total: $${newOrder.totalValue.toFixed(2)}`);
        form.reset(); // Clear form on success
        changeView('dashboard'); // Go back to dashboard
    } catch (error) {
        console.error("Error creating new order:", error);
        showModal("Error", "Failed to create new order. See console for details.");
    }
  };

  // --- ORDER CALENDAR VIEW (Implemented) ---

  function renderCalendarView() {
    const today = new Date();
    const currentMonth = state.currentCalendarDate.getMonth();
    const currentYear = state.currentCalendarDate.getFullYear();
    
    // Get first day of the month and last day of the month
    const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
    const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDayOfMonth.getDate();
    
    // Determine the day of the week for the first day (0=Sun, 6=Sat)
    const startDayOfWeek = firstDayOfMonth.getDay(); 
    
    const monthName = state.currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    // Group orders by day
    const ordersByDay = state.orders.reduce((acc, order) => {
        const dayKey = order.orderDate.toISOString().substring(0, 10);
        acc[dayKey] = acc[dayKey] || [];
        acc[dayKey].push(order);
        return acc;
    }, {});
    
    let calendarDaysHtml = '';
    
    // 1. Add empty cells for the starting padding
    for (let i = 0; i < startDayOfWeek; i++) {
        calendarDaysHtml += `<div class="day-cell bg-gray-100 border-none"></div>`;
    }
    
    // 2. Add actual days
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const isoDate = date.toISOString().substring(0, 10);
        const isToday = today.toDateString() === date.toDateString();
        const dailyOrders = ordersByDay[isoDate] || [];
        
        const dayClass = isToday ? 'day-cell today' : 'day-cell';
        const hasOrdersClass = dailyOrders.length > 0 ? 'has-orders' : '';
        
        // Show up to 2 orders directly
        const visibleOrders = dailyOrders.slice(0, 2);
        
        const ordersHtml = visibleOrders.map(order => `
            <div class="event-item bg-green-600/90 hover:bg-green-700" title="${order.customerName} - $${order.totalValue.toFixed(2)}">
                ${order.product}
            </div>
        `).join('');
        
        calendarDaysHtml += `
            <div class="${dayClass} ${hasOrdersClass}" onclick="showOrdersForDay('${isoDate}')">
                <div class="day-number text-lg font-bold mb-1">${day}</div>
                ${ordersHtml}
                ${dailyOrders.length > 2 ? `<div class="text-xs text-gray-500 mt-1">...${dailyOrders.length - 2} more</div>` : ''}
            </div>
        `;
    }

    return `
      <h2 class="text-3xl font-bold text-gray-800 mb-6 flex justify-between items-center">
        Order Calendar 
        <div class="flex space-x-2">
            <button onclick="changeMonth(-1)" class="btn-secondary px-3 py-1"><i class="fas fa-chevron-left"></i></button>
            <span class="text-xl font-semibold text-green-700">${monthName}</span>
            <button onclick="changeMonth(1)" class="btn-secondary px-3 py-1"><i class="fas fa-chevron-right"></i></button>
        </div>
      </h2>

      <div class="card p-4">
        <div class="calendar-grid">
          <div class="day-header">Sun</div>
          <div class="day-header">Mon</div>
          <div class="day-header">Tue</div>
          <div class="day-header">Wed</div>
          <div class="day-header">Thu</div>
          <div class="day-header">Fri</div>
          <div class="day-header">Sat</div>
          ${calendarDaysHtml}
        </div>
      </div>
    `;
  }
  
  // Missing calendar helper functions
  window.changeMonth = (delta) => {
    const newDate = new Date(state.currentCalendarDate.getFullYear(), state.currentCalendarDate.getMonth() + delta, 1);
    state.currentCalendarDate = newDate;
    window.renderApp();
  };

  window.showOrdersForDay = (isoDate) => {
    const orders = state.orders.filter(o => o.orderDate.toISOString().substring(0, 10) === isoDate);
    if (orders.length === 0) {
        showModal("No Orders", `No orders scheduled for ${new Date(isoDate).toDateString()}.`);
        return;
    }

    const ordersList = orders.map(order => {
        let statusColor = 'text-gray-500';
        if (order.status === 'Completed') statusColor = 'text-green-600';
        else if (order.status === 'Shipped') statusColor = 'text-blue-600';
        else if (order.status === 'Cancelled') statusColor = 'text-red-600';
        
        return `
            <li class="p-3 border-b border-gray-100 flex justify-between items-center">
                <div class="flex-1">
                    <p class="font-semibold text-gray-800">${order.customerName} - ${order.product}</p>
                    <p class="text-sm ${statusColor}">${order.status} - Qty: ${order.quantity}</p>
                </div>
                <span class="font-bold text-green-600">$${order.totalValue.toFixed(2)}</span>
            </li>
        `;
    }).join('');

    const modalContent = `
        <h3 class="text-xl font-bold text-green-700 mb-4">${new Date(isoDate).toDateString()} Orders (${orders.length})</h3>
        <ul class="divide-y divide-gray-200 max-h-96 overflow-y-auto">${ordersList}</ul>
      <div class="flex justify-end mt-4"><button onclick="closeModal()" class="btn-secondary">Close</button></div>
    `;
    
    // Re-use the global modal structure
    document.getElementById('modal-title').innerHTML = `<i class="fas fa-calendar-day mr-2"></i> Orders Detail`;
    document.getElementById('modal-message').innerHTML = modalContent;
    document.getElementById('global-modal').classList.remove('hidden');
  };
  
  // --- INVENTORY VIEW (Implemented) ---

  // Mock Inventory Data for demonstration
  const mockInventory = [
      { id: 'SKU001', name: 'Standard Paddle Cover', stock: 150, reorderPoint: 50, price: 35.00, lastRestock: '2025-11-01' },
      { id: 'SKU002', name: 'Pro Series Cover (Enhanced)', stock: 35, reorderPoint: 40, price: 55.00, lastRestock: '2025-11-20' },
      { id: 'SKU003', name: 'Custom Design Cover', stock: 10, reorderPoint: 20, price: 75.00, lastRestock: '2025-10-15' },
      { id: 'SKU004', name: 'Paddle Grip Tape (Black)', stock: 500, reorderPoint: 100, price: 10.00, lastRestock: '2025-12-01' },
  ];

  function renderInventoryView() {
    const inventoryListHtml = mockInventory.map(item => {
        const stockStatus = item.stock <= item.reorderPoint ? 
            `<span class="status-badge bg-red-100 text-red-600"><i class="fas fa-exclamation-triangle mr-1"></i> Low Stock</span>` : 
            `<span class="status-badge bg-green-100 text-green-600"><i class="fas fa-check-circle mr-1"></i> In Stock</span>`;
            
        return `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${item.stock <= item.reorderPoint ? 'text-red-600' : 'text-green-600'}">${item.stock}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.reorderPoint}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-green-700 font-medium">$${item.price.toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap">${stockStatus}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button class="text-indigo-600 hover:text-indigo-900" onclick="showModal('Restock Item', 'Feature to add restock details for ${item.name}.')">
                        <i class="fas fa-truck"></i> Restock
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    const lowStockCount = mockInventory.filter(item => item.stock <= item.reorderPoint).length;

    return `
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Inventory Management</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            ${renderMetricCard('Total SKUs', mockInventory.length, 'fas fa-boxes', 'bg-blue-100 text-blue-600')}
            ${renderMetricCard('Low Stock Items', lowStockCount, 'fas fa-exclamation-triangle', lowStockCount > 0 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600')}
            ${renderMetricCard('Inventory Value (Mock)', '$' + mockInventory.reduce((sum, i) => sum + (i.stock * i.price), 0).toFixed(2).toLocaleString(), 'fas fa-warehouse', 'bg-purple-100 text-purple-600')}
        </div>
        
        <div class="card overflow-x-auto">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Product Stock Levels</h3>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Level</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reorder Point</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="relative px-6 py-3"></th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${inventoryListHtml}
                </tbody>
            </table>
        </div>
    `;
  }
  
  // --- REPORTS VIEW (Implemented) ---

  function renderReportsView() {
    return `
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Sales & Performance Reports</h2>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card lg:col-span-2">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">Sales Volume by Product</h3>
          <canvas id="productSalesChart"></canvas>
        </div>

        <div class="card">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">Referral Leaderboard (Mock)</h3>
          <ul class="space-y-3">
            <li class="p-3 bg-green-50 rounded-lg flex justify-between items-center text-sm font-bold border-l-4 border-green-600">
                <span>#1: Alex Johnson</span>
                <span class="text-green-700">12 Referrals</span>
            </li>
            <li class="p-3 bg-gray-50 rounded-lg flex justify-between items-center text-sm">
                <span>#2: Sarah Lee</span>
                <span class="text-gray-700">8 Referrals</span>
            </li>
            <li class="p-3 bg-gray-50 rounded-lg flex justify-between items-center text-sm">
                <span>#3: Mark Chen</span>
                <span class="text-gray-700">5 Referrals</span>
            </li>
          </ul>
          <div class="info-box mt-4">
              <i class="fas fa-lightbulb text-blue-600 mr-2"></i>
              Top referrers show high product loyalty.
          </div>
        </div>
      </div>
      
      <div class="card mt-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">AI-Powered Sales Insights (Mock)</h3>
        <div class="flex flex-wrap gap-4">
            <div class="ai-badge bg-purple-600/90 text-white p-3 rounded-lg flex items-center space-x-2">
                <i class="fas fa-bolt"></i>
                <p><strong>Prediction:</strong> 15% Q4 Growth</p>
            </div>
            <div class="ai-badge bg-red-600/90 text-white p-3 rounded-lg flex items-center space-x-2">
                <i class="fas fa-exclamation-circle"></i>
                <p><strong>Risk:</strong> SKU003 low stock may hurt custom sales.</p>
            </div>
            <div class="ai-badge bg-blue-600/90 text-white p-3 rounded-lg flex items-center space-x-2">
                <i class="fas fa-star"></i>
                <p><strong>Opportunity:</strong> Target 'Pro Series' to top 20% customers.</p>
            </div>
        </div>
        <button class="mt-4 btn-secondary" onclick="showModal('Generate Full Report', 'Full report generation feature integration.')">
            Generate Full PDF Report <i class="fas fa-file-pdf ml-2"></i>
        </button>
      </div>
    `;
  }
  
  // Chart setup for reports view
  function setupReportsCharts() {
    const ctx = document.getElementById('productSalesChart');
    if (!ctx) return;

    // Group orders by product
    const productSales = state.orders.reduce((acc, order) => {
        const volume = order.quantity;
        acc[order.product] = (acc[order.product] || 0) + volume;
        return acc;
    }, {});

    const labels = Object.keys(productSales);
    const data = labels.map(label => productSales[label]);
    const backgroundColors = [
        'rgba(76, 175, 80, 0.8)', // Green
        'rgba(33, 150, 243, 0.8)', // Blue
        'rgba(255, 152, 0, 0.8)', // Orange
        'rgba(156, 39, 176, 0.8)' // Purple
    ];

    if (window.productSalesChartInstance) {
        window.productSalesChartInstance.destroy();
    }

    window.productSalesChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Sales Volume (Units)',
          data: data,
          backgroundColor: backgroundColors.slice(0, labels.length),
          borderColor: backgroundColors.slice(0, labels.length).map(c => c.replace('0.8', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: {
                display: true,
                text: 'Units Sold'
            }
          },
          x: {
             title: {
                display: true,
                text: 'Product'
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
  }
  
  // Hook the chart setup into the renderApp function to ensure charts load correctly
  const originalRenderApp = window.renderApp;
  window.renderApp = function() {
      // Check if originalRenderApp exists before calling it (safety)
      if (originalRenderApp) {
          originalRenderApp();
      }
      if (state.currentView === 'reports') {
          setupReportsCharts();
      }
      if (state.currentView === 'dashboard') {
          setupDashboardCharts();
      }
  };


  // --- SETTINGS VIEW (Implemented) ---
  function renderSettingsView() {
    return `
      <h2 class="text-3xl font-bold text-gray-800 mb-6">System Settings & Data Management</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card">
          <h3 class="text-xl font-semibold mb-4 text-gray-800"><i class="fas fa-database mr-2"></i> Data Backup & Import</h3>
          <p class="text-sm text-gray-600 mb-4">You can download your entire CRM dataset or upload a new JSON file to replace or merge data.</p>
          
          <div class="flex space-x-3">
              <button onclick="showModal('Download Data', 'Feature to securely download CRM data as JSON.')" class="btn-primary flex-1">
                  <i class="fas fa-download mr-2"></i> Download Data
              </button>
              <button onclick="showModal('Import Data', 'Feature to upload and import a CRM JSON file.')" class="btn-secondary flex-1">
                  <i class="fas fa-upload mr-2"></i> Import Data
              </button>
          </div>
          
          <div class="info-box mt-4">
            <p class="text-xs">
              <i class="fas fa-shield-alt text-blue-600 mr-1"></i> Data is securely stored in a private Firebase instance. Backups are recommended.
            </p>
          </div>
        </div>

        <div class="card">
          <h3 class="text-xl font-semibold mb-4 text-gray-800"><i class="fas fa-cogs mr-2"></i> General Configuration</h3>
          <form onsubmit="handleSettingsSave(event)">
            <div class="space-y-4">
              <div>
                <label for="systemName" class="block text-sm font-medium text-gray-700">CRM Name</label>
                <input type="text" id="systemName" value="AcoustiSkin CRM - Enterprise Edition" required
                  class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
              </div>
              <div>
                <label for="defaultCurrency" class="block text-sm font-medium text-gray-700">Default Currency</label>
                <select id="defaultCurrency" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 bg-white">
                    <option value="USD">USD ($)</option>
                    <option value="EUR">EUR ()</option>
                    <option value="GBP">GBP ()</option>
                </select>
              </div>
            </div>
            <button type="submit" class="mt-6 w-full py-3 btn-primary">
              Save General Settings
            </button>
          </form>
        </div>
      </div>
    `;
  }
  
  // Placeholder function for settings save
  window.handleSettingsSave = (event) => {
      event.preventDefault();
      showModal("Settings Saved", "General settings updated successfully (mock save).");
      // Future implementation: save to a 'settings' collection in Firestore
  };

  // --- MOBILE MENU TOGGLE ---
  document.getElementById('menu-toggle')?.addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  });

  // --- INITIALIZATION ---
  initFirebase();
</script>

</body>
</html>
