<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AcoustiSkin CRM - AI-Powered Enterprise Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
min-height: 100vh;
}
.sidebar { 
width: 260px; 
background: linear-gradient(180deg, #4a7c59 0%, #2e5940 100%);
box-shadow: 4px 0 20px rgba(0,0,0,0.15);
}
.main-content { margin-left: 260px; min-height: 100vh; }
.card {
background: white;
border-radius: 12px;
padding: 20px;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
margin-bottom: 20px;
}
.btn-primary {
background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
color: white;
padding: 10px 20px;
border-radius: 8px;
border: none;
cursor: pointer;
font-weight: 600;
transition: all 0.3s;
}
.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(67, 160, 71, 0.4);
}
.btn-secondary {
background: white;
color: #43a047;
border: 2px solid #43a047;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
font-weight: 500;
transition: all 0.3s;
}
.btn-secondary:hover {
background: #43a047;
color: white;
}
.btn-danger {
background: white;
color: #e53935;
border: 2px solid #e53935;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
font-weight: 500;
transition: all 0.3s;
}
.btn-danger:hover {
background: #e53935;
color: white;
}
.nav-item {
padding: 12px 20px;
color: white;
cursor: pointer;
border-radius: 8px;
margin: 5px 10px;
transition: all 0.3s;
}
.nav-item:hover, .nav-item.active {
background: rgba(255,255,255,0.2);
}
.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.5);
overflow-y: auto;
}
.modal-content {
background: white;
margin: 30px auto;
padding: 30px;
border-radius: 16px;
max-width: 1100px;
max-height: 90vh;
overflow-y: auto;
}
.form-group {
margin-bottom: 15px;
}
.form-group label {
display: block;
margin-bottom: 5px;
color: #2e5940;
font-weight: 600;
font-size: 14px;
}
.form-group input, .form-group select, .form-group textarea {
width: 100%;
padding: 10px;
border: 2px solid #c8e6c9;
border-radius: 6px;
font-size: 14px;
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
outline: none;
border-color: #66bb6a;
}
.checkbox-group {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 10px;
margin-top: 10px;
}
.checkbox-item {
display: flex;
align-items: center;
gap: 8px;
}
.checkbox-item input[type="checkbox"] {
width: auto;
cursor: pointer;
}
.calendar-grid {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 8px;
}
.calendar-day {
background: white;
border: 2px solid #e8f5e9;
border-radius: 8px;
padding: 10px;
min-height: 120px;
cursor: pointer;
transition: all 0.3s;
}
.calendar-day:hover {
background: #f1f8e9;
border-color: #66bb6a;
transform: translateY(-2px);
}
.calendar-day.today {
border-color: #43a047;
background: #e8f5e9;
box-shadow: 0 0 10px rgba(67, 160, 71, 0.3);
}
.event-item {
background: #66bb6a;
color: white;
padding: 4px 8px;
border-radius: 4px;
font-size: 11px;
margin-top: 4px;
cursor: pointer;
transition: all 0.2s;
}
.event-item:hover {
background: #43a047;
transform: scale(1.05);
}
.holiday-item {
background: #ff6b6b;
color: white;
padding: 4px 8px;
border-radius: 4px;
font-size: 11px;
margin-top: 4px;
}
.status-badge {
display: inline-block;
padding: 4px 12px;
border-radius: 12px;
font-size: 12px;
font-weight: 600;
}
.status-active { background: #c8e6c9; color: #2e7d32; }
.status-prospect { background: #bbdefb; color: #1565c0; }
.status-inactive { background: #ffcdd2; color: #c62828; }
.notification {
position: fixed;
top: 20px;
right: 20px;
background: white;
padding: 16px 24px;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
border-left: 4px solid #66bb6a;
display: none;
z-index: 2000;
animation: slideIn 0.3s;
max-width: 400px;
}
@keyframes slideIn {
from { transform: translateX(400px); opacity: 0; }
to { transform: translateX(0); opacity: 1; }
}
.table {
width: 100%;
border-collapse: collapse;
}
.table th {
background: #e8f5e9;
padding: 12px;
text-align: left;
font-weight: 600;
color: #2e5940;
}
.table td {
padding: 12px;
border-bottom: 1px solid #e8f5e9;
}
.table tr:hover {
background: #f1f8e9;
}
.grid-2 {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
}
.grid-3 {
display: grid;
grid-template-columns: 1fr 1fr 1fr;
gap: 15px;
}
.grid-4 {
display: grid;
grid-template-columns: 1fr 1fr 1fr 1fr;
gap: 15px;
}
.section-header {
color: #2e5940;
margin: 25px 0 15px 0;
border-bottom: 2px solid #e8f5e9;
padding-bottom: 10px;
font-size: 16px;
font-weight: 600;
display: flex;
align-items: center;
gap: 10px;
}
.ai-badge {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
padding: 4px 12px;
border-radius: 12px;
font-size: 11px;
font-weight: 600;
display: inline-flex;
align-items: center;
gap: 5px;
}
.score-badge {
padding: 6px 12px;
border-radius: 8px;
font-weight: 600;
display: inline-block;
}
.score-high { background: #c8e6c9; color: #2e7d32; }
.score-medium { background: #fff9c4; color: #f57f17; }
.score-low { background: #ffcdd2; color: #c62828; }
.info-box {
background: #e3f2fd;
border-left: 4px solid #2196f3;
padding: 12px;
border-radius: 6px;
margin: 15px 0;
font-size: 13px;
}
.backup-indicator {
background: rgba(255,255,255,0.1);
padding: 10px 15px;
border-radius: 8px;
margin: 15px 10px;
color: white;
font-size: 12px;
}
.drag-drop-zone {
border: 3px dashed #c8e6c9;
border-radius: 12px;
padding: 40px;
text-align: center;
background: #f1f8e9;
transition: all 0.3s;
cursor: pointer;
}
.drag-drop-zone.drag-over {
border-color: #43a047;
background: #e8f5e9;
transform: scale(1.02);
}
.drag-drop-zone:hover {
border-color: #66bb6a;
background: #e8f5e9;
}
/* Phase 1 Tabs Styling */
.tab-navigation {
display: flex;
gap: 5px;
border-bottom: 2px solid #e8f5e9;
margin-bottom: 20px;
}
.tab-button {
padding: 12px 24px;
background: transparent;
border: none;
color: #666;
font-weight: 600;
cursor: pointer;
border-bottom: 3px solid transparent;
transition: all 0.3s;
}
.tab-button:hover {
color: #43a047;
background: #f1f8e9;
}
.tab-button.active {
color: #43a047;
border-bottom-color: #43a047;
}
.tab-content {
display: none;
}
.tab-content.active {
display: block;
}
.comm-item, .task-item {
padding: 15px;
background: #f1f8e9;
border-radius: 8px;
border-left: 4px solid #66bb6a;
margin-bottom: 10px;
}
.task-item.completed {
opacity: 0.6;
border-left-color: #999;
}
.priority-high { border-left-color: #e53935; }
.priority-medium { border-left-color: #ffa726; }
.priority-low { border-left-color: #66bb6a; }
</style>
</head>
<body>
<!-- Notification -->
<div id="notification" class="notification">
<i class="fas fa-check-circle" style="color: #66bb6a; margin-right: 8px;"></i>
<span id="notificationText"></span>
</div>

<!-- Sidebar -->
<aside class="sidebar" style="position: fixed; height: 100vh; overflow-y: auto;">
<div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.2);">
<h1 style="color: white; font-size: 20px; font-weight: 700;">
<i class="fas fa-leaf"></i> AcoustiSkin CRM
</h1>
<div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 5px;">
<span class="ai-badge"><i class="fas fa-brain"></i> AI-Powered</span>
</div>
</div>

<nav style="padding: 20px 0;">
<div class="nav-item active" onclick="showView('dashboard')">
<i class="fas fa-home" style="margin-right: 10px;"></i>Dashboard
</div>
<div class="nav-item" onclick="showView('customers')">
<i class="fas fa-users" style="margin-right: 10px;"></i>Customers
</div>
<div class="nav-item" onclick="showView('orders')">
<i class="fas fa-shopping-cart" style="margin-right: 10px;"></i>Orders
</div>
<div class="nav-item" onclick="showView('calendar')">
<i class="fas fa-calendar" style="margin-right: 10px;"></i>Calendar
</div>
<div class="nav-item" onclick="showView('pipeline')">
<i class="fas fa-chart-line" style="margin-right: 10px;"></i>Pipeline
</div>
<div class="nav-item" onclick="showView('analytics')">
<i class="fas fa-chart-bar" style="margin-right: 10px;"></i>Analytics
</div>
<div class="nav-item" onclick="showView('marketing')">
<i class="fas fa-bullhorn" style="margin-right: 10px;"></i>Marketing
</div>
<div class="nav-item" onclick="showView('referrals')">
<i class="fas fa-gift" style="margin-right: 10px;"></i>Referral Program
</div>
</nav>

<div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
<button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="openCustomerModal()">
<i class="fas fa-plus"></i> New Customer
</button>
<button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="openEventModal()">
<i class="fas fa-calendar-plus"></i> Schedule Event
</button>
<button class="btn-primary" style="width: 100%;" onclick="openOrderModal()">
<i class="fas fa-cart-plus"></i> New Order
</button>

<div class="backup-indicator" id="backupIndicator">
<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
<span style="font-weight: 600;"><i class="fas fa-shield-alt"></i> Last Backup</span>
</div>
<div id="lastBackupTime" style="font-size: 11px; opacity: 0.8;">Never</div>
</div>

<div style="margin-top: 15px;">
<button class="btn-primary" style="width: 100%; margin-bottom: 10px; background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);" onclick="emailBackup()">
<i class="fas fa-envelope"></i> Email Backup
</button>
<button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="exportData()">
<i class="fas fa-download"></i> Download Backup
</button>
<button class="btn-secondary" style="width: 100%;" onclick="showImportOptions()">
<i class="fas fa-upload"></i> Import Data
</button>
<input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
</div>
</div>
</aside>
  <!-- Backup Reminder Modal -->
<div id="backupReminderModal" class="modal">
<div class="modal-content" style="max-width: 600px;">
<div style="text-align: center; padding: 20px;">
<i class="fas fa-exclamation-triangle" style="font-size: 60px; color: #ffa726; margin-bottom: 20px;"></i>
<h3 style="color: #2e5940; font-size: 24px; font-weight: 700; margin-bottom: 15px;">
Backup Reminder
</h3>
<p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
It's been a while since your last backup. Regular backups protect your valuable customer data.
Would you like to back up now?
</p>
<div style="display: flex; gap: 10px; justify-content: center;">
<button class="btn-secondary" onclick="closeModal('backupReminderModal')">
Remind Me Later
</button>
<button class="btn-primary" onclick="exportData(); closeModal('backupReminderModal')">
<i class="fas fa-download"></i> Backup Now
</button>
</div>
</div>
</div>
</div>

<!-- Conflict Resolution Modal -->
<div id="conflictModal" class="modal">
<div class="modal-content" style="max-width: 700px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
<h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
<i class="fas fa-exclamation-circle"></i> Data Conflict Detected
</h3>
</div>

<div class="info-box">
<strong>Important:</strong> You have existing data in the system. Choose how to handle the imported data:
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0;">
<div style="border: 2px solid #e8f5e9; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;" 
onclick="this.style.borderColor='#43a047'; document.getElementById('mergeBtn').focus();">
<div style="text-align: center; margin-bottom: 15px;">
<i class="fas fa-code-branch" style="font-size: 40px; color: #43a047;"></i>
</div>
<h4 style="color: #2e5940; font-size: 18px; margin-bottom: 10px; text-align: center;">Merge Data</h4>
<p style="color: #666; font-size: 14px; line-height: 1.5; text-align: center;">
Combine imported data with existing data. New records will be added, and duplicates will be updated.
</p>
</div>

<div style="border: 2px solid #e8f5e9; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;" 
onclick="this.style.borderColor='#e53935'; document.getElementById('replaceBtn').focus();">
<div style="text-align: center; margin-bottom: 15px;">
<i class="fas fa-sync-alt" style="font-size: 40px; color: #e53935;"></i>
</div>
<h4 style="color: #2e5940; font-size: 18px; margin-bottom: 10px; text-align: center;">Replace All</h4>
<p style="color: #666; font-size: 14px; line-height: 1.5; text-align: center;">
Delete all existing data and replace it with the imported data. This action cannot be undone.
</p>
</div>
</div>

<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
<button class="btn-secondary" onclick="closeModal('conflictModal')">Cancel</button>
<button id="mergeBtn" class="btn-primary" onclick="resolveConflict('merge')">
<i class="fas fa-code-branch"></i> Merge Data
</button>
<button id="replaceBtn" class="btn-danger" onclick="resolveConflict('replace')">
<i class="fas fa-sync-alt"></i> Replace All
</button>
</div>
</div>
</div>

<!-- Referral Settings Modal -->
<div id="referralSettingsModal" class="modal">
<div class="modal-content" style="max-width: 700px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
<h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
<i class="fas fa-cog"></i> Referral Program Settings
</h3>
<button onclick="closeModal('referralSettingsModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
<i class="fas fa-times"></i>
</button>
</div>

<div class="info-box">
<strong>Customize your referral program.</strong> Changes will apply to all customers immediately.
</div>

<div class="form-group">
<label>Credit Amount per Referral ($)</label>
<input type="number" id="settingCreditAmount" min="1" step="0.01" placeholder="15.00">
</div>

<div class="section-header">
<i class="fas fa-trophy"></i> Tier Thresholds
</div>

<div class="grid-2">
<div class="form-group">
<label>Bronze Tier (Min Referrals)</label>
<input type="number" id="settingBronzeMin" min="1" placeholder="1">
</div>
<div class="form-group">
<label>Bronze Tier (Max Referrals)</label>
<input type="number" id="settingBronzeMax" min="1" placeholder="2">
</div>
</div>

<div class="grid-2">
<div class="form-group">
<label>Silver Tier (Min Referrals)</label>
<input type="number" id="settingSilverMin" min="1" placeholder="3">
</div>
<div class="form-group">
<label>Silver Tier (Max Referrals)</label>
<input type="number" id="settingSilverMax" min="1" placeholder="5">
</div>
</div>

<div class="grid-2">
<div class="form-group">
<label>Gold Tier (Min Referrals)</label>
<input type="number" id="settingGoldMin" min="1" placeholder="6">
</div>
<div class="form-group">
<label>Gold Tier (Max Referrals)</label>
<input type="number" id="settingGoldMax" min="1" placeholder="10">
</div>
</div>

<div class="form-group">
<label>Platinum Tier (Min Referrals)</label>
<input type="number" id="settingPlatinumMin" min="1" placeholder="11">
</div>

<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
<button class="btn-secondary" onclick="closeModal('referralSettingsModal')">Cancel</button>
<button class="btn-primary" onclick="saveReferralSettings()">
<i class="fas fa-save"></i> Save Settings
</button>
</div>
</div>
</div>

<!-- Communication Modal (PHASE 1) -->
<div id="communicationModal" class="modal">
<div class="modal-content" style="max-width: 700px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
<h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
<i class="fas fa-comments"></i> Log Communication
</h3>
<button onclick="closeModal('communicationModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
<i class="fas fa-times"></i>
</button>
</div>

<form id="communicationForm" onsubmit="saveCommunication(event)">
<input type="hidden" id="commCustomerId">
<input type="hidden" id="commId">

<div class="form-group">
<label>Customer</label>
<select id="commCustomer" required onchange="document.getElementById('commCustomerId').value = this.value">
<option value="">Select Customer...</option>
</select>
</div>

<div class="grid-2">
<div class="form-group">
<label>Communication Type *</label>
<select id="commType" required>
<option value="">Select...</option>
<option value="Email">Email</option>
<option value="Phone Call">Phone Call</option>
<option value="Meeting">Meeting</option>
<option value="SMS">SMS/Text</option>
<option value="Social Media">Social Media</option>
<option value="Video Call">Video Call</option>
<option value="In-Person">In-Person</option>
<option value="Other">Other</option>
</select>
</div>
<div class="form-group">
<label>Date & Time *</label>
<input type="datetime-local" id="commDateTime" required>
</div>
</div>

<div class="form-group">
<label>Subject/Topic *</label>
<input type="text" id="commSubject" required placeholder="e.g., Product inquiry, Follow-up">
</div>

<div class="form-group">
<label>Notes/Details *</label>
<textarea id="commNotes" rows="5" required placeholder="What was discussed..."></textarea>
</div>

<div class="form-group">
<label>Outcome</label>
<select id="commOutcome">
<option value="">Select...</option>
<option value="Positive">Positive</option>
<option value="Neutral">Neutral</option>
<option value="Needs Follow-up">Needs Follow-up</option>
<option value="No Response">No Response</option>
</select>
</div>

<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
<button type="button" class="btn-secondary" onclick="closeModal('communicationModal')">Cancel</button>
<button type="submit" class="btn-primary">
<i class="fas fa-save"></i> Save Communication
</button>
</div>
</form>
</div>
</div>

<!-- Task Modal (PHASE 1) -->
<div id="taskModal" class="modal">
<div class="modal-content" style="max-width: 700px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
<h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
<i class="fas fa-tasks"></i> <span id="taskModalTitle">Add Task</span>
</h3>
<button onclick="closeModal('taskModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
<i class="fas fa-times"></i>
</button>
</div>

<form id="taskForm" onsubmit="saveTask(event)">
<input type="hidden" id="taskCustomerId">
<input type="hidden" id="taskId">

<div class="form-group">
<label>Related Customer</label>
<select id="taskCustomer" required onchange="document.getElementById('taskCustomerId').value = this.value">
<option value="">Select Customer...</option>
</select>
</div>

<div class="form-group">
<label>Task Title *</label>
<input type="text" id="taskTitle" required placeholder="e.g., Follow up on quote">
</div>

<div class="grid-3">
<div class="form-group">
<label>Priority *</label>
<select id="taskPriority" required>
<option value="Low">Low</option>
<option value="Medium" selected>Medium</option>
<option value="High">High</option>
</select>
</div>
<div class="form-group">
<label>Status *</label>
<select id="taskStatus" required>
<option value="Pending" selected>Pending</option>
<option value="In Progress">In Progress</option>
<option value="Completed">Completed</option>
<option value="Cancelled">Cancelled</option>
</select>
</div>
<div class="form-group">
<label>Due Date *</label>
<input type="date" id="taskDueDate" required>
</div>
</div>

<div class="form-group">
<label>Description</label>
<textarea id="taskDescription" rows="4" placeholder="Task details..."></textarea>
</div>

<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
<button type="button" class="btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
<button type="submit" class="btn-primary">
<i class="fas fa-save"></i> Save Task
</button>
</div>
</form>
</div>
</div>
<!-- Main Content Area -->
<main class="main-content" style="padding: 30px;">

<!-- Dashboard View -->
<div id="dashboardView" class="view">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
<div>
<h2 style="color: #2e5940; font-size: 32px; font-weight: 700; margin-bottom: 5px;">Dashboard</h2>
<p style="color: #666;">Welcome to your AcoustiSkin CRM</p>
</div>
<div class="ai-badge" style="font-size: 14px; padding: 8px 16px;">
<i class="fas fa-brain"></i> AI-Powered Insights
</div>
</div>

<!-- Stats Cards -->
<div class="grid-4" style="margin-bottom: 30px;">
<div class="card">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
<div>
<div style="color: #999; font-size: 12px; font-weight: 600; text-transform: uppercase;">Total Customers</div>
<div style="font-size: 32px; font-weight: 700; color: #2e5940;" id="totalCustomers">0</div>
</div>
<div style="background: #e8f5e9; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
<i class="fas fa-users" style="color: #43a047; font-size: 24px;"></i>
</div>
</div>
<div style="font-size: 13px; color: #43a047;">
<i class="fas fa-arrow-up"></i> <span id="activeCustomers">0</span> active
</div>
</div>

<div class="card">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
<div>
<div style="color: #999; font-size: 12px; font-weight: 600; text-transform: uppercase;">Total Revenue</div>
<div style="font-size: 32px; font-weight: 700; color: #2e5940;" id="totalRevenue">$0</div>
</div>
<div style="background: #e3f2fd; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
<i class="fas fa-dollar-sign" style="color: #2196f3; font-size: 24px;"></i>
</div>
</div>
<div style="font-size: 13px; color: #2196f3;">
<i class="fas fa-shopping-cart"></i> <span id="totalOrders">0</span> orders
</div>
</div>

<div class="card">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
<div>
<div style="color: #999; font-size: 12px; font-weight: 600; text-transform: uppercase;">This Month</div>
<div style="font-size: 32px; font-weight: 700; color: #2e5940;" id="monthRevenue">$0</div>
</div>
<div style="background: #fff3e0; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
<i class="fas fa-calendar" style="color: #ffa726; font-size: 24px;"></i>
</div>
</div>
<div style="font-size: 13px; color: #ffa726;">
<i class="fas fa-chart-line"></i> <span id="monthOrders">0</span> orders
</div>
</div>

<div class="card">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
<div>
<div style="color: #999; font-size: 12px; font-weight: 600; text-transform: uppercase;">Avg Order Value</div>
<div style="font-size: 32px; font-weight: 700; color: #2e5940;" id="avgOrderValue">$0</div>
</div>
<div style="background: #f3e5f5; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
<i class="fas fa-chart-bar" style="color: #ab47bc; font-size: 24px;"></i>
</div>
</div>
<div style="font-size: 13px; color: #ab47bc;">
<i class="fas fa-percentage"></i> Per transaction
</div>
</div>
</div>

<div class="grid-2">
<!-- Recent Customers -->
<div class="card">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600; margin-bottom: 20px;">
<i class="fas fa-user-plus"></i> Recent Customers
</h3>
<div id="recentCustomers">
<p style="color: #999; text-align: center; padding: 20px;">No customers yet</p>
</div>
</div>

<!-- Today's Tasks -->
<div class="card">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600; margin-bottom: 20px;">
<i class="fas fa-calendar-check"></i> Today's Tasks
</h3>
<div id="todaysTasks">
<p style="color: #999; text-align: center; padding: 20px;">No tasks scheduled for today</p>
</div>
</div>
</div>
</div>

<!-- Customers View -->
<div id="customersView" class="view" style="display: none;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
<div>
<h2 style="color: #2e5940; font-size: 32px; font-weight: 700; margin-bottom: 5px;">Customers</h2>
<p style="color: #666;">Manage your customer database</p>
</div>
<button class="btn-primary" onclick="openCustomerModal()">
<i class="fas fa-plus"></i> Add Customer
</button>
</div>

<div class="card">
<div style="display: flex; gap: 15px; margin-bottom: 20px;">
<input type="text" id="customerSearch" placeholder="Search customers..." 
style="flex: 1; padding: 12px; border: 2px solid #e8f5e9; border-radius: 8px;"
onkeyup="filterCustomers()">
<select id="customerStatusFilter" style="padding: 12px; border: 2px solid #e8f5e9; border-radius: 8px;"
onchange="filterCustomers()">
<option value="">All Status</option>
<option value="Prospect">Prospect</option>
<option value="Active">Active</option>
<option value="Inactive">Inactive</option>
</select>
</div>

<div style="overflow-x: auto;">
<table class="table" id="customersTable">
<thead>
<tr>
<th>Name</th>
<th>Contact</th>
<th>Status</th>
<th>AI Score</th>
<th>Referrals</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="customersTableBody">
<tr>
<td colspan="6" style="text-align: center; padding: 40px; color: #999;">
No customers yet. Click "Add Customer" to get started.
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Orders View -->
<div id="ordersView" class="view" style="display: none;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
<div>
<h2 style="color: #2e5940; font-size: 32px; font-weight: 700; margin-bottom: 5px;">Orders</h2>
<p style="color: #666;">Track and manage all orders</p>
</div>
<button class="btn-primary" onclick="openOrderModal()">
<i class="fas fa-cart-plus"></i> New Order
</button>
</div>

<div class="card">
<div style="overflow-x: auto;">
<table class="table" id="ordersTable">
<thead>
<tr>
<th>Order ID</th>
<th>Customer</th>
<th>Product</th>
<th>Date</th>
<th>Total</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="ordersTableBody">
<tr>
<td colspan="7" style="text-align: center; padding: 40px; color: #999;">
No orders yet. Click "New Order" to create one.
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Calendar View -->
<div id="calendarView" class="view" style="display: none;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
<div>
<h2 style="color: #2e5940; font-size: 32px; font-weight: 700; margin-bottom: 5px;">Calendar</h2>
<p style="color: #666;">Schedule and track events</p>
</div>
<button class="btn-primary" onclick="openEventModal()">
<i class="fas fa-calendar-plus"></i> Add Event
</button>
</div>

<div class="card">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<button class="btn-secondary" onclick="changeMonth(-1)">
<i class="fas fa-chevron-left"></i> Previous
</button>
<h3 id="currentMonth" style="color: #2e5940; font-size: 20px; font-weight: 600;"></h3>
<button class="btn-secondary" onclick="changeMonth(1)">
Next <i class="fas fa-chevron-right"></i>
</button>
</div>

<div class="calendar-grid" style="margin-bottom: 10px;">
<div style="padding: 10px; text-align: center; font-weight: 600; color: #2e5940;">Sun</div>
<div style="padding: 10px; text-align: center; font-weight: 600; color: #2e5940;">Mon</div>
<div style="padding: 10px; text-align: center; font-weight: 600; color: #2e5940;">Tue</div>
<div style="padding: 10px; text-align: center; font-weight: 600; color: #2e5940;">Wed</div>
<div style="padding: 10px; text-align: center; font-weight: 600; color: #2e5940;">Thu</div>
<div style="padding: 10px; text-align: center; font-weight: 600; color: #2e5940;">Fri</div>
<div style="padding: 10px; text-align: center; font-weight: 600; color: #2e5940;">Sat</div>
</div>

<div class="calendar-grid" id="calendarGrid"></div>
</div>
</div>

<!-- Pipeline View -->
<div id="pipelineView" class="view" style="display: none;">
<div style="margin-bottom: 30px;">
<h2 style="color: #2e5940; font-size: 32px; font-weight: 700; margin-bottom: 5px;">Sales Pipeline</h2>
<p style="color: #666;">Track your customer journey</p>
</div>

<div class="grid-3">
<div class="card">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600; margin-bottom: 20px;">
<i class="fas fa-hourglass-start"></i> Prospects
</h3>
<div id="prospectsList"></div>
</div>

<div class="card">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600; margin-bottom: 20px;">
<i class="fas fa-check-circle"></i> Active Customers
</h3>
<div id="activeList"></div>
</div>

<div class="card">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600; margin-bottom: 20px;">
<i class="fas fa-user-slash"></i> Inactive
</h3>
<div id="inactiveList"></div>
</div>
</div>
</div>

<!-- Analytics View -->
<div id="analyticsView" class="view" style="display: none;">
<div style="margin-bottom: 30px;">
<h2 style="color: #2e5940; font-size: 32px; font-weight: 700; margin-bottom: 5px;">Analytics</h2>
<p style="color: #666;">Business insights and reports</p>
</div>

<div class="grid-2" style="margin-bottom: 20px;">
<div class="card">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600; margin-bottom: 20px;">
<i class="fas fa-chart-pie"></i> Lead Sources
</h3>
<canvas id="leadSourceChart"></canvas>
</div>

<div class="card">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600; margin-bottom: 20px;">
<i class="fas fa-share-alt"></i> Social Media Reach
</h3>
<canvas id="socialChart"></canvas>
</div>
</div>

<div class="card">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600; margin-bottom: 20px;">
<i class="fas fa-chart-line"></i> Revenue Trend
</h3>
<canvas id="revenueChart"></canvas>
</div>

<div class="card" style="margin-top: 20px;">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600; margin-bottom: 20px;">
<i class="fas fa-brain"></i> AI-Powered Insights
</h3>
<div id="aiInsights"></div>
</div>
</div>

<!-- Marketing View -->
<div id="marketingView" class="view" style="display: none;">
<div style="margin-bottom: 30px;">
<h2 style="color: #2e5940; font-size: 32px; font-weight: 700; margin-bottom: 5px;">Marketing Hub</h2>
<p style="color: #666;">Create campaigns and reach your audience</p>
</div>

<div class="grid-2">
<div class="card">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600;">
<i class="fas fa-envelope"></i> Email Campaigns
</h3>
<button class="btn-primary" onclick="createEmailList()">
<i class="fas fa-plus"></i> Create List
</button>
</div>
<div class="info-box">
<strong>Target your audience</strong> with personalized email campaigns. Export customer lists based on status, interests, and engagement.
</div>
<div style="margin-top: 15px;">
<button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="createEmailList('active')">
<i class="fas fa-users"></i> Active Customers
</button>
<button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="createEmailList('prospects')">
<i class="fas fa-user-plus"></i> Prospects
</button>
<button class="btn-secondary" style="width: 100%;" onclick="createEmailList('high-value')">
<i class="fas fa-star"></i> High-Value Customers
</button>
</div>
</div>

<div class="card">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600;">
<i class="fas fa-sms"></i> SMS Marketing
</h3>
<button class="btn-primary" onclick="createSMSList()">
<i class="fas fa-plus"></i> Create List
</button>
</div>
<div class="info-box">
<strong>Direct outreach</strong> via SMS for time-sensitive promotions, order updates, and personalized offers.
</div>
<div style="margin-top: 15px;">
<button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="createSMSList('all')">
<i class="fas fa-users"></i> All Customers with Phone
</button>
<button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="createSMSList('pickleball')">
<i class="fas fa-table-tennis"></i> Pickleball Players
</button>
<button class="btn-secondary" style="width: 100%;" onclick="createSMSList('referrers')">
<i class="fas fa-gift"></i> Top Referrers
</button>
</div>
</div>
</div>

<div class="card" style="margin-top: 20px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600;">
<i class="fas fa-share-alt"></i> Social Media Outreach
</h3>
<button class="btn-primary" onclick="viewSocialContacts()">
<i class="fas fa-eye"></i> View Contacts
</button>
</div>
<div class="info-box">
<strong>Connect on social media</strong> with customers who are active on various platforms. Build relationships and increase engagement.
</div>
</div>

<div class="card" style="margin-top: 20px;">
<h3 style="color: #2e5940; font-size: 18px; font-weight: 600; margin-bottom: 15px;">
<i class="fas fa-lightbulb"></i> Smart Recommendations
</h3>
<div id="marketingRecommendations"></div>
</div>
</div>

<!-- Referrals View -->
<div id="referralsView" class="view" style="display: none;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
<div>
<h2 style="color: #2e5940; font-size: 32px; font-weight: 700; margin-bottom: 5px;">Referral Program</h2>
<p style="color: #666;">Track and reward customer referrals</p>
</div>
<button class="btn-primary" onclick="openReferralSettings()">
<i class="fas fa-cog"></i> Program Settings
</button>
</div>

<div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
<div style="color: white;">
<h3 style="font-size: 24px; font-weight: 700; margin-bottom: 10px;">
<i class="fas fa-gift"></i> Current Reward: $<span id="currentReward">15</span> per Referral
</h3>
<p style="opacity: 0.9;">Customers earn rewards for each successful referral. Adjust settings to match your business goals.</p>
</div>
</div>

<div class="card">
<h3 style="color: #2e5940; font-size: 20px; font-weight: 600; margin-bottom: 20px;">
<i class="fas fa-trophy"></i> Top Referrers Leaderboard
</h3>
<div id="referralLeaderboard"></div>
</div>
</div>

</main>
<!-- Customer Modal with Phase 1 Tabs -->
<div id="customerModal" class="modal">
<div class="modal-content">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
<h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
<i class="fas fa-user-plus"></i> <span id="customerModalTitle">Add New Customer</span>
</h3>
<button onclick="closeModal('customerModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
<i class="fas fa-times"></i>
</button>
</div>

<!-- Phase 1: Tab Navigation -->
<div class="tab-navigation">
<button type="button" class="tab-button active" onclick="switchCustomerTab('info')">
<i class="fas fa-info-circle"></i> Customer Info
</button>
<button type="button" class="tab-button" onclick="switchCustomerTab('communications')" id="commTabBtn" style="display: none;">
<i class="fas fa-comments"></i> Communications
</button>
<button type="button" class="tab-button" onclick="switchCustomerTab('tasks')" id="tasksTabBtn" style="display: none;">
<i class="fas fa-tasks"></i> Tasks
</button>
<button type="button" class="tab-button" onclick="switchCustomerTab('purchases')" id="purchasesTabBtn" style="display: none;">
<i class="fas fa-shopping-cart"></i> Purchases
</button>
</div>

<!-- Tab 1: Customer Info (Form) -->
<div id="infoTab" class="tab-content active">
<form id="customerForm" onsubmit="saveCustomer(event)">
<input type="hidden" id="customerId">

<!-- Basic Information -->
<div class="section-header">
<i class="fas fa-info-circle"></i> Basic Information
</div>
<div class="grid-2">
<div class="form-group">
<label>Full Name *</label>
<input type="text" id="customerName" required>
</div>
<div class="form-group">
<label>Contact Type *</label>
<select id="customerContact" required>
<option value="">Select...</option>
<option value="Individual">Individual</option>
<option value="Business">Business</option>
<option value="Organization">Organization</option>
</select>
</div>
</div>

<div class="grid-2">
<div class="form-group">
<label>Email</label>
<input type="email" id="customerEmail">
</div>
<div class="form-group">
<label>Phone</label>
<input type="tel" id="customerPhone">
</div>
</div>

<div class="grid-3">
<div class="form-group">
<label>Status *</label>
<select id="customerStatus" required>
<option value="Prospect">Prospect</option>
<option value="Active">Active</option>
<option value="Inactive">Inactive</option>
</select>
</div>
<div class="form-group">
<label>Industry</label>
<input type="text" id="customerIndustry" placeholder="e.g., Healthcare, Tech">
</div>
<div class="form-group">
<label>Age Range</label>
<select id="customerAgeRange">
<option value="">Select...</option>
<option value="18-24">18-24</option>
<option value="25-34">25-34</option>
<option value="35-44">35-44</option>
<option value="45-54">45-54</option>
<option value="55-64">55-64</option>
<option value="65+">65+</option>
</select>
</div>
</div>

<!-- Billing Address -->
<div class="section-header">
<i class="fas fa-map-marker-alt"></i> Billing Address
</div>
<div class="form-group">
<label>Street Address</label>
<input type="text" id="customerBillingStreet">
</div>
<div class="grid-3">
<div class="form-group">
<label>City</label>
<input type="text" id="customerBillingCity">
</div>
<div class="form-group">
<label>State</label>
<select id="customerBillingState">
<option value="">Select...</option>
<option value="AL">Alabama</option>
<option value="AK">Alaska</option>
<option value="AZ">Arizona</option>
<option value="AR">Arkansas</option>
<option value="CA">California</option>
<option value="CO">Colorado</option>
<option value="CT">Connecticut</option>
<option value="DE">Delaware</option>
<option value="FL">Florida</option>
<option value="GA">Georgia</option>
<option value="HI">Hawaii</option>
<option value="ID">Idaho</option>
<option value="IL">Illinois</option>
<option value="IN">Indiana</option>
<option value="IA">Iowa</option>
<option value="KS">Kansas</option>
<option value="KY">Kentucky</option>
<option value="LA">Louisiana</option>
<option value="ME">Maine</option>
<option value="MD">Maryland</option>
<option value="MA">Massachusetts</option>
<option value="MI">Michigan</option>
<option value="MN">Minnesota</option>
<option value="MS">Mississippi</option>
<option value="MO">Missouri</option>
<option value="MT">Montana</option>
<option value="NE">Nebraska</option>
<option value="NV">Nevada</option>
<option value="NH">New Hampshire</option>
<option value="NJ">New Jersey</option>
<option value="NM">New Mexico</option>
<option value="NY">New York</option>
<option value="NC">North Carolina</option>
<option value="ND">North Dakota</option>
<option value="OH">Ohio</option>
<option value="OK">Oklahoma</option>
<option value="OR">Oregon</option>
<option value="PA">Pennsylvania</option>
<option value="RI">Rhode Island</option>
<option value="SC">South Carolina</option>
<option value="SD">South Dakota</option>
<option value="TN">Tennessee</option>
<option value="TX">Texas</option>
<option value="UT">Utah</option>
<option value="VT">Vermont</option>
<option value="VA">Virginia</option>
<option value="WA">Washington</option>
<option value="WV">West Virginia</option>
<option value="WI">Wisconsin</option>
<option value="WY">Wyoming</option>
</select>
</div>
<div class="form-group">
<label>ZIP Code</label>
<input type="text" id="customerBillingZip">
</div>
</div>

<!-- Shipping Address -->
<div class="section-header">
<i class="fas fa-shipping-fast"></i> Shipping Address
</div>
<div class="form-group">
<label style="display: flex; align-items: center; gap: 8px;">
<input type="checkbox" id="sameAsBilling" onchange="copySameAsBilling()" style="width: auto;">
<span>Same as billing address</span>
</label>
</div>
<div class="form-group">
<label>Street Address</label>
<input type="text" id="customerShippingStreet">
</div>
<div class="grid-3">
<div class="form-group">
<label>City</label>
<input type="text" id="customerShippingCity">
</div>
<div class="form-group">
<label>State</label>
<select id="customerShippingState">
<option value="">Select...</option>
<option value="AL">Alabama</option>
<option value="AK">Alaska</option>
<option value="AZ">Arizona</option>
<option value="AR">Arkansas</option>
<option value="CA">California</option>
<option value="CO">Colorado</option>
<option value="CT">Connecticut</option>
<option value="DE">Delaware</option>
<option value="FL">Florida</option>
<option value="GA">Georgia</option>
<option value="HI">Hawaii</option>
<option value="ID">Idaho</option>
<option value="IL">Illinois</option>
<option value="IN">Indiana</option>
<option value="IA">Iowa</option>
<option value="KS">Kansas</option>
<option value="KY">Kentucky</option>
<option value="LA">Louisiana</option>
<option value="ME">Maine</option>
<option value="MD">Maryland</option>
<option value="MA">Massachusetts</option>
<option value="MI">Michigan</option>
<option value="MN">Minnesota</option>
<option value="MS">Mississippi</option>
<option value="MO">Missouri</option>
<option value="MT">Montana</option>
<option value="NE">Nebraska</option>
<option value="NV">Nevada</option>
<option value="NH">New Hampshire</option>
<option value="NJ">New Jersey</option>
<option value="NM">New Mexico</option>
<option value="NY">New York</option>
<option value="NC">North Carolina</option>
<option value="ND">North Dakota</option>
<option value="OH">Ohio</option>
<option value="OK">Oklahoma</option>
<option value="OR">Oregon</option>
<option value="PA">Pennsylvania</option>
<option value="RI">Rhode Island</option>
<option value="SC">South Carolina</option>
<option value="SD">South Dakota</option>
<option value="TN">Tennessee</option>
<option value="TX">Texas</option>
<option value="UT">Utah</option>
<option value="VT">Vermont</option>
<option value="VA">Virginia</option>
<option value="WA">Washington</option>
<option value="WV">West Virginia</option>
<option value="WI">Wisconsin</option>
<option value="WY">Wyoming</option>
</select>
</div>
<div class="form-group">
<label>ZIP Code</label>
<input type="text" id="customerShippingZip">
</div>
</div>

<!-- Lead Information -->
<div class="section-header">
<i class="fas fa-funnel-dollar"></i> Lead Information
</div>
<div class="grid-2">
<div class="form-group">
<label>Lead Source</label>
<select id="customerLeadSource">
<option value="">Select...</option>
<option value="Website">Website</option>
<option value="Social Media">Social Media</option>
<option value="Referral">Referral</option>
<option value="Trade Show">Trade Show</option>
<option value="Cold Call">Cold Call</option>
<option value="Partner">Partner</option>
<option value="Advertisement">Advertisement</option>
<option value="Other">Other</option>
</select>
</div>
<div class="form-group">
<label>Referred By</label>
<input type="text" id="customerReferredBy" placeholder="Customer name">
</div>
</div>

<!-- Social Media -->
<div class="section-header">
<i class="fas fa-share-alt"></i> Social Media
</div>
<div class="form-group">
<label>Active Platforms</label>
<div class="checkbox-group">
<div class="checkbox-item">
<input type="checkbox" id="socialFacebook" value="Facebook">
<label for="socialFacebook">Facebook</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="socialInstagram" value="Instagram">
<label for="socialInstagram">Instagram</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="socialTwitter" value="Twitter">
<label for="socialTwitter">Twitter/X</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="socialLinkedIn" value="LinkedIn">
<label for="socialLinkedIn">LinkedIn</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="socialTikTok" value="TikTok">
<label for="socialTikTok">TikTok</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="socialYouTube" value="YouTube">
<label for="socialYouTube">YouTube</label>
</div>
</div>
</div>
<div class="grid-2">
<div class="form-group">
<label>Social Handle</label>
<input type="text" id="customerSocialHandle" placeholder="@username">
</div>
<div class="form-group">
<label>Social Engagement Level</label>
<select id="customerSocialEngagement">
<option value="">Select...</option>
<option value="High">High</option>
<option value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
</div>

<!-- Pickleball Profile -->
<div class="section-header">
<i class="fas fa-table-tennis"></i> Pickleball Profile
</div>
<div class="grid-3">
<div class="form-group">
<label>Skill Level</label>
<select id="customerSkillLevel">
<option value="">Select...</option>
<option value="Beginner">Beginner</option>
<option value="Intermediate">Intermediate</option>
<option value="Advanced">Advanced</option>
<option value="Professional">Professional</option>
</select>
</div>
<div class="form-group">
<label>Play Frequency</label>
<select id="customerPlayFrequency">
<option value="">Select...</option>
<option value="Daily">Daily</option>
<option value="Weekly">Weekly</option>
<option value="Monthly">Monthly</option>
<option value="Occasionally">Occasionally</option>
</select>
</div>
<div class="form-group">
<label>Current Paddle Brand</label>
<select id="customerPaddleBrand">
<option value="">Select...</option>
<option value="Selkirk">Selkirk</option>
<option value="Paddletek">Paddletek</option>
<option value="Engage">Engage</option>
<option value="ProKennex">ProKennex</option>
<option value="Onix">Onix</option>
<option value="Head">Head</option>
<option value="Wilson">Wilson</option>
<option value="Gamma">Gamma</option>
<option value="Franklin">Franklin</option>
<option value="Vulcan">Vulcan</option>
<option value="Electrum">Electrum</option>
<option value="Diadem">Diadem</option>
<option value="Joola">Joola</option>
<option value="Amazin' Aces">Amazin' Aces</option>
<option value="Rally">Rally</option>
<option value="PickleballCentral">PickleballCentral</option>
<option value="Niupipo">Niupipo</option>
<option value="SLK">SLK</option>
<option value="TMPR">TMPR</option>
<option value="ProXR">ProXR</option>
<option value="Fromuth">Fromuth</option>
<option value="Champion Sports">Champion Sports</option>
<option value="Baden">Baden</option>
<option value="6.0">6.0</option>
<option value="Legacy">Legacy</option>
<option value="Other">Other</option>
</select>
</div>
</div>

<!-- Product Interests -->
<div class="section-header">
<i class="fas fa-heart"></i> Product Interests
</div>
<div class="form-group">
<label>Interested In</label>
<textarea id="customerInterests" rows="2" placeholder="e.g., Paddle covers, accessories, custom designs"></textarea>
</div>

<!-- Communication Preferences -->
<div class="section-header">
<i class="fas fa-bell"></i> Communication Preferences
</div>
<div class="grid-2">
<div class="form-group">
<label>Preferred Contact Method</label>
<select id="customerPreferredContact">
<option value="">Select...</option>
<option value="Email">Email</option>
<option value="Phone">Phone</option>
<option value="SMS">SMS</option>
<option value="Social Media">Social Media</option>
</select>
</div>
<div class="form-group">
<label>Contact Frequency</label>
<select id="customerContactFrequency">
<option value="">Select...</option>
<option value="Weekly">Weekly</option>
<option value="Bi-weekly">Bi-weekly</option>
<option value="Monthly">Monthly</option>
<option value="Quarterly">Quarterly</option>
</select>
</div>
</div>

<!-- Referral -->
<div class="section-header">
<i class="fas fa-gift"></i> Referral Program
</div>
<div class="grid-2">
<div class="form-group">
<label>Referral Code</label>
<input type="text" id="customerReferralCode" readonly>
</div>
<div class="form-group">
<label>Referral Potential</label>
<select id="customerReferralPotential">
<option value="">Select...</option>
<option value="High">High</option>
<option value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
</div>

<!-- Notes -->
<div class="section-header">
<i class="fas fa-sticky-note"></i> Additional Notes
</div>
<div class="form-group">
<label>Internal Notes</label>
<textarea id="customerNotes" rows="3" placeholder="Any additional information about this customer..."></textarea>
</div>

<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
<button type="button" class="btn-secondary" onclick="closeModal('customerModal')">Cancel</button>
<button type="submit" class="btn-primary">
<i class="fas fa-save"></i> Save Customer
</button>
</div>
</form>
</div>

<!-- Tab 2: Communications (PHASE 1) -->
<div id="communicationsTab" class="tab-content">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h4 style="color: #2e5940; font-size: 18px;">
<i class="fas fa-comments"></i> Communication History
</h4>
<button class="btn-primary" onclick="openCommunicationModal(document.getElementById('customerId').value)">
<i class="fas fa-plus"></i> Log Communication
</button>
</div>

<div id="customerCommunications">
<p style="color: #999; text-align: center; padding: 40px;">No communications logged yet.</p>
</div>
</div>

<!-- Tab 3: Tasks (PHASE 1) -->
<div id="tasksTab" class="tab-content">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h4 style="color: #2e5940; font-size: 18px;">
<i class="fas fa-tasks"></i> Customer Tasks
</h4>
<button class="btn-primary" onclick="openTaskModal(document.getElementById('customerId').value)">
<i class="fas fa-plus"></i> Add Task
</button>

<div id="customerTasks">
<p style="color: #999; text-align: center; padding: 40px;">No tasks assigned yet.</p>
</div>
</div>

<!-- Tab 4: Purchases (PHASE 1) -->
<div id="purchasesTab" class="tab-content">
<h4 style="color: #2e5940; font-size: 18px; margin-bottom: 20px;">
<i class="fas fa-shopping-cart"></i> Purchase History
</h4>

<div id="customerPurchases">
<p style="color: #999; text-align: center; padding: 40px;">No purchases yet.</p>
</div>

<div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<strong style="color: #2e5940;">Customer Lifetime Value:</strong>
<div style="font-size: 24px; font-weight: 700; color: #43a047;" id="customerLTV">$0.00</div>
</div>
<button class="btn-primary" onclick="openOrderModalForCustomer()">
<i class="fas fa-cart-plus"></i> Add Order
</button>
</div>
</div>
</div>

</div>
</div>
<!-- Order Modal -->
<div id="orderModal" class="modal">
<div class="modal-content" style="max-width: 900px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
<h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
<i class="fas fa-shopping-cart"></i> <span id="orderModalTitle">New Order</span>
</h3>
<button onclick="closeModal('orderModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
<i class="fas fa-times"></i>
</button>
</div>

<form id="orderForm" onsubmit="saveOrder(event)">
<input type="hidden" id="orderId">

<div class="section-header">
<i class="fas fa-user"></i> Customer Information
</div>
<div class="form-group">
<label>Customer *</label>
<select id="orderCustomer" required onchange="updateShipAddress()">
<option value="">Select Customer...</option>
</select>
</div>

<div class="section-header">
<i class="fas fa-box"></i> Product Details
</div>
<div class="grid-2">
<div class="form-group">
<label>Product Name *</label>
<input type="text" id="orderProduct" required placeholder="e.g., Custom Paddle Cover">
</div>
<div class="form-group">
<label>Paddle Manufacturer</label>
<select id="orderManufacturer">
<option value="">Select...</option>
<option value="Selkirk">Selkirk</option>
<option value="Paddletek">Paddletek</option>
<option value="Engage">Engage</option>
<option value="ProKennex">ProKennex</option>
<option value="Onix">Onix</option>
<option value="Head">Head</option>
<option value="Wilson">Wilson</option>
<option value="Gamma">Gamma</option>
<option value="Franklin">Franklin</option>
<option value="Vulcan">Vulcan</option>
<option value="Electrum">Electrum</option>
<option value="Diadem">Diadem</option>
<option value="Joola">Joola</option>
<option value="Amazin' Aces">Amazin' Aces</option>
<option value="Rally">Rally</option>
<option value="PickleballCentral">PickleballCentral</option>
<option value="Niupipo">Niupipo</option>
<option value="SLK">SLK</option>
<option value="TMPR">TMPR</option>
<option value="ProXR">ProXR</option>
<option value="Fromuth">Fromuth</option>
<option value="Champion Sports">Champion Sports</option>
<option value="Baden">Baden</option>
<option value="6.0">6.0</option>
<option value="Legacy">Legacy</option>
<option value="Other">Other</option>
</select>
</div>
</div>

<div class="grid-3">
<div class="form-group">
<label>Quantity *</label>
<input type="number" id="orderQuantity" min="1" value="1" required onchange="calculateOrderTotal()">
</div>
<div class="form-group">
<label>Unit Price ($) *</label>
<input type="number" id="orderPrice" min="0" step="0.01" required onchange="calculateOrderTotal()">
</div>
<div class="form-group">
<label>Discount ($)</label>
<input type="number" id="orderDiscount" min="0" step="0.01" value="0" onchange="calculateOrderTotal()">
</div>
</div>

<div class="section-header">
<i class="fas fa-shipping-fast"></i> Shipping Details
</div>
<div class="form-group">
<label>Street Address *</label>
<input type="text" id="orderShippingStreet" required>
</div>
<div class="grid-3">
<div class="form-group">
<label>City *</label>
<input type="text" id="orderShippingCity" required>
</div>
<div class="form-group">
<label>State *</label>
<select id="orderShippingState" required onchange="calculateOrderTotal()">
<option value="">Select...</option>
<option value="AL">Alabama</option>
<option value="AK">Alaska</option>
<option value="AZ">Arizona</option>
<option value="AR">Arkansas</option>
<option value="CA">California</option>
<option value="CO">Colorado</option>
<option value="CT">Connecticut</option>
<option value="DE">Delaware</option>
<option value="FL">Florida</option>
<option value="GA">Georgia</option>
<option value="HI">Hawaii</option>
<option value="ID">Idaho</option>
<option value="IL">Illinois</option>
<option value="IN">Indiana</option>
<option value="IA">Iowa</option>
<option value="KS">Kansas</option>
<option value="KY">Kentucky</option>
<option value="LA">Louisiana</option>
<option value="ME">Maine</option>
<option value="MD">Maryland</option>
<option value="MA">Massachusetts</option>
<option value="MI">Michigan</option>
<option value="MN">Minnesota</option>
<option value="MS">Mississippi</option>
<option value="MO">Missouri</option>
<option value="MT">Montana</option>
<option value="NE">Nebraska</option>
<option value="NV">Nevada</option>
<option value="NH">New Hampshire</option>
<option value="NJ">New Jersey</option>
<option value="NM">New Mexico</option>
<option value="NY">New York</option>
<option value="NC">North Carolina</option>
<option value="ND">North Dakota</option>
<option value="OH">Ohio</option>
<option value="OK">Oklahoma</option>
<option value="OR">Oregon</option>
<option value="PA">Pennsylvania</option>
<option value="RI">Rhode Island</option>
<option value="SC">South Carolina</option>
<option value="SD">South Dakota</option>
<option value="TN">Tennessee</option>
<option value="TX">Texas</option>
<option value="UT">Utah</option>
<option value="VT">Vermont</option>
<option value="VA">Virginia</option>
<option value="WA">Washington</option>
<option value="WV">West Virginia</option>
<option value="WI">Wisconsin</option>
<option value="WY">Wyoming</option>
</select>
</div>
<div class="form-group">
<label>ZIP Code *</label>
<input type="text" id="orderShippingZip" required>
</div>
</div>

<div class="grid-2">
<div class="form-group">
<label>Shipping Cost ($)</label>
<input type="number" id="orderShippingCost" min="0" step="0.01" value="0" onchange="calculateOrderTotal()">
</div>
<div class="form-group">
<label>Shipping Company</label>
<input type="text" id="orderShippingCompany" placeholder="e.g., UPS, FedEx, USPS">
</div>
</div>

<div class="form-group">
<label>Tracking Number</label>
<input type="text" id="orderTrackingNumber">
</div>

<div class="section-header">
<i class="fas fa-info-circle"></i> Order Details
</div>
<div class="grid-2">
<div class="form-group">
<label>Order Date *</label>
<input type="date" id="orderDate" required>
</div>
<div class="form-group">
<label>Order Status *</label>
<select id="orderStatus" required>
<option value="Pending">Pending</option>
<option value="Processing">Processing</option>
<option value="Shipped">Shipped</option>
<option value="Delivered">Delivered</option>
<option value="Cancelled">Cancelled</option>
</select>
</div>
</div>

<div class="form-group">
<label>Order Notes</label>
<textarea id="orderNotes" rows="2" placeholder="Special instructions or notes..."></textarea>
</div>

<!-- Order Totals -->
<div style="background: #f1f8e9; padding: 20px; border-radius: 8px; margin: 20px 0;">
<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
<span style="color: #666;">Subtotal:</span>
<span style="font-weight: 600; color: #2e5940;" id="orderSubtotal">$0.00</span>
</div>
<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
<span style="color: #666;">Tax:</span>
<span style="font-weight: 600; color: #2e5940;" id="orderTax">$0.00</span>
</div>
<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
<span style="color: #666;">Shipping:</span>
<span style="font-weight: 600; color: #2e5940;" id="orderShipping">$0.00</span>
</div>
<div style="border-top: 2px solid #c8e6c9; padding-top: 10px; margin-top: 10px;">
<div style="display: flex; justify-content: space-between;">
<span style="font-size: 18px; font-weight: 700; color: #2e5940;">Total:</span>
<span style="font-size: 24px; font-weight: 700; color: #43a047;" id="orderTotal">$0.00</span>
</div>
</div>
</div>

<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
<button type="button" class="btn-secondary" onclick="closeModal('orderModal')">Cancel</button>
<button type="submit" class="btn-primary">
<i class="fas fa-save"></i> Save Order
</button>
</div>
</form>
</div>
</div>

<!-- Event Modal -->
<div id="eventModal" class="modal">
<div class="modal-content" style="max-width: 700px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
<h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
<i class="fas fa-calendar-plus"></i> <span id="eventModalTitle">Schedule Event</span>
</h3>
<button onclick="closeModal('eventModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
<i class="fas fa-times"></i>
</button>
</div>

<form id="eventForm" onsubmit="saveEvent(event)">
<input type="hidden" id="eventId">

<div class="form-group">
<label>Event Type *</label>
<select id="eventType" required>
<option value="">Select...</option>
<option value="Meeting">Meeting</option>
<option value="Call">Phone Call</option>
<option value="Task">Task</option>
<option value="Follow-up">Follow-up</option>
<option value="Presentation">Presentation</option>
<option value="Other">Other</option>
</select>
</div>

<div class="form-group">
<label>Title *</label>
<input type="text" id="eventTitle" required placeholder="e.g., Client Meeting">
</div>

<div class="form-group">
<label>Related Customer</label>
<select id="eventCustomer">
<option value="">Select Customer...</option>
</select>
</div>

<div class="grid-2">
<div class="form-group">
<label>Date *</label>
<input type="date" id="eventDate" required>
</div>
<div class="form-group">
<label>Time</label>
<input type="time" id="eventTime">
</div>
</div>

<div class="form-group">
<label>Description</label>
<textarea id="eventDescription" rows="3" placeholder="Event details..."></textarea>
</div>

<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
<button type="button" class="btn-secondary" onclick="closeModal('eventModal')">Cancel</button>
<button type="submit" class="btn-primary">
<i class="fas fa-save"></i> Save Event
</button>
</div>
</form>
</div>
</div>

<!-- Event Details Modal -->
<div id="eventDetailsModal" class="modal">
<div class="modal-content" style="max-width: 600px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
<h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
<i class="fas fa-calendar"></i> Event Details
</h3>
<button onclick="closeModal('eventDetailsModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
<i class="fas fa-times"></i>
</button>
</div>

<div id="eventDetailsContent"></div>

<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
<button class="btn-danger" onclick="deleteEventFromDetails()">
<i class="fas fa-trash"></i> Delete
</button>
<button class="btn-secondary" onclick="editEventFromDetails()">
<i class="fas fa-edit"></i> Edit
</button>
<button class="btn-primary" onclick="closeModal('eventDetailsModal')">
Close
</button>
</div>
</div>
</div>
<script>
// State Tax Rates (All 50 States)
const stateTaxRates = {
'AL': 4.00, 'AK': 0.00, 'AZ': 5.60, 'AR': 6.50, 'CA': 7.25,
'CO': 2.90, 'CT': 6.35, 'DE': 0.00, 'FL': 6.00, 'GA': 4.00,
'HI': 4.00, 'ID': 6.00, 'IL': 6.25, 'IN': 7.00, 'IA': 6.00,
'KS': 6.50, 'KY': 6.00, 'LA': 4.45, 'ME': 5.50, 'MD': 6.00,
'MA': 6.25, 'MI': 6.00, 'MN': 6.88, 'MS': 7.00, 'MO': 4.23,
'MT': 0.00, 'NE': 5.50, 'NV': 6.85, 'NH': 0.00, 'NJ': 6.63,
'NM': 5.13, 'NY': 4.00, 'NC': 4.75, 'ND': 5.00, 'OH': 5.75,
'OK': 4.50, 'OR': 0.00, 'PA': 6.00, 'RI': 7.00, 'SC': 6.00,
'SD': 4.50, 'TN': 7.00, 'TX': 6.25, 'UT': 6.10, 'VT': 6.00,
'VA': 5.30, 'WA': 6.50, 'WV': 6.00, 'WI': 5.00, 'WY': 4.00
};

// US Holidays
const holidays = {
'2024-01-01': 'New Year\'s Day',
'2024-01-15': 'MLK Day',
'2024-02-19': 'Presidents\' Day',
'2024-05-27': 'Memorial Day',
'2024-07-04': 'Independence Day',
'2024-09-02': 'Labor Day',
'2024-10-14': 'Columbus Day',
'2024-11-11': 'Veterans Day',
'2024-11-28': 'Thanksgiving',
'2024-12-25': 'Christmas Day',
'2025-01-01': 'New Year\'s Day',
'2025-01-20': 'MLK Day',
'2025-02-17': 'Presidents\' Day',
'2025-05-26': 'Memorial Day',
'2025-07-04': 'Independence Day',
'2025-09-01': 'Labor Day',
'2025-10-13': 'Columbus Day',
'2025-11-11': 'Veterans Day',
'2025-11-27': 'Thanksgiving',
'2025-12-25': 'Christmas Day',
'2026-01-01': 'New Year\'s Day',
'2026-01-19': 'MLK Day',
'2026-02-16': 'Presidents\' Day',
'2026-05-25': 'Memorial Day',
'2026-07-04': 'Independence Day',
'2026-09-07': 'Labor Day',
'2026-10-12': 'Columbus Day',
'2026-11-11': 'Veterans Day',
'2026-11-26': 'Thanksgiving',
'2026-12-25': 'Christmas Day'
};

// Data Structure with Phase 1
// Global Data Structure Initialization (Ensure all objects and counters are set up)
const defaultData = {
    customers: [],
    orders: [],
    events: [],
    tasks: [],
    communications: [],
    // **CORRECTION 1: New customer ID counter for consistency**
    nextCustomerId: 1000, 
    nextOrderId: 2000,
    nextTaskId: 3000,
    nextCommId: 4000,
    nextEventId: 5000,
};

let crmData = loadData();

// Load Data
function loadData() {
    const data = localStorage.getItem('acoustiskinCRM');
    if (data) {
        return JSON.parse(data);
    }
    // If no data, return default structure
    return defaultData; 
}
// Save Data
function saveData() {
    localStorage.setItem('acoustiskinCRM', JSON.stringify(crmData));
    updateBackupIndicator();
} 
customers: [],
orders: [],
events: [],
communications: [], // PHASE 1: Communication tracking
tasks: [] // PHASE 1: Task management
};

// --- CRUCIAL GLOBAL DEFINITIONS ---
const referralSettings = {
    creditAmount: 25.00,
    tiers: {
        bronze: { min: 1, max: 2 },
        silver: { min: 3, max: 5 },
        gold: { min: 6, max: 10 },
        platinum: { min: 11, max: 999 }
    }
};

const stateTaxRates = {
    'CA': 7.25, // California
    'NY': 4.00, // New York
    'TX': 6.25, // Texas
    'FL': 6.00, // Florida
    'WA': 6.50, // Washington
    'UNKNOWN': 0.00
};

let currentDate = new Date();
let holidays = {
    '2025-12-25': 'Christmas Day',
    '2026-01-01': 'New Year\'s Day'
    // Add more dates here
};

let currentEventId = null; 
// -----------------------------------

// Initialize
document.addEventListener('DOMContentLoaded', function() {
loadData();
loadReferralSettings();
updateDashboard();
updateCustomersView();
updateOrdersView();
renderCalendar();
updatePipelineView();
renderLeadSourceChart();
renderSocialChart();
renderRevenueChart();
generateAIInsights();
updateMarketingView();
updateReferralsView();
updateLastBackupIndicator();
checkBackupReminder();

// Set today's date for event modal
const today = new Date().toISOString().split('T')[0];
document.getElementById('eventDate').value = today;
document.getElementById('orderDate').value = today;

// Setup drag-drop for import
const body = document.body;
body.addEventListener('dragover', (e) => {
e.preventDefault();
e.stopPropagation();
});
body.addEventListener('drop', (e) => {
e.preventDefault();
e.stopPropagation();
const files = e.dataTransfer.files;
if (files.length > 0 && files[0].type === 'application/json') {
const reader = new FileReader();
reader.onload = (event) => {
try {
const importedData = JSON.parse(event.target.result);
handleImportData(importedData);
} catch (error) {
showNotification('Invalid JSON file', 'error');
}
};
reader.readAsText(files[0]);
}
});
});

// Load Data
function loadData() {
const saved = localStorage.getItem('acoustiskinCRM_AI');
if (saved) {
const parsed = JSON.parse(saved);
crmData = {
customers: parsed.customers || [],
orders: parsed.orders || [],
events: parsed.events || [],
communications: parsed.communications || [], // PHASE 1
tasks: parsed.tasks || [] // PHASE 1
};
}
}

// Save Data
function saveData() {
localStorage.setItem('acoustiskinCRM_AI', JSON.stringify(crmData));
localStorage.setItem('lastBackupTime', new Date().toISOString());
updateLastBackupIndicator();
}

// Update Last Backup Indicator
function updateLastBackupIndicator() {
const lastBackup = localStorage.getItem('lastBackupTime');
const element = document.getElementById('lastBackupTime');
if (lastBackup) {
const date = new Date(lastBackup);
const now = new Date();
const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

if (diffDays === 0) {
element.textContent = 'Today';
} else if (diffDays === 1) {
element.textContent = 'Yesterday';
} else {
element.textContent = `${diffDays} days ago`;
}
} else {
element.textContent = 'Never';
}
}

// Check Backup Reminder
function checkBackupReminder() {
const lastBackup = localStorage.getItem('lastBackupTime');
const lastReminder = localStorage.getItem('lastBackupReminder');
const now = new Date();

if (!lastBackup) return;

const backupDate = new Date(lastBackup);
const daysSinceBackup = Math.floor((now - backupDate) / (1000 * 60 * 60 * 24));

if (daysSinceBackup >= 3) {
if (!lastReminder || Math.floor((now - new Date(lastReminder)) / (1000 * 60 * 60 * 24)) >= 1) {
setTimeout(() => {
document.getElementById('backupReminderModal').style.display = 'block';
localStorage.setItem('lastBackupReminder', now.toISOString());
}, 2000);
}
}
}

// Export Data
function exportData() {
const dataStr = JSON.stringify(crmData, null, 2);
const dataBlob = new Blob([dataStr], { type: 'application/json' });
const url = URL.createObjectURL(dataBlob);
const link = document.createElement('a');
link.href = url;
link.download = `acoustiskin-crm-backup-${new Date().toISOString().split('T')[0]}.json`;
link.click();
showNotification('Backup downloaded successfully!');
saveData();
}

// Email Backup
function emailBackup() {
const dataStr = JSON.stringify(crmData, null, 2);
const subject = encodeURIComponent('AcoustiSkin CRM Backup');
const body = encodeURIComponent(`Here is your CRM backup from ${new Date().toLocaleDateString()}.\n\nIMPORTANT: Save the attached data securely.\n\nBackup Data:\n${dataStr}`);
window.location.href = `mailto:?subject=${subject}&body=${body}`;
showNotification('Opening email client...');
saveData();
}

// Show Import Options
function showImportOptions() {
document.getElementById('importFile').click();
}

// Import Data
function importData(event) {
const file = event.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = (e) => {
try {
const importedData = JSON.parse(e.target.result);
handleImportData(importedData);
} catch (error) {
showNotification('Invalid backup file', 'error');
}
};
reader.readAsText(file);
}

// Handle Import Data
function handleImportData(importedData) {
if (crmData.customers.length > 0 || crmData.orders.length > 0 || crmData.events.length > 0) {
window.pendingImportData = importedData;
document.getElementById('conflictModal').style.display = 'block';
} else {
crmData = {
customers: importedData.customers || [],
orders: importedData.orders || [],
events: importedData.events || [],
communications: importedData.communications || [],
tasks: importedData.tasks || []
};
saveData();
location.reload();
}
}

// Resolve Conflict
function resolveConflict(action) {
const importedData = window.pendingImportData;

if (action === 'merge') {
crmData.customers = [...crmData.customers, ...(importedData.customers || [])];
crmData.orders = [...crmData.orders, ...(importedData.orders || [])];
crmData.events = [...crmData.events, ...(importedData.events || [])];
crmData.communications = [...crmData.communications, ...(importedData.communications || [])];
crmData.tasks = [...crmData.tasks, ...(importedData.tasks || [])];
} else if (action === 'replace') {
crmData = {
customers: importedData.customers || [],
orders: importedData.orders || [],
events: importedData.events || [],
communications: importedData.communications || [],
tasks: importedData.tasks || []
};
}

saveData();
closeModal('conflictModal');
location.reload();
}

// Load Referral Settings
function loadReferralSettings() {
const saved = localStorage.getItem('acoustiskinReferralSettings');
if (saved) {
referralSettings = JSON.parse(saved);
}
updateReferralReward();
}

// Save Referral Settings
function saveReferralSettings() {
const creditAmount = parseFloat(document.getElementById('settingCreditAmount').value);
const bronzeMin = parseInt(document.getElementById('settingBronzeMin').value);
const bronzeMax = parseInt(document.getElementById('settingBronzeMax').value);
const silverMin = parseInt(document.getElementById('settingSilverMin').value);
const silverMax = parseInt(document.getElementById('settingSilverMax').value);
const goldMin = parseInt(document.getElementById('settingGoldMin').value);
const goldMax = parseInt(document.getElementById('settingGoldMax').value);
const platinumMin = parseInt(document.getElementById('settingPlatinumMin').value);

referralSettings = {
creditAmount: creditAmount,
tiers: {
bronze: { min: bronzeMin, max: bronzeMax },
silver: { min: silverMin, max: silverMax },
gold: { min: goldMin, max: goldMax },
platinum: { min: platinumMin }
}
};

localStorage.setItem('acoustiskinReferralSettings', JSON.stringify(referralSettings));

// Recalculate all referral credits
crmData.customers.forEach(customer => {
if (customer.referralCount > 0) {
customer.referralCredit = customer.referralCount * referralSettings.creditAmount;
}
});

saveData();
updateReferralsView();
updateReferralReward();
closeModal('referralSettingsModal');
showNotification('Referral settings updated successfully!');
}

// Open Referral Settings
function openReferralSettings() {
document.getElementById('settingCreditAmount').value = referralSettings.creditAmount;
document.getElementById('settingBronzeMin').value = referralSettings.tiers.bronze.min;
document.getElementById('settingBronzeMax').value = referralSettings.tiers.bronze.max;
document.getElementById('settingSilverMin').value = referralSettings.tiers.silver.min;
document.getElementById('settingSilverMax').value = referralSettings.tiers.silver.max;
document.getElementById('settingGoldMin').value = referralSettings.tiers.gold.min;
document.getElementById('settingGoldMax').value = referralSettings.tiers.gold.max;
document.getElementById('settingPlatinumMin').value = referralSettings.tiers.platinum.min;
document.getElementById('referralSettingsModal').style.display = 'block';
}

// Update Referral Reward Display
function updateReferralReward() {
const element = document.getElementById('currentReward');
if (element) {
element.textContent = referralSettings.creditAmount.toFixed(2);
}
}
// ========== PHASE 1: COMMUNICATION FUNCTIONS ==========

// Open Communication Modal
function openCommunicationModal(customerId = null) {
document.getElementById('communicationForm').reset();
document.getElementById('commId').value = '';

// Populate customer dropdown
const customerSelect = document.getElementById('commCustomer');
customerSelect.innerHTML = '<option value="">Select Customer...</option>';
crmData.customers.forEach(customer => {
const option = document.createElement('option');
option.value = customer.id;
option.textContent = customer.name;
customerSelect.appendChild(option);
});

// Pre-select customer if provided
if (customerId) {
document.getElementById('commCustomerId').value = customerId;
customerSelect.value = customerId;
}

// Set current datetime
const now = new Date();
const datetime = now.toISOString().slice(0, 16);
document.getElementById('commDateTime').value = datetime;

document.getElementById('communicationModal').style.display = 'block';
}

// Save Communication
function saveCommunication(event) {
event.preventDefault();

const commId = document.getElementById('commId').value;
const customerId = document.getElementById('commCustomerId').value;
const type = document.getElementById('commType').value;
const dateTime = document.getElementById('commDateTime').value;
const subject = document.getElementById('commSubject').value;
const notes = document.getElementById('commNotes').value;
const outcome = document.getElementById('commOutcome').value;

const communication = {
id: commId || Date.now().toString(),
customerId: customerId,
type: type,
dateTime: dateTime,
subject: subject,
notes: notes,
outcome: outcome,
createdAt: new Date().toISOString()
};

if (commId) {
const index = crmData.communications.findIndex(c => c.id === commId);
crmData.communications[index] = communication;
} else {
crmData.communications.push(communication);
}

saveData();
closeModal('communicationModal');
showNotification('Communication logged successfully!');

// Refresh customer communications if modal is open
if (document.getElementById('customerModal').style.display === 'block') {
loadCustomerCommunications(customerId);
}

return false;
}

// Load Customer Communications
function loadCustomerCommunications(customerId) {
const container = document.getElementById('customerCommunications');
const communications = crmData.communications.filter(c => c.customerId === customerId);

if (communications.length === 0) {
container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No communications logged yet.</p>';
return;
}

// Sort by date (newest first)
communications.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));

let html = '';
communications.forEach(comm => {
const date = new Date(comm.dateTime);
const dateStr = date.toLocaleDateString();
const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

const outcomeColor = {
'Positive': '#43a047',
'Neutral': '#666',
'Needs Follow-up': '#ffa726',
'No Response': '#999'
};

html += `
<div class="comm-item">
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
<div>
<span style="background: #66bb6a; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
${comm.type}
</span>
<span style="margin-left: 10px; color: #666; font-size: 14px;">
${dateStr} at ${timeStr}
</span>
</div>
${comm.outcome ? `<span style="color: ${outcomeColor[comm.outcome] || '#666'}; font-weight: 600; font-size: 13px;">${comm.outcome}</span>` : ''}
</div>
<div style="font-weight: 600; color: #2e5940; margin-bottom: 5px;">${comm.subject}</div>
<div style="color: #666; font-size: 14px;">${comm.notes}</div>
</div>
`;
});

container.innerHTML = html;
}

// ========== PHASE 1: TASK FUNCTIONS ==========

// Open Task Modal
function openTaskModal(customerId = null, taskId = null) {
document.getElementById('taskForm').reset();
document.getElementById('taskId').value = '';
document.getElementById('taskModalTitle').textContent = taskId ? 'Edit Task' : 'Add Task';

// Populate customer dropdown
const customerSelect = document.getElementById('taskCustomer');
customerSelect.innerHTML = '<option value="">Select Customer...</option>';
crmData.customers.forEach(customer => {
const option = document.createElement('option');
option.value = customer.id;
option.textContent = customer.name;
customerSelect.appendChild(option);
});

if (taskId) {
const task = crmData.tasks.find(t => t.id === taskId);
if (task) {
document.getElementById('taskId').value = task.id;
document.getElementById('taskCustomerId').value = task.customerId;
customerSelect.value = task.customerId;
document.getElementById('taskTitle').value = task.title;
document.getElementById('taskPriority').value = task.priority;
document.getElementById('taskStatus').value = task.status;
document.getElementById('taskDueDate').value = task.dueDate;
document.getElementById('taskDescription').value = task.description || '';
}
} else if (customerId) {
document.getElementById('taskCustomerId').value = customerId;
customerSelect.value = customerId;
}

// Set default due date to today if new task
if (!taskId) {
const today = new Date().toISOString().split('T')[0];
document.getElementById('taskDueDate').value = today;
}

document.getElementById('taskModal').style.display = 'block';
}

// Save Task
function saveTask(event) {
event.preventDefault();

const taskId = document.getElementById('taskId').value;
const customerId = document.getElementById('taskCustomerId').value;
const title = document.getElementById('taskTitle').value;
const priority = document.getElementById('taskPriority').value;
const status = document.getElementById('taskStatus').value;
const dueDate = document.getElementById('taskDueDate').value;
const description = document.getElementById('taskDescription').value;

const task = {
id: taskId || Date.now().toString(),
customerId: customerId,
title: title,
priority: priority,
status: status,
dueDate: dueDate,
description: description,
createdAt: taskId ? crmData.tasks.find(t => t.id === taskId).createdAt : new Date().toISOString()
};

if (taskId) {
const index = crmData.tasks.findIndex(t => t.id === taskId);
crmData.tasks[index] = task;
} else {
crmData.tasks.push(task);
}

saveData();
closeModal('taskModal');
showNotification('Task saved successfully!');

// Refresh customer tasks if modal is open
if (document.getElementById('customerModal').style.display === 'block') {
loadCustomerTasks(customerId);
}

// Refresh dashboard
updateDashboard();

return false;
}

// Load Customer Tasks
function loadCustomerTasks(customerId) {
const container = document.getElementById('customerTasks');
const tasks = crmData.tasks.filter(t => t.customerId === customerId);

if (tasks.length === 0) {
container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No tasks assigned yet.</p>';
return;
}

// Sort by due date
tasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

let html = '';
tasks.forEach(task => {
const dueDate = new Date(task.dueDate);
const dateStr = dueDate.toLocaleDateString();
const isOverdue = dueDate < new Date() && task.status !== 'Completed';
const isCompleted = task.status === 'Completed';

const priorityClass = task.priority === 'High' ? 'priority-high' : 
task.priority === 'Medium' ? 'priority-medium' : 'priority-low';

html += `
<div class="task-item ${priorityClass} ${isCompleted ? 'completed' : ''}" style="position: relative;">
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
<div>
<span style="background: ${task.priority === 'High' ? '#e53935' : task.priority === 'Medium' ? '#ffa726' : '#66bb6a'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
${task.priority}
</span>
<span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 5px;">
${task.status}
</span>
</div>
<div style="display: flex; gap: 5px;">
<button onclick="editTask('${task.id}')" class="btn-secondary" style="padding: 4px 8px; font-size: 12px;">
<i class="fas fa-edit"></i>
</button>
<button onclick="deleteTask('${task.id}')" class="btn-danger" style="padding: 4px 8px; font-size: 12px;">
<i class="fas fa-trash"></i>
</button>
</div>
</div>
<div style="font-weight: 600; color: #2e5940; margin-bottom: 5px;">${task.title}</div>
${task.description ? `<div style="color: #666; font-size: 13px; margin-bottom: 5px;">${task.description}</div>` : ''}
<div style="color: ${isOverdue ? '#e53935' : '#666'}; font-size: 13px; font-weight: 600;">
<i class="fas fa-calendar"></i> Due: ${dateStr} ${isOverdue ? '(OVERDUE)' : ''}
</div>
</div>
`;
});

container.innerHTML = html;
}

// Edit Task
function editTask(taskId) {
const task = crmData.tasks.find(t => t.id === taskId);
if (task) {
openTaskModal(task.customerId, taskId);
}
}

// Delete Task
function deleteTask(taskId) {
if (confirm('Are you sure you want to delete this task?')) {
const task = crmData.tasks.find(t => t.id === taskId);
crmData.tasks = crmData.tasks.filter(t => t.id !== taskId);
saveData();
showNotification('Task deleted successfully!');
if (task && document.getElementById('customerModal').style.display === 'block') {
loadCustomerTasks(task.customerId);
}
updateDashboard();
}
}

// Load Customer Purchases (PHASE 1)
function loadCustomerPurchases(customerId) {
const container = document.getElementById('customerPurchases');
const orders = crmData.orders.filter(o => o.customerId === customerId);

if (orders.length === 0) {
container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No purchases yet.</p>';
document.getElementById('customerLTV').textContent = '$0.00';
return;
}

// Sort by date (newest first)
orders.sort((a, b) => new Date(b.date) - new Date(a.date));

// Calculate LTV
const ltv = orders.reduce((sum, order) => sum + order.total, 0);
document.getElementById('customerLTV').textContent = `$${ltv.toFixed(2)}`;

let html = '';
orders.forEach(order => {
const date = new Date(order.date);
const dateStr = date.toLocaleDateString();

const statusColors = {
'Pending': '#ffa726',
'Processing': '#42a5f5',
'Shipped': '#66bb6a',
'Delivered': '#43a047',
'Cancelled': '#e53935'
};

html += `
<div style="padding: 15px; background: #f1f8e9; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${statusColors[order.status]};">
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
<div>
<span style="background: ${statusColors[order.status]}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
${order.status}
</span>
<span style="margin-left: 10px; color: #666; font-size: 14px;">
${dateStr}
</span>
</div>
<span style="font-weight: 700; color: #43a047; font-size: 16px;">$${order.total.toFixed(2)}</span>
</div>
<div style="font-weight: 600; color: #2e5940;">${order.product}</div>
${order.manufacturer ? `<div style="color: #666; font-size: 13px;">Manufacturer: ${order.manufacturer}</div>` : ''}
<div style="color: #666; font-size: 13px;">Quantity: ${order.quantity}</div>
</div>
`;
});

container.innerHTML = html;
}

// Switch Customer Tabs (PHASE 1)
function switchCustomerTab(tabName) {
// Hide all tabs
document.querySelectorAll('.tab-content').forEach(tab => {
tab.classList.remove('active');
});
document.querySelectorAll('.tab-button').forEach(btn => {
btn.classList.remove('active');
});

// Show selected tab
if (tabName === 'info') {
document.getElementById('infoTab').classList.add('active');
document.querySelector('.tab-button').classList.add('active');
} else if (tabName === 'communications') {
document.getElementById('communicationsTab').classList.add('active');
document.getElementById('commTabBtn').classList.add('active');
const customerId = document.getElementById('customerId').value;
loadCustomerCommunications(customerId);
} else if (tabName === 'tasks') {
document.getElementById('tasksTab').classList.add('active');
document.getElementById('tasksTabBtn').classList.add('active');
const customerId = document.getElementById('customerId').value;
loadCustomerTasks(customerId);
} else if (tabName === 'purchases') {
document.getElementById('purchasesTab').classList.add('active');
document.getElementById('purchasesTabBtn').classList.add('active');
const customerId = document.getElementById('customerId').value;
loadCustomerPurchases(customerId);
}
}
// ========== CUSTOMER FUNCTIONS ==========

// Open Customer Modal
function openCustomerModal(customerId = null) {
document.getElementById('customerForm').reset();
document.getElementById('customerId').value = '';
document.getElementById('customerModalTitle').textContent = customerId ? 'Edit Customer' : 'Add New Customer';

// Hide Phase 1 tabs for new customers
if (!customerId) {
document.getElementById('commTabBtn').style.display = 'none';
document.getElementById('tasksTabBtn').style.display = 'none';
document.getElementById('purchasesTabBtn').style.display = 'none';
switchCustomerTab('info');
} else {
document.getElementById('commTabBtn').style.display = 'block';
document.getElementById('tasksTabBtn').style.display = 'block';
document.getElementById('purchasesTabBtn').style.display = 'block';
}

if (customerId) {
const customer = crmData.customers.find(c => c.id === customerId);
if (customer) {
document.getElementById('customerId').value = customer.id;
document.getElementById('customerName').value = customer.name;
document.getElementById('customerContact').value = customer.contactType || '';
document.getElementById('customerEmail').value = customer.email || '';
document.getElementById('customerPhone').value = customer.phone || '';
document.getElementById('customerStatus').value = customer.status;
document.getElementById('customerIndustry').value = customer.industry || '';
document.getElementById('customerAgeRange').value = customer.ageRange || '';

// Billing Address
document.getElementById('customerBillingStreet').value = customer.billingAddress?.street || '';
document.getElementById('customerBillingCity').value = customer.billingAddress?.city || '';
document.getElementById('customerBillingState').value = customer.billingAddress?.state || '';
document.getElementById('customerBillingZip').value = customer.billingAddress?.zip || '';

// Shipping Address
document.getElementById('customerShippingStreet').value = customer.shippingAddress?.street || '';
document.getElementById('customerShippingCity').value = customer.shippingAddress?.city || '';
document.getElementById('customerShippingState').value = customer.shippingAddress?.state || '';
document.getElementById('customerShippingZip').value = customer.shippingAddress?.zip || '';

document.getElementById('customerLeadSource').value = customer.leadSource || '';
document.getElementById('customerReferredBy').value = customer.referredBy || '';

// Social Media
if (customer.socialPlatforms) {
customer.socialPlatforms.forEach(platform => {
const checkbox = document.getElementById(`social${platform}`);
if (checkbox) checkbox.checked = true;
});
}
document.getElementById('customerSocialHandle').value = customer.socialHandle || '';
document.getElementById('customerSocialEngagement').value = customer.socialEngagement || '';

// Pickleball
document.getElementById('customerSkillLevel').value = customer.skillLevel || '';
document.getElementById('customerPlayFrequency').value = customer.playFrequency || '';
document.getElementById('customerPaddleBrand').value = customer.paddleBrand || '';
document.getElementById('customerInterests').value = customer.interests || '';

// Communication Preferences
document.getElementById('customerPreferredContact').value = customer.preferredContact || '';
document.getElementById('customerContactFrequency').value = customer.contactFrequency || '';

// Referral
document.getElementById('customerReferralCode').value = customer.referralCode || '';
document.getElementById('customerReferralPotential').value = customer.referralPotential || '';

document.getElementById('customerNotes').value = customer.notes || '';
}
}

// Generate referral code for new customers
if (!customerId) {
document.getElementById('customerReferralCode').value = generateReferralCode();
}

document.getElementById('customerModal').style.display = 'block';
}

// Save Customer
function saveCustomer(event) {
event.preventDefault();

const customerId = document.getElementById('customerId').value;
const name = document.getElementById('customerName').value;

// Get social platforms
const socialPlatforms = [];
['Facebook', 'Instagram', 'Twitter', 'LinkedIn', 'TikTok', 'YouTube'].forEach(platform => {
if (document.getElementById(`social${platform}`).checked) {
socialPlatforms.push(platform);
}
});

const customer = {
id: customerId || Date.now().toString(),
name: name,
contactType: document.getElementById('customerContact').value,
email: document.getElementById('customerEmail').value,
phone: document.getElementById('customerPhone').value,
status: document.getElementById('customerStatus').value,
industry: document.getElementById('customerIndustry').value,
ageRange: document.getElementById('customerAgeRange').value,
billingAddress: {
street: document.getElementById('customerBillingStreet').value,
city: document.getElementById('customerBillingCity').value,
state: document.getElementById('customerBillingState').value,
zip: document.getElementById('customerBillingZip').value
},
shippingAddress: {
street: document.getElementById('customerShippingStreet').value,
city: document.getElementById('customerShippingCity').value,
state: document.getElementById('customerShippingState').value,
zip: document.getElementById('customerShippingZip').value
},
leadSource: document.getElementById('customerLeadSource').value,
referredBy: document.getElementById('customerReferredBy').value,
socialPlatforms: socialPlatforms,
socialHandle: document.getElementById('customerSocialHandle').value,
socialEngagement: document.getElementById('customerSocialEngagement').value,
skillLevel: document.getElementById('customerSkillLevel').value,
playFrequency: document.getElementById('customerPlayFrequency').value,
paddleBrand: document.getElementById('customerPaddleBrand').value,
interests: document.getElementById('customerInterests').value,
preferredContact: document.getElementById('customerPreferredContact').value,
contactFrequency: document.getElementById('customerContactFrequency').value,
referralCode: document.getElementById('customerReferralCode').value,
referralPotential: document.getElementById('customerReferralPotential').value,
notes: document.getElementById('customerNotes').value,
aiScore: customerId ? crmData.customers.find(c => c.id === customerId)?.aiScore : calculateAIScore(),
referralCount: customerId ? crmData.customers.find(c => c.id === customerId)?.referralCount || 0 : 0,
referralCredit: customerId ? crmData.customers.find(c => c.id === customerId)?.referralCredit || 0 : 0,
createdAt: customerId ? crmData.customers.find(c => c.id === customerId).createdAt : new Date().toISOString()
};

if (customerId) {
const index = crmData.customers.findIndex(c => c.id === customerId);
crmData.customers[index] = customer;
} else {
crmData.customers.push(customer);
}

// Update referrer's count
if (customer.referredBy) {
const referrer = crmData.customers.find(c => 
c.name.toLowerCase() === customer.referredBy.toLowerCase()
);
if (referrer) {
referrer.referralCount = (referrer.referralCount || 0) + 1;
referrer.referralCredit = referrer.referralCount * referralSettings.creditAmount;
}
}

saveData();
updateDashboard();
updateCustomersView();
updatePipelineView();
closeModal('customerModal');
showNotification(customerId ? 'Customer updated successfully!' : 'Customer added successfully!');

return false;
}

// Delete Customer
function deleteCustomer(customerId) {
if (confirm('Are you sure you want to delete this customer? This will also delete all related orders, tasks, and communications.')) {
crmData.customers = crmData.customers.filter(c => c.id !== customerId);
crmData.orders = crmData.orders.filter(o => o.customerId !== customerId);
crmData.tasks = crmData.tasks.filter(t => t.customerId !== customerId);
crmData.communications = crmData.communications.filter(c => c.customerId !== customerId);
saveData();
updateDashboard();
updateCustomersView();
updateOrdersView();
updatePipelineView();
showNotification('Customer deleted successfully!');
}
}

// Filter Customers
function filterCustomers() {
const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
const statusFilter = document.getElementById('customerStatusFilter').value;

const filtered = crmData.customers.filter(customer => {
const matchesSearch = customer.name.toLowerCase().includes(searchTerm) ||
(customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
(customer.phone && customer.phone.includes(searchTerm));
const matchesStatus = !statusFilter || customer.status === statusFilter;
return matchesSearch && matchesStatus;
});

updateCustomersTable(filtered);
}

// Update Customers Table
function updateCustomersTable(customers = crmData.customers) {
const tbody = document.getElementById('customersTableBody');
if (customers.length === 0) {
tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No customers found.</td></tr>';
return;
}

let html = '';
customers.forEach(customer => {
const statusClass = customer.status === 'Active' ? 'status-active' : 
customer.status === 'Prospect' ? 'status-prospect' : 'status-inactive';

const scoreClass = customer.aiScore >= 80 ? 'score-high' : 
customer.aiScore >= 50 ? 'score-medium' : 'score-low';

const referralTier = getReferralTier(customer.referralCount || 0);
const tierEmoji = referralTier === 'Platinum' ? '' : 
referralTier === 'Gold' ? '' : 
referralTier === 'Silver' ? '' : 
referralTier === 'Bronze' ? '' : '';

html += `
<tr>
<td>
<div style="font-weight: 600; color: #2e5940;">${customer.name}</div>
<div style="font-size: 12px; color: #999;">${customer.contactType || 'Individual'}</div>
</td>
<td>
${customer.email ? `<div style="font-size: 13px;"><i class="fas fa-envelope"></i> ${customer.email}</div>` : ''}
${customer.phone ? `<div style="font-size: 13px;"><i class="fas fa-phone"></i> ${customer.phone}</div>` : ''}
</td>
<td><span class="status-badge ${statusClass}">${customer.status}</span></td>
<td><span class="score-badge ${scoreClass}">${customer.aiScore}</span></td>
<td>
${customer.referralCount > 0 ? `
<div style="font-weight: 600; color: #43a047;">${tierEmoji} ${customer.referralCount} referrals</div>
<div style="font-size: 12px; color: #666;">$${customer.referralCredit.toFixed(2)} credit</div>
` : '<span style="color: #999;">None</span>'}
</td>
<td>
<button onclick="openCustomerModal('${customer.id}')" class="btn-secondary" style="padding: 6px 12px; margin-right: 5px;">
<i class="fas fa-edit"></i>
</button>
<button onclick="deleteCustomer('${customer.id}')" class="btn-danger" style="padding: 6px 12px;">
<i class="fas fa-trash"></i>
</button>
</td>
</tr>
`;
});

tbody.innerHTML = html;
}

// Update Customers View
function updateCustomersView() {
updateCustomersTable();
}

// Copy Same as Billing Address
function copySameAsBilling() {
const checkbox = document.getElementById('sameAsBilling');
if (checkbox.checked) {
document.getElementById('customerShippingStreet').value = document.getElementById('customerBillingStreet').value;
document.getElementById('customerShippingCity').value = document.getElementById('customerBillingCity').value;
document.getElementById('customerShippingState').value = document.getElementById('customerBillingState').value;
document.getElementById('customerShippingZip').value = document.getElementById('customerBillingZip').value;
}
}

// Generate Referral Code
function generateReferralCode() {
return 'REF' + Math.random().toString(36).substr(2, 8).toUpperCase();
}

// Calculate AI Score
function calculateAIScore() {
return Math.floor(Math.random() * 40) + 60; // Random score between 60-100
}

// Get Referral Tier
function getReferralTier(count) {
if (count >= referralSettings.tiers.platinum.min) return 'Platinum';
if (count >= referralSettings.tiers.gold.min && count <= referralSettings.tiers.gold.max) return 'Gold';
if (count >= referralSettings.tiers.silver.min && count <= referralSettings.tiers.silver.max) return 'Silver';
if (count >= referralSettings.tiers.bronze.min && count <= referralSettings.tiers.bronze.max) return 'Bronze';
return 'None';
}
// ========== ORDER FUNCTIONS (FIXED - SEPARATE SHIPPING FIELDS) ==========

// Open Order Modal
function openOrderModal(orderId = null) {
document.getElementById('orderForm').reset();
document.getElementById('orderId').value = '';
document.getElementById('orderModalTitle').textContent = orderId ? 'Edit Order' : 'New Order';

// Populate customer dropdown
const customerSelect = document.getElementById('orderCustomer');
customerSelect.innerHTML = '<option value="">Select Customer...</option>';
crmData.customers.forEach(customer => {
const option = document.createElement('option');
option.value = customer.id;
option.textContent = customer.name;
customerSelect.appendChild(option);
});

if (orderId) {
const order = crmData.orders.find(o => o.id === orderId);
if (order) {
document.getElementById('orderId').value = order.id;
document.getElementById('orderCustomer').value = order.customerId;
document.getElementById('orderProduct').value = order.product;
document.getElementById('orderManufacturer').value = order.manufacturer || '';
document.getElementById('orderQuantity').value = order.quantity;
document.getElementById('orderPrice').value = order.price;
document.getElementById('orderDiscount').value = order.discount || 0;
document.getElementById('orderDate').value = order.date;
document.getElementById('orderStatus').value = order.status;
document.getElementById('orderNotes').value = order.notes || '';
document.getElementById('orderShippingCost').value = order.shippingCost || 0;
document.getElementById('orderShippingCompany').value = order.shippingCompany || '';
document.getElementById('orderTrackingNumber').value = order.trackingNumber || '';

// Handle shipping address - support both object and legacy string format
if (typeof order.shippingAddress === 'object' && order.shippingAddress !== null) {
// New format: object with separate fields
document.getElementById('orderShippingStreet').value = order.shippingAddress.street || '';
document.getElementById('orderShippingCity').value = order.shippingAddress.city || '';
document.getElementById('orderShippingState').value = order.shippingAddress.state || '';
document.getElementById('orderShippingZip').value = order.shippingAddress.zip || '';
} else if (typeof order.shippingAddress === 'string') {
// Legacy format: single string - put in street field
document.getElementById('orderShippingStreet').value = order.shippingAddress;
document.getElementById('orderShippingCity').value = '';
document.getElementById('orderShippingState').value = order.shippingState || '';
document.getElementById('orderShippingZip').value = '';
} else {
// No shipping address
document.getElementById('orderShippingStreet').value = '';
document.getElementById('orderShippingCity').value = '';
document.getElementById('orderShippingState').value = '';
document.getElementById('orderShippingZip').value = '';
}

calculateOrderTotal();
}
} else {
// Set defaults for new order
const today = new Date().toISOString().split('T')[0];
document.getElementById('orderDate').value = today;
document.getElementById('orderQuantity').value = 1;
document.getElementById('orderDiscount').value = 0;
document.getElementById('orderShippingCost').value = 0;

// Reset order totals display for new orders
document.getElementById('orderSubtotal').textContent = '$0.00';
document.getElementById('orderTax').textContent = '$0.00';
document.getElementById('orderShipping').textContent = '$0.00';
document.getElementById('orderTotal').textContent = '$0.00';
}

document.getElementById('orderModal').style.display = 'block';
}

// Open Order Modal for Customer (from Purchases tab)
function openOrderModalForCustomer() {
const customerId = document.getElementById('customerId').value;
openOrderModal();
document.getElementById('orderCustomer').value = customerId;
updateShipAddress();
}

// Update Shipping Address from Customer
function updateShipAddress() {
const customerId = document.getElementById('orderCustomer').value;
if (!customerId) return;

const customer = crmData.customers.find(c => c.id === customerId);
if (customer && customer.shippingAddress) {
document.getElementById('orderShippingStreet').value = customer.shippingAddress.street || '';
document.getElementById('orderShippingCity').value = customer.shippingAddress.city || '';
document.getElementById('orderShippingState').value = customer.shippingAddress.state || '';
document.getElementById('orderShippingZip').value = customer.shippingAddress.zip || '';
}

calculateOrderTotal();
}

// Calculate Order Total
function calculateOrderTotal() {
const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
const price = parseFloat(document.getElementById('orderPrice').value) || 0;
const discount = parseFloat(document.getElementById('orderDiscount').value) || 0;
const shippingCost = parseFloat(document.getElementById('orderShippingCost').value) || 0;
const state = document.getElementById('orderShippingState').value;

const subtotal = (quantity * price) - discount;
const taxRate = state ? (stateTaxRates[state] || 0) : 0;
const tax = subtotal * (taxRate / 100);
const total = subtotal + tax + shippingCost;

document.getElementById('orderSubtotal').textContent = `$${subtotal.toFixed(2)}`;
document.getElementById('orderTax').textContent = `$${tax.toFixed(2)}`;
document.getElementById('orderShipping').textContent = `$${shippingCost.toFixed(2)}`;
document.getElementById('orderTotal').textContent = `$${total.toFixed(2)}`;
}

// Function: saveOrder(event)

// ... (code for creating the 'order' object)

// Find the index of the order in the array
const index = crmData.orders.findIndex(o => o.id === orderId);

// **REPLACE THE ORIGINAL IF/ELSE BLOCK WITH THE FOLLOWING:**
if (index !== -1) { 
    // This is an existing order (index was found)
    crmData.orders[index] = order;
    showNotification('Order updated successfully!');
} else { 
    // This is a NEW order (index was not found)
    crmData.orders.push(order);
    crmData.nextOrderId++;
    showNotification('New order added successfully!');
}
// ... (rest of the function, saveData(), closeModal(), etc.)
saveData();
updateDashboard();
updateOrdersView();
closeModal('orderModal');
showNotification(orderId ? 'Order updated successfully!' : 'Order created successfully!');

// Refresh purchases tab if customer modal is open
if (document.getElementById('customerModal').style.display === 'block') {
loadCustomerPurchases(customerId);
}

return false;
}

// Delete Order
function deleteOrder(orderId) {
    if (confirm('Are you sure you want to delete this order?')) {
        crmData.orders = crmData.orders.filter(o => o.id !== orderId);
        saveData();
        updateDashboard();
        updateOrdersView();
        showNotification('Order deleted successfully!');
    }
}

// Update Orders View
function updateOrdersView() {
const tbody = document.getElementById('ordersTableBody');
if (crmData.orders.length === 0) {
tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No orders yet. Click "New Order" to create one.</td></tr>';
return;
}

// Sort by date (newest first)
const sortedOrders = [...crmData.orders].sort((a, b) => new Date(b.date) - new Date(a.date));

let html = '';
sortedOrders.forEach(order => {
const statusColors = {
'Pending': '#ffa726',
'Processing': '#42a5f5',
'Shipped': '#66bb6a',
'Delivered': '#43a047',
'Cancelled': '#e53935'
};

const date = new Date(order.date);
const dateStr = date.toLocaleDateString();

html += `
<tr>
<td style="font-weight: 600; color: #2e5940;">#${order.id.substr(-6)}</td>
<td>${order.customerName}</td>
<td>
<div style="font-weight: 600;">${order.product}</div>
${order.manufacturer ? `<div style="font-size: 12px; color: #666;">${order.manufacturer}</div>` : ''}
</td>
<td>${dateStr}</td>
<td style="font-weight: 600; color: #43a047;">$${order.total.toFixed(2)}</td>
<td>
<span style="background: ${statusColors[order.status]}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
${order.status}
</span>
</td>
<td>
<button onclick="openOrderModal('${order.id}')" class="btn-secondary" style="padding: 6px 12px; margin-right: 5px;">
<i class="fas fa-edit"></i>
</button>
<button onclick="deleteOrder('${order.id}')" class="btn-danger" style="padding: 6px 12px;">
<i class="fas fa-trash"></i>
</button>
</td>
</tr>
`;
});

tbody.innerHTML = html;
}
// ========== CALENDAR & EVENT FUNCTIONS ==========

// Render Calendar
function renderCalendar() {
const year = currentDate.getFullYear();
const month = currentDate.getMonth();
const firstDay = new Date(year, month, 1);
const lastDay = new Date(year, month + 1, 0);
const daysInMonth = lastDay.getDate();
const startingDayOfWeek = firstDay.getDay();

const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
'July', 'August', 'September', 'October', 'November', 'December'];
document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

const calendarGrid = document.getElementById('calendarGrid');
calendarGrid.innerHTML = '';

// Add empty cells for days before month starts
for (let i = 0; i < startingDayOfWeek; i++) {
const emptyDay = document.createElement('div');
emptyDay.className = 'calendar-day';
emptyDay.style.opacity = '0.3';
calendarGrid.appendChild(emptyDay);
}

// Add days of the month
const today = new Date();
for (let day = 1; day <= daysInMonth; day++) {
const dayDiv = document.createElement('div');
dayDiv.className = 'calendar-day';

const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
const isToday = dateStr === today.toISOString().split('T')[0];
if (isToday) dayDiv.classList.add('today');

dayDiv.innerHTML = `<div style="font-weight: 700; color: #2e5940; margin-bottom: 5px;">${day}</div>`;

// Check for holidays
if (holidays[dateStr]) {
dayDiv.innerHTML += `<div class="holiday-item">${holidays[dateStr]}</div>`;
}

// Check for events
const dayEvents = crmData.events.filter(e => e.date === dateStr);
dayEvents.forEach(event => {
dayDiv.innerHTML += `<div class="event-item" onclick="viewEventDetails('${event.id}')">${event.title}</div>`;
});

dayDiv.onclick = () => openEventModal(null, dateStr);
calendarGrid.appendChild(dayDiv);
}
}

// Change Month
function changeMonth(delta) {
currentDate.setMonth(currentDate.getMonth() + delta);
renderCalendar();
}

// Open Event Modal
function openEventModal(eventId = null, presetDate = null) {
document.getElementById('eventForm').reset();
document.getElementById('eventId').value = '';
document.getElementById('eventModalTitle').textContent = eventId ? 'Edit Event' : 'Schedule Event';

// Populate customer dropdown
const customerSelect = document.getElementById('eventCustomer');
customerSelect.innerHTML = '<option value="">Select Customer...</option>';
crmData.customers.forEach(customer => {
const option = document.createElement('option');
option.value = customer.id;
option.textContent = customer.name;
customerSelect.appendChild(option);
});

if (eventId) {
const event = crmData.events.find(e => e.id === eventId);
if (event) {
document.getElementById('eventId').value = event.id;
document.getElementById('eventType').value = event.type;
document.getElementById('eventTitle').value = event.title;
document.getElementById('eventCustomer').value = event.customerId || '';
document.getElementById('eventDate').value = event.date;
document.getElementById('eventTime').value = event.time || '';
document.getElementById('eventDescription').value = event.description || '';
}
} else {
if (presetDate) {
document.getElementById('eventDate').value = presetDate;
} else {
const today = new Date().toISOString().split('T')[0];
document.getElementById('eventDate').value = today;
}
}

document.getElementById('eventModal').style.display = 'block';
}

// Save Event
function saveEvent(event) {
event.preventDefault();

const eventId = document.getElementById('eventId').value;
const newEvent = {
id: eventId || Date.now().toString(),
type: document.getElementById('eventType').value,
title: document.getElementById('eventTitle').value,
customerId: document.getElementById('eventCustomer').value || null,
customerName: document.getElementById('eventCustomer').value ? 
crmData.customers.find(c => c.id === document.getElementById('eventCustomer').value)?.name : null,
date: document.getElementById('eventDate').value,
time: document.getElementById('eventTime').value,
description: document.getElementById('eventDescription').value,
createdAt: eventId ? crmData.events.find(e => e.id === eventId).createdAt : new Date().toISOString()
};

if (eventId) {
const index = crmData.events.findIndex(e => e.id === eventId);
crmData.events[index] = newEvent;
} else {
crmData.events.push(newEvent);
}

saveData();
renderCalendar();
closeModal('eventModal');
showNotification(eventId ? 'Event updated successfully!' : 'Event scheduled successfully!');

return false;
}

// View Event Details
function viewEventDetails(eventId) {
currentEventId = eventId;
const event = crmData.events.find(e => e.id === eventId);
if (!event) return;

const date = new Date(event.date);
const dateStr = date.toLocaleDateString();
const timeStr = event.time || 'Not specified';

let html = `
<div style="padding: 20px;">
<div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
<div style="font-size: 24px; font-weight: 700; color: #2e5940; margin-bottom: 10px;">${event.title}</div>
<div style="display: flex; gap: 10px; margin-bottom: 10px;">
<span style="background: #66bb6a; color: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;">
<i class="fas fa-tag"></i> ${event.type}
</span>
</div>
<div style="color: #666; margin-top: 10px;">
<div style="margin-bottom: 5px;"><i class="fas fa-calendar"></i> ${dateStr}</div>
<div style="margin-bottom: 5px;"><i class="fas fa-clock"></i> ${timeStr}</div>
${event.customerName ? `<div><i class="fas fa-user"></i> ${event.customerName}</div>` : ''}
</div>
</div>
${event.description ? `
<div style="margin-bottom: 15px;">
<div style="font-weight: 600; color: #2e5940; margin-bottom: 5px;">Description:</div>
<div style="color: #666;">${event.description}</div>
</div>
` : ''}
</div>
`;

document.getElementById('eventDetailsContent').innerHTML = html;
document.getElementById('eventDetailsModal').style.display = 'block';
}

// Edit Event from Details
function editEventFromDetails() {
closeModal('eventDetailsModal');
openEventModal(currentEventId);
}

// Delete Event from Details
function deleteEventFromDetails() {
if (confirm('Are you sure you want to delete this event?')) {
crmData.events = crmData.events.filter(e => e.id !== currentEventId);
saveData();
renderCalendar();
closeModal('eventDetailsModal');
showNotification('Event deleted successfully!');
}
}
// ========== DASHBOARD FUNCTIONS ==========

// Update Dashboard
function updateDashboard() {
// Total customers
const totalCustomers = crmData.customers.length;
const activeCustomers = crmData.customers.filter(c => c.status === 'Active').length;
document.getElementById('totalCustomers').textContent = totalCustomers;
document.getElementById('activeCustomers').textContent = activeCustomers;

// Revenue stats
const totalRevenue = crmData.orders.reduce((sum, order) => sum + order.total, 0);
document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(0)}`;
document.getElementById('totalOrders').textContent = crmData.orders.length;

// This month stats
const now = new Date();
const thisMonthOrders = crmData.orders.filter(order => {
const orderDate = new Date(order.date);
return orderDate.getMonth() === now.getMonth() && 
orderDate.getFullYear() === now.getFullYear();
});
const monthRevenue = thisMonthOrders.reduce((sum, order) => sum + order.total, 0);
document.getElementById('monthRevenue').textContent = `$${monthRevenue.toFixed(0)}`;
document.getElementById('monthOrders').textContent = thisMonthOrders.length;

// Average order value
const avgOrderValue = crmData.orders.length > 0 ? totalRevenue / crmData.orders.length : 0;
document.getElementById('avgOrderValue').textContent = `$${avgOrderValue.toFixed(0)}`;

// Recent customers
const recentCustomers = [...crmData.customers]
.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
.slice(0, 5);

const recentCustomersDiv = document.getElementById('recentCustomers');
if (recentCustomers.length === 0) {
recentCustomersDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No customers yet</p>';
} else {
let html = '';
recentCustomers.forEach(customer => {
const statusClass = customer.status === 'Active' ? 'status-active' : 
customer.status === 'Prospect' ? 'status-prospect' : 'status-inactive';
html += `
<div style="padding: 15px; background: #f1f8e9; border-radius: 8px; margin-bottom: 10px; cursor: pointer;" onclick="openCustomerModal('${customer.id}')">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-weight: 600; color: #2e5940; margin-bottom: 5px;">${customer.name}</div>
<div style="font-size: 12px; color: #666;">${customer.email || 'No email'}</div>
</div>
<span class="status-badge ${statusClass}">${customer.status}</span>
</div>
</div>
`;
});
recentCustomersDiv.innerHTML = html;
}

// Today's tasks
const today = new Date().toISOString().split('T')[0];
const todaysTasks = crmData.tasks.filter(t => t.dueDate === today && t.status !== 'Completed');

const todaysTasksDiv = document.getElementById('todaysTasks');
if (todaysTasks.length === 0) {
todaysTasksDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No tasks scheduled for today</p>';
} else {
let html = '';
todaysTasks.forEach(task => {
const customer = crmData.customers.find(c => c.id === task.customerId);
const priorityColor = task.priority === 'High' ? '#e53935' : 
task.priority === 'Medium' ? '#ffa726' : '#66bb6a';

html += `
<div style="padding: 15px; background: #f1f8e9; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${priorityColor}; cursor: pointer;" onclick="editTask('${task.id}')">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
<div style="font-weight: 600; color: #2e5940;">${task.title}</div>
<span style="background: ${priorityColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
${task.priority}
</span>
</div>
${customer ? `<div style="font-size: 12px; color: #666;"><i class="fas fa-user"></i> ${customer.name}</div>` : ''}
</div>
`;
});
todaysTasksDiv.innerHTML = html;
}
}

// ========== PIPELINE FUNCTIONS ==========

// Update Pipeline View
function updatePipelineView() {
const prospects = crmData.customers.filter(c => c.status === 'Prospect');
const active = crmData.customers.filter(c => c.status === 'Active');
const inactive = crmData.customers.filter(c => c.status === 'Inactive');

updatePipelineColumn('prospectsList', prospects);
updatePipelineColumn('activeList', active);
updatePipelineColumn('inactiveList', inactive);
}

function updatePipelineColumn(columnId, customers) {
const column = document.getElementById(columnId);
if (customers.length === 0) {
column.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No customers</p>';
return;
}

let html = '';
customers.forEach(customer => {
const scoreClass = customer.aiScore >= 80 ? 'score-high' : 
customer.aiScore >= 50 ? 'score-medium' : 'score-low';

html += `
<div style="padding: 15px; background: #f1f8e9; border-radius: 8px; margin-bottom: 10px; cursor: pointer;" onclick="openCustomerModal('${customer.id}')">
<div style="font-weight: 600; color: #2e5940; margin-bottom: 5px;">${customer.name}</div>
<div style="font-size: 12px; color: #666; margin-bottom: 8px;">${customer.email || 'No email'}</div>
<div style="display: flex; justify-content: space-between; align-items: center;">
<span class="score-badge ${scoreClass}">Score: ${customer.aiScore}</span>
${customer.leadSource ? `<span style="font-size: 11px; color: #666;">${customer.leadSource}</span>` : ''}
</div>
</div>
`;
});
column.innerHTML = html;
}

// ========== ANALYTICS FUNCTIONS ==========

// Render Lead Source Chart
function renderLeadSourceChart() {
const ctx = document.getElementById('leadSourceChart');
if (!ctx) return;

const sources = {};
crmData.customers.forEach(customer => {
const source = customer.leadSource || 'Unknown';
sources[source] = (sources[source] || 0) + 1;
});

new Chart(ctx, {
type: 'pie',
data: {
labels: Object.keys(sources),
datasets: [{
data: Object.values(sources),
backgroundColor: [
'#66bb6a', '#42a5f5', '#ffa726', '#ab47bc', 
'#26c6da', '#ef5350', '#ffca28', '#5c6bc0'
]
}]
},
options: {
responsive: true,
maintainAspectRatio: true,
plugins: {
legend: {
position: 'bottom'
}
}
}
});
}

// Render Social Chart
function renderSocialChart() {
const ctx = document.getElementById('socialChart');
if (!ctx) return;

const platforms = {};
crmData.customers.forEach(customer => {
if (customer.socialPlatforms) {
customer.socialPlatforms.forEach(platform => {
platforms[platform] = (platforms[platform] || 0) + 1;
});
}
});

new Chart(ctx, {
type: 'bar',
data: {
labels: Object.keys(platforms),
datasets: [{
label: 'Active Users',
data: Object.values(platforms),
backgroundColor: '#42a5f5'
}]
},
options: {
responsive: true,
maintainAspectRatio: true,
plugins: {
legend: {
display: false
}
},
scales: {
y: {
beginAtZero: true,
ticks: {
stepSize: 1
}
}
}
}
});
}

// Render Revenue Chart
function renderRevenueChart() {
const ctx = document.getElementById('revenueChart');
if (!ctx) return;

// Get last 6 months
const months = [];
const revenue = [];
const now = new Date();

for (let i = 5; i >= 0; i--) {
const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
const monthName = date.toLocaleString('default', { month: 'short' });
months.push(monthName);

const monthRevenue = crmData.orders
.filter(order => {
const orderDate = new Date(order.date);
return orderDate.getMonth() === date.getMonth() && 
orderDate.getFullYear() === date.getFullYear();
})
.reduce((sum, order) => sum + order.total, 0);

revenue.push(monthRevenue);
}

new Chart(ctx, {
type: 'line',
data: {
labels: months,
datasets: [{
label: 'Revenue ($)',
data: revenue,
borderColor: '#43a047',
backgroundColor: 'rgba(67, 160, 71, 0.1)',
tension: 0.4,
fill: true
}]
},
options: {
responsive: true,
maintainAspectRatio: true,
plugins: {
legend: {
display: false
}
},
scales: {
y: {
beginAtZero: true,
ticks: {
callback: function(value) {
return '$' + value;
}
}
}
}
}
});
}

// Generate AI Insights
function generateAIInsights() {
const container = document.getElementById('aiInsights');
if (!container) return;

const totalCustomers = crmData.customers.length;
const activeCustomers = crmData.customers.filter(c => c.status === 'Active').length;
const prospects = crmData.customers.filter(c => c.status === 'Prospect').length;
const avgScore = totalCustomers > 0 ? 
crmData.customers.reduce((sum, c) => sum + c.aiScore, 0) / totalCustomers : 0;

const topReferrers = [...crmData.customers]
.filter(c => c.referralCount > 0)
.sort((a, b) => b.referralCount - a.referralCount)
.slice(0, 3);

let html = '<div style="display: grid; gap: 15px;">';

// Insight 1: Conversion opportunity
if (prospects > 0) {
html += `
<div style="padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 8px;">
<div style="font-weight: 600; color: #1976d2; margin-bottom: 5px;">
<i class="fas fa-lightbulb"></i> Conversion Opportunity
</div>
<div style="color: #666; font-size: 14px;">
You have ${prospects} prospect(s). Focus on converting high-scoring prospects to active customers.
</div>
</div>
`;
}

// Insight 2: Average engagement score
html += `
<div style="padding: 15px; background: #f3e5f5; border-left: 4px solid #ab47bc; border-radius: 8px;">
<div style="font-weight: 600; color: #8e24aa; margin-bottom: 5px;">
<i class="fas fa-chart-line"></i> Average Engagement Score
</div>
<div style="color: #666; font-size: 14px;">
Your average customer AI score is ${avgScore.toFixed(0)}. ${avgScore >= 75 ? 'Great job maintaining high engagement!' : 'Consider reaching out to low-scoring customers.'}
</div>
</div>
`;

// Insight 3: Top referrers
if (topReferrers.length > 0) {
html += `
<div style="padding: 15px; background: #e8f5e9; border-left: 4px solid #43a047; border-radius: 8px;">
<div style="font-weight: 600; color: #2e7d32; margin-bottom: 5px;">
<i class="fas fa-trophy"></i> Top Referrers
</div>
<div style="color: #666; font-size: 14px;">
${topReferrers.map(c => `${c.name} (${c.referralCount} referrals)`).join(', ')} are your top advocates. Consider rewarding them!
</div>
</div>
`;
}

html += '</div>';
container.innerHTML = html;
}
// ========== MARKETING FUNCTIONS ==========

// Update Marketing View
function updateMarketingView() {
const container = document.getElementById('marketingRecommendations');
if (!container) return;

const activeCustomers = crmData.customers.filter(c => c.status === 'Active').length;
const prospects = crmData.customers.filter(c => c.status === 'Prospect').length;
const highEngagement = crmData.customers.filter(c => c.socialEngagement === 'High').length;

let html = '<div style="display: grid; gap: 15px;">';

if (prospects > 5) {
html += `
<div style="padding: 15px; background: #fff3e0; border-left: 4px solid #ffa726; border-radius: 8px;">
<div style="font-weight: 600; color: #f57c00; margin-bottom: 5px;">
<i class="fas fa-bullhorn"></i> Prospect Campaign Recommended
</div>
<div style="color: #666; font-size: 14px;">
You have ${prospects} prospects. Consider launching an email campaign to convert them.
</div>
</div>
`;
}

if (highEngagement > 0) {
html += `
<div style="padding: 15px; background: #e8f5e9; border-left: 4px solid #43a047; border-radius: 8px;">
<div style="font-weight: 600; color: #2e7d32; margin-bottom: 5px;">
<i class="fas fa-share-alt"></i> Social Media Opportunity
</div>
<div style="color: #666; font-size: 14px;">
${highEngagement} customer(s) are highly engaged on social media. Perfect for user-generated content campaigns!
</div>
</div>
`;
}

if (activeCustomers > 10) {
html += `
<div style="padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 8px;">
<div style="font-weight: 600; color: #1976d2; margin-bottom: 5px;">
<i class="fas fa-heart"></i> Loyalty Program
</div>
<div style="color: #666; font-size: 14px;">
With ${activeCustomers} active customers, now is a great time to launch a loyalty rewards program.
</div>
</div>
`;
}

html += '</div>';
container.innerHTML = html;
}

// Create Email List
function createEmailList(type = 'all') {
let customers = [];
let listName = '';

switch(type) {
case 'active':
customers = crmData.customers.filter(c => c.status === 'Active' && c.email);
listName = 'Active Customers';
break;
case 'prospects':
customers = crmData.customers.filter(c => c.status === 'Prospect' && c.email);
listName = 'Prospects';
break;
case 'high-value':
const avgOrderValue = crmData.orders.length > 0 ? 
crmData.orders.reduce((sum, o) => sum + o.total, 0) / crmData.orders.length : 0;
const highValueCustomerIds = crmData.orders
.filter(o => o.total > avgOrderValue)
.map(o => o.customerId);
customers = crmData.customers.filter(c => highValueCustomerIds.includes(c.id) && c.email);
listName = 'High-Value Customers';
break;
default:
customers = crmData.customers.filter(c => c.email);
listName = 'All Customers';
}

if (customers.length === 0) {
showNotification('No customers with email addresses found for this list.', 'error');
return;
}

const emails = customers.map(c => c.email).join(', ');
const emailBody = `Email List: ${listName}\n\nTotal: ${customers.length} customers\n\nEmail addresses:\n${emails}`;

// Create downloadable file
const blob = new Blob([emailBody], { type: 'text/plain' });
const url = URL.createObjectURL(blob);
const link = document.createElement('a');
link.href = url;
link.download = `${listName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
link.click();

showNotification(`Email list created: ${customers.length} customers`);
}

// Create SMS List
function createSMSList(type = 'all') {
let customers = [];
let listName = '';

switch(type) {
case 'all':
customers = crmData.customers.filter(c => c.phone);
listName = 'All Customers with Phone';
break;
case 'pickleball':
customers = crmData.customers.filter(c => c.phone && c.skillLevel);
listName = 'Pickleball Players';
break;
case 'referrers':
customers = crmData.customers.filter(c => c.phone && c.referralCount > 0);
listName = 'Top Referrers';
break;
default:
customers = crmData.customers.filter(c => c.phone);
listName = 'All Customers';
}

if (customers.length === 0) {
showNotification('No customers with phone numbers found for this list.', 'error');
return;
}

const phones = customers.map(c => `${c.name}: ${c.phone}`).join('\n');
const smsBody = `SMS List: ${listName}\n\nTotal: ${customers.length} customers\n\n${phones}`;

// Create downloadable file
const blob = new Blob([smsBody], { type: 'text/plain' });
const url = URL.createObjectURL(blob);
const link = document.createElement('a');
link.href = url;
link.download = `${listName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
link.click();

showNotification(`SMS list created: ${customers.length} customers`);
}

// View Social Contacts
function viewSocialContacts() {
const socialCustomers = crmData.customers.filter(c => c.socialPlatforms && c.socialPlatforms.length > 0);

if (socialCustomers.length === 0) {
showNotification('No customers with social media information found.', 'error');
return;
}

let content = 'Social Media Contacts\n\n';
socialCustomers.forEach(customer => {
content += `${customer.name}\n`;
content += `Platforms: ${customer.socialPlatforms.join(', ')}\n`;
if (customer.socialHandle) content += `Handle: ${customer.socialHandle}\n`;
if (customer.socialEngagement) content += `Engagement: ${customer.socialEngagement}\n`;
content += '\n';
});

const blob = new Blob([content], { type: 'text/plain' });
const url = URL.createObjectURL(blob);
const link = document.createElement('a');
link.href = url;
link.download = `Social_Contacts_${new Date().toISOString().split('T')[0]}.txt`;
link.click();

showNotification(`Social contacts exported: ${socialCustomers.length} customers`);
}

// ========== REFERRAL FUNCTIONS ==========

// Update Referrals View
function updateReferralsView() {
const container = document.getElementById('referralLeaderboard');
if (!container) return;

const referrers = crmData.customers
.filter(c => c.referralCount > 0)
.sort((a, b) => b.referralCount - a.referralCount);

if (referrers.length === 0) {
container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No referrals yet. Encourage customers to refer friends!</p>';
return;
}

let html = '<div style="display: grid; gap: 15px;">';

referrers.forEach((customer, index) => {
const tier = getReferralTier(customer.referralCount);
const tierColors = {
'Platinum': '#9c27b0',
'Gold': '#ffa726',
'Silver': '#78909c',
'Bronze': '#cd7f32'
};
const tierEmojis = {
'Platinum': '',
'Gold': '',
'Silver': '',
'Bronze': ''
};

html += `
<div style="padding: 20px; background: linear-gradient(135deg, ${tierColors[tier] || '#e0e0e0'} 0%, ${tierColors[tier] || '#e0e0e0'}dd 100%); border-radius: 12px; color: white;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
<div style="display: flex; align-items: center; gap: 10px;">
<div style="font-size: 32px;">${tierEmojis[tier] || ''}</div>
<div>
<div style="font-size: 20px; font-weight: 700;">#${index + 1} ${customer.name}</div>
<div style="opacity: 0.9; font-size: 14px;">${tier} Tier</div>
</div>
</div>
<div style="text-align: right;">
<div style="font-size: 28px; font-weight: 700;">${customer.referralCount}</div>
<div style="opacity: 0.9; font-size: 13px;">Referrals</div>
</div>
</div>
<div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.3);">
<div style="opacity: 0.9;">Credit Earned:</div>
<div style="font-size: 20px; font-weight: 700;">$${customer.referralCredit.toFixed(2)}</div>
</div>
</div>
`;
});

html += '</div>';
container.innerHTML = html;
}

// ========== UTILITY FUNCTIONS ==========

// Function: Show View
function showView(viewName, elementId) { // ADDED elementId
    // ... hide all views ...

    // Remove active class from all nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });

    // Show selected view
    const viewId = viewName + 'View';
    const view = document.getElementById(viewId);
    if (view) {
        view.style.display = 'block';
    }

    // Add active class to selected nav item
    const navItem = document.getElementById(elementId); // Use passed ID
    if (navItem) {
        navItem.classList.add('active');
    }

    // ... view-specific updates ...
}
<ul>
        <li> Active Customers (Purchased in last 30 days)</li>
        <li> Dormant Customers (No purchase in 90+ days)</li>
        <li> High Value VIPs (Spent > $500)</li>
      </ul>
      <div style="margin-top: 15px; display: flex; gap: 10px;">
        <button class="btn-secondary" onclick="exportMarketingList('active')">Export Active</button>
        <button class="btn-secondary" onclick="exportMarketingList('dormant')">Export Dormant</button>
      </div>
    </div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: #2e5940; font-size: 18px; font-weight: 600;">
          <i class="fas fa-ad"></i> Promotions
        </h3>
        <button class="btn-primary" onclick="alert('Promo builder coming in Phase 2')">
          <i class="fas fa-plus"></i> New Promo
        </button>
      </div>
      <div class="info-box">
        <strong>Current Offer:</strong> "Referral Bonus" - Get $15 credit for every friend referred.
      </div>
      <div style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px;">
          <span>Campaign Performance</span>
          <span style="font-weight: 600;">68% Success</span>
        </div>
        <div style="background: #e8f5e9; height: 8px; border-radius: 4px; overflow: hidden;">
          <div style="background: #43a047; width: 68%; height: 100%;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="referralsView" class="view" style="display: none;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <div>
      <h2 style="color: #2e5940; font-size: 32px; font-weight: 700; margin-bottom: 5px;">Referral Program</h2>
      <p style="color: #666;">Manage rewards and affiliates</p>
    </div>
    <button class="btn-secondary" onclick="openReferralSettings()">
      <i class="fas fa-cog"></i> Settings
    </button>
  </div>

  <div class="grid-3">
    <div class="card">
      <div style="color: #999; font-size: 12px; font-weight: 600; text-transform: uppercase;">Total Referrals</div>
      <div style="font-size: 32px; font-weight: 700; color: #2e5940;" id="totalReferrals">0</div>
    </div>
    <div class="card">
      <div style="color: #999; font-size: 12px; font-weight: 600; text-transform: uppercase;">Credits Issued</div>
      <div style="font-size: 32px; font-weight: 700; color: #2e5940;" id="totalCredits">$0.00</div>
    </div>
    <div class="card">
      <div style="color: #999; font-size: 12px; font-weight: 600; text-transform: uppercase;">Top Referrer</div>
      <div style="font-size: 18px; font-weight: 700; color: #2e5940; margin-top: 8px;" id="topReferrer">None</div>
    </div>
  </div>

  <div class="card">
    <h3 style="color: #2e5940; font-size: 18px; font-weight: 600; margin-bottom: 20px;">Referral History</h3>
    <table class="table" id="referralTable">
      <thead>
        <tr>
          <th>Referred By</th>
          <th>New Customer</th>
          <th>Date</th>
          <th>Status</th>
          <th>Reward</th>
        </tr>
      </thead>
      <tbody id="referralTableBody">
        <tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">No referrals tracked yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>

</main>

<div id="customerModal" class="modal">
  <div class="modal-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
      <h3 style="color: #2e5940; font-size: 24px; font-weight: 700;">
        <i class="fas fa-user-circle"></i> <span id="modalTitle">Customer Details</span>
      </h3>
      <button onclick="closeModal('customerModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="tab-navigation">
      <button class="tab-button active" onclick="switchTab(event, 'tab-profile')">Profile</button>
      <button class="tab-button" onclick="switchTab(event, 'tab-comms')">Communications</button>
      <button class="tab-button" onclick="switchTab(event, 'tab-tasks')">Tasks</button>
      <button class="tab-button" onclick="switchTab(event, 'tab-history')">Order History</button>
    </div>

    <div id="tab-profile" class="tab-content active">
      <form id="customerForm" onsubmit="saveCustomer(event)">
        <input type="hidden" id="customerId">
        <div class="grid-2">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="name" required placeholder="Jane Doe">
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="email" required placeholder="jane@example.com">
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="phone" placeholder="(555) 123-4567">
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="status">
              <option value="Prospect">Prospect</option>
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Address</label>
          <textarea id="address" rows="2" placeholder="Shipping address..."></textarea>
        </div>

        <div class="form-group">
          <label>Notes & Preferences</label>
          <textarea id="notes" rows="3" placeholder="Skin type, allergies, preferences..."></textarea>
        </div>

        <div class="grid-2">
           <div class="form-group">
             <label>Referral Code (Auto-generated)</label>
             <input type="text" id="referralCode" readonly style="background: #f1f8e9; color: #666;">
           </div>
           <div class="form-group">
             <label>Referred By (Optional)</label>
             <input type="text" id="referredBy" placeholder="Enter code of referrer">
           </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
           <button type="button" class="btn-danger" id="deleteCustomerBtn" onclick="deleteCustomer()" style="display: none; margin-right: auto;">Delete</button>
           <button type="button" class="btn-secondary" onclick="closeModal('customerModal')">Cancel</button>
           <button type="submit" class="btn-primary">Save Customer</button>
        </div>
      </form>
    </div>

    <div id="tab-comms" class="tab-content">
      <button class="btn-primary" style="margin-bottom: 15px;" onclick="openCommunicationModal(document.getElementById('customerId').value)">
        <i class="fas fa-plus"></i> Log Communication
      </button>
      <div id="customerCommList" style="max-height: 400px; overflow-y: auto;">
        <p style="color: #999; padding: 20px; text-align: center;">Save customer to log communications.</p>
      </div>
    </div>

    <div id="tab-tasks" class="tab-content">
      <button class="btn-primary" style="margin-bottom: 15px;" onclick="openTaskModal(document.getElementById('customerId').value)">
        <i class="fas fa-plus"></i> Add Task
      </button>
      <div id="customerTaskList" style="max-height: 400px; overflow-y: auto;">
        <p style="color: #999; padding: 20px; text-align: center;">Save customer to manage tasks.</p>
      </div>
    </div>

    <div id="tab-history" class="tab-content">
      <div id="customerOrderList">
         <p style="color: #999; padding: 20px; text-align: center;">No orders found.</p>
      </div>
    </div>
  </div>
</div>

<div id="orderModal" class="modal">
  <div class="modal-content">
    <h3 style="color: #2e5940; margin-bottom: 20px;">New Order</h3>
    <form id="orderForm" onsubmit="saveOrder(event)">
      <div class="form-group">
        <label>Customer</label>
        <select id="orderCustomer" required>
          <option value="">Select Customer...</option>
        </select>
      </div>
      <div class="grid-2">
        <div class="form-group">
          <label>Product</label>
          <input type="text" id="orderProduct" required placeholder="e.g. Lavender Salve">
        </div>
        <div class="form-group">
          <label>Amount ($)</label>
          <input type="number" id="orderAmount" step="0.01" required>
        </div>
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="orderDate" required>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button type="button" class="btn-secondary" onclick="closeModal('orderModal')">Cancel</button>
        <button type="submit" class="btn-primary">Create Order</button>
      </div>
    </form>
  </div>
</div>

<div id="eventModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <h3 style="color: #2e5940; margin-bottom: 20px;">Schedule Event</h3>
    <form id="eventForm" onsubmit="saveEvent(event)">
      <div class="form-group">
        <label>Event Title</label>
        <input type="text" id="eventTitle" required>
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="eventDate" required>
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="eventType">
          <option value="meeting">Meeting</option>
          <option value="followup">Follow-up</option>
          <option value="personal">Personal</option>
        </select>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button type="button" class="btn-secondary" onclick="closeModal('eventModal')">Cancel</button>
        <button type="submit" class="btn-primary">Save Event</button>
      </div>
    </form>
  </div>
</div>

<script>
// --- CORE DATA MANAGEMENT & STATE ---
let state = {
    customers: [],
    orders: [],
    events: [],
    communications: [], // Phase 1
    tasks: [],          // Phase 1
    referralSettings: { creditAmount: 15, bronze: [1,2], silver: [3,5], gold: [6,10], platinum: 11 }
};

// Initialize Application
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    updateDashboard();
    renderCalendar();
    checkBackupStatus();
    
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('orderDate').value = today;
    document.getElementById('eventDate').value = today;
    
    // Setup Charts (Mocked for now as we need data)
    initCharts();
});

// --- NAVIGATION ---
function showView(viewId) {
    document.querySelectorAll('.view').forEach(el => el.style.display = 'none');
    document.getElementById(viewId + 'View').style.display = 'block';
    
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active'); // Works if clicked, fails if called programmatically without event
    
    if (viewId === 'customers') renderCustomersTable();
    if (viewId === 'orders') renderOrdersTable();
    if (viewId === 'pipeline') renderPipeline();
    if (viewId === 'referrals') renderReferrals();
}

function switchTab(e, tabId) {
    e.preventDefault();
    const modal = e.target.closest('.modal-content');
    modal.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    modal.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    
    document.getElementById(tabId).classList.add('active');
    e.target.classList.add('active');
}

// --- DATA PERSISTENCE ---
function saveData() {
    localStorage.setItem('acoustiskin_crm_data', JSON.stringify(state));
    localStorage.setItem('acoustiskin_last_backup', new Date().toISOString());
    updateDashboard();
    showNotification('Data saved successfully');
}

function loadData() {
    const data = localStorage.getItem('acoustiskin_crm_data');
    if (data) {
        state = JSON.parse(data);
        // Ensure new arrays exist if loading old data format
        if(!state.communications) state.communications = [];
        if(!state.tasks) state.tasks = [];
        if(!state.referralSettings) state.referralSettings = { creditAmount: 15, bronze: [1,2], silver: [3,5], gold: [6,10], platinum: 11 };
    }
    const lastBackup = localStorage.getItem('acoustiskin_last_backup');
    if (lastBackup) {
        document.getElementById('lastBackupTime').textContent = new Date(lastBackup).toLocaleString();
    }
}

// --- DASHBOARD LOGIC ---
function updateDashboard() {
    // Stats
    document.getElementById('totalCustomers').innerText = state.customers.length;
    document.getElementById('activeCustomers').innerText = state.customers.filter(c => c.status === 'Active').length;
    
    const totalRev = state.orders.reduce((sum, order) => sum + parseFloat(order.amount), 0);
    document.getElementById('totalRevenue').innerText = '$' + totalRev.toLocaleString(undefined, {minimumFractionDigits: 2});
    document.getElementById('totalOrders').innerText = state.orders.length;
    
    const avg = state.orders.length ? totalRev / state.orders.length : 0;
    document.getElementById('avgOrderValue').innerText = '$' + avg.toFixed(2);

    // Current Month Logic
    const now = new Date();
    const currentMonthOrders = state.orders.filter(o => {
        const d = new Date(o.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });
    const monthRev = currentMonthOrders.reduce((sum, o) => sum + parseFloat(o.amount), 0);
    document.getElementById('monthRevenue').innerText = '$' + monthRev.toLocaleString();
    document.getElementById('monthOrders').innerText = currentMonthOrders.length;

    // Recent Customers
    const recentList = document.getElementById('recentCustomers');
    if (state.customers.length === 0) {
        recentList.innerHTML = '<p style="color:#999; text-align:center; padding:20px;">No customers yet</p>';
    } else {
        recentList.innerHTML = state.customers.slice(-5).reverse().map(c => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #f1f8e9;">
                <div>
                    <div style="font-weight:600; color:#2e5940;">${c.name}</div>
                    <div style="font-size:12px; color:#666;">${c.email}</div>
                </div>
                <span class="status-badge status-${c.status.toLowerCase()}">${c.status}</span>
            </div>
        `).join('');
    }

    // Today's Tasks
    updateTodaysTasks();
}

function updateTodaysTasks() {
    const today = new Date().toISOString().split('T')[0];
    const tasks = state.tasks.filter(t => t.dueDate === today && t.status !== 'Completed');
    const container = document.getElementById('todaysTasks');
    
    if (tasks.length === 0) {
        container.innerHTML = '<p style="color:#999; text-align:center; padding:20px;">No tasks for today</p>';
    } else {
        container.innerHTML = tasks.map(t => `
            <div class="task-item priority-${t.priority.toLowerCase()}">
                <div style="font-weight:600;">${t.title}</div>
                <div style="font-size:12px;">${t.priority} Priority</div>
            </div>
        `).join('');
    }
}

// --- CUSTOMER MANAGEMENT ---
function openCustomerModal(id = null) {
    const modal = document.getElementById('customerModal');
    const form = document.getElementById('customerForm');
    
    // Reset tabs
    modal.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    modal.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-profile').classList.add('active');
    modal.querySelector('.tab-button').classList.add('active');

    if (id) {
        const customer = state.customers.find(c => c.id === parseInt(id));
        document.getElementById('modalTitle').innerText = 'Edit Customer';
        document.getElementById('customerId').value = customer.id;
        document.getElementById('name').value = customer.name;
        document.getElementById('email').value = customer.email;
        document.getElementById('phone').value = customer.phone || '';
        document.getElementById('status').value = customer.status;
        document.getElementById('address').value = customer.address || '';
        document.getElementById('notes').value = customer.notes || '';
        document.getElementById('referralCode').value = customer.referralCode || generateReferralCode(customer.name);
        document.getElementById('referredBy').value = customer.referredBy || '';
        document.getElementById('deleteCustomerBtn').style.display = 'block';
        
        renderCustomerHistory(customer.id);
        renderCustomerComms(customer.id);
        renderCustomerTasks(customer.id);
    } else {
        document.getElementById('modalTitle').innerText = 'New Customer';
        form.reset();
        document.getElementById('customerId').value = '';
        document.getElementById('referralCode').value = 'Will be generated';
        document.getElementById('deleteCustomerBtn').style.display = 'none';
        
        // Clear lists for new customer
        document.getElementById('customerOrderList').innerHTML = '<p style="padding:20px;">Save customer first.</p>';
        document.getElementById('customerCommList').innerHTML = '<p style="padding:20px;">Save customer first.</p>';
        document.getElementById('customerTaskList').innerHTML = '<p style="padding:20px;">Save customer first.</p>';
    }
    modal.style.display = 'block';
}

function saveCustomer(e) {
    e.preventDefault();
    const id = document.getElementById('customerId').value;
    const name = document.getElementById('name').value;
    
    const customer = {
        id: id ? parseInt(id) : Date.now(),
        name: name,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        status: document.getElementById('status').value,
        address: document.getElementById('address').value,
        notes: document.getElementById('notes').value,
        referralCode: id ? document.getElementById('referralCode').value : generateReferralCode(name),
        referredBy: document.getElementById('referredBy').value,
        joinedDate: id ? (state.customers.find(c => c.id == id).joinedDate) : new Date().toISOString()
    };

    if (id) {
        const index = state.customers.findIndex(c => c.id === parseInt(id));
        state.customers[index] = customer;
    } else {
        state.customers.push(customer);
        // Check for referral credit
        if (customer.referredBy) checkReferralCredit(customer.referredBy);
    }

    saveData();
    closeModal('customerModal');
    renderCustomersTable();
}

function renderCustomersTable() {
    const filterText = document.getElementById('customerSearch').value.toLowerCase();
    const filterStatus = document.getElementById('customerStatusFilter').value;
    
    const filtered = state.customers.filter(c => {
        const matchesText = c.name.toLowerCase().includes(filterText) || c.email.toLowerCase().includes(filterText);
        const matchesStatus = filterStatus ? c.status === filterStatus : true;
        return matchesText && matchesStatus;
    });

    const tbody = document.getElementById('customersTableBody');
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No customers found.</td></tr>';
        return;
    }

    tbody.innerHTML = filtered.map(c => {
        // Calculate AI Score (Mock logic: Activity based)
        const orders = state.orders.filter(o => o.customerId === c.id).length;
        let scoreClass = 'score-low';
        if (orders > 5) scoreClass = 'score-high';
        else if (orders > 0) scoreClass = 'score-medium';
        
        // Count Referrals
        const referralCount = state.customers.filter(ref => ref.referredBy === c.referralCode).length;

        return `
        <tr onclick="openCustomerModal('${c.id}')" style="cursor:pointer;">
            <td>
                <div style="font-weight:600; color:#2e5940;">${c.name}</div>
                <div style="font-size:12px; color:#999;">Joined: ${new Date(c.joinedDate).toLocaleDateString()}</div>
            </td>
            <td>
                <div>${c.email}</div>
                <div style="font-size:12px;">${c.phone}</div>
            </td>
            <td><span class="status-badge status-${c.status.toLowerCase()}">${c.status}</span></td>
            <td><span class="score-badge ${scoreClass}">${orders > 5 ? 'High Value' : (orders > 0 ? 'Regular' : 'New')}</span></td>
            <td>${referralCount}</td>
            <td>
                <button class="btn-secondary" style="padding:4px 8px;">View</button>
            </td>
        </tr>
    `}).join('');
}

// --- COMMUNICATIONS & TASKS (PHASE 1) ---
function openCommunicationModal(customerId) {
    if(!customerId) return alert("Please select or save a customer first.");
    document.getElementById('commForm').reset();
    document.getElementById('commId').value = '';
    
    // Populate customer select
    const select = document.getElementById('commCustomer');
    select.innerHTML = '<option value="">Select Customer...</option>';
    state.customers.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.text = c.name;
        if(c.id == customerId) opt.selected = true;
        select.appendChild(opt);
    });
    document.getElementById('commCustomerId').value = customerId; // Hidden field
    
    document.getElementById('communicationModal').style.display = 'block';
}

function saveCommunication(e) {
    e.preventDefault();
    const comm = {
        id: Date.now(),
        customerId: parseInt(document.getElementById('commCustomerId').value),
        type: document.getElementById('commType').value,
        date: document.getElementById('commDateTime').value,
        subject: document.getElementById('commSubject').value,
        notes: document.getElementById('commNotes').value,
        outcome: document.getElementById('commOutcome').value
    };
    
    state.communications.push(comm);
    saveData();
    closeModal('communicationModal');
    
    // Refresh list if we are in the customer modal
    if(document.getElementById('customerModal').style.display === 'block') {
        renderCustomerComms(comm.customerId);
    }
}

function renderCustomerComms(customerId) {
    const comms = state.communications.filter(c => c.customerId === parseInt(customerId)).sort((a,b) => new Date(b.date) - new Date(a.date));
    const container = document.getElementById('customerCommList');
    
    if(comms.length === 0) {
        container.innerHTML = '<p style="color:#999; padding:20px; text-align:center;">No communications logged.</p>';
        return;
    }
    
    container.innerHTML = comms.map(c => `
        <div class="comm-item">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <strong><i class="fas fa-${getCommIcon(c.type)}"></i> ${c.type}</strong>
                <span style="font-size:12px; color:#666;">${new Date(c.date).toLocaleString()}</span>
            </div>
            <div style="font-weight:600; font-size:13px; margin-bottom:5px;">${c.subject}</div>
            <div style="font-size:13px; color:#444;">${c.notes}</div>
            ${c.outcome ? `<div style="font-size:11px; margin-top:5px; color:#2e5940;">Outcome: ${c.outcome}</div>` : ''}
        </div>
    `).join('');
}

function getCommIcon(type) {
    const map = { 'Email': 'envelope', 'Phone Call': 'phone', 'Meeting': 'handshake', 'SMS': 'comment-alt', 'Video Call': 'video' };
    return map[type] || 'circle';
}

function openTaskModal(customerId) {
    if(!customerId) return alert("Please select or save a customer first.");
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    
    const select = document.getElementById('taskCustomer');
    select.innerHTML = '<option value="">Select Customer...</option>';
    state.customers.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.text = c.name;
        if(c.id == customerId) opt.selected = true;
        select.appendChild(opt);
    });
    document.getElementById('taskCustomerId').value = customerId;
    
    document.getElementById('taskModal').style.display = 'block';
}

function saveTask(e) {
    e.preventDefault();
    const task = {
        id: Date.now(),
        customerId: parseInt(document.getElementById('taskCustomerId').value),
        title: document.getElementById('taskTitle').value,
        priority: document.getElementById('taskPriority').value,
        status: document.getElementById('taskStatus').value,
        dueDate: document.getElementById('taskDueDate').value,
        description: document.getElementById('taskDescription').value
    };
    
    state.tasks.push(task);
    saveData();
    closeModal('taskModal');
    
    if(document.getElementById('customerModal').style.display === 'block') {
        renderCustomerTasks(task.customerId);
    }
    updateTodaysTasks();
}

function renderCustomerTasks(customerId) {
    const tasks = state.tasks.filter(t => t.customerId === parseInt(customerId)).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
    const container = document.getElementById('customerTaskList');
    
    if(tasks.length === 0) {
        container.innerHTML = '<p style="color:#999; padding:20px; text-align:center;">No tasks found.</p>';
        return;
    }
    
    container.innerHTML = tasks.map(t => `
        <div class="task-item priority-${t.priority.toLowerCase()} ${t.status === 'Completed' ? 'completed' : ''}">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <strong>${t.title}</strong>
                <span class="status-badge status-${t.status === 'In Progress' ? 'prospect' : (t.status === 'Completed' ? 'active' : 'inactive')}">${t.status}</span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:12px; color:#666;">
                <span>Due: ${t.dueDate}</span>
                <span>${t.priority} Priority</span>
            </div>
            ${t.description ? `<div style="font-size:12px; margin-top:5px;">${t.description}</div>` : ''}
        </div>
    `).join('');
}

// --- ORDERS ---
function openOrderModal() {
    const select = document.getElementById('orderCustomer');
    select.innerHTML = '<option value="">Select Customer...</option>';
    state.customers.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.text = c.name;
        select.appendChild(option);
    });
    document.getElementById('orderModal').style.display = 'block';
}

// ========== ORDER FUNCTIONS - FIXED VERSION ==========
// Save Order
function saveOrder(event) {
    event.preventDefault();
    const orderIdValue = document.getElementById('orderId').value;
    const customerId = document.getElementById('orderCustomer').value;
    const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
    const price = parseFloat(document.getElementById('orderPrice').value) || 0;
    const discount = parseFloat(document.getElementById('orderDiscount').value) || 0;
    const shippingCost = parseFloat(document.getElementById('orderShippingCost').value) || 0;
    const orderTotalText = document.getElementById('orderTotal').textContent;
    const total = parseFloat(orderTotalText.replace('$', '')) || 0; // Get calculated total

    // --- FIX APPLIED HERE ---
    // 1. Determine the Order ID: Use existing ID if present, otherwise assign the next available ID.
    const orderId = orderIdValue ? parseInt(orderIdValue) : crmData.nextOrderId;

    const order = {
        id: orderId, // Use the determined ID
        customerId: parseInt(customerId),
        product: document.getElementById('orderProduct').value,
        manufacturer: document.getElementById('orderManufacturer').value,
        quantity: quantity,
        price: price,
        discount: discount,
        shipping: {
            cost: shippingCost,
            company: document.getElementById('orderShippingCompany').value,
            trackingNumber: document.getElementById('orderTrackingNumber').value,
            street: document.getElementById('orderShippingStreet').value,
            city: document.getElementById('orderShippingCity').value,
            state: document.getElementById('orderShippingState').value,
            zip: document.getElementById('orderShippingZip').value,
        },
        date: document.getElementById('orderDate').value,
        status: document.getElementById('orderStatus').value,
        notes: document.getElementById('orderNotes').value,
        total: total,
        isImported: false 
    };

    // 2. Check if the order ID exists in the data array
    const index = crmData.orders.findIndex(o => o.id === orderId);

    if (index !== -1) {
        // Condition: Order FOUND in array -> EDIT existing order
        crmData.orders[index] = order;
        showNotification('Order updated successfully!');
    } else {
        // Condition: Order NOT FOUND in array -> ADD new order
        crmData.orders.push(order);
        crmData.nextOrderId++;
        
        // Convert Prospect to Active if this is their first order
        updateCustomerStatus(customerId); 
        
        showNotification('New order added successfully!');
    }

    closeModal('orderModal');
    saveData();
    updateDashboard();
    updateOrdersView();
    
    return false; // Prevent form submission
}
function renderOrdersTable() {
    const tbody = document.getElementById('ordersTableBody');
    if (state.orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#999;">No orders yet.</td></tr>';
        return;
    }
    
    tbody.innerHTML = state.orders.map(o => {
        const customer = state.customers.find(c => c.id === o.customerId) || { name: 'Unknown' };
        return `
        <tr>
            <td>#${o.id.toString().slice(-6)}</td>
            <td>${customer.name}</td>
            <td>${o.product}</td>
            <td>${o.date}</td>
            <td>$${o.amount.toFixed(2)}</td>
            <td><span class="status-badge status-active">Completed</span></td>
            <td><button class="btn-secondary" style="padding:4px 8px;">View</button></td>
        </tr>
    `}).join('');
}

function renderCustomerHistory(id) {
    const orders = state.orders.filter(o => o.customerId === id);
    const container = document.getElementById('customerOrderList');
    if (orders.length === 0) {
        container.innerHTML = '<p style="color:#999; padding:20px; text-align:center;">No orders found.</p>';
    } else {
        container.innerHTML = orders.map(o => `
            <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                <div>
                    <div style="font-weight:600;">${o.product}</div>
                    <div style="font-size:12px; color:#999;">${o.date}</div>
                </div>
                <div style="font-weight:600; color:#2e5940;">$${o.amount.toFixed(2)}</div>
            </div>
        `).join('');
    }
}

// --- REFERRAL LOGIC ---
function generateReferralCode(name) {
    return name.substring(0,3).toUpperCase() + Math.floor(Math.random() * 10000);
}

function openReferralSettings() {
    document.getElementById('settingCreditAmount').value = state.referralSettings.creditAmount;
    document.getElementById('referralSettingsModal').style.display = 'block';
}

function saveReferralSettings() {
    state.referralSettings.creditAmount = parseFloat(document.getElementById('settingCreditAmount').value);
    // Add logic to save tiers if needed
    saveData();
    closeModal('referralSettingsModal');
}

function checkReferralCredit(referrerCode) {
    const referrer = state.customers.find(c => c.referralCode === referrerCode);
    if (referrer) {
        showNotification(`Referral applied! ${referrer.name} receives credit.`);
        // Logic to add credit to referrer would go here
    }
}

function renderReferrals() {
    const tbody = document.getElementById('referralTableBody');
    let totalRef = 0;
    
    // Build referral rows by finding customers who have a 'referredBy' value
    const referralRows = state.customers.filter(c => c.referredBy).map(c => {
        const referrer = state.customers.find(ref => ref.referralCode === c.referredBy);
        if(!referrer) return '';
        totalRef++;
        return `
            <tr>
                <td>${referrer.name}</td>
                <td>${c.name}</td>
                <td>${new Date(c.joinedDate).toLocaleDateString()}</td>
                <td><span class="status-badge status-active">Approved</span></td>
                <td>$${state.referralSettings.creditAmount}</td>
            </tr>
        `;
    }).join('');
    
    document.getElementById('totalReferrals').innerText = totalRef;
    document.getElementById('totalCredits').innerText = '$' + (totalRef * state.referralSettings.creditAmount).toFixed(2);
    
    tbody.innerHTML = referralRows || '<tr><td colspan="5" style="text-align:center; padding:20px;">No referrals yet.</td></tr>';
}

// --- UTILS ---
function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

function showNotification(msg) {
    const n = document.getElementById('notification');
    document.getElementById('notificationText').innerText = msg;
    n.style.display = 'block';
    setTimeout(() => n.style.display = 'none', 3000);
}

function checkBackupStatus() {
    const lastBackup = localStorage.getItem('acoustiskin_last_backup');
    if (!lastBackup) return;
    
    const days = (new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24);
    if (days > 7) {
        document.getElementById('backupReminderModal').style.display = 'block';
    }
}

function exportData() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "acoustiskin_backup_" + new Date().toISOString().split('T')[0] + ".json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
    
    localStorage.setItem('acoustiskin_last_backup', new Date().toISOString());
    document.getElementById('lastBackupTime').textContent = new Date().toLocaleString();
}

function showImportOptions() { document.getElementById('importFile').click(); }

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedState = JSON.parse(e.target.result);
            if(state.customers.length > 0) {
                // If data exists, ask to merge or replace
                window.tempImport = importedState;
                document.getElementById('conflictModal').style.display = 'block';
            } else {
                state = importedState;
                saveData();
                location.reload();
            }
        } catch (err) {
            alert('Invalid backup file');
        }
    };
    reader.readAsText(file);
}

function resolveConflict(action) {
    if(action === 'replace') {
        state = window.tempImport;
    } else {
        // Simple merge: Concat arrays and dedupe by ID
        const mergedCustomers = [...state.customers, ...window.tempImport.customers];
        state.customers = Array.from(new Map(mergedCustomers.map(item => [item.id, item])).values());
        
        // Merge Orders
        state.orders = [...state.orders, ...window.tempImport.orders];
    }
    saveData();
    location.reload();
}

// --- CHARTS (Placeholder) ---
function initCharts() {
    // Basic Chart.js implementation would go here
    // Currently mocked for visual layout in CSS
}

// --- CALENDAR ---
function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    const date = new Date();
    const month = date.toLocaleString('default', { month: 'long' });
    document.getElementById('currentMonth').innerText = `${month} ${date.getFullYear()}`;
    
    // Mock Calendar Days
    for(let i=1; i<=31; i++) {
        const day = document.createElement('div');
        day.className = 'calendar-day';
        if(i === date.getDate()) day.classList.add('today');
        
        let content = `<div style="font-weight:600; margin-bottom:5px;">${i}</div>`;
        
        // Find events/tasks for this day (mock logic)
        const dayEvents = state.events ? state.events.filter(e => new Date(e.date).getDate() === i) : [];
        dayEvents.forEach(e => {
            content += `<div class="event-item">${e.title}</div>`;
        });

        day.innerHTML = content;
        grid.appendChild(day);
    }
}
function openEventModal() { document.getElementById('eventModal').style.display = 'block'; }
</script>
</body>
</html>
  
