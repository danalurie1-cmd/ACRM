<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcoustiSkin CRM - AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; /* Light Green Tint */ }
        
        /* Sidebar Styling matching your Screenshot */
        .sidebar { background-color: #355e3b; color: white; } /* Hunter Green */
        .sidebar-btn { 
            display: flex; align-items: center; padding: 12px 20px; 
            color: #d1fae5; transition: 0.2s; cursor: pointer; border-left: 4px solid transparent; 
        }
        .sidebar-btn:hover, .sidebar-btn.active { 
            background-color: #2f5235; border-left-color: #4ade80; color: white; font-weight: 600; 
        }
        .action-btn {
            background-color: #4ade80; color: #064e3b; font-weight: 700;
            border-radius: 8px; margin: 5px 15px; padding: 10px; text-align: center;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        .action-btn:hover { background-color: #22c55e; transform: translateY(-1px); }

        /* Card Styling */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .stat-card { color: white; padding: 20px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; }
        .stat-card:hover { transform: scale(1.02); }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; place-items: center; z-index: 50; }
        .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 25px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .input-group label { display: block; font-size: 0.8rem; font-weight: 600; color: #4b5563; margin-bottom: 4px; }
        .input-group input, .input-group select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; }
        
        /* Pipeline */
        .pipeline-col { min-width: 250px; background: #f3f4f6; padding: 10px; border-radius: 8px; }
        .deal-card { background: white; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #10b981; shadow: sm; cursor: pointer; }

        /* Helpers */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800">

    <aside class="sidebar w-64 flex flex-col h-full shadow-2xl z-20">
        <div class="p-6 flex items-center gap-3">
            <i class="fa-solid fa-leaf text-2xl text-green-400"></i>
            <div>
                <h1 class="font-bold text-lg tracking-tight">AcoustiSkin</h1>
                <span class="bg-purple-600 text-[10px] px-2 py-0.5 rounded-full text-white">AI-Powered</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto py-2">
            <div onclick="nav('dashboard')" class="sidebar-btn active" id="btn-dashboard"><i class="fa fa-home w-8"></i> Dashboard</div>
            <div onclick="nav('customers')" class="sidebar-btn" id="btn-customers"><i class="fa fa-users w-8"></i> Customers</div>
            <div onclick="nav('orders')" class="sidebar-btn" id="btn-orders"><i class="fa fa-shopping-cart w-8"></i> Orders</div>
            <div onclick="nav('calendar')" class="sidebar-btn" id="btn-calendar"><i class="fa fa-calendar w-8"></i> Calendar</div>
            <div onclick="nav('pipeline')" class="sidebar-btn" id="btn-pipeline"><i class="fa fa-chart-simple w-8"></i> Pipeline</div>
            <div onclick="nav('analytics')" class="sidebar-btn" id="btn-analytics"><i class="fa fa-chart-line w-8"></i> Analytics</div>
            <div onclick="nav('marketing')" class="sidebar-btn" id="btn-marketing"><i class="fa fa-bullhorn w-8"></i> Marketing</div>
            <div onclick="nav('referral')" class="sidebar-btn" id="btn-referral"><i class="fa fa-gift w-8"></i> Referral Program</div>
            <div onclick="nav('import')" class="sidebar-btn" id="btn-import"><i class="fa fa-file-import w-8"></i> Import Data</div>
        </div>

        <div class="pb-6 pt-2 border-t border-green-800">
            <div onclick="openCustomerModal()" class="action-btn"><i class="fa fa-plus"></i> New Customer</div>
            <div onclick="openEventModal()" class="action-btn bg-emerald-500 text-white"><i class="fa fa-calendar-plus"></i> Schedule Event</div>
            <div onclick="openOrderModal()" class="action-btn bg-green-600 text-white"><i class="fa fa-cart-plus"></i> New Order</div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden bg-[#f8fafc]">
        <header class="bg-white p-4 shadow-sm flex justify-between items-center z-10">
            <div class="flex items-center bg-gray-100 rounded-lg px-3 py-2 w-96">
                <i class="fa fa-search text-gray-400 mr-2"></i>
                <input id="globalSearch" type="text" placeholder="Search customers, orders..." class="bg-transparent outline-none w-full text-sm" onkeyup="handleSearch()">
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="font-bold text-sm">Dana Lurie</div>
                    <div class="text-xs text-green-600">Admin</div>
                </div>
                <div class="h-10 w-10 bg-green-100 text-green-700 rounded-full flex items-center justify-center font-bold">DL</div>
            </div>
        </header>

        <div id="app-container" class="flex-1 overflow-y-auto p-8 relative">
            </div>
    </main>

    <div id="customerModal" class="modal-overlay">
        <div class="modal-content animate-fade-in-down">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-bold text-gray-800">Add New Customer</h2>
                <button onclick="closeModals()" class="text-gray-400 hover:text-red-500"><i class="fa fa-times text-xl"></i></button>
            </div>
            <form id="customerForm" onsubmit="saveCustomer(event)">
                <h3 class="text-sm font-bold text-green-700 uppercase mb-3 border-b border-green-100 pb-1">Personal & Contact Info</h3>
                <div class="form-grid mb-6">
                    <div class="input-group"><label>First Name *</label><input name="firstName" required></div>
                    <div class="input-group"><label>Last Name *</label><input name="lastName" required></div>
                    <div class="input-group"><label>Company</label><input name="company"></div>
                    <div class="input-group"><label>Email Address *</label><input type="email" name="email" required></div>
                    <div class="input-group"><label>Phone (Mobile)</label><input name="phone"></div>
                    <div class="input-group"><label>Phone (Work)</label><input name="workPhone"></div>
                    <div class="input-group"><label>Date of Birth</label><input type="date" name="dob"></div>
                    <div class="input-group"><label>Gender</label><select name="gender"><option>Male</option><option>Female</option><option>Other</option></select></div>
                    <div class="input-group"><label>Preferred Contact</label><select name="contactPref"><option>Email</option><option>SMS</option><option>Phone</option></select></div>
                </div>

                <h3 class="text-sm font-bold text-green-700 uppercase mb-3 border-b border-green-100 pb-1">Billing & Shipping</h3>
                <div class="form-grid mb-6">
                    <div class="input-group"><label>Street Address</label><input name="address"></div>
                    <div class="input-group"><label>City</label><input name="city"></div>
                    <div class="input-group"><label>State/Province</label><input name="state"></div>
                    <div class="input-group"><label>Zip/Postal Code</label><input name="zip"></div>
                    <div class="input-group"><label>Country</label><input name="country" value="USA"></div>
                    <div class="input-group"><label>Billing Method</label><select name="billing"><option>Credit Card</option><option>Invoice</option></select></div>
                </div>

                <h3 class="text-sm font-bold text-green-700 uppercase mb-3 border-b border-green-100 pb-1">Marketing & Referral</h3>
                <div class="form-grid mb-6">
                    <div class="input-group"><label>Lead Source</label><select name="source"><option>Website</option><option>Referral</option><option>Social Media</option></select></div>
                    <div class="input-group"><label>Referred By (Name)</label><input name="referredBy" placeholder="Who sent them?"></div>
                    <div class="input-group"><label>Assigned Rep</label><input name="rep" value="Dana Lurie"></div>
                    <div class="input-group"><label>Instagram Handle</label><input name="instagram"></div>
                    <div class="input-group"><label>Opt-in Marketing</label><select name="optIn"><option value="true">Yes</option><option value="false">No</option></select></div>
                    <div class="input-group"><label>Initial Status</label><select name="status"><option>Active</option><option>Prospect</option><option>Lead</option></select></div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="closeModals()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700">Save Customer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="orderModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Create New Order</h2>
            <form onsubmit="saveOrder(event)">
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">Customer</label>
                    <select id="orderCustomerSelect" class="w-full border p-2 rounded"></select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">Product</label>
                    <select id="orderProduct" class="w-full border p-2 rounded">
                        <option value="29.95">AcoustiSkin Standard ($29.95)</option>
                        <option value="49.95">AcoustiSkin Pro ($49.95)</option>
                        <option value="150.00">Wholesale Pack ($150.00)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">Quantity</label>
                    <input type="number" id="orderQty" value="1" min="1" class="w-full border p-2 rounded">
                </div>
                <button class="w-full bg-blue-600 text-white py-2 rounded font-bold">Process Order</button>
            </form>
        </div>
    </div>

    <div id="eventModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Schedule Event</h2>
            <form onsubmit="saveEvent(event)">
                <input id="eventTitle" placeholder="Event Title" class="w-full border p-2 rounded mb-3" required>
                <input id="eventDate" type="date" class="w-full border p-2 rounded mb-3" required>
                <select id="eventType" class="w-full border p-2 rounded mb-4">
                    <option>Meeting</option><option>Call</option><option>Follow-up</option>
                </select>
                <button class="w-full bg-emerald-600 text-white py-2 rounded font-bold">Add to Calendar</button>
            </form>
        </div>
    </div>

    <div id="eventDetailModal" class="modal-overlay">
        <div class="modal-content max-w-sm">
            <h2 id="detailTitle" class="text-xl font-bold mb-2"></h2>
            <p id="detailDate" class="text-gray-500 mb-4"></p>
            <div class="bg-gray-100 p-3 rounded mb-4 text-sm" id="detailType"></div>
            <button onclick="closeModals()" class="w-full bg-gray-200 py-2 rounded">Close</button>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        let db = {
            customers: [],
            orders: [],
            events: [],
            pipeline: [],
            referrals: []
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            nav('dashboard');
        });

        function loadData() {
            const saved = localStorage.getItem('acoustiskin_db_fixed');
            if (saved) {
                db = JSON.parse(saved);
            } else {
                // Seed Dummy Data
                db.customers = [
                    { id: 'c1', firstName: 'Lance', lastName: 'Ochs', email: 'lochs@cleanroomtape.com', company: 'CleanRoom Tape', source: 'Website', referralCode: 'LOCHS25', credits: 10 },
                    { id: 'c2', firstName: 'Dana', lastName: 'Lurie', email: 'dana@acoustiskin.com', company: 'AcoustiSkin', source: 'Internal', referralCode: 'DANA10', credits: 50 }
                ];
                db.orders = [
                    { id: '1001', custId: 'c1', name: 'Lance Ochs', date: '2025-12-06', amount: 39.70, status: 'Completed' },
                    { id: '1002', custId: 'c1', name: 'Lance Ochs', date: '2025-11-20', amount: 39.70, status: 'Completed' },
                    { id: '1003', custId: 'c2', name: 'Dana Lurie', date: '2025-12-01', amount: 150.00, status: 'Processing' }
                ];
                db.events = [
                    { id: 'e1', title: 'Strategy Meeting', date: '2025-12-06', type: 'Meeting' }
                ];
                db.pipeline = [
                    { id: 'p1', title: 'Bulk Deal', customer: 'CleanRoom Tape', value: 5000, stage: 'Negotiation' }
                ];
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('acoustiskin_db_fixed', JSON.stringify(db));
        }

        // --- NAVIGATION ---
        function nav(view) {
            const container = document.getElementById('app-container');
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`btn-${view}`);
            if(btn) btn.classList.add('active');

            // Routing Logic
            switch(view) {
                case 'dashboard': renderDashboard(container); break;
                case 'customers': renderCustomers(container); break;
                case 'orders': renderOrders(container); break;
                case 'calendar': renderCalendar(container); break;
                case 'pipeline': renderPipeline(container); break;
                case 'analytics': renderAnalytics(container); break;
                case 'marketing': renderMarketing(container); break;
                case 'referral': renderReferral(container); break;
                case 'import': renderImport(container); break;
            }
        }

        // --- RENDERERS ---

        function renderDashboard(t) {
            // Fix NaN: Calculate total revenue safely
            let totalRev = 0;
            db.orders.forEach(o => {
                let val = parseFloat(o.amount);
                if (!isNaN(val)) totalRev += val;
            });

            t.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                    <p class="text-gray-500">Welcome back, Dana! Here's what's happening today.</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-green-500" onclick="nav('customers')">
                        <div class="text-sm font-medium opacity-90">Total Customers</div>
                        <div class="text-4xl font-bold mt-2">${db.customers.length}</div>
                        <div class="mt-4 text-xs opacity-75">â†‘ Click to view all</div>
                    </div>
                    <div class="stat-card bg-blue-500" onclick="nav('orders')">
                        <div class="text-sm font-medium opacity-90">Total Orders</div>
                        <div class="text-4xl font-bold mt-2">${db.orders.length}</div>
                        <div class="mt-4 text-xs opacity-75">All time</div>
                    </div>
                    <div class="stat-card bg-orange-400">
                        <div class="text-sm font-medium opacity-90">Total Revenue</div>
                        <div class="text-4xl font-bold mt-2">$${totalRev.toFixed(2)}</div>
                        <div class="mt-4 text-xs opacity-75">No NaN Errors</div>
                    </div>
                    <div class="stat-card bg-purple-600" onclick="nav('calendar')">
                        <div class="text-sm font-medium opacity-90">Events Today</div>
                        <div class="text-4xl font-bold mt-2">${db.events.length}</div>
                        <div class="mt-4 text-xs opacity-75">ðŸ“… Click to view calendar</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700"><i class="fa fa-users text-green-600 mr-2"></i>Recent Customers</h3>
                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Active</span>
                        </div>
                        <div class="space-y-4">
                            ${db.customers.slice(0, 4).map(c => `
                                <div class="flex items-center justify-between border-b pb-2">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600">${c.firstName[0]}${c.lastName[0]}</div>
                                        <div>
                                            <div class="font-bold text-sm">${c.firstName} ${c.lastName}</div>
                                            <div class="text-xs text-gray-500">${c.email}</div>
                                        </div>
                                    </div>
                                    <button class="text-xs border px-2 py-1 rounded hover:bg-gray-50">View</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="card">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700"><i class="fa fa-tasks text-blue-600 mr-2"></i>Tasks & Orders</h3>
                        </div>
                        ${db.orders.length === 0 ? '<p class="text-gray-400">No orders yet.</p>' : ''}
                         <div class="space-y-4">
                            ${db.orders.slice(0, 4).map(o => `
                                <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                                    <div class="text-sm"><span class="font-bold">Order #${o.id}</span> - ${o.name}</div>
                                    <div class="font-bold text-green-600">$${o.amount.toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCustomers(t) {
            t.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Customer Database</h2>
                    <button onclick="openCustomerModal()" class="bg-green-600 text-white px-4 py-2 rounded font-bold shadow hover:bg-green-700">+ Add New</button>
                </div>
                <div class="card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="p-4 font-bold text-sm text-gray-600">Name</th>
                                <th class="p-4 font-bold text-sm text-gray-600">Email</th>
                                <th class="p-4 font-bold text-sm text-gray-600">Source</th>
                                <th class="p-4 font-bold text-sm text-gray-600">Referral Code</th>
                                <th class="p-4 font-bold text-sm text-gray-600">Credits</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${db.customers.map(c => `
                                <tr class="hover:bg-green-50">
                                    <td class="p-4 font-bold text-slate-700">${c.firstName} ${c.lastName}</td>
                                    <td class="p-4 text-sm text-gray-600">${c.email}</td>
                                    <td class="p-4 text-sm"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">${c.source}</span></td>
                                    <td class="p-4 font-mono text-sm">${c.referralCode || '-'}</td>
                                    <td class="p-4 font-bold text-green-600">$${c.credits || 0}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderOrders(t) {
            t.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Order Management</h2>
                    <button onclick="openOrderModal()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold shadow hover:bg-blue-700">Create Order</button>
                </div>
                <div class="card">
                     ${db.orders.length === 0 ? '<div class="text-center py-10 text-gray-400">No orders found. Create one!</div>' : ''}
                     <table class="w-full text-left">
                        <thead class="bg-gray-100 border-b">
                            <tr><th class="p-3">Order ID</th><th class="p-3">Customer</th><th class="p-3">Date</th><th class="p-3">Total</th><th class="p-3">Status</th></tr>
                        </thead>
                        <tbody class="divide-y">
                            ${db.orders.map(o => `
                                <tr>
                                    <td class="p-3 font-mono">#${o.id}</td>
                                    <td class="p-3 font-bold">${o.name}</td>
                                    <td class="p-3 text-gray-500">${o.date}</td>
                                    <td class="p-3 font-bold text-green-600">$${o.amount.toFixed(2)}</td>
                                    <td class="p-3"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${o.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderCalendar(t) {
            const days = Array.from({length: 31}, (_, i) => i + 1);
            t.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Calendar</h2>
                    <button onclick="openEventModal()" class="bg-emerald-500 text-white px-4 py-2 rounded font-bold shadow">+ Add Event</button>
                </div>
                <div class="card">
                    <div class="grid grid-cols-7 gap-2 text-center font-bold text-gray-400 mb-2">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div class="grid grid-cols-7 gap-2">
                        ${days.map(d => {
                             // Check for event
                             const dateStr = `2025-12-${d.toString().padStart(2, '0')}`;
                             const event = db.events.find(e => e.date === dateStr);
                             return `
                                <div onclick="${event ? `showEventDetail('${event.id}')` : ''}" class="h-24 border rounded p-1 hover:bg-gray-50 cursor-pointer relative ${event ? 'bg-green-50 border-green-200' : ''}">
                                    <span class="text-gray-400 text-sm">${d}</span>
                                    ${event ? `<div class="mt-1 text-xs bg-green-500 text-white p-1 rounded truncate">${event.title}</div>` : ''}
                                </div>
                             `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderPipeline(t) {
            const stages = ['Lead', 'Negotiation', 'Closed'];
            t.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">Sales Pipeline</h2>
                <div class="flex gap-4 overflow-x-auto pb-4">
                    ${stages.map(stage => `
                        <div class="pipeline-col flex-1">
                            <div class="font-bold text-gray-500 uppercase text-xs mb-3 flex justify-between">
                                ${stage} <span class="bg-gray-200 px-2 rounded-full">${db.pipeline.filter(p=>p.stage===stage).length}</span>
                            </div>
                            ${db.pipeline.filter(p=>p.stage === stage).map(d => `
                                <div class="deal-card group">
                                    <div class="font-bold text-gray-800">${d.title}</div>
                                    <div class="text-xs text-gray-500">${d.customer}</div>
                                    <div class="mt-2 font-bold text-green-600">$${d.value}</div>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAnalytics(t) {
            // Calculate dummy metrics for charts
            let total = 0; db.orders.forEach(o => total += o.amount);
            
            t.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">Analytics & Insights</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h3 class="font-bold mb-4">Revenue Trend</h3>
                        <div class="h-40 flex items-end justify-between px-2 gap-2">
                            <div class="w-full bg-green-200 hover:bg-green-300 rounded-t h-[30%]"></div>
                            <div class="w-full bg-green-200 hover:bg-green-300 rounded-t h-[50%]"></div>
                            <div class="w-full bg-green-200 hover:bg-green-300 rounded-t h-[40%]"></div>
                            <div class="w-full bg-green-500 hover:bg-green-600 rounded-t h-[80%] relative group">
                                <span class="hidden group-hover:block absolute -top-8 bg-black text-white text-xs p-1 rounded">$${total}</span>
                            </div>
                            <div class="w-full bg-green-200 hover:bg-green-300 rounded-t h-[60%]"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400 mt-2"><span>Aug</span><span>Sep</span><span>Oct</span><span>Nov</span><span>Dec</span></div>
                    </div>
                    <div class="card">
                         <h3 class="font-bold mb-4">Lead Sources</h3>
                         <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-sm mb-1"><span>Website</span><span>60%</span></div>
                                <div class="h-2 bg-gray-100 rounded-full"><div class="h-full bg-blue-500 rounded-full" style="width:60%"></div></div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1"><span>Referrals</span><span>30%</span></div>
                                <div class="h-2 bg-gray-100 rounded-full"><div class="h-full bg-purple-500 rounded-full" style="width:30%"></div></div>
                            </div>
                         </div>
                    </div>
                </div>
            `;
        }

        function renderReferral(t) {
            t.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">Referral Program</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card border-l-4 border-purple-500">
                        <h3 class="font-bold text-lg mb-2">Program Status</h3>
                        <p class="text-sm text-gray-600 mb-4">Active. Customers earn $10 credit per referral.</p>
                        <div class="text-3xl font-bold text-purple-700">$${db.customers.reduce((a,b)=>a+(b.credits||0), 0)}</div>
                        <div class="text-xs text-gray-400 uppercase">Total Credits Issued</div>
                    </div>
                     <div class="card">
                        <h3 class="font-bold text-lg mb-2">Top Referrers</h3>
                        <ul class="space-y-2">
                             ${db.customers.filter(c => c.credits > 0).map(c => `
                                <li class="flex justify-between border-b pb-1">
                                    <span>${c.firstName} ${c.lastName}</span>
                                    <span class="font-bold text-green-600">$${c.credits}</span>
                                </li>
                             `).join('')}
                        </ul>
                    </div>
                </div>
                <div class="card mt-6">
                    <h3 class="font-bold mb-4">Code Generator Preview</h3>
                    <div class="flex gap-4 items-center">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=ACOUSTISKIN-PROMO" alt="QR" class="border p-1 rounded">
                        <div>
                            <p class="font-bold">Scan to Refer</p>
                            <p class="text-sm text-gray-500">This QR code is generated for customers to share.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMarketing(t) {
            t.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">Marketing Hub</h2>
                <div class="card">
                     <table class="w-full text-left">
                        <thead><tr class="bg-gray-100"><th class="p-3">Customer</th><th class="p-3">Email</th><th class="p-3">Actions</th></tr></thead>
                        <tbody>
                             ${db.customers.slice(0,5).map(c => `
                                <tr class="border-b">
                                    <td class="p-3 font-bold">${c.firstName} ${c.lastName}</td>
                                    <td class="p-3 text-sm">${c.email}</td>
                                    <td class="p-3 flex gap-2">
                                        <button onclick="alert('Email sent to ${c.email}')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200"><i class="fa fa-envelope"></i> Email</button>
                                        <button onclick="alert('SMS sent to ${c.phone || 'mobile'}')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200"><i class="fa fa-comment"></i> SMS</button>
                                    </td>
                                </tr>
                             `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderImport(t) {
            t.innerHTML = `
                <div class="max-w-xl mx-auto card text-center py-12">
                    <i class="fa fa-cloud-upload-alt text-4xl text-gray-300 mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2">Import / Export Data</h2>
                    <p class="text-gray-500 mb-6">Manage your CRM data locally. Safe and secure.</p>
                    
                    <div class="flex gap-4 justify-center">
                        <button onclick="exportData()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-blue-700">Download Backup (JSON)</button>
                        <label class="bg-green-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-green-700 cursor-pointer">
                            Restore Backup
                            <input type="file" class="hidden" onchange="importData(this)">
                        </label>
                    </div>
                </div>
            `;
        }

        // --- ACTIONS & LOGIC ---

        function openCustomerModal() { document.getElementById('customerModal').style.display = 'grid'; }
        function openOrderModal() {
            document.getElementById('orderModal').style.display = 'grid';
            // Populate select
            const sel = document.getElementById('orderCustomerSelect');
            sel.innerHTML = db.customers.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
        }
        function openEventModal() { document.getElementById('eventModal').style.display = 'grid'; }
        
        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        }

        function saveCustomer(e) {
            e.preventDefault();
            const f = new FormData(e.target);
            const newC = {};
            f.forEach((value, key) => newC[key] = value);
            newC.id = 'c' + Date.now();
            newC.credits = 0;
            newC.referralCode = (newC.firstName.substring(0,3) + newC.lastName.substring(0,3) + '25').toUpperCase();
            
            // Check referral
            if (newC.referredBy) {
                // Find referrer (fuzzy match logic simulation)
                const referrer = db.customers.find(c => newC.referredBy.toLowerCase().includes(c.firstName.toLowerCase()));
                if(referrer) referrer.credits += 10;
            }

            db.customers.push(newC);
            saveData();
            closeModals();
            nav('customers');
            alert('Customer Saved! Referral Code Generated: ' + newC.referralCode);
        }

        function saveOrder(e) {
            e.preventDefault();
            const custId = document.getElementById('orderCustomerSelect').value;
            const price = parseFloat(document.getElementById('orderProduct').value);
            const qty = parseInt(document.getElementById('orderQty').value);
            const cust = db.customers.find(c => c.id === custId);

            db.orders.unshift({
                id: Math.floor(Math.random() * 90000) + 10000,
                custId: custId,
                name: cust.firstName + ' ' + cust.lastName,
                date: new Date().toISOString().split('T')[0],
                amount: price * qty,
                status: 'Processing'
            });
            saveData();
            closeModals();
            nav('orders');
        }

        function saveEvent(e) {
            e.preventDefault();
            db.events.push({
                id: 'e' + Date.now(),
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                type: document.getElementById('eventType').value
            });
            saveData();
            closeModals();
            nav('calendar');
        }

        function showEventDetail(id) {
            const ev = db.events.find(e => e.id === id);
            if(ev) {
                document.getElementById('detailTitle').innerText = ev.title;
                document.getElementById('detailDate').innerText = ev.date;
                document.getElementById('detailType').innerText = ev.type;
                document.getElementById('eventDetailModal').style.display = 'grid';
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "AcoustiSkin_Backup.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        function importData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    db = JSON.parse(e.target.result);
                    saveData();
                    alert('Data restored successfully!');
                    location.reload();
                } catch(err) { alert('Invalid file.'); }
            };
            reader.readAsText(file);
        }

        function handleSearch() {
            // Placeholder: Filtering logic would go here
            console.log("Searching: " + document.getElementById('globalSearch').value);
        }

    </script>
</body>
</html>
