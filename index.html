<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AcoustiSkin CRM</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
      color: #2e5940;
    }
    
    .container {
      display: flex;
      min-height: 100vh;
    }
    
    .sidebar {
      width: 220px;
      background: linear-gradient(180deg, #2e5940 0%, #1e3a28 100%);
      color: white;
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }
    
    .sidebar-header h2 {
      font-size: 22px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .ai-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .sidebar-nav {
      padding: 20px 0;
    }
    
    .nav-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
      color: rgba(255,255,255,0.8);
    }
    
    .nav-item:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .nav-item.active {
      background: rgba(102,187,106,0.3);
      border-left: 4px solid #66bb6a;
      color: white;
    }
    
    .nav-item i {
      width: 20px;
      text-align: center;
    }
    
    .main-content {
      margin-left: 220px;
      flex: 1;
      padding: 30px;
    }
    
    .top-bar {
      background: white;
      padding: 20px 30px;
      border-radius: 16px;
      margin-bottom: 30px;
      box-shadow: 0 2px 12px rgba(46,89,64,0.08);
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .search-container {
      flex: 1;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 20px 12px 45px;
      border: 2px solid #e8f5e9;
      border-radius: 12px;
      font-size: 15px;
      transition: all 0.3s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #66bb6a;
      box-shadow: 0 0 0 3px rgba(102,187,106,0.1);
    }
    
    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
    }
    
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
    }
    
    .page-header {
      margin-bottom: 30px;
    }
    
    .page-header h1 {
      font-size: 32px;
      color: #2e5940;
      margin-bottom: 8px;
    }
    
    .page-header p {
      color: #666;
      font-size: 16px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(46,89,64,0.08);
      transition: transform 0.3s;
      cursor: pointer;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(46,89,64,0.12);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      font-weight: 500;
    }
    
    .stat-card .value {
      font-size: 36px;
      font-weight: 700;
      color: #2e5940;
      margin-bottom: 8px;
    }
    
    .stat-card .label {
      font-size: 13px;
      color: #999;
    }
    
    .card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(46,89,64,0.08);
      margin-bottom: 20px;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .card-header h3 {
      font-size: 20px;
      color: #2e5940;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn-primary, .btn-secondary, .btn-success, .btn-danger {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,187,106,0.3);
    }
    
    .btn-secondary {
      background: #e8f5e9;
      color: #2e5940;
    }
    
    .btn-secondary:hover {
      background: #c8e6c9;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
      color: white;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table thead {
      background: #f1f8e9;
    }
    
    .table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #2e5940;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table td {
      padding: 15px;
      border-bottom: 1px solid #f1f8e9;
    }
    
    .table tbody tr {
      transition: background 0.2s;
    }
    
    .table tbody tr:hover {
      background: #f9fdf9;
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    
    .status-active { background: #c8e6c9; color: #2e7d32; }
    .status-lead { background: #fff9c4; color: #f57f17; }
    .status-pending { background: #ffecb3; color: #f57f17; }
    .status-processing { background: #bbdefb; color: #1565c0; }
    .status-shipped { background: #b2dfdb; color: #00695c; }
    .status-completed { background: #c8e6c9; color: #2e7d32; }
    
    .score-badge {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 700;
      display: inline-block;
    }
    
    .score-high { background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); color: white; }
    .score-medium { background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); color: white; }
    .score-low { background: linear-gradient(135deg, #ef5350 0%, #e53935 100%); color: white; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }
    
    .modal-content {
      background: white;
      max-width: 900px;
      margin: 50px auto;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      padding: 25px 30px;
      border-bottom: 2px solid #f1f8e9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      color: #2e5940;
      font-size: 24px;
    }
    
    .close {
      font-size: 32px;
      color: #999;
      cursor: pointer;
      transition: color 0.3s;
    }
    
    .close:hover {
      color: #2e5940;
    }
    
    .modal-body {
      padding: 30px;
      max-height: calc(100vh - 250px);
      overflow-y: auto;
    }
    
    .modal-footer {
      padding: 20px 30px;
      border-top: 2px solid #f1f8e9;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2e5940;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e8f5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #66bb6a;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-nav {
      display: flex;
      gap: 10px;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }
    
    .calendar-day {
      background: white;
      padding: 12px;
      border-radius: 8px;
      min-height: 100px;
      border: 2px solid #f1f8e9;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .calendar-day:hover {
      border-color: #66bb6a;
      box-shadow: 0 2px 8px rgba(102,187,106,0.2);
    }
    
    .calendar-day.today {
      background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
      border-color: #66bb6a;
    }
    
    .event-item {
      background: #e8f5e9;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 6px;
      color: #2e5940;
      cursor: pointer;
    }
    
    .event-item:hover {
      background: #c8e6c9;
    }
    
    .holiday-item {
      background: #fff9c4;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 11px;
      margin-top: 6px;
      color: #f57f17;
    }
    
    .pipeline-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }
    
    .pipeline-column {
      background: #f9fdf9;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e8f5e9;
    }
    
    .pipeline-column h3 {
      color: #2e5940;
      margin-bottom: 15px;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #1e88e5;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e8f5e9;
    }
    
    .tab-btn {
      padding: 12px 24px;
      background: none;
      border: none;
      color: #666;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .tab-btn.active {
      color: #2e5940;
      border-bottom-color: #66bb6a;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      display: none;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .date-header {
      text-align: right;
      color: #2e5940;
      font-size: 14px;
      margin-bottom: 10px;
    }

    #searchResults {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-top: 5px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
  </style>
</head>
  <body>
  <div class="notification" id="notification"></div>
  
  <div class="container">
        <div class="sidebar">
      <div class="sidebar-header">
        <h2>
          <i class="fas fa-drum"></i> AcoustiSkin CRM
        </h2>
        <div class="ai-badge">
          <i class="fas fa-robot"></i> AI-Powered
        </div>
      </div>
      
      <div class="sidebar-nav">
        <div class="nav-item active" id="nav-dashboard" onclick="showView('dashboard', this)">
          <i class="fas fa-home"></i> Dashboard
        </div>
        <div class="nav-item" id="nav-customers" onclick="showView('customers', this)">
          <i class="fas fa-users"></i> Customers
        </div>
        <div class="nav-item" id="nav-orders" onclick="showView('orders', this)">
          <i class="fas fa-shopping-cart"></i> Orders
        </div>
        <div class="nav-item" id="nav-calendar" onclick="showView('calendar', this)">
          <i class="fas fa-calendar"></i> Calendar
        </div>
        <div class="nav-item" id="nav-pipeline" onclick="showView('pipeline', this)">
          <i class="fas fa-chart-line"></i> Pipeline
        </div>
        <div class="nav-item" id="nav-analytics" onclick="showView('analytics', this)">
          <i class="fas fa-chart-bar"></i> Analytics
        </div>
        <div class="nav-item" id="nav-marketing" onclick="showView('marketing', this)">
          <i class="fas fa-bullhorn"></i> Marketing
        </div>
        <div class="nav-item" id="nav-referrals" onclick="showView('referrals', this)">
          <i class="fas fa-gift"></i> Referral Program
        </div>
        <div class="nav-item" id="nav-reports" onclick="showView('reports', this)">
          <i class="fas fa-file-alt"></i> Reports & Tracking
        </div>
        <div class="nav-item" id="nav-import" onclick="showView('import', this)">
          <i class="fas fa-download"></i> Import Data
        </div>
      </div>
      
      <div class="sidebar-actions">
        <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="openCustomerModal()">
          <i class="fas fa-user-plus"></i> New Customer
        </button>
        <button class="btn-success" style="width: 100%; margin-bottom: 10px;" onclick="openEventModal()">
          <i class="fas fa-calendar-plus"></i> Schedule Event
        </button>
        <button class="btn-primary" style="width: 100%;" onclick="openOrderModal()">
          <i class="fas fa-cart-plus"></i> New Order
        </button>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.1); font-size: 12px; color: rgba(255,255,255,0.6);">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <i class="fas fa-save"></i>
            <span>Last Backup</span>
          </div>
          <div id="lastBackupTime" style="color: rgba(255,255,255,0.8);">Never</div>
          <button class="btn-secondary" style="width: 100%; margin-top: 10px; font-size: 12px; padding: 8px;" onclick="downloadBackup()">
            <i class="fas fa-download"></i> Download Backup
          </button>
        </div>
    </div>
        <div class="main-content">
            <div class="top-bar">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" class="search-input" id="searchInput" placeholder="Search customers, orders, locations..." oninput="performGlobalSearch()">
          <div id="searchResults"></div>
        </div>
        <select id="searchFilter" class="form-control" style="width: 200px; padding: 12px; border: 2px solid #e8f5e9; border-radius: 12px;">
          <option value="all">All Results</option>
          <option value="customers">Customers</option>
          <option value="orders">Orders</option>
          <option value="locations">Locations</option>
        </select>
        <button class="btn-primary" onclick="performGlobalSearch()">
          <i class="fas fa-search"></i> Search
        </button>
      </div>

            <div id="dashboard" class="view active">
        <div class="page-header">
          <h1>Dashboard</h1>
          <p>Welcome back! Here's what's happening today.</p>
          <div class="date-header">Today<br><strong style="font-size: 18px;" id="dashboardDate"></strong></div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card" style="background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); color: white;" onclick="showAllCustomers()">
            <h3 style="color: rgba(255,255,255,0.9);">Total Customers</h3>
            <div class="value" id="totalCustomers" style="color: white;">0</div>
            <div class="label" style="color: rgba(255,255,255,0.8);">
              <i class="fas fa-arrow-up"></i> Click to view all
            </div>
          </div>
          
          <div class="stat-card" style="background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: white;" onclick="showAllOrders()">
            <h3 style="color: rgba(255,255,255,0.9);">Total Orders</h3>
            <div class="value" id="totalOrders" style="color: white;">0</div>
            <div class="label" style="color: rgba(255,255,255,0.8);">
              <i class="fas fa-shopping-cart"></i> All time
            </div>
          </div>
          
          <div class="stat-card" style="background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); color: white;" onclick="showRevenueBreakdown()">
            <h3 style="color: rgba(255,255,255,0.9);">Total Revenue</h3>
            <div class="value" id="totalRevenue" style="color: white;">$0.00</div>
            <div class="label" style="color: rgba(255,255,255,0.8);">
              <i class="fas fa-dollar-sign"></i> Click for breakdown
            </div>
          </div>
          
          <div class="stat-card" style="background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%); color: white;" onclick="showTodaysEvents()">
            <h3 style="color: rgba(255,255,255,0.9);">Events Today</h3>
            <div class="value" id="eventsToday" style="color: white;">0</div>
            <div class="label" style="color: rgba(255,255,255,0.8);">
              <i class="fas fa-calendar"></i> Click to view
            </div>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-user-clock"></i> Recent Customers</h3>
            </div>
            <div id="recentCustomers">
              <p style="text-align: center; color: #999; padding: 20px;">No customers yet</p>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-tasks"></i> Today's Tasks</h3>
            </div>
            <div id="todaysTasks">
              <p style="text-align: center; color: #999; padding: 20px;">No tasks for today</p>
            </div>
        </div>
      </div>
    </div>

            <div id="customers" class="view">
        <div class="page-header">
          <h1>Customers</h1>
          <p>Manage your customer relationships</p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3><i class="fas fa-users"></i> All Customers</h3>
            <div>
              <input type="text" id="customerSearch" placeholder="Search customers..." style="padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px; margin-right: 10px;" oninput="filterCustomers()">
              <button class="btn-primary" onclick="openCustomerModal()">
                <i class="fas fa-user-plus"></i> Add Customer
              </button>
            </div>
          </div>
          
          <table class="table">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Contact</th>
                <th>Status</th>
                <th>AI Score</th>
                <th>Lead Source</th>
                <th>Referrals Made</th>
                <th>Potential</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersTable">
              <tr>
                <td colspan="8" style="text-align: center; color: #999; padding: 40px;">
                  No customers yet. Click "Add Customer" to get started.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

            <div id="orders" class="view">
        <div class="page-header">
          <h1>Orders</h1>
          <p>Track and manage all orders</p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3><i class="fas fa-shopping-cart"></i> All Orders</h3>
            <button class="btn-primary" onclick="openOrderModal()">
              <i class="fas fa-plus"></i> New Order
            </button>
          </div>
          
          <table class="table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Product</th>
                <th>Taken By</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTable">
              <tr>
                <td colspan="8" style="text-align: center; color: #999; padding: 40px;">
                  No orders yet. Click "New Order" to get started.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

            <div id="calendar" class="view">
        <div class="page-header">
          <h1>Calendar</h1>
          <p>Schedule and track events</p>
        </div>
        
        <div class="card">
          <div class="calendar-header">
            <h3 id="calendarTitle" style="color: #2e5940; font-size: 24px;">December 2025</h3>
            <div class="calendar-nav">
              <button class="btn-secondary" onclick="changeMonth(-1)">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="btn-secondary" onclick="changeMonth(1)">
                <i class="fas fa-chevron-right"></i>
              </button>
              <button class="btn-primary" onclick="openEventModal()">
                <i class="fas fa-plus"></i> New Event
              </button>
            </div>
          </div>
          
          <div class="calendar-grid">
            <div style="font-weight: 600; color: #2e5940; padding: 10px; text-align: center;">Sun</div>
            <div style="font-weight: 600; color: #2e5940; padding: 10px; text-align: center;">Mon</div>
            <div style="font-weight: 600; color: #2e5940; padding: 10px; text-align: center;">Tue</div>
            <div style="font-weight: 600; color: #2e5940; padding: 10px; text-align: center;">Wed</div>
            <div style="font-weight: 600; color: #2e5940; padding: 10px; text-align: center;">Thu</div>
            <div style="font-weight: 600; color: #2e5940; padding: 10px; text-align: center;">Fri</div>
            <div style="font-weight: 600; color: #2e5940; padding: 10px; text-align: center;">Sat</div>
          </div>
          
          <div class="calendar-grid" id="calendarDays"></div>
        </div>
      </div>
            <div id="pipeline" class="view">
        <div class="page-header">
          <h1>Sales Pipeline</h1>
          <p>Track orders through each stage</p>
        </div>
        
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; text-align: center;">
            <div>
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Pipeline Value</div>
              <div id="pipelineValue" style="font-size: 28px; font-weight: 700; color: #2e5940;">$0.00</div>
            </div>
            <div>
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Average Deal</div>
              <div id="avgDealSize" style="font-size: 28px; font-weight: 700; color: #2e5940;">$0.00</div>
            </div>
            <div>
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Conversion Rate</div>
              <div id="conversionRate" style="font-size: 28px; font-weight: 700; color: #2e5940;">0%</div>
            </div>
            <div>
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Avg Close Time</div>
              <div id="avgCloseTime" style="font-size: 28px; font-weight: 700; color: #2e5940;">0 days</div>
            </div>
        </div>
        
        <div class="pipeline-grid">
          <div class="pipeline-column">
            <h3>Pending</h3>
            <div style="font-size: 24px; font-weight: 700; color: #f57f17; margin-bottom: 10px;" id="pendingCount">0 orders</div>
            <div style="font-size: 18px; font-weight: 600; color: #2e5940; margin-bottom: 15px;" id="pendingValue">$0.00</div>
            <div id="pendingOrdersList"></div>
          </div>
          
          <div class="pipeline-column">
            <h3>Processing</h3>
            <div style="font-size: 24px; font-weight: 700; color: #1565c0; margin-bottom: 10px;" id="processingCount">0 orders</div>
            <div style="font-size: 18px; font-weight: 600; color: #2e5940; margin-bottom: 15px;" id="processingValue">$0.00</div>
            <div id="processingOrdersList"></div>
          </div>
          
          <div class="pipeline-column">
            <h3>Shipped</h3>
            <div style="font-size: 24px; font-weight: 700; color: #00695c; margin-bottom: 10px;" id="shippedCount">0 orders</div>
            <div style="font-size: 18px; font-weight: 600; color: #2e5940; margin-bottom: 15px;" id="shippedValue">$0.00</div>
            <div id="shippedOrdersList"></div>
          </div>
          
          <div class="pipeline-column">
            <h3>Completed</h3>
            <div style="font-size: 24px; font-weight: 700; color: #2e7d32; margin-bottom: 10px;" id="completedCount">0 orders</div>
            <div style="font-size: 18px; font-weight: 600; color: #2e5940; margin-bottom: 15px;" id="completedValue">$0.00</div>
            <div id="completedOrdersList"></div>
          </div>
        </div>
      </div>

            <div id="analytics" class="view">
        <div class="page-header">
          <h1>Analytics</h1>
          <p>Data-driven insights for your business</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div class="card">
            <h3 style="margin-bottom: 20px; color: #2e5940;">
              <i class="fas fa-chart-pie"></i> Lead Sources
            </b>
            <canvas id="leadSourceChart"></canvas>
          </div>
          
          <div class="card">
            <h3 style="margin-bottom: 20px; color: #2e5940;">
              <i class="fas fa-share-alt"></i> Social Media Reach
            </h3>
            <canvas id="socialChart"></canvas>
        </div>
        
        <div class="card">
          <h3 style="margin-bottom: 20px; color: #2e5940;">
            <i class="fas fa-chart-line"></i> Revenue Trend
          </b>
          <canvas id="revenueChart"></canvas>
        </div>
        
        <div class="card">
          <h3 style="margin-bottom: 20px; color: #2e5940;">
            <i class="fas fa-lightbulb"></i> AI-Powered Insights
          </b>
          <div id="aiInsights">
            <p style="color: #999; text-align: center; padding: 40px;">
              Gathering insights... Add more customer data to see AI-powered recommendations.
            </p>
          </div>
        </div>
      </div>

            <div id="marketing" class="view">
        <div class="page-header">
          <h1>Marketing Hub</h1>
          <p>Targeted campaigns and opportunities</p>
        </div>
        
        <div class="card">
          <h3 style="margin-bottom: 20px; color: #2e5940;">
            <i class="fas fa-bullseye"></i> Recommended Campaigns
          </b>
          <div id="marketingRecommendations"></div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="card">
            <h3 style="margin-bottom: 20px; color: #2e5940;">
              <i class="fas fa-star"></i> High-Value Customers
            </b>
            <div id="highValueCustomers"></div>
          </div>
          
          <div class="card">
            <h3 style="margin-bottom: 20px; color: #2e5940;">
              <i class="fas fa-user-friends"></i> Referral Opportunities
            </b>
            <div id="referralOpportunities"></div>
          </div>
        </div>
      </div>

            <div id="referrals" class="view">
        <div class="page-header">
          <h1>Referral Program</h1>
          <p>Reward customers for spreading the word</p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3><i class="fas fa-cog"></i> Program Settings</h3>
            <button class="btn-primary" onclick="openReferralSettings()">
              <i class="fas fa-edit"></i> Edit Settings
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
            <div style="text-align: center; padding: 20px; background: #f1f8e9; border-radius: 12px;">
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Credit per Referral</div>
              <div id="displayCreditAmount" style="font-size: 32px; font-weight: 700; color: #43a047;">$15</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #fff3e0; border-radius: 12px;">
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Bronze Tier</div>
              <div id="displayBronzeThreshold" style="font-size: 32px; font-weight: 700; color: #fb8c00;">1+</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #f3e5f5; border-radius: 12px;">
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Silver Tier</div>
              <div id="displaySilverThreshold" style="font-size: 32px; font-weight: 700; color: #ab47bc;">3+</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #fff9c4; border-radius: 12px;">
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Gold Tier</div>
              <div id="displayGoldThreshold" style="font-size: 32px; font-weight: 700; color: #fbc02d;">5+</div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h3 style="margin-bottom: 20px; color: #2e5940;">
            <i class="fas fa-trophy"></i> Top Referrers
          </b>
          <div id="referralLeaderboard">
            <p style="color: #999; text-align: center; padding: 40px;">
              No referrals yet. Start tracking customer referrals to see your top performers here.
            </p>
        </div>
        </div>
      </div>

            <div id="reports" class="view">
        <div class="page-header">
          <h1>Reports & Tracking</h1>
          <p>Generate custom reports and analytics</p>
        </div>
        
        <div class="card">
          <h3 style="margin-bottom: 20px; color: #2e5940;">
            <i class="fas fa-calendar-alt"></i> Select Date Range
          </b>
          
          <div style="display: flex; gap: 15px; align-items: end; margin-bottom: 20px;">
            <div class="form-group" style="flex: 1;">
              <label>Start Date</label>
              <input type="date" id="reportStartDate" class="form-control">
            </div>
            <div class="form-group" style="flex: 1;">
              <label>End Date</label>
              <input type="date" id="reportEndDate" class="form-control">
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Quick Select</label>
              <select id="reportQuickSelect" class="form-control" onchange="setReportDateRange(this.value)">
                <option value="">Custom Range</option>
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="thisWeek">This Week</option>
                <option value="lastWeek">Last Week</option>
                <option value="thisMonth">This Month</option>
                <option value="lastMonth">Last Month</option>
                <option value="thisYear">This Year</option>
                <option value="lastYear">Last Year</option>
              </select>
            </div>
            <button class="btn-primary" onclick="generateReport()">
              <i class="fas fa-chart-bar"></i> Generate Report
            </button>
          </div>
        </div>
        
        <div id="reportResults"></div>
      </div>

            <div id="import" class="view">
        <div class="page-header">
          <h1>Import Data</h1>
          <p>Import orders from various platforms</p>
        </div>
        
        <div class="card">
          <h3 style="margin-bottom: 20px; color: #2e5940;">
            <i class="fas fa-cloud-upload-alt"></i> Select Platform
          </b>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card" onclick="selectImportPlatform('amazon')" style="cursor: pointer; border: 3px solid transparent; transition: all 0.3s;">
              <div style="font-size: 48px; color: #ff9900; margin-bottom: 15px; text-align: center;">
                <i class="fab fa-amazon"></i>
              </div>
              <h3 style="text-align: center; font-size: 18px; color: #2e5940;">Amazon FBA</h3>
            </div>
            
            <div class="stat-card" onclick="selectImportPlatform('shopify')" style="cursor: pointer; border: 3px solid transparent; transition: all 0.3s;">
              <div style="font-size: 48px; color: #96bf48; margin-bottom: 15px; text-align: center;">
                <i class="fab fa-shopify"></i>
              </div>
              <h3 style="text-align: center; font-size: 18px; color: #2e5940;">Shopify</h3>
            </div>
            
            <div class="stat-card" onclick="selectImportPlatform('ebay')" style="cursor: pointer; border: 3px solid transparent; transition: all 0.3s;">
              <div style="font-size: 48px; color: #e53238; margin-bottom: 15px; text-align: center;">
                <i class="fab fa-ebay"></i>
              </div>
              <h3 style="text-align: center; font-size: 18px; color: #2e5940;">eBay</h3>
            </div>
            
            <div class="stat-card" onclick="selectImportPlatform('csv')" style="cursor: pointer; border: 3px solid transparent; transition: all 0.3s;">
              <div style="font-size: 48px; color: #66bb6a; margin-bottom: 15px; text-align: center;">
                <i class="fas fa-file-csv"></i>
              </div>
              <h3 style="text-align: center; font-size: 18px; color: #2e5940;">Generic CSV</h3>
            </div>
          </div>
          
          <div id="importInstructions" style="display: none;">
            <h4 id="importPlatformTitle" style="color: #2e5940; margin-bottom: 15px;"></h4>
            <div id="importInstructionsContent"></div>
            
            <div style="margin-top: 20px;">
              <label class="btn-primary" style="cursor: pointer;">
                <i class="fas fa-upload"></i> Choose File
                <input type="file" id="platformImportFile" accept=".csv" style="display: none;" onchange="handlePlatformImport(event)">
              </label>
              <span id="selectedFileName" style="margin-left: 15px; color: #666;"></span>
            </div>
        </div>
        
        <div id="importPreview" style="display: none; margin-top: 30px;">
            <h4 style="color: #2e5940; margin-bottom: 15px;">Preview</h4>
            <div id="importPreviewContent"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
              <button class="btn-success" onclick="confirmImport()">
                <i class="fas fa-check"></i> Confirm Import
              </button>
              <button class="btn-secondary" onclick="cancelImport()">
                <i class="fas fa-times"></i> Cancel
              </button>
            </div>
        </div>
      </div>

    </div>
  </div>
    <div id="customerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="customerModalTitle">New Customer</h2>
        <span class="close" onclick="closeModal('customerModal')">&times;</span>
      </div>
      <form id="customerForm" onsubmit="saveCustomer(event)">
        <div class="modal-body">
          <input type="hidden" id="customerId">
          
          <div class="tab-buttons">
            <button type="button" class="tab-btn active" onclick="switchCustomerTab('basic')">Basic Info</button>
            <button type="button" class="tab-btn" onclick="switchCustomerTab('contact')">Contact Details</button>
            <button type="button" class="tab-btn" onclick="switchCustomerTab('address')">Address</button>
            <button type="button" class="tab-btn" onclick="switchCustomerTab('pickleball')">Pickleball Info</button>
            <button type="button" class="tab-btn" onclick="switchCustomerTab('preferences')">Preferences</button>
            <button type="button" class="tab-btn" onclick="switchCustomerTab('referral')">Referral Info</button>
            <button type="button" class="tab-btn" onclick="switchCustomerTab('history')">History</button>
          </div>
          
          <div id="basicTab" class="tab-content active">
            <div class="form-grid">
              <div class="form-group">
                <label>Full Name *</label>
                <input type="text" id="customerName" required>
              </div>
              <div class="form-group">
                <label>Contact Type *</label>
                <select id="customerContact" required>
                  <option value="Individual">Individual</option>
                  <option value="Business">Business</option>
                </select>
            </div>
              <div class="form-group">
                <label>Status *</label>
                <select id="customerStatus" required>
                  <option value="Lead">Lead</option>
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                </select>
              </div>
              <div class="form-group">
                <label>Industry</label>
                <input type="text" id="customerIndustry">
              </div>
              <div class="form-group">
                <label>Age Range</label>
                <select id="customerAgeRange">
                  <option value="">Select...</option>
                  <option value="18-25">18-25</option>
                  <option value="26-35">26-35</option>
                  <option value="36-45">36-45</option>
                  <option value="46-55">46-55</option>
                  <option value="56-65">56-65</option>
                  <option value="66+">66+</option>
                </select>
              </div>
              <div class="form-group">
                <label>Lead Source</label>
                <select id="customerLeadSource">
                  <option value="">Select...</option>
                  <option value="Website">Website</option>
                  <option value="Social Media">Social Media</option>
                  <option value="Referral">Referral</option>
                  <option value="Event">Event</option>
                  <option value="Direct Contact">Direct Contact</option>
                  <option value="Advertisement">Advertisement</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label>Referrer (if applicable)</label>
              <input type="text" id="customerReferrer" placeholder="Who referred this customer?">
            </div>
          </div>
          
          <div id="contactTab" class="tab-content">
            <div class="form-grid">
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="customerEmail">
              </div>
              <div class="form-group">
                <label>Home Phone</label>
                <input type="tel" id="customerHomePhone">
              </div>
              <div class="form-group">
                <label>Mobile Phone</label>
                <input type="tel" id="customerMobilePhone">
              </div>
              <div class="form-group">
                <label>Preferred Contact Method</label>
                <select id="customerContactMethod">
                  <option value="Email">Email</option>
                  <option value="Phone">Phone</option>
                  <option value="Text">Text Message</option>
                  <option value="Social Media">Social Media</option>
                </select>
              </div>
              <div class="form-group">
                <label>Best Time to Contact</label>
                <select id="customerContactTime">
                  <option value="Morning">Morning (8am-12pm)</option>
                  <option value="Afternoon">Afternoon (12pm-5pm)</option>
                  <option value="Evening">Evening (5pm-9pm)</option>
                  <option value="Anytime">Anytime</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label>Social Media Platforms</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="social_facebook" value="Facebook">
                  <label for="social_facebook">Facebook</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="social_instagram" value="Instagram">
                  <label for="social_instagram">Instagram</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="social_twitter" value="Twitter">
                  <label for="social_twitter">Twitter/X</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="social_tiktok" value="TikTok">
                  <label for="social_tiktok">TikTok</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="social_youtube" value="YouTube">
                  <label for="social_youtube">YouTube</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="social_linkedin" value="LinkedIn">
                  <label for="social_linkedin">LinkedIn</label>
                </div>
              </div>
            </div>
            
            <div class="form-grid">
              <div class="form-group">
                <label>Social Media Handle</label>
                <input type="text" id="customerSocialHandle" placeholder="@username">
            </div>
              <div class="form-group">
                <label>Social Media Engagement Level</label>
                <select id="customerSocialEngagement">
                  <option value="">Select...</option>
                  <option value="Very High">Very High (Influencer)</option>
                  <option value="High">High (Very Active)</option>
                  <option value="Medium">Medium (Regular Posts)</option>
                  <option value="Low">Low (Occasional)</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-item">
                <input type="checkbox" id="customerEmailOptIn">
                <label for="customerEmailOptIn">Opt-in for email marketing</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-item">
                <input type="checkbox" id="customerSMSOptIn">
                <label for="customerSMSOptIn">Opt-in for SMS marketing</label>
              </div>
            </div>
          </div>
          
          <div id="addressTab" class="tab-content">
            <h4 style="color: #2e5940; margin-bottom: 15px;">Billing Address</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Street Address</label>
                <input type="text" id="customerBillingStreet">
              </div>
              <div class="form-group">
                <label>City</label>
                <input type="text" id="customerBillingCity">
            </div>
              <div class="form-group">
                <label>State</label>
                <select id="customerBillingState">
                  <option value="">Select State...</option>
                  <option value="AL">Alabama</option>
                  <option value="AK">Alaska</option>
                  <option value="AZ">Arizona</option>
                  <option value="AR">Arkansas</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="CT">Connecticut</option>
                  <option value="DE">Delaware</option>
                  <option value="FL">Florida</option>
                  <option value="GA">Georgia</option>
                  <option value="HI">Hawaii</option>
                  <option value="ID">Idaho</option>
                  <option value="IL">Illinois</option>
                  <option value="IN">Indiana</option>
                  <option value="IA">Iowa</option>
                  <option value="KS">Kansas</option>
                  <option value="KY">Kentucky</option>
                  <option value="LA">Louisiana</option>
                  <option
value="ME">Maine</option>
                  <option value="MD">Maryland</option>
                  <option value="MA">Massachusetts</option>
                  <option value="MI">Michigan</option>
                  <option value="MN">Minnesota</option>
                  <option value="MS">Mississippi</option>
                  <option value="MO">Missouri</option>
                  <option value="MT">Montana</option>
                  <option value="NE">Nebraska</option>
                  <option value="NV">Nevada</option>
                  <option value="NH">New Hampshire</option>
                  <option value="NJ">New Jersey</option>
                  <option value="NM">New Mexico</option>
                  <option value="NY">New York</option>
                  <option value="NC">North Carolina</option>
                  <option value="ND">North Dakota</option>
                  <option value="OH">Ohio</option>
                  <option value="OK">Oklahoma</option>
                  <option value="OR">Oregon</option>
                  <option value="PA">Pennsylvania</option>
                  <option value="RI">Rhode Island</option>
                  <option value="SC">South Carolina</option>
                  <option value="SD">South Dakota</option>
                  <option value="TN">Tennessee</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                  <option value="VT">Vermont</option>
                  <option value="VA">Virginia</option>
                  <option value="WA">Washington</option>
                  <option value="WV">West Virginia</option>
                  <option value="WI">Wisconsin</option>
                  <option value="WY">Wyoming</option>
                </select>
              </div>
              <div class="form-group">
                <label>Zip Code</label>
                <input type="text" id="customerBillingZip">
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-item">
                <input type="checkbox" id="shippingSameAsBilling" onchange="toggleShippingAddress()">
                <label for="shippingSameAsBilling">Shipping address same as billing</label>
              </div>
            </div>
            
            <div id="shippingAddressSection">
              <h4 style="color: #2e5940; margin: 20px 0 15px;">Shipping Address</h4>
              <div class="form-grid">
                <div class="form-group">
                  <label>Street Address</label>
                  <input type="text" id="customerShippingStreet">
              </div>
                <div class="form-group">
                  <label>City</label>
                  <input type="text" id="customerShippingCity">
              </div>
                <div class="form-group">
                  <label>State</label>
                  <select id="customerShippingState">
                    <option value="">Select State...</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Zip Code</label>
                  <input type="text" id="customerShippingZip">
              </div>
              </div>
            </div>
          </div>
          
          <div id="pickleballTab" class="tab-content">
            <div class="form-grid">
              <div class="form-group">
                <label>Skill Level</label>
                <select id="customerSkillLevel">
                  <option value="">Select...</option>
                  <option value="Beginner">Beginner (1.0-2.5)</option>
                  <option value="Intermediate">Intermediate (3.0-3.5)</option>
                  <option value="Advanced">Advanced (4.0-4.5)</option>
                  <option value="Pro">Pro (5.0+)</option>
                </select>
              </div>
              <div class="form-group">
                <label>Play Frequency</label>
                <select id="customerPlayFrequency">
                  <option value="">Select...</option>
                  <option value="Daily">Daily</option>
                  <option value="Several times/week">Several times per week</option>
                  <option value="Weekly">Weekly</option>
                  <option value="Monthly">Monthly</option>
                  <option value="Occasionally">Occasionally</option>
                </select>
              </div>
              <div class="form-group">
                <label>Preferred Playing Time</label>
                <select id="customerPreferredTime">
                  <option value="">Select...</option>
                  <option value="Early Morning">Early Morning</option>
                  <option value="Morning">Morning</option>
                  <option value="Afternoon">Afternoon</option>
                  <option value="Evening">Evening</option>
                </select>
              </div>
              <div class="form-group">
                <label>Home Court/Club</label>
                <input type="text" id="customerHomeCourt">
              </div>
            </div>
            
            <div class="form-group">
              <label>Playing Style</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="style_singles" value="Singles">
                  <label for="style_singles">Singles</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="style_doubles" value="Doubles">
                  <label for="style_doubles">Doubles</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="style_competitive" value="Competitive">
                  <label for="style_competitive">Competitive</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="style_recreational" value="Recreational">
                  <label for="style_recreational">Recreational</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="style_tournaments" value="Tournaments">
                  <label for="style_tournaments">Tournaments</label>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Equipment Preferences</label>
              <textarea id="customerEquipment" placeholder="Paddle brand, ball preferences, etc."></textarea>
            </div>
          </div>
          
          <div id="preferencesTab" class="tab-content">
            <div class="form-group">
              <label>Product Interests</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="interest_paddles" value="Paddles">
                  <label for="interest_paddles">Paddles</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="interest_balls" value="Balls">
                  <label for="interest_balls">Balls</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="interest_bags" value="Bags">
                  <label for="interest_bags">Bags</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="interest_apparel" value="Apparel">
                  <label for="interest_apparel">Apparel</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="interest_accessories" value="Accessories">
                  <label for="interest_accessories">Accessories</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="interest_grips" value="Grips">
                  <label for="interest_grips">Grips & Tapes</label>
                </div>
              </div>
            </div>
            
            <div class="form-grid">
              <div class="form-group">
                <label>Budget Range</label>
                <select id="customerBudget">
                  <option value="">Select...</option>
                  <option value="Under $50">Under $50</option>
                  <option value="$50-$100">$50-$100</option>
                  <option value="$100-$200">$100-$200</option>
                  <option value="$200+">$200+</option>
                </select>
              </div>
              <div class="form-group">
                <label>Purchase Timeline</label>
                <select id="customerTimeline">
                  <option value="">Select...</option>
                  <option value="Immediate">Immediate (Within 1 week)</option>
                  <option value="Short-term">Short-term (1-4 weeks)</option>
                  <option value="Medium-term">Medium-term (1-3 months)</option>
                  <option value="Long-term">Long-term (3+ months)</option>
                  <option value="Just Browsing">Just Browsing</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label>Special Requirements/Notes</label>
              <textarea id="customerNotes" placeholder="Any special needs, preferences, or important information..."></textarea>
          </div>
          
          <div id="referralTab" class="tab-content">
            <div class="form-grid">
              <div class="form-group">
                <label>Referrals Made</label>
                <input type="number" id="customerReferralCount" value="0" min="0">
              </div>
              <div class="form-group">
                <label>Referral Tier</label>
                <select id="customerReferralTier">
                  <option value="None">None</option>
                  <option value="Bronze">Bronze</option>
                  <option value="Silver">Silver</option>
                  <option value="Gold">Gold</option>
                  <option value="Platinum">Platinum</option>
                </select>
              </div>
              <div class="form-group">
                <label>Credits Earned</label>
                <input type="number" id="customerCreditsEarned" value="0" min="0" step="0.01">
              </div>
              <div class="form-group">
                <label>Credits Used</label>
                <input type="number" id="customerCreditsUsed" value="0" min="0" step="0.01">
              </div>
            </div>
            
            <div class="form-group">
              <label>Referred Customers</label>
              <textarea id="customerReferredList" placeholder="List of customers this person has referred..."></textarea>
            </div>
          </div>
          
          <div id="historyTab" class="tab-content">
            <div class="tab-buttons">
              <button type="button" class="tab-btn active" onclick="switchHistoryTab('communications')">Communications</button>
              <button type="button" class="tab-btn" onclick="switchHistoryTab('tasks')">Tasks</button>
              <button type="button" class="tab-btn" onclick="switchHistoryTab('purchases')">Purchases</button>
            </div>
            
            <div id="communicationsHistoryTab" class="tab-content active">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: #2e5940;">Communication History</h4>
                <button type="button" class="btn-primary" onclick="addCommunication()">
                  <i class="fas fa-plus"></i> Add Communication
                </button>
            </div>
              <div id="communicationsList">
                <p style="color: #999; text-align: center; padding: 20px;">No communications recorded yet.</p>
            </div>
            
            <div id="tasksHistoryTab" class="tab-content">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: #2e5940;">Follow-up Tasks</h4>
                <button type="button" class="btn-primary" onclick="addTask()">
                  <i class="fas fa-plus"></i> Add Task
                </button>
            </div>
              <div id="tasksList">
                <p style="color: #999; text-align: center; padding: 20px;">No tasks created yet.</p>
            </div>
            
            <div id="purchasesHistoryTab" class="tab-content">
              <div style="margin-bottom: 15px;">
                <h4 style="color: #2e5940;">Purchase History</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                  <div style="background: #f1f8e9; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Orders</div>
                    <div id="customerTotalOrders" style="font-size: 24px; font-weight: 700; color: #2e5940;">0</div>
                </div>
                  <div style="background: #f1f8e9; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Spent</div>
                    <div id="customerTotalSpent" style="font-size: 24px; font-weight: 700; color: #2e5940;">$0.00</div>
                </div>
                  <div style="background: #f1f8e9; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Lifetime Value</div>
                    <div id="customerLTV" style="font-size: 24px; font-weight: 700; color: #43a047;">$0.00</div>
                </div>
              </div>
            </div>
              <div id="purchasesList">
                <p style="color: #999; text-align: center; padding: 20px;">No purchases yet.</p>
            </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeModal('customerModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Customer
          </button>
        </div>
      </form>
    </div>
  </div>

    <div id="orderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="orderModalTitle">New Order</h2>
        <span class="close" onclick="closeModal('orderModal')">&times;</span>
      </div>
      <form id="orderForm" onsubmit="saveOrder(event)">
        <div class="modal-body">
          <input type="hidden" id="orderId">
          
          <div class="form-grid">
            <div class="form-group">
              <label>Customer *</label>
              <select id="orderCustomer" required onchange="populateOrderCustomerInfo()">
                <option value="">Select Customer...</option>
              </select>
            </div>
            <div class="form-group">
              <label>Order Date *</label>
              <input type="date" id="orderDate" required>
            </div>
            <div class="form-group">
              <label>Status *</label>
              <select id="orderStatus" required>
                <option value="Pending">Pending</option>
                <option value="Processing">Processing</option>
                <option value="Shipped">Shipped</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
            <div class="form-group">
              <label>Order Taken By</label>
              <input type="text" id="orderTakenBy" placeholder="Your name or ID">
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Product/Service *</label>
              <input type="text" id="orderProduct" required placeholder="e.g., Premium Paddle, Training Session">
            </div>
            <div class="form-group">
              <label>Manufacturer</label>
              <input type="text" id="orderManufacturer" placeholder="e.g., Selkirk, Paddletek">
            </div>
            <div class="form-group">
              <label>Quantity *</label>
              <input type="number" id="orderQuantity" value="1" min="1" required onchange="calculateOrderTotal()">
            </div>
            <div class="form-group">
              <label>Unit Price *</label>
              <input type="number" id="orderPrice" step="0.01" min="0" required placeholder="0.00" onchange="calculateOrderTotal()">
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Discount (%)</label>
              <input type="number" id="orderDiscount" value="0" min="0" max="100" step="0.01" onchange="calculateOrderTotal()">
            </div>
            <div class="form-group">
              <label>Tax Rate (%)</label>
              <input type="number" id="orderTaxRate" value="7" min="0" max="100" step="0.01" onchange="calculateOrderTotal()">
            </div>
            <div class="form-group">
              <label>Shipping Cost</label>
              <input type="number" id="orderShippingCost" value="0" min="0" step="0.01" onchange="calculateOrderTotal()">
            </div>
          </div>
          
          <div style="background: #f1f8e9; padding: 20px; border-radius: 12px; margin: 20px 0;">
            <h4 style="color: #2e5940; margin-bottom: 15px;">Order Summary</h4>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>Subtotal:</span>
              <strong id="orderSubtotalDisplay">$0.00</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>Tax:</span>
              <strong id="orderTaxDisplay">$0.00</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>Shipping:</span>
              <strong id="orderShippingDisplay">$0.00</strong>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 20px; padding-top: 10px; border-top: 2px solid #c8e6c9;">
              <span style="color: #2e5940; font-weight: 700;">Total:</span>
              <strong id="orderTotalDisplay" style="color: #43a047;">$0.00</strong>
            </div>
          </div>
          
          <h4 style="color: #2e5940; margin: 20px 0 15px;">Bill To</h4>
          <div class="form-grid">
            <div class="form-group">
              <label>Street Address</label>
              <input type="text" id="orderBillStreet">
            </div>
            <div class="form-group">
              <label>City</label>
              <input type="text" id="orderBillCity">
            </div>
            <div class="form-group">
              <label>State</label>
              <input type="text" id="orderBillState">
            </div>
            <div class="form-group">
              <label>Zip Code</label>
              <input type="text" id="orderBillZip">
            </div>
          </div>
          
          <h4 style="color: #2e5940; margin: 20px 0 15px;">Ship To</h4>
          <div class="form-grid">
            <div class="form-group">
              <label>Street Address</label>
              <input type="text" id="orderShipStreet">
            </div>
            <div class="form-group">
              <label>City</label>
              <input type="text" id="orderShipCity">
            </div>
            <div class="form-group">
              <label>State</label>
              <input type="text" id="orderShipState">
            </div>
            <div class="form-group">
              <label>Zip Code</label>
              <input type="text" id="orderShipZip">
            </div>
          </div>
          
          <div class="form-group">
            <label>Order Notes</label>
            <textarea id="orderNotes" placeholder="Any special instructions or notes..."></textarea>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeModal('orderModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Order
          </button>
        </div>
      </form>
    </div>
  </div>

    <div id="eventModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="eventModalTitle">New Event</h2>
        <span class="close" onclick="closeModal('eventModal')">&times;</span>
      </div>
      <form id="eventForm" onsubmit="saveEvent(event)">
        <div class="modal-body">
          <input type="hidden" id="eventId">
          
          <div class="form-grid">
            <div class="form-group">
              <label>Event Title *</label>
              <input type="text" id="eventTitle" required>
            </div>
            <div class="form-group">
              <label>Event Type *</label>
              <select id="eventType" required>
                <option value="Meeting">Meeting</option>
                <option value="Call">Phone Call</option>
                <option value="Demo">Product Demo</option>
                <option value="Follow-up">Follow-up</option>
                <option value="Tournament">Tournament</option>
                <option value="Clinic">Clinic/Training</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Customer</label>
              <select id="eventCustomer">
                <option value="">No customer (general event)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Date *</label>
              <input type="date" id="eventDate" required>
            </div>
            <div class="form-group">
              <label>Time</label>
              <input type="time" id="eventTime">
            </div>
            <div class="form-group">
              <label>Duration (minutes)</label>
              <input type="number" id="eventDuration" value="30" min="15" step="15">
            </div>
          </div>
          
          <div class="form-group">
            <label>Location</label>
            <input type="text" id="eventLocation" placeholder="e.g., Office, Phone, Local Club">
          </div>
          
          <div class="form-group">
            <label>Description</label>
            <textarea id="eventDescription" placeholder="Event details..."></textarea>
          </div>
          
          <div class="form-group">
            <div class="checkbox-item">
              <input type="checkbox" id="eventReminder">
              <label for="eventReminder">Set reminder 24 hours before</label>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeModal('eventModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Event
          </button>
        </div>
      </form>
    </div>
  </div>

    <div id="communicationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Communication</h2>
        <span class="close" onclick="closeModal('communicationModal')">&times;</span>
      </div>
      <form id="communicationForm" onsubmit="saveCommunication(event)">
        <div class="modal-body">
          <input type="hidden" id="communicationCustomerId">
          
          <div class="form-grid">
            <div class="form-group">
              <label>Type *</label>
              <select id="communicationType" required>
                <option value="Email">Email</option>
                <option value="Phone">Phone Call</option>
                <option value="Meeting">In-Person Meeting</option>
                <option value="Text">Text Message</option>
                <option value="Social">Social Media</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Date *</label>
              <input type="date" id="communicationDate" required>
            </div>
          </div>
          
          <div class="form-group">
            <label>Subject</label>
            <input type="text" id="communicationSubject" placeholder="Brief summary">
          </div>
          
          <div class="form-group">
            <label>Notes *</label>
            <textarea id="communicationNotes" required placeholder="What was discussed?"></textarea>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeModal('communicationModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save
          </button>
        </div>
      </form>
    </div>
  </div>

    <div id="taskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Task</h2>
        <span class="close" onclick="closeModal('taskModal')">&times;</span>
      </div>
      <form id="taskForm" onsubmit="saveTask(event)">
        <div class="modal-body">
          <input type="hidden" id="taskCustomerId">
          
          <div class="form-group">
            <label>Task Description *</label>
            <input type="text" id="taskDescription" required placeholder="What needs to be done?">
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Due Date *</label>
              <input type="date" id="taskDueDate" required>
            </div>
            <div class="form-group">
              <label>Priority *</label>
              <select id="taskPriority" required>
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
              </select>
            </div>
            <div class="form-group">
              <label>Status *</label>
              <select id="taskStatus" required>
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>Notes</label>
            <textarea id="taskNotes" placeholder="Additional details..."></textarea>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Task
          </button>
        </div>
      </form>
    </div>
  </div>

    <div id="referralSettingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Referral Program Settings</h2>
        <span class="close" onclick="closeModal('referralSettingsModal')">&times;</span>
      </div>
      <form id="referralSettingsForm" onsubmit="saveReferralSettings(event)">
        <div class="modal-body">
          <div class="form-group">
            <label>Credit Amount per Referral ($)</label>
            <input type="number" id="creditPerReferral" value="15" min="0" step="0.01">
            <small style="color: #666; display: block; margin-top: 5px;">Amount credited to customer for each successful referral</small>
          </div>
          
          <h4 style="color: #2e5940; margin: 20px 0 15px;">Reward Tiers</h4>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Bronze Tier (referrals)</label>
              <input type="number" id="bronzeTier" value="1" min="1">
            </div>
            <div class="form-group">
              <label>Silver Tier (referrals)</label>
              <input type="number" id="silverTier" value="3" min="1">
            </div>
            <div class="form-group">
              <label>Gold Tier (referrals)</label>
              <input type="number" id="goldTier" value="5" min="1">
            </div>
            <div class="form-group">
              <label>Platinum Tier (referrals)</label>
              <input type="number" id="platinumTier" value="10" min="1">
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeModal('referralSettingsModal')">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Settings
          </button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // CRM Data Structure
    let crmData = {
      customers: [],
      orders: [],
      events: [],
      referralSettings: {
        creditPerReferral: 15,
        tiers: {
          bronze: 1,
          silver: 3,
          gold: 5,
          platinum: 10
        }
      }
    };

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let currentView = 'dashboard';

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      updateDashboardDate();
      populateCustomerDropdowns();
      // Explicitly call showView on the element to ensure activation
      showView('dashboard', document.getElementById('nav-dashboard'));
      
      // Set default dates
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('eventDate').value = today;
      document.getElementById('orderDate').value = today;
      document.getElementById('communicationDate').value = today;
      document.getElementById('taskDueDate').value = today;
    });
    
    function updateDashboardDate() {
      document.getElementById('dashboardDate').textContent = new Date().toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
    }

    // Local Storage Functions
    function saveData() {
      localStorage.setItem('acoustiskinCRM', JSON.stringify(crmData));
      document.getElementById('lastBackupTime').textContent = new Date().toLocaleString();
      localStorage.setItem('lastBackup', new Date().toISOString());
    }

    function loadData() {
      const saved = localStorage.getItem('acoustiskinCRM');
      if (saved) {
        crmData = JSON.parse(saved);
      }
      
      const lastBackup = localStorage.getItem('lastBackup');
      if (lastBackup) {
        document.getElementById('lastBackupTime').textContent = new Date(lastBackup).toLocaleString();
      }
    }

    function downloadBackup() {
      const dataStr = JSON.stringify(crmData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `acoustiskin-crm-backup-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      showNotification('Backup downloaded successfully!');
    }

    // View Management
    function showView(viewName, element) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      document.getElementById(viewName).classList.add('active');
      
      if (element) {
        element.classList.add('active');
      } else {
        // Fallback to explicitly set active nav item
        const navItem = document.getElementById('nav-' + viewName);
        if (navItem) navItem.classList.add('active');
      }
      
      currentView = viewName;
      
      // Update view content
      if (viewName === 'dashboard') updateDashboard();
      if (viewName === 'customers') updateCustomersView();
      if (viewName === 'orders') updateOrdersView();
      if (viewName === 'calendar') renderCalendar();
      if (viewName === 'pipeline') updatePipelineView();
      if (viewName === 'analytics') updateAnalyticsView();
      if (viewName === 'marketing') updateMarketingView();
      if (viewName === 'referrals') updateReferralsView();
    }

    // Customer Tab Switching
    function switchCustomerTab(tabName) {
      document.querySelectorAll('#customerModal .tab-buttons .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('#customerModal .tab-content').forEach(content => content.classList.remove('active'));
      
      // Find the corresponding button and content
      const buttonElement = document.querySelector(`.tab-buttons .tab-btn[onclick*="${tabName}"]`);
      if(buttonElement) buttonElement.classList.add('active');
      
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // Load customer history if switching to history tab
      if (tabName === 'history') {
        const customerId = document.getElementById('customerId').value;
        if (customerId) {
          loadCustomerHistory(customerId);
        }
      }
    }

    function switchHistoryTab(tabName) {
      document.querySelectorAll('#historyTab .tab-buttons .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('#historyTab .tab-content').forEach(content => content.classList.remove('active'));
      
      const buttonElement = document.querySelector(`#historyTab .tab-buttons .tab-btn[onclick*="${tabName}"]`);
      if(buttonElement) buttonElement.classList.add('active');
      
      document.getElementById(tabName + 'HistoryTab').classList.add('active');
    }

    // Customer Functions
    function openCustomerModal(customerId = null) {
      document.getElementById('customerModal').style.display = 'block';
      document.getElementById('customerForm').reset();
      
      // Reset checkboxes manually, as form.reset() might miss them
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      
      // Reset to first tab
      switchCustomerTab('basic');
      
      if (customerId) {
        const customer = crmData.customers.find(c => c.id === customerId);
        if (customer) {
          document.getElementById('customerModalTitle').textContent = 'Edit Customer';
          document.getElementById('customerId').value = customer.id;
          document.getElementById('customerName').value = customer.name;
          document.getElementById('customerContact').value = customer.contactType || 'Individual';
          document.getElementById('customerStatus').value = customer.status;
          document.getElementById('customerEmail').value = customer.email || '';
          document.getElementById('customerHomePhone').value = customer.homePhone || '';
          document.getElementById('customerMobilePhone').value = customer.mobilePhone || '';
          document.getElementById('customerIndustry').value = customer.industry || '';
          document.getElementById('customerAgeRange').value = customer.ageRange || '';
          document.getElementById('customerLeadSource').value = customer.leadSource || '';
          document.getElementById('customerReferrer').value = customer.referrer || '';
          document.getElementById('customerContactMethod').value = customer.contactMethod || 'Email';
          document.getElementById('customerContactTime').value = customer.contactTime || 'Anytime';
          document.getElementById('customerSocialHandle').value = customer.socialHandle || '';
          document.getElementById('customerSocialEngagement').value = customer.socialEngagement || '';
          document.getElementById('customerEmailOptIn').checked = customer.emailOptIn || false;
          document.getElementById('customerSMSOptIn').checked = customer.smsOptIn || false;
          
          // Address fields
          document.getElementById('customerBillingStreet').value = customer.billing?.street || '';
          document.getElementById('customerBillingCity').value = customer.billing?.city || '';
          document.getElementById('customerBillingState').value = customer.billing?.state || '';
          document.getElementById('customerBillingZip').value = customer.billing?.zip || '';
          document.getElementById('customerShippingStreet').value = customer.shipping?.street || '';
          document.getElementById('customerShippingCity').value = customer.shipping?.city || '';
          document.getElementById('customerShippingState').value = customer.shipping?.state || '';
          document.getElementById('customerShippingZip').value = customer.shipping?.zip || '';
          
          // If shipping equals billing, check the box and hide the section
          const shippingSame = customer.billing && customer.shipping &&
            customer.billing.street === customer.shipping.street &&
            customer.billing.city === customer.shipping.city; // Simple check
          document.getElementById('shippingSameAsBilling').checked = shippingSame;
          document.getElementById('shippingAddressSection').style.display = shippingSame ? 'none' : 'block';
          
          // Pickleball info
          document.getElementById('customerSkillLevel').value = customer.skillLevel || '';
          document.getElementById('customerPlayFrequency').value = customer.playFrequency || '';
          document.getElementById('customerPreferredTime').value = customer.preferredTime || '';
          document.getElementById('customerHomeCourt').value = customer.homeCourt || '';
          document.getElementById('customerEquipment').value = customer.equipment || '';
          
          // Preferences
          document.getElementById('customerBudget').value = customer.budget || '';
          document.getElementById('customerTimeline').value = customer.timeline || '';
          document.getElementById('customerNotes').value = customer.notes || '';
          
          // Referral info
          document.getElementById('customerReferralCount').value = customer.referralCount || 0;
          document.getElementById('customerReferralTier').value = customer.referralTier || 'None';
          document.getElementById('customerCreditsEarned').value = customer.creditsEarned || 0;
          document.getElementById('customerCreditsUsed').value = customer.creditsUsed || 0;
          document.getElementById('customerReferredList').value = customer.referredList || '';
          
          // Checkboxes - Social Media
          if (customer.socialMedia) {
            customer.socialMedia.forEach(platform => {
              const checkbox = document.getElementById('social_' + platform.toLowerCase());
              if (checkbox) checkbox.checked = true;
            });
          }
          
          // Checkboxes - Playing Style
          if (customer.playingStyle) {
            customer.playingStyle.forEach(style => {
              const checkbox = document.getElementById('style_' + style.toLowerCase());
              if (checkbox) checkbox.checked = true;
            });
          }
          
          // Checkboxes - Product Interests
          if (customer.interests) {
            customer.interests.forEach(interest => {
              const checkbox = document.getElementById('interest_' + interest.toLowerCase());
              if (checkbox) checkbox.checked = true;
            });
          }
          
          loadCustomerHistory(customerId);
        }
      } else {
        document.getElementById('customerModalTitle').textContent = 'New Customer';
        document.getElementById('customerId').value = '';
      }
    }

    function saveCustomer(event) {
      event.preventDefault();
      
      const customerId = document.getElementById('customerId').value;
      const isNew = !customerId;
      
      // Get checked values
      const socialMedia = [];
      document.querySelectorAll('#contactTab [id^="social_"]:checked').forEach(cb => socialMedia.push(cb.value));
      
      const playingStyle = [];
      document.querySelectorAll('#pickleballTab [id^="style_"]:checked').forEach(cb => playingStyle.push(cb.value));
      
      const interests = [];
      document.querySelectorAll('#preferencesTab [id^="interest_"]:checked').forEach(cb => interests.push(cb.value));
      
      // Determine shipping address based on checkbox state
      const sameAsBilling = document.getElementById('shippingSameAsBilling').checked;
      
      const customer = {
        id: customerId || 'CUST' + Date.now(),
        name: document.getElementById('customerName').value,
        contactType: document.getElementById('customerContact').value,
        status: document.getElementById('customerStatus').value,
        email: document.getElementById('customerEmail').value,
        homePhone: document.getElementById('customerHomePhone').value,
        mobilePhone: document.getElementById('customerMobilePhone').value,
        industry: document.getElementById('customerIndustry').value,
        ageRange: document.getElementById('customerAgeRange').value,
        leadSource: document.getElementById('customerLeadSource').value,
        referrer: document.getElementById('customerReferrer').value,
        contactMethod: document.getElementById('customerContactMethod').value,
        contactTime: document.getElementById('customerContactTime').value,
        socialMedia: socialMedia,
        socialHandle: document.getElementById('customerSocialHandle').value,
        socialEngagement: document.getElementById('customerSocialEngagement').value,
        emailOptIn: document.getElementById('customerEmailOptIn').checked,
        smsOptIn: document.getElementById('customerSMSOptIn').checked,
        billing: {
          street: document.getElementById('customerBillingStreet').value,
          city: document.getElementById('customerBillingCity').value,
          state: document.getElementById('customerBillingState').value,
          zip: document.getElementById('customerBillingZip').value
        },
        shipping: sameAsBilling ? {
          street: document.getElementById('customerBillingStreet').value,
          city: document.getElementById('customerBillingCity').value,
          state: document.getElementById('customerBillingState').value,
          zip: document.getElementById('customerBillingZip').value
        } : {
          street: document.getElementById('customerShippingStreet').value,
          city: document.getElementById('customerShippingCity').value,
          state: document.getElementById('customerShippingState').value,
          zip: document.getElementById('customerShippingZip').value
        },
        skillLevel: document.getElementById('customerSkillLevel').value,
        playFrequency: document.getElementById('customerPlayFrequency').value,
        preferredTime: document.getElementById('customerPreferredTime').value,
        homeCourt: document.getElementById('customerHomeCourt').value,
        playingStyle: playingStyle,
        equipment: document.getElementById('customerEquipment').value,
        interests: interests,
        budget: document.getElementById('customerBudget').value,
        timeline: document.getElementById('customerTimeline').value,
        notes: document.getElementById('customerNotes').value,
        referralCount: parseInt(document.getElementById('customerReferralCount').value) || 0,
        referralTier: document.getElementById('customerReferralTier').value,
        creditsEarned: parseFloat(document.getElementById('customerCreditsEarned').value) || 0,
        creditsUsed: parseFloat(document.getElementById('customerCreditsUsed').value) || 0,
        referredList: document.getElementById('customerReferredList').value,
        aiScore: calculateAIScore(),
        createdAt: isNew ? new Date().toISOString() : (crmData.customers.find(c => c.id === customerId)?.createdAt || new Date().toISOString()),
        communications: isNew ? [] : (crmData.customers.find(c => c.id === customerId)?.communications || []),
        tasks: isNew ? [] : (crmData.customers.find(c => c.id === customerId)?.tasks || [])
      };
      
      if (isNew) {
        crmData.customers.push(customer);
        showNotification('Customer added successfully!');
      } else {
        const index = crmData.customers.findIndex(c => c.id === customerId);
        // Preserve communications and tasks if not modified in the modal (they are modified in sub-modals)
        customer.communications = crmData.customers[index].communications;
        customer.tasks = crmData.customers[index].tasks;
        crmData.customers[index] = customer;
        showNotification('Customer updated successfully!');
      }
      
      saveData();
      closeModal('customerModal');
      updateAllViews();
      populateCustomerDropdowns();
    }

    function deleteCustomer(id) {
      if (confirm('Are you sure you want to delete this customer? This will also delete all associated orders and events.')) {
        crmData.customers = crmData.customers.filter(c => c.id !== id);
        crmData.orders = crmData.orders.filter(o => o.customerId !== id);
        crmData.events = crmData.events.filter(e => e.customerId !== id);
        saveData();
        updateAllViews();
        showNotification('Customer deleted');
      }
    }

    function calculateAIScore() {
      let score = 50; // Base score
      
      // Factors that increase score
      const budget = document.getElementById('customerBudget').value;
      if (budget === '$200+') score += 30;
      else if (budget === '$100-$200') score += 20;
      else if (budget === '$50-$100') score += 10;
      
      const timeline = document.getElementById('customerTimeline').value;
      if (timeline === 'Immediate') score += 25;
      else if (timeline === 'Short-term') score += 15;
      else if (timeline === 'Medium-term') score += 10;
      
      const engagement = document.getElementById('customerSocialEngagement').value;
      if (engagement === 'Very High') score += 20;
      else if (engagement === 'High') score += 15;
      else if (engagement === 'Medium') score += 10;
      
      // Checkboxes are retrieved above in saveCustomer for consistency but are used here for scoring calculation
      const interests = document.querySelectorAll('#preferencesTab [id^="interest_"]:checked').length;
      score += interests * 3;
      
      if (document.getElementById('customerEmailOptIn').checked) score += 5;
      if (document.getElementById('customerSMSOptIn').checked) score += 5;
      
      return Math.min(100, Math.max(0, score));
    }

    function toggleShippingAddress() {
      const sameAsBilling = document.getElementById('shippingSameAsBilling').checked;
      const shippingSection = document.getElementById('shippingAddressSection');
      
      if (sameAsBilling) {
        shippingSection.style.display = 'none';
      } else {
        shippingSection.style.display = 'block';
        // Clear fields if they were previously hidden and copied
        if (document.getElementById('customerShippingStreet').value === document.getElementById('customerBillingStreet').value) {
          document.getElementById('customerShippingStreet').value = '';
          document.getElementById('customerShippingCity').value = '';
          document.getElementById('customerShippingState').value = '';
          document.getElementById('customerShippingZip').value = '';
        }
      }
    }

    function updateCustomersView() {
      const tbody = document.getElementById('customersTable');
      const html = crmData.customers.map(c => {
        const scoreClass = c.aiScore >= 75 ? 'score-high' : c.aiScore >= 50 ? 'score-medium' : 'score-low';
        return `
          <tr>
            <td>
              <strong>${c.name}</strong><br>
              <small style="color: #666;">${c.contactType || 'Individual'}</small>
            </td>
            <td>
              ${c.email ? `<div><i class="fas fa-envelope"></i> ${c.email}</div>` : ''}
              ${c.homePhone ? `<div><i class="fas fa-phone"></i> ${c.homePhone}</div>` : ''}
              ${c.mobilePhone ? `<div><i class="fas fa-mobile-alt"></i> ${c.mobilePhone}</div>` : ''}
            </td>
            <td><span class="status-badge status-${c.status.toLowerCase()}">${c.status}</span></td>
            <td><span class="score-badge ${scoreClass}">${c.aiScore}/100</span></td>
            <td>${c.leadSource || 'Unknown'}</td>
            <td><strong>${c.referralCount || 0}</strong></td>
            <td>${c.budget || 'Not set'}</td>
            <td>
              <button class="btn-secondary" style="padding: 6px 12px; margin-right: 5px;" onclick="openCustomerModal('${c.id}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-danger" style="padding: 6px 12px;" onclick="deleteCustomer('${c.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML = html || '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No customers yet. Click "Add Customer" to get started.</td></tr>';
    }

    function filterCustomers() {
      const search = document.getElementById('customerSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#customersTable tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      });
    }
    // Order Functions
    function openOrderModal(orderId = null) {
      document.getElementById('orderModal').style.display = 'block';
      document.getElementById('orderForm').reset();
      populateCustomerDropdowns();
      
      if (orderId) {
        const order = crmData.orders.find(o => o.id === orderId);
        if (order) {
          document.getElementById('orderModalTitle').textContent = 'Edit Order';
          document.getElementById('orderId').value = order.id;
          document.getElementById('orderCustomer').value = order.customerId;
          document.getElementById('orderDate').value = order.date;
          document.getElementById('orderStatus').value = order.status;
          document.getElementById('orderTakenBy').value = order.takenBy || '';
          document.getElementById('orderProduct').value = order.product;
          document.getElementById('orderManufacturer').value = order.manufacturer || '';
          document.getElementById('orderQuantity').value = order.quantity;
          document.getElementById('orderPrice').value = order.price;
          document.getElementById('orderDiscount').value = order.discount || 0;
          document.getElementById('orderTaxRate').value = order.taxRate || 7; // Corrected ID
          document.getElementById('orderShippingCost').value = order.shippingCost || 0;
          document.getElementById('orderNotes').value = order.notes || '';
          
          // Billing address
          document.getElementById('orderBillStreet').value = order.billTo?.street || '';
          document.getElementById('orderBillCity').value = order.billTo?.city || '';
          document.getElementById('orderBillState').value = order.billTo?.state || '';
          document.getElementById('orderBillZip').value = order.billTo?.zip || '';
          
          // Shipping address
          document.getElementById('orderShipStreet').value = order.shipTo?.street || '';
          document.getElementById('orderShipCity').value = order.shipTo?.city || '';
          document.getElementById('orderShipState').value = order.shipTo?.state || '';
          document.getElementById('orderShipZip').value = order.shipTo?.zip || '';
          
          calculateOrderTotal();
        }
      } else {
        document.getElementById('orderModalTitle').textContent = 'New Order';
        document.getElementById('orderId').value = '';
        
        // Set defaults for new order
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('orderDate').value = today;
        document.getElementById('orderQuantity').value = 1;
        document.getElementById('orderDiscount').value = 0;
        document.getElementById('orderTaxRate').value = 7; // Corrected ID
        document.getElementById('orderShippingCost').value = 0;
        
        // Reset order totals display for new orders
        document.getElementById('orderSubtotalDisplay').textContent = '$0.00'; // Corrected ID
        document.getElementById('orderTaxDisplay').textContent = '$0.00'; // Corrected ID
        document.getElementById('orderShippingDisplay').textContent = '$0.00'; // Corrected ID
        document.getElementById('orderTotalDisplay').textContent = '$0.00'; // Corrected ID
      }
    }

    function populateOrderCustomerInfo() {
      const customerId = document.getElementById('orderCustomer').value;
      if (!customerId) return;
      
      const customer = crmData.customers.find(c => c.id === customerId);
      if (customer) {
        // Populate billing address
        if (customer.billing) {
          document.getElementById('orderBillStreet').value = customer.billing.street || '';
          document.getElementById('orderBillCity').value = customer.billing.city || '';
          document.getElementById('orderBillState').value = customer.billing.state || '';
          document.getElementById('orderBillZip').value = customer.billing.zip || '';
        }
        
        // Populate shipping address
        if (customer.shipping) {
          document.getElementById('orderShipStreet').value = customer.shipping.street || '';
          document.getElementById('orderShipCity').value = customer.shipping.city || '';
          document.getElementById('orderShipState').value = customer.shipping.state || '';
          document.getElementById('orderShipZip').value = customer.shipping.zip || '';
        }
      }
    }

    function calculateOrderTotal() {
      // Get values from form fields
      const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
      const price = parseFloat(document.getElementById('orderPrice').value) || 0;
      const discount = parseFloat(document.getElementById('orderDiscount').value) || 0;
      const taxRate = parseFloat(document.getElementById('orderTaxRate').value) || 0; // Corrected ID
      const shippingCost = parseFloat(document.getElementById('orderShippingCost').value) || 0;
      
      // Calculations
      const subtotal = quantity * price;
      const discountAmount = subtotal * (discount / 100);
      const subtotalAfterDiscount = subtotal - discountAmount;
      const tax = subtotalAfterDiscount * (taxRate / 100);
      const total = subtotalAfterDiscount + tax + shippingCost;
      
      // Update display fields
      document.getElementById('orderSubtotalDisplay').textContent = '$' + subtotalAfterDiscount.toFixed(2); // Corrected ID
      document.getElementById('orderTaxDisplay').textContent = '$' + tax.toFixed(2); // Corrected ID
      document.getElementById('orderShippingDisplay').textContent = '$' + shippingCost.toFixed(2); // Corrected ID
      document.getElementById('orderTotalDisplay').textContent = '$' + total.toFixed(2); // Corrected ID
    }

    function saveOrder(event) {
      event.preventDefault();
      
      const orderId = document.getElementById('orderId').value;
      const isNew = !orderId;
      
      // Re-calculate final totals immediately before saving for accuracy
      const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
      const price = parseFloat(document.getElementById('orderPrice').value) || 0;
      const discount = parseFloat(document.getElementById('orderDiscount').value) || 0;
      const taxRate = parseFloat(document.getElementById('orderTaxRate').value) || 0; // Corrected ID
      const shippingCost = parseFloat(document.getElementById('orderShippingCost').value) || 0;
      
      const subtotalCalculated = quantity * price;
      const discountAmount = subtotalCalculated * (discount / 100);
      const subtotalAfterDiscount = subtotalCalculated - discountAmount;
      const taxCalculated = subtotalAfterDiscount * (taxRate / 100);
      const totalCalculated = subtotalAfterDiscount + taxCalculated + shippingCost;
      
      const order = {
        id: orderId || 'ORD' + Date.now(),
        customerId: document.getElementById('orderCustomer').value,
        date: document.getElementById('orderDate').value,
        status: document.getElementById('orderStatus').value,
        takenBy: document.getElementById('orderTakenBy').value,
        product: document.getElementById('orderProduct').value,
        manufacturer: document.getElementById('orderManufacturer').value,
        quantity: quantity,
        price: price,
        discount: discount,
        taxRate: taxRate,
        shippingCost: shippingCost,
        subtotal: subtotalAfterDiscount,
        tax: taxCalculated,
        total: totalCalculated, // Saved final calculated total
        billTo: {
          street: document.getElementById('orderBillStreet').value,
          city: document.getElementById('orderBillCity').value,
          state: document.getElementById('orderBillState').value,
          zip: document.getElementById('orderBillZip').value
        },
        shipTo: {
          street: document.getElementById('orderShipStreet').value,
          city: document.getElementById('orderShipCity').value,
          state: document.getElementById('orderShipState').value,
          zip: document.getElementById('orderShipZip').value
        },
        notes: document.getElementById('orderNotes').value,
        createdAt: isNew ? new Date().toISOString() : (crmData.orders.find(o => o.id === orderId)?.createdAt || new Date().toISOString())
      };
      
      if (isNew) {
        crmData.orders.push(order);
        showNotification('Order created successfully!');
      } else {
        const index = crmData.orders.findIndex(o => o.id === orderId);
        crmData.orders[index] = order;
        showNotification('Order updated successfully!');
      }
      
      saveData();
      closeModal('orderModal');
      updateAllViews();
    }

    function updateOrdersView() {
      const tbody = document.getElementById('ordersTable');
      const html = crmData.orders.map(o => {
        const customer = crmData.customers.find(c => c.id === o.customerId);
        return `
          <tr>
            <td><strong>${o.id}</strong></td>
            <td>${customer ? customer.name : 'Unknown'}</td>
            <td>${new Date(o.date).toLocaleDateString()}</td>
            <td>${o.product}${o.manufacturer ? ' (' + o.manufacturer + ')' : ''}</td>
            <td>${o.takenBy || 'N/A'}</td>
            <td><strong>$${o.total.toFixed(2)}</strong></td>
            <td><span class="status-badge status-${o.status.toLowerCase()}">${o.status}</span></td>
            <td>
              <button class="btn-secondary" style="padding: 6px 12px; margin-right: 5px;" onclick="openOrderModal('${o.id}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-danger" style="padding: 6px 12px;" onclick="deleteOrder('${o.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML = html || '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No orders yet. Click "New Order" to create one.</td></tr>';
    }

    function deleteOrder(id) {
      if (confirm('Are you sure you want to delete this order?')) {
        crmData.orders = crmData.orders.filter(o => o.id !== id);
        saveData();
        updateDashboard();
        updateOrdersView();
        showNotification('Order deleted');
      }
    }

    // Event Functions
    function openEventModal(eventId = null, date = null) {
      document.getElementById('eventModal').style.display = 'block';
      document.getElementById('eventForm').reset();
      populateCustomerDropdowns();
      
      if (eventId) {
        const event = crmData.events.find(e => e.id === eventId);
        if (event) {
          document.getElementById('eventModalTitle').textContent = 'Edit Event';
          document.getElementById('eventId').value = event.id;
          document.getElementById('eventTitle').value = event.title;
          document.getElementById('eventType').value = event.type;
          document.getElementById('eventCustomer').value = event.customerId || '';
          document.getElementById('eventDate').value = event.date;
          document.getElementById('eventTime').value = event.time || '';
          document.getElementById('eventDuration').value = event.duration || 30;
          document.getElementById('eventLocation').value = event.location || '';
          document.getElementById('eventDescription').value = event.description || '';
          document.getElementById('eventReminder').checked = event.reminder || false;
        }
      } else {
        document.getElementById('eventModalTitle').textContent = 'New Event';
        document.getElementById('eventId').value = '';
        if (date) {
          document.getElementById('eventDate').value = date;
        } else {
          // Set default date to today for new events
          document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
        }
      }
    }

    function saveEvent(event) {
      event.preventDefault();
      
      const eventId = document.getElementById('eventId').value;
      const isNew = !eventId;
      
      const eventData = {
        id: eventId || 'EVT' + Date.now(),
        title: document.getElementById('eventTitle').value,
        type: document.getElementById('eventType').value,
        customerId: document.getElementById('eventCustomer').value || null,
        date: document.getElementById('eventDate').value,
        time: document.getElementById('eventTime').value,
        duration: parseInt(document.getElementById('eventDuration').value),
        location: document.getElementById('eventLocation').value,
        description: document.getElementById('eventDescription').value,
        reminder: document.getElementById('eventReminder').checked,
        createdAt: isNew ? new Date().toISOString() : (crmData.events.find(e => e.id === eventId)?.createdAt || new Date().toISOString())
      };
      
      if (isNew) {
        crmData.events.push(eventData);
        showNotification('Event created successfully!');
      } else {
        const index = crmData.events.findIndex(e => e.id === eventId);
        crmData.events[index] = eventData;
        showNotification('Event updated successfully!');
      }
      
      saveData();
      closeModal('eventModal');
      renderCalendar();
      updateDashboard();
    }

    function deleteEvent(id) {
      if (confirm('Are you sure you want to delete this event?')) {
        crmData.events = crmData.events.filter(e => e.id !== id);
        saveData();
        renderCalendar();
        updateDashboard();
        showNotification('Event deleted');
      }
    }

    // --- Calendar Helper Functions for US Holidays ---
    // Helper function to find the Nth weekday of a month (e.g., 2nd Monday)
    function findNthDay(year, month, n, dayOfWeek) {
      const firstOfMonth = new Date(year, month, 1);
      let count = 0;
      let date = 1;
      while (count < n) {
        const current = new Date(year, month, date);
        if (current.getDay() === dayOfWeek) {
          count++;
          if (count === n) return current;
        }
        date++;
        if (date > 31) return null; // Safety break
      }
    }

    // Helper function to find the last weekday of a month (e.g., last Monday)
    function findLastDay(year, month, dayOfWeek) {
      let date = new Date(year, month + 1, 0).getDate(); // Last day of month
      while (true) {
        const current = new Date(year, month, date);
        if (current.getDay() === dayOfWeek) return current;
        date--;
        if (date < 1) return null;
      }
    }

    // Function to generate a list of US Public Holidays for a specific month and year
    function getUSPublicHolidays(year, month) {
      const holidays = [];
      // Helper to format date as YYYY-MM-DD string
      const formatDate = (date) => date.toISOString().split('T')[0];

      // Fixed date holidays (Adjust for weekend observation if needed, but for display, use base date)
      const fixedHolidays = [
        { name: "New Year's Day", month: 0, day: 1 },
        { name: "Juneteenth", month: 5, day: 19 },
        { name: "Independence Day", month: 6, day: 4 },
        { name: "Veterans Day", month: 10, day: 11 },
        { name: "Christmas Day", month: 11, day: 25 },
      ];

      fixedHolidays.forEach(h => {
        if (h.month === month) {
          holidays.push({
            name: h.name,
            date: formatDate(new Date(year, h.month, h.day))
          });
        }
      });

      // Floating date holidays (Month is 0-indexed: 0=Jan, 11=Dec)
      // 1. Martin Luther King, Jr.'s Birthday (3rd Monday in January)
      if (month === 0) {
        const mlkDay = findNthDay(year, 0, 3, 1); // 1 = Monday
        holidays.push({ name: "MLK Day", date: formatDate(mlkDay) });
      }

      // 2. Washington's Birthday/Presidents' Day (3rd Monday in February)
      if (month === 1) {
        const presidentsDay = findNthDay(year, 1, 3, 1); // 1 = Monday
        holidays.push({ name: "Presidents' Day", date: formatDate(presidentsDay) });
      }

      // 3. Memorial Day (Last Monday in May)
      if (month === 4) {
        const memorialDay = findLastDay(year, 4, 1); // 1 = Monday
        holidays.push({ name: "Memorial Day", date: formatDate(memorialDay) });
      }

      // 4. Labor Day (1st Monday in September)
      if (month === 8) {
        const laborDay = findNthDay(year, 8, 1, 1); // 1 = Monday
        holidays.push({ name: "Labor Day", date: formatDate(laborDay) });
      }

      // 5. Columbus Day (2nd Monday in October)
      if (month === 9) {
        const columbusDay = findNthDay(year, 9, 2, 1); // 1 = Monday
        holidays.push({ name: "Columbus Day", date: formatDate(columbusDay) });
      }

      // 6. Thanksgiving Day (4th Thursday in November)
      if (month === 10) {
        const thanksgiving = findNthDay(year, 10, 4, 4); // 4 = Thursday
        holidays.push({ name: "Thanksgiving Day", date: formatDate(thanksgiving) });
      }

      return holidays.reduce((acc, h) => {
        acc[h.date] = h.name;
        return acc;
      }, {});
    }
    // --- End Calendar Helper Functions ---


    // Calendar Functions
    function renderCalendar() {
      const calendarDays = document.getElementById('calendarDays');
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      
      document.getElementById('calendarTitle').textContent = `${monthNames[currentMonth]} ${currentYear}`;
      
      const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
      const firstDay = firstDayOfMonth.getDay(); // 0 (Sunday) to 6 (Saturday)
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const today = new Date();
      const todayDateString = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
      
      // Fetch holidays for the current month/year
      const holidaysInMonth = getUSPublicHolidays(currentYear, currentMonth);
      
      let html = '';
      
      // Empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day" style="visibility: hidden;"></div>';
      }
      
      // Days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === todayDateString;
        
        const dayEvents = crmData.events.filter(e => e.date === dateStr);
        const holidayName = holidaysInMonth[dateStr];
        
        let content = '';
        
        if (holidayName) {
          content += `<div class="holiday-item"><i class="fas fa-flag"></i> ${holidayName}</div>`;
        }
      
        content += dayEvents.map(e => {
          const customer = e.customerId ? crmData.customers.find(c => c.id === e.customerId) : null;
          return `
            <div class="event-item" onclick="event.stopPropagation(); openEventModal('${e.id}')">
              <i class="fas fa-${getEventIcon(e.type)}"></i> ${e.title}
              ${customer ? '<br><small>' + customer.name + '</small>' : ''}
            </div>
          `;
        }).join('');
      
        html += `
          <div class="calendar-day ${isToday ? 'today' : ''}" onclick="openEventModal(null, '${dateStr}')">
            <div style="font-weight: 600; margin-bottom: 8px;">${day}</div>
            ${content}
          </div>
        `;
      }
      
      calendarDays.innerHTML = html;
    }

    function getEventIcon(type) {
      const icons = {
        'Meeting': 'handshake',
        'Call': 'phone',
        'Demo': 'laptop',
        'Follow-up': 'tasks',
        'Tournament': 'trophy',
        'Clinic': 'graduation-cap',
        'Other': 'calendar-check'
      };
      return icons[type] || 'calendar-check';
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      } else if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
    }
    // Dashboard Functions
    function updateDashboard() {
      updateDashboardDate();
      // Total customers
      document.getElementById('totalCustomers').textContent = crmData.customers.length;
      
      // Total orders
      document.getElementById('totalOrders').textContent = crmData.orders.length;
      
      // Total revenue
      const totalRevenue = crmData.orders.reduce((sum, o) => sum + o.total, 0);
      document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toFixed(2);
      
      // Events today
      const today = new Date().toISOString().split('T')[0];
      const todayEvents = crmData.events.filter(e => e.date === today);
      document.getElementById('eventsToday').textContent = todayEvents.length;
      
      // Recent customers
      const recentCustomers = [...crmData.customers]
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        .slice(0, 5);
      
      const recentCustomersHtml = recentCustomers.length > 0 ? recentCustomers.map(c => `
        <div style="padding: 12px; border-bottom: 1px solid #f1f8e9; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${c.name}</strong><br>
            <small style="color: #666;">${c.email || c.homePhone || c.mobilePhone || 'No contact info'}</small>
          </div>
          <button class="btn-secondary" style="padding: 6px 12px;" onclick="openCustomerModal('${c.id}')">
            <i class="fas fa-edit"></i>
          </button>
        </div>
      `).join('') : '<p style="text-align: center; color: #999; padding: 20px;">No customers yet</p>';
      
      document.getElementById('recentCustomers').innerHTML = recentCustomersHtml;
      
      // Today's tasks
      const todayTasks = [];
      crmData.customers.forEach(customer => {
        if (customer.tasks) {
          customer.tasks.forEach(task => {
            if (task.dueDate === today && task.status !== 'Completed') {
              todayTasks.push({...task, customerName: customer.name, customerId: customer.id});
            }
          });
        }
      });
      
      const todayTasksHtml = todayTasks.length > 0 ? todayTasks.map(t => {
        const priorityColors = {
          'High': '#ef5350',
          'Medium': '#ffa726',
          'Low': '#66bb6a'
        };
        return `
          <div style="padding: 12px; border-bottom: 1px solid #f1f8e9; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <div style="width: 8px; height: 8px; border-radius: 50%; background: ${priorityColors[t.priority]};"></div>
                <strong>${t.description}</strong>
              </div>
              <small style="color: #666;"><i class="fas fa-user"></i> ${t.customerName}</small>
            </div>
            <button class="btn-secondary" style="padding: 6px 12px;" onclick="openCustomerModal('${t.customerId}')">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        `;
      }).join('') : '<p style="text-align: center; color: #999; padding: 20px;">No tasks for today</p>';
      
      document.getElementById('todaysTasks').innerHTML = todayTasksHtml;
    }

    // Pipeline Functions
    function updatePipelineView() {
      const statusGroups = {
        pending: crmData.orders.filter(o => o.status === 'Pending'),
        processing: crmData.orders.filter(o => o.status === 'Processing'),
        shipped: crmData.orders.filter(o => o.status === 'Shipped'),
        completed: crmData.orders.filter(o => o.status === 'Completed')
      };
      
      // Update counts and values
      Object.keys(statusGroups).forEach(status => {
        const orders = statusGroups[status];
        const value = orders.reduce((sum, o) => sum + o.total, 0);
        document.getElementById(`${status}Count`).textContent = `${orders.length} order${orders.length !== 1 ? 's' : ''}`;
        document.getElementById(`${status}Value`).textContent = '$' + value.toFixed(2);
        
        // Update order lists
        const html = orders.map(o => {
          const customer = crmData.customers.find(c => c.id === o.customerId);
          return `
            <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #66bb6a; cursor: pointer;" onclick="openOrderModal('${o.id}')">
              <div style="font-weight: 600; margin-bottom: 4px;">${o.id}</div>
              <div style="font-size: 13px; color: #666; margin-bottom: 4px;">${customer ? customer.name : 'Unknown'}</div>
              <div style="font-weight: 600; color: #43a047;">$${o.total.toFixed(2)}</div>
            </div>
          `;
        }).join('');
        
        document.getElementById(`${status}OrdersList`).innerHTML = html || '<p style="color: #999; font-size: 13px;">No orders</p>';
      });
      
      // Calculate metrics
      const allOrders = crmData.orders;
      const pipelineValue = allOrders.filter(o => o.status !== 'Completed').reduce((sum, o) => sum + o.total, 0);
      const avgDeal = allOrders.length > 0 ? allOrders.reduce((sum, o) => sum + o.total, 0) / allOrders.length : 0;
      const completedOrders = statusGroups.completed.length;
      const conversionRate = allOrders.length > 0 ? (completedOrders / allOrders.length) * 100 : 0;
      
      // Calculate average close time
      let totalDays = 0;
      let closedCount = 0;
      statusGroups.completed.forEach(o => {
        const created = new Date(o.createdAt);
        const completed = new Date(); // Simplified - in real app would track completion date
        const days = Math.floor((completed - created) / (1000 * 60 * 60 * 24));
        totalDays += days;
        closedCount++;
      });
      const avgCloseTime = closedCount > 0 ? Math.round(totalDays / closedCount) : 0;
      
      document.getElementById('pipelineValue').textContent = '$' + pipelineValue.toFixed(2);
      document.getElementById('avgDealSize').textContent = '$' + avgDeal.toFixed(2);
      document.getElementById('conversionRate').textContent = conversionRate.toFixed(1) + '%';
      document.getElementById('avgCloseTime').textContent = avgCloseTime + ' days';
    }

    // Analytics Functions
    function updateAnalyticsView() {
      updateLeadSourceChart();
      updateSocialChart();
      updateRevenueChart();
      generateAIInsights();
    }

    function updateLeadSourceChart() {
      const ctx = document.getElementById('leadSourceChart');
      if (!ctx) return;
      
      const leadSources = {};
      crmData.customers.forEach(c => {
        const source = c.leadSource || 'Unknown';
        leadSources[source] = (leadSources[source] || 0) + 1;
      });
      
      if (window.leadSourceChartInstance) {
        window.leadSourceChartInstance.destroy();
      }
      
      window.leadSourceChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(leadSources),
          datasets: [{
            data: Object.values(leadSources),
            backgroundColor: [
              '#66bb6a', '#42a5f5', '#ffa726', '#ab47bc', '#ef5350', '#26c6da', '#ffee58'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    function updateSocialChart() {
      const ctx = document.getElementById('socialChart');
      if (!ctx) return;
      
      const socialCounts = {};
      crmData.customers.forEach(c => {
        if (c.socialMedia && Array.isArray(c.socialMedia)) {
          c.socialMedia.forEach(platform => {
            socialCounts[platform] = (socialCounts[platform] || 0) + 1;
          });
        }
      });
      
      if (window.socialChartInstance) {
        window.socialChartInstance.destroy();
      }
      
      window.socialChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(socialCounts),
          datasets: [{
            label: 'Active Users',
            data: Object.values(socialCounts),
            backgroundColor: '#42a5f5'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    function updateRevenueChart() {
      const ctx = document.getElementById('revenueChart');
      if (!ctx) return;
      
      // Group orders by month
      const monthlyRevenue = {};
      crmData.orders.forEach(o => {
        const month = o.date.substring(0, 7); // YYYY-MM
        monthlyRevenue[month] = (monthlyRevenue[month] || 0) + o.total;
      });
      
      const sortedMonths = Object.keys(monthlyRevenue).sort();
      const revenues = sortedMonths.map(m => monthlyRevenue[m]);
      
      if (window.revenueChartInstance) {
        window.revenueChartInstance.destroy();
      }
      
      window.revenueChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedMonths.map(m => {
            const [year, month] = m.split('-');
            return new Date(year, month - 1).toLocaleDateString('en-US', {month: 'short', year: 'numeric'});
          }),
          datasets: [{
            label: 'Revenue',
            data: revenues,
            borderColor: '#66bb6a',
            backgroundColor: 'rgba(102, 187, 106, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(0);
                }
              }
            }
          }
        }
      });
    }

    function generateAIInsights() {
      const insights = [];
      
      // High-value customers
      const highValueCustomers = crmData.customers.filter(c => c.aiScore >= 75);
      if (highValueCustomers.length > 0) {
        insights.push({
          icon: 'star',
          color: '#ffa726',
          text: `You have ${highValueCustomers.length} high-value customer${highValueCustomers.length !== 1 ? 's' : ''} with AI scores above 75. Focus on nurturing these relationships.`
        });
      }
      
      // Conversion opportunities
      const leads = crmData.customers.filter(c => c.status === 'Lead');
      if (leads.length > 0) {
        insights.push({
          icon: 'user-plus',
          color: '#42a5f5',
          text: `${leads.length} lead${leads.length !== 1 ? 's' : ''} waiting for conversion. Consider reaching out with personalized offers.`
        });
      }
      
      // Social media potential
      const highSocialEngagement = crmData.customers.filter(c => 
        c.socialEngagement === 'Very High' || c.socialEngagement === 'High'
      );
      if (highSocialEngagement.length > 0) {
        insights.push({
          icon: 'bullhorn',
          color: '#ab47bc',
          text: `${highSocialEngagement.length} customer${highSocialEngagement.length !== 1 ? 's have' : ' has'} high social media engagement. Great candidates for referral programs or brand ambassadors.`
        });
      }
      
      // Referral opportunities
      const activeCustomers = crmData.customers.filter(c => c.status === 'Active');
      const customersWithNoReferrals = activeCustomers.filter(c => !c.referralCount || c.referralCount === 0);
      if (customersWithNoReferrals.length > 0) {
        insights.push({
          icon: 'gift',
          color: '#66bb6a',
          text: `${customersWithNoReferrals.length} active customer${customersWithNoReferrals.length !== 1 ? 's haven\'t' : ' hasn\'t'} made any referrals yet. Consider incentivizing referrals.`
        });
      }
      
      // Revenue trend
      if (crmData.orders.length >= 2) {
        const recentOrders = [...crmData.orders].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
        const olderOrders = [...crmData.orders].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(5, 10);
        
        if (olderOrders.length > 0) {
          const recentAvg = recentOrders.reduce((sum, o) => sum + o.total, 0) / recentOrders.length;
          const olderAvg = olderOrders.reduce((sum, o) => sum + o.total, 0) / olderOrders.length;
          const change = ((recentAvg - olderAvg) / olderAvg) * 100;
          
          if (change > 10) {
            insights.push({
              icon: 'chart-line',
              color: '#66bb6a',
              text: `Revenue trending up! Average order value increased by ${change.toFixed(1)}% recently.`
            });
          } else if (change < -10) {
            insights.push({
              icon: 'chart-line',
              color: '#ef5350',
              text: `Revenue trending down. Average order value decreased by ${Math.abs(change).toFixed(1)}%. Consider promotional campaigns.`
            });
          }
        }
      }
      
      const insightsHtml = insights.length > 0 ? insights.map(i => `
        <div style="display: flex; gap: 15px; padding: 20px; background: #f9fdf9; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid ${i.color};">
          <div style="font-size: 32px; color: ${i.color};">
            <i class="fas fa-${i.icon}"></i>
          </div>
          <div style="flex: 1;">
            <p style="margin: 0; color: #2e5940; line-height: 1.6;">${i.text}</p>
          </div>
        </div>
      `).join('') : '<p style="color: #999; text-align: center; padding: 40px;">Add more customer data to see AI-powered recommendations.</p>';
      
      document.getElementById('aiInsights').innerHTML = insightsHtml;
    }
    // Marketing Functions
    function updateMarketingView() {
      // Recommended campaigns
      const campaigns = [];
      
      // Email campaign for leads
      const emailOptInLeads = crmData.customers.filter(c => c.status === 'Lead' && c.emailOptIn);
      if (emailOptInLeads.length > 0) {
        campaigns.push({
          title: 'Lead Nurture Email Campaign',
          description: `${emailOptInLeads.length} leads have opted in to email. Send a welcome series with product highlights.`,
          icon: 'envelope',
          color: '#42a5f5',
          action: 'Launch Email Campaign',
          audience: emailOptInLeads.length
        });
      }
      
      // SMS campaign for high engagement
      const smsOptIn = crmData.customers.filter(c => c.smsOptIn && c.status === 'Active');
      if (smsOptIn.length > 0) {
        campaigns.push({
          title: 'SMS Flash Sale',
          description: `${smsOptIn.length} active customers opted in for SMS. Perfect for time-sensitive promotions.`,
          icon: 'mobile-alt',
          color: '#66bb6a',
          action: 'Send SMS Campaign',
          audience: smsOptIn.length
        });
      }
      
      // Social media campaign
      const highSocial = crmData.customers.filter(c => 
        c.socialEngagement === 'Very High' || c.socialEngagement === 'High'
      );
      if (highSocial.length > 0) {
        campaigns.push({
          title: 'Social Media Influencer Program',
          description: `${highSocial.length} customers with high social engagement. Create a brand ambassador program.`,
          icon: 'share-alt',
          color: '#ab47bc',
          action: 'Create Ambassador Program',
          audience: highSocial.length
        });
      }
      
      // Re-engagement campaign
      const inactive = crmData.customers.filter(c => c.status === 'Inactive');
      if (inactive.length > 0) {
        campaigns.push({
          title: 'Win-Back Campaign',
          description: `${inactive.length} inactive customers. Re-engage with special "we miss you" offers.`,
          icon: 'redo',
          color: '#ffa726',
          action: 'Launch Win-Back',
          audience: inactive.length
        });
      }
      
      const campaignsHtml = campaigns.length > 0 ? campaigns.map(c => `
        <div style="padding: 20px; background: #f9fdf9; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid ${c.color};">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <div style="display: flex; gap: 15px; flex: 1;">
              <div style="font-size: 32px; color: ${c.color};">
                <i class="fas fa-${c.icon}"></i>
              </div>
              <div style="flex: 1;">
                <h4 style="color: #2e5940; margin: 0 0 8px 0;">${c.title}</h4>
                <p style="margin: 0; color: #666; line-height: 1.6;">${c.description}</p>
                <div style="margin-top: 10px; font-size: 13px; color: #999;">
                  <i class="fas fa-users"></i> Target Audience: ${c.audience} customers
                </div>
              </div>
            </div>
            <button class="btn-primary" style="white-space: nowrap;">
              ${c.action}
            </button>
          </div>
        </div>
      `).join('') : '<p style="color: #999; text-align: center; padding: 40px;">Add more customer data to see campaign recommendations.</p>';
      
      document.getElementById('marketingRecommendations').innerHTML = campaignsHtml;
      
      // High-value customers
      const highValue = [...crmData.customers]
        .filter(c => c.aiScore >= 75)
        .sort((a, b) => b.aiScore - a.aiScore)
        .slice(0, 5);
      
      const highValueHtml = highValue.length > 0 ? highValue.map(c => `
        <div style="padding: 15px; border-bottom: 1px solid #f1f8e9; display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #2e5940; margin-bottom: 4px;">${c.name}</div>
            <div style="font-size: 13px; color: #666;">${c.leadSource || 'Unknown source'}</div>
          </div>
          <div style="text-align: right;">
            <div class="score-badge score-high" style="margin-bottom: 5px;">${c.aiScore}/100</div>
            <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="openCustomerModal('${c.id}')">
              View
            </button>
          </div>
        </div>
      `).join('') : '<p style="color: #999; text-align: center; padding: 20px;">No high-value customers yet</p>';
      
      document.getElementById('highValueCustomers').innerHTML = highValueHtml;
      
      // Referral opportunities
      const referralOpps = [...crmData.customers]
        .filter(c => c.status === 'Active' && (!c.referralCount || c.referralCount === 0))
        .slice(0, 5);
      
      const referralOppsHtml = referralOpps.length > 0 ? referralOpps.map(c => `
        <div style="padding: 15px; border-bottom: 1px solid #f1f8e9; display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #2e5940; margin-bottom: 4px;">${c.name}</div>
            <div style="font-size: 13px; color: #666;">
              ${c.socialEngagement ? c.socialEngagement + ' engagement' : 'Active customer'}
            </div>
          </div>
          <button class="btn-primary" style="padding: 6px 12px; font-size: 13px;" onclick="openCustomerModal('${c.id}')">
            <i class="fas fa-gift"></i> Invite
          </button>
        </div>
      `).join('') : '<p style="color: #999; text-align: center; padding: 20px;">All active customers are in referral program</p>';
      
      document.getElementById('referralOpportunities').innerHTML = referralOppsHtml;
    }

  // Referral Functions
    function updateReferralsView() {
      // Update display settings
      const settings = crmData.referralSettings;
      document.getElementById('displayCreditAmount').textContent = '$' + settings.creditPerReferral;
      document.getElementById('displayBronzeThreshold').textContent = settings.tiers.bronze + '+';
      document.getElementById('displaySilverThreshold').textContent = settings.tiers.silver + '+';
      document.getElementById('displayGoldThreshold').textContent = settings.tiers.gold + '+';
      
      // Leaderboard
      const referrers = [...crmData.customers]
        .filter(c => c.referralCount > 0)
        .sort((a, b) => b.referralCount - a.referralCount);
      
      const leaderboardHtml = referrers.length > 0 ? `
        <table class="table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Customer</th>
              <th>Referrals</th>
              <th>Tier</th>
              <th>Credits Earned</th>
              <th>Credits Used</th>
              <th>Balance</th>
            </tr>
          </thead>
          <tbody>
            ${referrers.map((c, index) => {
              const balance = (c.creditsEarned || 0) - (c.creditsUsed || 0);
              const tierColors = {
                'Platinum': '#e1bee7',
                'Gold': '#fff9c4',
                'Silver': '#f5f5f5',
                'Bronze': '#ffccbc',
                'None': '#e0e0e0'
              };
              return `
                <tr>
                  <td><strong>#${index + 1}</strong></td>
                  <td>${c.name}</td>
                  <td><strong>${c.referralCount}</strong></td>
                  <td><span class="status-badge" style="background: ${tierColors[c.referralTier || 'None']};">${c.referralTier || 'None'}</span></td>
                  <td>$${(c.creditsEarned || 0).toFixed(2)}</td>
                  <td>$${(c.creditsUsed || 0).toFixed(2)}</td>
                  <td><strong style="color: #43a047;">$${balance.toFixed(2)}</strong></td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      ` : '<p style="color: #999; text-align: center; padding: 40px;">No referrals yet. Start tracking customer referrals to see your top performers here.</p>';
      
      document.getElementById('referralLeaderboard').innerHTML = leaderboardHtml;
    }

    function openReferralSettings() {
      document.getElementById('referralSettingsModal').style.display = 'block';
      const settings = crmData.referralSettings;
      document.getElementById('creditPerReferral').value = settings.creditPerReferral;
      document.getElementById('bronzeTier').value = settings.tiers.bronze;
      document.getElementById('silverTier').value = settings.tiers.silver;
      document.getElementById('goldTier').value = settings.tiers.gold;
      document.getElementById('platinumTier').value = settings.tiers.platinum;
    }

    function saveReferralSettings(event) {
      event.preventDefault();
      
      crmData.referralSettings = {
        creditPerReferral: parseFloat(document.getElementById('creditPerReferral').value),
        tiers: {
          bronze: parseInt(document.getElementById('bronzeTier').value),
          silver: parseInt(document.getElementById('silverTier').value),
          gold: parseInt(document.getElementById('goldTier').value),
          platinum: parseInt(document.getElementById('platinumTier').value)
        }
      };
      
      saveData();
      closeModal('referralSettingsModal');
      updateReferralsView();
      showNotification('Referral settings updated!');
    }

    // Customer History Functions
    function loadCustomerHistory(customerId) {
      const customer = crmData.customers.find(c => c.id === customerId);
      if (!customer) return;
      
      // Load communications
      const communications = customer.communications || [];
      const commsHtml = communications.length > 0 ? communications.map((comm, index) => `
        <div style="padding: 15px; border-bottom: 1px solid #f1f8e9; display: flex; justify-content: space-between;">
          <div style="flex: 1;">
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
              <span class="status-badge" style="background: #e3f2fd;">${comm.type}</span>
              <span style="color: #666; font-size: 13px;">${new Date(comm.date).toLocaleDateString()}</span>
            </div>
            ${comm.subject ? `<div style="font-weight: 600; margin-bottom: 4px;">${comm.subject}</div>` : ''}
            <div style="color: #666; font-size: 14px;">${comm.notes}</div>
          </div>
          <button class="btn-danger" style="padding: 6px 12px;" onclick="deleteCommunication('${customerId}', ${index})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('') : '<p style="color: #999; text-align: center; padding: 20px;">No communications recorded yet.</p>';
      
      document.getElementById('communicationsList').innerHTML = commsHtml;
      
      // Load tasks
      const tasks = customer.tasks || [];
      const tasksHtml = tasks.length > 0 ? tasks.map((task, index) => {
        const priorityColors = {
          'High': '#ef5350',
          'Medium': '#ffa726',
          'Low': '#66bb6a'
        };
        const statusColors = {
          'Completed': '#66bb6a',
          'In Progress': '#42a5f5',
          'Pending': '#ffa726'
        };
        return `
          <div style="padding: 15px; border-bottom: 1px solid #f1f8e9; display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                <div style="width: 8px; height: 8px; border-radius: 50%; background: ${priorityColors[task.priority]};"></div>
                <strong>${task.description}</strong>
              </div>
              <div style="display: flex; gap: 10px; font-size: 13px; color: #666; margin-bottom: 4px;">
                <span><i class="fas fa-calendar"></i> Due: ${new Date(task.dueDate).toLocaleDateString()}</span>
                <span class="status-badge" style="background: ${statusColors[task.status]}; color: white;">${task.status}</span>
              </div>
              ${task.notes ? `<div style="font-size: 13px; color: #666;">${task.notes}</div>` : ''}
            </div>
            <div style="display: flex; gap: 5px;">
              <button class="btn-secondary" style="padding: 6px 12px;" onclick="editTask('${customerId}', ${index})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-danger" style="padding: 6px 12px;" onclick="deleteTask('${customerId}', ${index})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('') : '<p style="color: #999; text-align: center; padding: 20px;">No tasks created yet.</p>';
      
      document.getElementById('tasksList').innerHTML = tasksHtml;
      
      // Load purchases
      const customerOrders = crmData.orders.filter(o => o.customerId === customerId);
      const totalSpent = customerOrders.reduce((sum, o) => sum + o.total, 0);
      const ltv = totalSpent * 1.5; // Simple LTV calculation (adjust as needed)
      
      document.getElementById('customerTotalOrders').textContent = customerOrders.length;
      document.getElementById('customerTotalSpent').textContent = '$' + totalSpent.toFixed(2);
      document.getElementById('customerLTV').textContent = '$' + ltv.toFixed(2);
      
      const purchasesHtml = customerOrders.length > 0 ? customerOrders.map(o => `
        <div style="padding: 15px; border-bottom: 1px solid #f1f8e9; display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">${o.product}</div>
            <div style="font-size: 13px; color: #666;">
              ${new Date(o.date).toLocaleDateString()} • ${o.id}
            </div>
          </div>
          <div style="text-align: right;">
            <div style="font-weight: 600; color: #43a047; margin-bottom: 4px;">$${o.total.toFixed(2)}</div>
            <span class="status-badge status-${o.status.toLowerCase()}">${o.status}</span>
          </div>
        </div>
      `).join('') : '<p style="color: #999; text-align: center; padding: 20px;">No purchases yet.</p>';
      
      document.getElementById('purchasesList').innerHTML = purchasesHtml;
    }

    // Communication & Task Functions
    function addCommunication() {
      const customerId = document.getElementById('customerId').value;
      if (!customerId) {
        showNotification('Please save the customer first');
        return;
      }
      document.getElementById('communicationCustomerId').value = customerId;
      document.getElementById('communicationModal').style.display = 'block';
      document.getElementById('communicationForm').reset();
      document.getElementById('communicationDate').value = new Date().toISOString().split('T')[0];
    }

    function saveCommunication(event) {
      event.preventDefault();
      
      const customerId = document.getElementById('communicationCustomerId').value;
      const customer = crmData.customers.find(c => c.id === customerId);
      
      if (!customer) return;
      
      if (!customer.communications) {
        customer.communications = [];
      }
      
      customer.communications.push({
        type: document.getElementById('communicationType').value,
        date: document.getElementById('communicationDate').value,
        subject: document.getElementById('communicationSubject').value,
        notes: document.getElementById('communicationNotes').value,
        createdAt: new Date().toISOString()
      });
      
      saveData();
      closeModal('communicationModal');
      loadCustomerHistory(customerId);
      showNotification('Communication logged successfully!');
    }

    function deleteCommunication(customerId, index) {
      if (confirm('Delete this communication?')) {
        const customer = crmData.customers.find(c => c.id === customerId);
        if (customer && customer.communications) {
          customer.communications.splice(index, 1);
          saveData();
          loadCustomerHistory(customerId);
          showNotification('Communication deleted');
        }
      }
    }

    function addTask() {
      const customerId = document.getElementById('customerId').value;
      if (!customerId) {
        showNotification('Please save the customer first');
        return;
      }
      document.getElementById('taskCustomerId').value = customerId;
      document.getElementById('taskModal').style.display = 'block';
      document.getElementById('taskForm').reset();
      document.getElementById('taskDueDate').value = new Date().toISOString().split('T')[0];
    }

    function saveTask(event) {
      event.preventDefault();
      
      const customerId = document.getElementById('taskCustomerId').value;
      const customer = crmData.customers.find(c => c.id === customerId);
      
      if (!customer) return;
      
      if (!customer.tasks) {
        customer.tasks = [];
      }
      
      customer.tasks.push({
        description: document.getElementById('taskDescription').value,
        dueDate: document.getElementById('taskDueDate').value,
        priority: document.getElementById('taskPriority').value,
        status: document.getElementById('taskStatus').value,
        notes: document.getElementById('taskNotes').value,
        createdAt: new Date().toISOString()
      });
      
      saveData();
      closeModal('taskModal');
      loadCustomerHistory(customerId);
      updateDashboard();
      showNotification('Task created successfully!');
    }

    function editTask(customerId, index) {
      const customer = crmData.customers.find(c => c.id === customerId);
      if (!customer || !customer.tasks || !customer.tasks[index]) return;
      
      const task = customer.tasks[index];
      document.getElementById('taskCustomerId').value = customerId;
      document.getElementById('taskDescription').value = task.description;
      document.getElementById('taskDueDate').value = task.dueDate;
      document.getElementById('taskPriority').value = task.priority;
      document.getElementById('taskStatus').value = task.status;
      document.getElementById('taskNotes').value = task.notes || '';
      
      document.getElementById('taskModal').style.display = 'block';
      
      // Delete old task after saving (logic moved to saveTask, but keeping placeholder here for potential future update logic if needed)
      // For now, we rely on user manually deleting after editing is complete, or user overwriting in an external system.
    }

    function deleteTask(customerId, index) {
      if (confirm('Delete this task?')) {
        const customer = crmData.customers.find(c => c.id === customerId);
        if (customer && customer.tasks) {
          customer.tasks.splice(index, 1);
          saveData();
          loadCustomerHistory(customerId);
          updateDashboard();
          showNotification('Task deleted');
        }
      }
    }
    // Reports Functions
    function setReportDateRange(range) {
      const today = new Date();
      let startDate, endDate;
      
      // Ensure a fresh copy of today is used for multi-step calculations like last week/month
      const dateUtil = new Date();
      
      switch(range) {
        case 'today':
          startDate = endDate = dateUtil;
          break;
        case 'yesterday':
          startDate = endDate = new Date(dateUtil.setDate(dateUtil.getDate() - 1));
          break;
        case 'thisWeek':
          startDate = new Date(dateUtil.setDate(dateUtil.getDate() - dateUtil.getDay()));
          endDate = new Date();
          break;
        case 'lastWeek':
          // Start of this week, then go back 7 days for the end of last week
          dateUtil.setDate(dateUtil.getDate() - dateUtil.getDay()); // Start of current week (Sun)
          endDate = new Date(dateUtil.setDate(dateUtil.getDate() - 1)); // End of last week (Sat)
          startDate = new Date(endDate);
          startDate.setDate(endDate.getDate() - 6); // Start of last week (Sun)
          break;
        case 'thisMonth':
          startDate = new Date(dateUtil.getFullYear(), dateUtil.getMonth(), 1);
          endDate = new Date();
          break;
        case 'lastMonth':
          startDate = new Date(dateUtil.getFullYear(), dateUtil.getMonth() - 1, 1);
          endDate = new Date(dateUtil.getFullYear(), dateUtil.getMonth(), 0);
          break;
        case 'thisYear':
          startDate = new Date(dateUtil.getFullYear(), 0, 1);
          endDate = new Date();
          break;
        case 'lastYear':
          startDate = new Date(dateUtil.getFullYear() - 1, 0, 1);
          endDate = new Date(dateUtil.getFullYear() - 1, 11, 31);
          break;
        default:
          return;
      }
      
      document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
      document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
    }

    function generateReport() {
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;
      
      if (!startDate || !endDate) {
        showNotification('Please select a date range');
        return;
      }
      
      // Filter data by date range
      const ordersInRange = crmData.orders.filter(o => o.date >= startDate && o.date <= endDate);
      const customersInRange = crmData.customers.filter(c => c.createdAt.split('T')[0] >= startDate && c.createdAt.split('T')[0] <= endDate);
      const eventsInRange = crmData.events.filter(e => e.date >= startDate && e.date <= endDate);
      
      // Calculate metrics
      const totalRevenue = ordersInRange.reduce((sum, o) => sum + o.total, 0);
      const avgOrderValue = ordersInRange.length > 0 ? totalRevenue / ordersInRange.length : 0;
      const completedOrders = ordersInRange.filter(o => o.status === 'Completed').length;
      const conversionRate = ordersInRange.length > 0 ? (completedOrders / ordersInRange.length) * 100 : 0;
      
      // Lead sources breakdown
      const leadSourceBreakdown = {};
      customersInRange.forEach(c => {
        const source = c.leadSource || 'Unknown';
        leadSourceBreakdown[source] = (leadSourceBreakdown[source] || 0) + 1;
      });
      
      // Product breakdown
      const productBreakdown = {};
      ordersInRange.forEach(o => {
        productBreakdown[o.product] = (productBreakdown[o.product] || 0) + 1;
      });
      
      const reportHtml = `
        <div class="card">
          <h3 style="margin-bottom: 20px; color: #2e5940;">
            <i class="fas fa-chart-pie"></i> Report: ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}
          </h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div style="background: #f1f8e9; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Total Revenue</div>
              <div style="font-size: 32px; font-weight: 700; color: #43a047;">$${totalRevenue.toFixed(2)}</div>
            </div>
            <div style="background: #f1f8e9; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Orders</div>
              <div style="font-size: 32px; font-weight: 700; color: #2e5940;">${ordersInRange.length}</div>
            </div>
            <div style="background: #f1f8e9; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Avg Order Value</div>
              <div style="font-size: 32px; font-weight: 700; color: #2e5940;">$${avgOrderValue.toFixed(2)}</div>
            </div>
            <div style="background: #f1f8e9; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">New Customers</div>
              <div style="font-size: 32px; font-weight: 700; color: #2e5940;">${customersInRange.length}</div>
            </div>
            <div style="background: #f1f8e9; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Events</div>
              <div style="font-size: 32px; font-weight: 700; color: #2e5940;">${eventsInRange.length}</div>
            </div>
            <div style="background: #f1f8e9; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Conversion Rate</div>
              <div style="font-size: 32px; font-weight: 700; color: #2e5940;">${conversionRate.toFixed(1)}%</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h4 style="color: #2e5940; margin-bottom: 15px;">Lead Sources</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>Source</th>
                    <th>Count</th>
                  </tr>
                </thead>
                <tbody>
                  ${Object.entries(leadSourceBreakdown).map(([source, count]) => `
                    <tr>
                      <td>${source}</td>
                      <td><strong>${count}</strong></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div>
              <h4 style="color: #2e5940; margin-bottom: 15px;">Top Products</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Orders</th>
                  </tr>
                </thead>
                <tbody>
                  ${Object.entries(productBreakdown)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([product, count]) => `
                      <tr>
                        <td>${product}</td>
                        <td><strong>${count}</strong></td>
                    </tr>
                    `).join('')}
                </tbody>
              </table>
            </div>
          </div>
          
          <div style="margin-top: 20px; text-align: center;">
            <button class="btn-primary" onclick="exportReportCSV()">
              <i class="fas fa-download"></i> Export as CSV
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('reportResults').innerHTML = reportHtml;
    }

    function exportReportCSV() {
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;
      
      const ordersInRange = crmData.orders.filter(o => o.date >= startDate && o.date <= endDate);
      
      let csv = 'Order ID,Customer,Date,Product,Status,Total\n';
      ordersInRange.forEach(o => {
        const customer = crmData.customers.find(c => c.id === o.customerId);
        csv += `${o.id},"${customer ? customer.name : 'Unknown'}",${o.date},"${o.product}",${o.status},${o.total}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `report-${startDate}-to-${endDate}.csv`;
      link.click();
      showNotification('Report exported successfully!');
    }

    // Import Functions
    let pendingImport = null;

    function selectImportPlatform(platform) {
      document.getElementById('importInstructions').style.display = 'block';
      document.getElementById('importPreview').style.display = 'none';
      
      const instructions = {
        amazon: {
          title: 'Amazon FBA Import',
          content: `
            <div class="info-box">
              <strong>How to get your Amazon FBA data:</strong>
              <ol style="margin: 10px 0 0 20px;">
                <li>Log into Amazon Seller Central</li>
                <li>Go to Reports → Fulfillment</li>
                <li>Download "All Orders" report as CSV</li>
                <li>Upload the CSV file here</li>
              </ol>
            </div>
          `
        },
        shopify: {
          title: 'Shopify Import',
          content: `
            <div class="info-box">
              <strong>How to get your Shopify data:</strong>
              <ol style="margin: 10px 0 0 20px;">
                <li>Log into your Shopify admin</li>
                <li>Go to Orders</li>
                <li>Click "Export" and select CSV format</li>
                <li>Upload the CSV file here</li>
              </ol>
            </div>
          `
        },
        ebay: {
          title: 'eBay Import',
          content: `
            <div class="info-box">
              <strong>How to get your eBay data:</strong>
              <ol style="margin: 10px 0 0 20px;">
                <li>Log into eBay Seller Hub</li>
                <li>Go to Orders → Download orders</li>
                <li>Select date range and download as CSV</li>
                <li>Upload the CSV file here</li>
              </ol>
            </div>
          `
        },
        csv: {
          title: 'Generic CSV Import',
          content: `
            <div class="info-box">
              <strong>CSV Format Requirements:</strong>
              <p style="margin: 10px 0;">Your CSV should have these columns (in any order):</p>
              <ul style="margin: 10px 0 0 20px;">
                <li><strong>customer_name</strong> - Customer full name</li>
                <li><strong>customer_email</strong> - Email address</li>
                <li><strong>order_date</strong> - Order date (YYYY-MM-DD)</li>
                <li><strong>product</strong> - Product name</li>
                <li><strong>price</strong> - Order total</li>
                <li><strong>status</strong> - Order status (Pending, Processing, Shipped, Completed)</li>
              </ul>
            </div>
          `
        }
      };
      
      document.getElementById('importPlatformTitle').textContent = instructions[platform].title;
      document.getElementById('importInstructionsContent').innerHTML = instructions[platform].content;
    }

    function handlePlatformImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      document.getElementById('selectedFileName').textContent = file.name;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const csv = e.target.result;
        const lines = csv.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        
        const orders = [];
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          
          const values = lines[i].split(',');
          const order = {};
          headers.forEach((header, index) => {
            order[header] = values[index] ? values[index].trim().replace(/['"]/g, '') : '';
          });
          
          if (order.customer_name || order['customer name']) {
            orders.push(order);
          }
        }
        
        pendingImport = orders;
        showImportPreview(orders);
      };
      
      reader.readAsText(file);
    }

    function showImportPreview(orders) {
      document.getElementById('importPreview').style.display = 'block';
      
      const previewHtml = `
        <p style="margin-bottom: 15px;"><strong>${orders.length} orders</strong> ready to import</p>
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Email</th>
                <th>Date</th>
                <th>Product</th>
                <th>Price</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${orders.slice(0, 10).map(o => `
                <tr>
                  <td>${o.customer_name || o['customer name'] || 'N/A'}</td>
                  <td>${o.customer_email || o['customer email'] || 'N/A'}</td>
                  <td>${o.order_date || o['order date'] || 'N/A'}</td>
                  <td>${o.product || o['product name'] || 'N/A'}</td>
                  <td>$${parseFloat(o.price || o.total || 0).toFixed(2)}</td>
                  <td>${o.status || 'Completed'}</td>
                </tr>
              `).join('')}
              ${orders.length > 10 ? `<tr><td colspan="6" style="text-align: center; color: #666;">... and ${orders.length - 10} more</td></tr>` : ''}
            </tbody>
          </table>
        </div>
      `;
      
      document.getElementById('importPreviewContent').innerHTML = previewHtml;
    }

    function confirmImport() {
      if (!pendingImport || pendingImport.length === 0) return;
      
      let customersAdded = 0;
      let ordersAdded = 0;
      
      pendingImport.forEach(item => {
        const customerName = item.customer_name || item['customer name'];
        const customerEmail = item.customer_email || item['customer email'];
        
        if (!customerName) return;
        
        // Check if customer exists
        let customer = crmData.customers.find(c => 
          c.name.toLowerCase() === customerName.toLowerCase() || 
          (c.email && customerEmail && c.email.toLowerCase() === customerEmail.toLowerCase())
        );
        
        // Create customer if doesn't exist
        if (!customer) {
          customer = {
            id: 'CUST' + Date.now() + Math.random().toString(36).substr(2, 9),
            name: customerName,
            email: customerEmail || '',
            status: 'Active',
            contactType: 'Individual',
            leadSource: 'Import',
            aiScore: 50,
            referralCount: 0,
            creditsEarned: 0,
            creditsUsed: 0,
            createdAt: new Date().toISOString(),
            communications: [],
            tasks: []
          };
          crmData.customers.push(customer);
          customersAdded++;
        }
        
        // Create order
        const order = {
          id: 'ORD' + Date.now() + Math.random().toString(36).substr(2, 9),
          customerId: customer.id,
          date: item.order_date || item['order date'] || new Date().toISOString().split('T')[0],
          product: item.product || item['product name'] || 'Imported Product',
          manufacturer: item.manufacturer || '',
          quantity: parseInt(item.quantity || 1),
          price: parseFloat(item.price || item.total || 0),
          discount: 0,
          taxRate: 0,
          shippingCost: 0,
          subtotal: parseFloat(item.price || item.total || 0),
          tax: 0,
          total: parseFloat(item.price || item.total || 0),
          status: item.status || 'Completed',
          takenBy: 'Import',
          billTo: {},
          shipTo: {},
          notes: 'Imported from CSV',
          createdAt: new Date().toISOString()
        };
        crmData.orders.push(order);
        ordersAdded++;
      });
      
      saveData();
      cancelImport();
      updateAllViews();
      populateCustomerDropdowns();
      showNotification(`Import complete! Added ${customersAdded} customers and ${ordersAdded} orders.`);
    }

    function cancelImport() {
      pendingImport = null;
      document.getElementById('importInstructions').style.display = 'none';
      document.getElementById('importPreview').style.display = 'none';
      document.getElementById('platformImportFile').value = '';
      document.getElementById('selectedFileName').textContent = '';
    }

    // Search Functions
    function performGlobalSearch() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const filter = document.getElementById('searchFilter').value;
      
      if (!query) {
        document.getElementById('searchResults').style.display = 'none';
        return;
      }
      
      const results = {
        customers: [],
        orders: [],
        locations: []
      };
      
      // Search customers
      if (filter === 'all' || filter === 'customers') {
        results.customers = crmData.customers.filter(c => 
          c.name.toLowerCase().includes(query) ||
          (c.email && c.email.toLowerCase().includes(query)) ||
          (c.homePhone && c.homePhone.includes(query)) ||
          (c.mobilePhone && c.mobilePhone.includes(query)) ||
          (c.industry && c.industry.toLowerCase().includes(query))
        ).slice(0, 5);
      }
      
      // Search orders
      if (filter === 'all' || filter === 'orders') {
        results.orders = crmData.orders.filter(o => 
          o.id.toLowerCase().includes(query) ||
          o.product.toLowerCase().includes(query) ||
          (o.manufacturer && o.manufacturer.toLowerCase().includes(query))
        ).slice(0, 5);
      }
      
      // Search locations (from customer addresses)
      if (filter === 'all' || filter === 'locations') {
        results.locations = crmData.customers.filter(c => 
          (c.billing?.city && c.billing.city.toLowerCase().includes(query)) ||
          (c.billing?.state && c.billing.state.toLowerCase().includes(query)) ||
          (c.shipping?.city && c.shipping.city.toLowerCase().includes(query)) ||
          (c.shipping?.state && c.shipping.state.toLowerCase().includes(query))
        ).slice(0, 5);
      }
      
      displaySearchResults(results);
    }

    function displaySearchResults(results) {
      const resultsDiv = document.getElementById('searchResults');
      let html = '';
      
      if (results.customers.length > 0) {
        html += '<div style="padding: 10px; background: #f1f8e9; font-weight: 600;">Customers</div>';
        results.customers.forEach(c => {
          html += `
            <div style="padding: 12px; border-bottom: 1px solid #f1f8e9; cursor: pointer;" onclick="showCustomerFromSearch('${c.id}')">
              <div style="font-weight: 600;">${c.name}</div>
              <div style="font-size: 13px; color: #666;">${c.email || c.homePhone || c.mobilePhone || 'No contact'}</div>
            </div>
          `;
        });
      }
      
      if (results.orders.length > 0) {
        html += '<div style="padding: 10px; background: #f1f8e9; font-weight: 600; border-top: 2px solid #e8f5e9;">Orders</div>';
        results.orders.forEach(o => {
          const customer = crmData.customers.find(c => c.id === o.customerId);
          html += `
            <div style="padding: 12px; border-bottom: 1px solid #f1f8e9; cursor: pointer;" onclick="showOrderFromSearch('${o.id}')">
              <div style="font-weight: 600;">${o.id} - ${o.product}</div>
              <div style="font-size: 13px; color: #666;">${customer ? customer.name : 'Unknown'} • $${o.total.toFixed(2)}</div>
            </div>
          `;
        });
      }
      
      if (results.locations.length > 0) {
        html += '<div style="padding: 10px; background: #f1f8e9; font-weight: 600; border-top: 2px solid #e8f5e9;">Locations</div>';
        results.locations.forEach(c => {
          const location = c.billing?.city && c.billing?.state ? 
            `${c.billing.city}, ${c.billing.state}` : 
            (c.shipping?.city && c.shipping?.state ? `${c.shipping.city}, ${c.shipping.state}` : 'Unknown');
          html += `
            <div style="padding: 12px; border-bottom: 1px solid #f1f8e9; cursor: pointer;" onclick="showCustomerFromSearch('${c.id}')">
              <div style="font-weight: 600;">${c.name}</div>
              <div style="font-size: 13px; color: #666;"><i class="fas fa-map-marker-alt"></i> ${location}</div>
            </div>
          `;
        });
      }
      
      if (html === '') {
        html = '<div style="padding: 20px; text-align: center; color: #999;">No results found</div>';
      }
      
      resultsDiv.innerHTML = html;
      resultsDiv.style.display = 'block';
    }

    function showCustomerFromSearch(customerId) {
      document.getElementById('searchResults').style.display = 'none';
      document.getElementById('searchInput').value = '';
      showView('customers', document.getElementById('nav-customers'));
      openCustomerModal(customerId);
    }

    function showOrderFromSearch(orderId) {
      document.getElementById('searchResults').style.display = 'none';
      document.getElementById('searchInput').value = '';
      showView('orders', document.getElementById('nav-orders'));
      openOrderModal(orderId);
    }

    // Dashboard click handlers
    function showAllCustomers() {
      showView('customers', document.getElementById('nav-customers'));
    }

    function showAllOrders() {
      showView('orders', document.getElementById('nav-orders'));
    }

    function showRevenueBreakdown() {
      showView('analytics', document.getElementById('nav-analytics'));
    }

    function showTodaysEvents() {
      showView('calendar', document.getElementById('nav-calendar'));
    }

    // Utility Functions
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    function populateCustomerDropdowns() {
      const customerSelects = ['orderCustomer', 'eventCustomer'];
      
      customerSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        const currentValue = select.value;
        const options = crmData.customers.map(c => 
          `<option value="${c.id}">${c.name}</option>`
        ).join('');
        
        if (selectId === 'orderCustomer') {
          select.innerHTML = '<option value="">Select Customer...</option>' + options;
        } else if (selectId === 'eventCustomer') {
          select.innerHTML = '<option value="">No customer (general event)</option>' + options;
        }
        
        if (currentValue) {
          select.value = currentValue;
        }
      });
    }

    function updateAllViews() {
      updateDashboard();
      updateCustomersView();
      updateOrdersView();
      updatePipelineView();
      updateAnalyticsView();
      updateMarketingView();
      updateReferralsView();
    }

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
      const searchContainer = document.querySelector('.search-container');
      const searchResults = document.getElementById('searchResults');
      if (searchResults && !searchContainer.contains(e.target)) {
        searchResults.style.display = 'none';
      }
    });

    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    };
  </script>
</body>
</html>
